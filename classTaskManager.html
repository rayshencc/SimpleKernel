<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: TaskManager Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('classTaskManager.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pri-types">Private Types</a> &#124;
<a href="#pri-methods">Private Member Functions</a> &#124;
<a href="#pri-attribs">Private Attributes</a> &#124;
<a href="#pri-static-attribs">Static Private Attributes</a> &#124;
<a href="classTaskManager-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">TaskManager Class Reference</div></div>
</div><!--header-->
<div class="contents">

<p>任务管理器  
 <a href="classTaskManager.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>&gt;</code></p>
<div class="dynheader">
Collaboration diagram for TaskManager:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager__coll__graph.png" border="0" usemap="#aTaskManager_coll__map" alt="Collaboration graph"/></div>
<map name="aTaskManager_coll__map" id="aTaskManager_coll__map">
<area shape="rect" title="任务管理器" alt="" coords="5,523,197,1288"/>
<area shape="rect" href="classSpinLock.html" title="自旋锁" alt="" coords="7,5,196,431"/>
<area shape="poly" title=" " alt="" coords="104,431,104,506,99,506,99,431"/>
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structTaskManager_1_1InterruptWork.html">InterruptWork</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">中断线程处理结构体  <a href="structTaskManager_1_1InterruptWork.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:aa997c36c40d00f38722808ab8db70f36" id="r_aa997c36c40d00f38722808ab8db70f36"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#aa997c36c40d00f38722808ab8db70f36">InitCurrentCore</a> ()</td></tr>
<tr class="memdesc:aa997c36c40d00f38722808ab8db70f36"><td class="mdescLeft">&#160;</td><td class="mdescRight">初始化 per cpu 的调度数据，创建 idle 线程  <br /></td></tr>
<tr class="separator:aa997c36c40d00f38722808ab8db70f36"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae97ee6101a6462300666058cc4bedd05" id="r_ae97ee6101a6462300666058cc4bedd05"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#ae97ee6101a6462300666058cc4bedd05">AddTask</a> (<a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> *task)</td></tr>
<tr class="memdesc:ae97ee6101a6462300666058cc4bedd05"><td class="mdescLeft">&#160;</td><td class="mdescRight">添加任务  <br /></td></tr>
<tr class="separator:ae97ee6101a6462300666058cc4bedd05"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af7525954e852c09c1dd8ba50235f1d78" id="r_af7525954e852c09c1dd8ba50235f1d78"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78">Schedule</a> ()</td></tr>
<tr class="memdesc:af7525954e852c09c1dd8ba50235f1d78"><td class="mdescLeft">&#160;</td><td class="mdescRight">调度函数 选择下一个任务并切换上下文  <br /></td></tr>
<tr class="separator:af7525954e852c09c1dd8ba50235f1d78"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a926010fadc0b0d1f1df608c59d4a57a0" id="r_a926010fadc0b0d1f1df608c59d4a57a0"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0">GetCurrentTask</a> () const</td></tr>
<tr class="memdesc:a926010fadc0b0d1f1df608c59d4a57a0"><td class="mdescLeft">&#160;</td><td class="mdescRight">获取当前任务  <br /></td></tr>
<tr class="separator:a926010fadc0b0d1f1df608c59d4a57a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa1041f9ed06a9d0b6b738621c30e1921" id="r_aa1041f9ed06a9d0b6b738621c30e1921"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#aa1041f9ed06a9d0b6b738621c30e1921">TickUpdate</a> ()</td></tr>
<tr class="memdesc:aa1041f9ed06a9d0b6b738621c30e1921"><td class="mdescLeft">&#160;</td><td class="mdescRight">更新系统 tick  <br /></td></tr>
<tr class="separator:aa1041f9ed06a9d0b6b738621c30e1921"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a86fe8ff01e353a0acb150c90e8081811" id="r_a86fe8ff01e353a0acb150c90e8081811"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a86fe8ff01e353a0acb150c90e8081811">Sleep</a> (uint64_t ms)</td></tr>
<tr class="memdesc:a86fe8ff01e353a0acb150c90e8081811"><td class="mdescLeft">&#160;</td><td class="mdescRight">线程睡眠  <br /></td></tr>
<tr class="separator:a86fe8ff01e353a0acb150c90e8081811"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae3444c55ab7b6ec348a56b596229fc0f" id="r_ae3444c55ab7b6ec348a56b596229fc0f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#ae3444c55ab7b6ec348a56b596229fc0f">Exit</a> (int exit_code=0)</td></tr>
<tr class="memdesc:ae3444c55ab7b6ec348a56b596229fc0f"><td class="mdescLeft">&#160;</td><td class="mdescRight">退出当前线程  <br /></td></tr>
<tr class="separator:ae3444c55ab7b6ec348a56b596229fc0f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a71763ebababa9aa90bad6a07c66edede" id="r_a71763ebababa9aa90bad6a07c66edede"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a71763ebababa9aa90bad6a07c66edede">Block</a> (<a class="el" href="structResourceId.html">ResourceId</a> resource_id)</td></tr>
<tr class="memdesc:a71763ebababa9aa90bad6a07c66edede"><td class="mdescLeft">&#160;</td><td class="mdescRight">阻塞当前任务  <br /></td></tr>
<tr class="separator:a71763ebababa9aa90bad6a07c66edede"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aecc6edadfbd8fd250db72884b1e23f93" id="r_aecc6edadfbd8fd250db72884b1e23f93"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#aecc6edadfbd8fd250db72884b1e23f93">Wakeup</a> (<a class="el" href="structResourceId.html">ResourceId</a> resource_id)</td></tr>
<tr class="memdesc:aecc6edadfbd8fd250db72884b1e23f93"><td class="mdescLeft">&#160;</td><td class="mdescRight">唤醒等待指定资源的所有任务  <br /></td></tr>
<tr class="separator:aecc6edadfbd8fd250db72884b1e23f93"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a101df6fadedb6dd4f93ee1a1e24550c2" id="r_a101df6fadedb6dd4f93ee1a1e24550c2"><td class="memItemLeft" align="right" valign="top"><a class="el" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected</a>&lt; <a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a101df6fadedb6dd4f93ee1a1e24550c2">Clone</a> (uint64_t <a class="el" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a>, void *user_stack, int *parent_tid, int *child_tid, void *tls, <a class="el" href="structcpu__io_1_1TrapContext.html">cpu_io::TrapContext</a> &amp;parent_context)</td></tr>
<tr class="memdesc:a101df6fadedb6dd4f93ee1a1e24550c2"><td class="mdescLeft">&#160;</td><td class="mdescRight">克隆当前任务 (fork/clone 系统调用)  <br /></td></tr>
<tr class="separator:a101df6fadedb6dd4f93ee1a1e24550c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aadc206ac53400212078270833533f247" id="r_aadc206ac53400212078270833533f247"><td class="memItemLeft" align="right" valign="top"><a class="el" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected</a>&lt; <a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#aadc206ac53400212078270833533f247">Wait</a> (<a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> pid, int *status, bool no_hang=false, bool untraced=false)</td></tr>
<tr class="memdesc:aadc206ac53400212078270833533f247"><td class="mdescLeft">&#160;</td><td class="mdescRight">等待子进程退出  <br /></td></tr>
<tr class="separator:aadc206ac53400212078270833533f247"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a68d6b636f85f72416de99952e61a1508" id="r_a68d6b636f85f72416de99952e61a1508"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a68d6b636f85f72416de99952e61a1508">FindTask</a> (<a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> pid)</td></tr>
<tr class="memdesc:a68d6b636f85f72416de99952e61a1508"><td class="mdescLeft">&#160;</td><td class="mdescRight">按 PID 查找任务  <br /></td></tr>
<tr class="separator:a68d6b636f85f72416de99952e61a1508"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr><td colspan="2"><div class="groupHeader">构造/析构函数</div></td></tr>
<tr class="memitem:ab1adaa0f5b87d8fb26c09e7883fdd9fe" id="r_ab1adaa0f5b87d8fb26c09e7883fdd9fe"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#ab1adaa0f5b87d8fb26c09e7883fdd9fe">TaskManager</a> ()=default</td></tr>
<tr class="separator:ab1adaa0f5b87d8fb26c09e7883fdd9fe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa507b7c7c7022cb35f6923b34d72e479" id="r_aa507b7c7c7022cb35f6923b34d72e479"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#aa507b7c7c7022cb35f6923b34d72e479">TaskManager</a> (const <a class="el" href="classTaskManager.html">TaskManager</a> &amp;)=delete</td></tr>
<tr class="separator:aa507b7c7c7022cb35f6923b34d72e479"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae0eb341aea4d994c72e4267bb78d8658" id="r_ae0eb341aea4d994c72e4267bb78d8658"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#ae0eb341aea4d994c72e4267bb78d8658">TaskManager</a> (<a class="el" href="classTaskManager.html">TaskManager</a> &amp;&amp;)=delete</td></tr>
<tr class="separator:ae0eb341aea4d994c72e4267bb78d8658"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a773d9dd15c6ebdafbd94c1c0abf1cfc8" id="r_a773d9dd15c6ebdafbd94c1c0abf1cfc8"><td class="memItemLeft" align="right" valign="top">auto&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a773d9dd15c6ebdafbd94c1c0abf1cfc8">operator=</a> (const <a class="el" href="classTaskManager.html">TaskManager</a> &amp;) -&gt; <a class="el" href="classTaskManager.html">TaskManager</a> &amp;=delete</td></tr>
<tr class="separator:a773d9dd15c6ebdafbd94c1c0abf1cfc8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4e4d2f9f4f5232d139fa6e489dd9be45" id="r_a4e4d2f9f4f5232d139fa6e489dd9be45"><td class="memItemLeft" align="right" valign="top">auto&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a4e4d2f9f4f5232d139fa6e489dd9be45">operator=</a> (<a class="el" href="classTaskManager.html">TaskManager</a> &amp;&amp;) -&gt; <a class="el" href="classTaskManager.html">TaskManager</a> &amp;=delete</td></tr>
<tr class="separator:a4e4d2f9f4f5232d139fa6e489dd9be45"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6ecdd2b8a6b7545eae64da180ba80c53" id="r_a6ecdd2b8a6b7545eae64da180ba80c53"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a6ecdd2b8a6b7545eae64da180ba80c53">~TaskManager</a> ()</td></tr>
<tr class="separator:a6ecdd2b8a6b7545eae64da180ba80c53"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-types" name="pri-types"></a>
Private Types</h2></td></tr>
<tr class="memitem:ab0adec238f0d8ec99595bcc3522f8031" id="r_ab0adec238f0d8ec99595bcc3522f8031"><td class="memItemLeft" align="right" valign="top">using&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#ab0adec238f0d8ec99595bcc3522f8031">InterruptWorkQueue</a> = mpmc_queue::MPMCQueue&lt; <a class="el" href="structTaskManager_1_1InterruptWork.html">InterruptWork</a>, <a class="el" href="classTaskManager.html#ae9f12b6fc28eb32b79ded767eb7ea405">kInterruptQueueCapacity</a> &gt;</td></tr>
<tr class="memdesc:ab0adec238f0d8ec99595bcc3522f8031"><td class="mdescLeft">&#160;</td><td class="mdescRight">中断工作队列  <br /></td></tr>
<tr class="separator:ab0adec238f0d8ec99595bcc3522f8031"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-methods" name="pri-methods"></a>
Private Member Functions</h2></td></tr>
<tr class="memitem:a69688c59dbd65567df780d024e6faa7c" id="r_a69688c59dbd65567df780d024e6faa7c"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a69688c59dbd65567df780d024e6faa7c">AllocatePid</a> ()</td></tr>
<tr class="memdesc:a69688c59dbd65567df780d024e6faa7c"><td class="mdescLeft">&#160;</td><td class="mdescRight">分配新的 PID  <br /></td></tr>
<tr class="separator:a69688c59dbd65567df780d024e6faa7c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a68f938a4d8f069f9f4ead850bd75b0cd" id="r_a68f938a4d8f069f9f4ead850bd75b0cd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a68f938a4d8f069f9f4ead850bd75b0cd">Balance</a> ()</td></tr>
<tr class="memdesc:a68f938a4d8f069f9f4ead850bd75b0cd"><td class="mdescLeft">&#160;</td><td class="mdescRight">负载均衡 (空闲 core 窃取任务)  <br /></td></tr>
<tr class="separator:a68f938a4d8f069f9f4ead850bd75b0cd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4c1b1e56864ca791fe96710270acfc11" id="r_a4c1b1e56864ca791fe96710270acfc11"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structCpuSchedData.html">CpuSchedData</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11">GetCurrentCpuSched</a> ()</td></tr>
<tr class="memdesc:a4c1b1e56864ca791fe96710270acfc11"><td class="mdescLeft">&#160;</td><td class="mdescRight">获取当前核心的调度数据  <br /></td></tr>
<tr class="separator:a4c1b1e56864ca791fe96710270acfc11"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a73c6f04f5f8aa4a646f56aa940d46d3d" id="r_a73c6f04f5f8aa4a646f56aa940d46d3d"><td class="memItemLeft" align="right" valign="top">sk_std::vector&lt; <a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a73c6f04f5f8aa4a646f56aa940d46d3d">GetThreadGroup</a> (<a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> tgid)</td></tr>
<tr class="memdesc:a73c6f04f5f8aa4a646f56aa940d46d3d"><td class="mdescLeft">&#160;</td><td class="mdescRight">获取线程组的所有线程  <br /></td></tr>
<tr class="separator:a73c6f04f5f8aa4a646f56aa940d46d3d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aee251dfccf1511abff3458d75f4aa034" id="r_aee251dfccf1511abff3458d75f4aa034"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#aee251dfccf1511abff3458d75f4aa034">SignalThreadGroup</a> (<a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> tgid, int signal)</td></tr>
<tr class="memdesc:aee251dfccf1511abff3458d75f4aa034"><td class="mdescLeft">&#160;</td><td class="mdescRight">向线程组中的所有线程发送信号  <br /></td></tr>
<tr class="separator:aee251dfccf1511abff3458d75f4aa034"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a63b9cd5ec9df1dc6878eff6cc355fccb" id="r_a63b9cd5ec9df1dc6878eff6cc355fccb"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a63b9cd5ec9df1dc6878eff6cc355fccb">ReapTask</a> (<a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> *task)</td></tr>
<tr class="memdesc:a63b9cd5ec9df1dc6878eff6cc355fccb"><td class="mdescLeft">&#160;</td><td class="mdescRight">回收僵尸进程资源  <br /></td></tr>
<tr class="separator:a63b9cd5ec9df1dc6878eff6cc355fccb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acfa70286ca9b8c538d1f75ba4d953ec8" id="r_acfa70286ca9b8c538d1f75ba4d953ec8"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#acfa70286ca9b8c538d1f75ba4d953ec8">ReparentChildren</a> (<a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> *parent)</td></tr>
<tr class="memdesc:acfa70286ca9b8c538d1f75ba4d953ec8"><td class="mdescLeft">&#160;</td><td class="mdescRight">将孤儿进程过继给 init 进程  <br /></td></tr>
<tr class="separator:acfa70286ca9b8c538d1f75ba4d953ec8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-attribs" name="pri-attribs"></a>
Private Attributes</h2></td></tr>
<tr class="memitem:aaebe944e28d505769c2acc4ce1c8cca5" id="r_aaebe944e28d505769c2acc4ce1c8cca5"><td class="memItemLeft" align="right" valign="top">std::array&lt; <a class="el" href="structCpuSchedData.html">CpuSchedData</a>, SIMPLEKERNEL_MAX_CORE_COUNT &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#aaebe944e28d505769c2acc4ce1c8cca5">cpu_schedulers_</a></td></tr>
<tr class="memdesc:aaebe944e28d505769c2acc4ce1c8cca5"><td class="mdescLeft">&#160;</td><td class="mdescRight">每个核心的调度数据  <br /></td></tr>
<tr class="separator:aaebe944e28d505769c2acc4ce1c8cca5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af14711655dcdd45271bfcd36d30c435d" id="r_af14711655dcdd45271bfcd36d30c435d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classSpinLock.html">SpinLock</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">task_table_lock_</a> {&quot;task_table_lock&quot;}</td></tr>
<tr class="memdesc:af14711655dcdd45271bfcd36d30c435d"><td class="mdescLeft">&#160;</td><td class="mdescRight">全局任务表 (PID -&gt; TCB 映射)  <br /></td></tr>
<tr class="separator:af14711655dcdd45271bfcd36d30c435d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abc5030703356936b612fec5dd4c91c5b" id="r_abc5030703356936b612fec5dd4c91c5b"><td class="memItemLeft" align="right" valign="top">sk_std::unordered_map&lt; <a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a>, <a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a></td></tr>
<tr class="separator:abc5030703356936b612fec5dd4c91c5b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa130b9c08feb39a8d8c653fbff4a4fa6" id="r_aa130b9c08feb39a8d8c653fbff4a4fa6"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classSpinLock.html">SpinLock</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#aa130b9c08feb39a8d8c653fbff4a4fa6">interrupt_threads_lock_</a> {&quot;interrupt_threads_lock&quot;}</td></tr>
<tr class="memdesc:aa130b9c08feb39a8d8c653fbff4a4fa6"><td class="mdescLeft">&#160;</td><td class="mdescRight">中断线程相关数据保护锁  <br /></td></tr>
<tr class="separator:aa130b9c08feb39a8d8c653fbff4a4fa6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5d6830c00a3e81dca6d2dc3c5379fc83" id="r_a5d6830c00a3e81dca6d2dc3c5379fc83"><td class="memItemLeft" align="right" valign="top">sk_std::unordered_map&lt; uint64_t, <a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a5d6830c00a3e81dca6d2dc3c5379fc83">interrupt_threads_</a></td></tr>
<tr class="memdesc:a5d6830c00a3e81dca6d2dc3c5379fc83"><td class="mdescLeft">&#160;</td><td class="mdescRight">中断号 -&gt; 中断线程映射  <br /></td></tr>
<tr class="separator:a5d6830c00a3e81dca6d2dc3c5379fc83"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a82c2ca716e81aba77419830f345aaa05" id="r_a82c2ca716e81aba77419830f345aaa05"><td class="memItemLeft" align="right" valign="top">sk_std::unordered_map&lt; uint64_t, <a class="el" href="classTaskManager.html#ab0adec238f0d8ec99595bcc3522f8031">InterruptWorkQueue</a> * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a82c2ca716e81aba77419830f345aaa05">interrupt_work_queues_</a></td></tr>
<tr class="memdesc:a82c2ca716e81aba77419830f345aaa05"><td class="mdescLeft">&#160;</td><td class="mdescRight">中断号 -&gt; 工作队列映射  <br /></td></tr>
<tr class="separator:a82c2ca716e81aba77419830f345aaa05"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a64b37b4d49c7ebbf120520759138eafe" id="r_a64b37b4d49c7ebbf120520759138eafe"><td class="memItemLeft" align="right" valign="top">std::atomic&lt; size_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#a64b37b4d49c7ebbf120520759138eafe">pid_allocator</a> {1}</td></tr>
<tr class="memdesc:a64b37b4d49c7ebbf120520759138eafe"><td class="mdescLeft">&#160;</td><td class="mdescRight">PID 分配器  <br /></td></tr>
<tr class="separator:a64b37b4d49c7ebbf120520759138eafe"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-static-attribs" name="pri-static-attribs"></a>
Static Private Attributes</h2></td></tr>
<tr class="memitem:ae9f12b6fc28eb32b79ded767eb7ea405" id="r_ae9f12b6fc28eb32b79ded767eb7ea405"><td class="memItemLeft" align="right" valign="top">static constexpr const size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classTaskManager.html#ae9f12b6fc28eb32b79ded767eb7ea405">kInterruptQueueCapacity</a> = 256</td></tr>
<tr class="memdesc:ae9f12b6fc28eb32b79ded767eb7ea405"><td class="mdescLeft">&#160;</td><td class="mdescRight">中断工作队列容量  <br /></td></tr>
<tr class="separator:ae9f12b6fc28eb32b79ded767eb7ea405"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>任务管理器 </p>
<p>负责管理系统中的所有任务，包括任务的创建、调度、切换等。 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00060">60</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>
</div><h2 class="groupheader">Member Typedef Documentation</h2>
<a id="ab0adec238f0d8ec99595bcc3522f8031" name="ab0adec238f0d8ec99595bcc3522f8031"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab0adec238f0d8ec99595bcc3522f8031">&#9670;&#160;</a></span>InterruptWorkQueue</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">using <a class="el" href="classTaskManager.html#ab0adec238f0d8ec99595bcc3522f8031">TaskManager::InterruptWorkQueue</a> =  mpmc_queue::MPMCQueue&lt;<a class="el" href="structTaskManager_1_1InterruptWork.html">InterruptWork</a>, <a class="el" href="classTaskManager.html#ae9f12b6fc28eb32b79ded767eb7ea405">kInterruptQueueCapacity</a>&gt;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>中断工作队列 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00191">191</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>

</div>
</div>
<h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="ab1adaa0f5b87d8fb26c09e7883fdd9fe" name="ab1adaa0f5b87d8fb26c09e7883fdd9fe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab1adaa0f5b87d8fb26c09e7883fdd9fe">&#9670;&#160;</a></span>TaskManager() <span class="overload">[1/3]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">TaskManager::TaskManager </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">default</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="aa507b7c7c7022cb35f6923b34d72e479" name="aa507b7c7c7022cb35f6923b34d72e479"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa507b7c7c7022cb35f6923b34d72e479">&#9670;&#160;</a></span>TaskManager() <span class="overload">[2/3]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">TaskManager::TaskManager </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classTaskManager.html">TaskManager</a> &amp;&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">delete</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="ae0eb341aea4d994c72e4267bb78d8658" name="ae0eb341aea4d994c72e4267bb78d8658"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae0eb341aea4d994c72e4267bb78d8658">&#9670;&#160;</a></span>TaskManager() <span class="overload">[3/3]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">TaskManager::TaskManager </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classTaskManager.html">TaskManager</a> &amp;&amp;&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">delete</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a6ecdd2b8a6b7545eae64da180ba80c53" name="a6ecdd2b8a6b7545eae64da180ba80c53"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6ecdd2b8a6b7545eae64da180ba80c53">&#9670;&#160;</a></span>~TaskManager()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">TaskManager::~TaskManager </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00219">219</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  219</span>                          {</div>
<div class="line"><span class="lineno">  220</span>  <span class="comment">// 清理每个核心的调度器</span></div>
<div class="line"><span class="lineno">  221</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; cpu_sched : <a class="code hl_variable" href="classTaskManager.html#aaebe944e28d505769c2acc4ce1c8cca5">cpu_schedulers_</a>) {</div>
<div class="line"><span class="lineno">  222</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; scheduler : cpu_sched.schedulers) {</div>
<div class="line"><span class="lineno">  223</span>      <span class="keyword">delete</span> scheduler;</div>
<div class="line"><span class="lineno">  224</span>      scheduler = <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">  225</span>    }</div>
<div class="line"><span class="lineno">  226</span>  }</div>
<div class="line"><span class="lineno">  227</span>}</div>
<div class="ttc" id="aclassTaskManager_html_aaebe944e28d505769c2acc4ce1c8cca5"><div class="ttname"><a href="classTaskManager.html#aaebe944e28d505769c2acc4ce1c8cca5">TaskManager::cpu_schedulers_</a></div><div class="ttdeci">std::array&lt; CpuSchedData, SIMPLEKERNEL_MAX_CORE_COUNT &gt; cpu_schedulers_</div><div class="ttdoc">每个核心的调度数据</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8hpp_source.html#l00195">task_manager.hpp:195</a></div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="ae97ee6101a6462300666058cc4bedd05" name="ae97ee6101a6462300666058cc4bedd05"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae97ee6101a6462300666058cc4bedd05">&#9670;&#160;</a></span>AddTask()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::AddTask </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> *&#160;</td>
          <td class="paramname"><em>task</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>添加任务 </p>
<p>根据任务的调度策略，将其添加到对应的调度器中。</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">task</td><td>任务控制块指针，状态应为 kUnInit </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00067">67</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   67</span>                                                {</div>
<div class="line"><span class="lineno">   68</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(task != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;AddTask: task must not be null&quot;</span>);</div>
<div class="line"><span class="lineno">   69</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">status</a> == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2aea2cc5ef767941164ec1261929e4cd6e">TaskStatus::kUnInit</a>,</div>
<div class="line"><span class="lineno">   70</span>                <span class="stringliteral">&quot;AddTask: task status must be kUnInit&quot;</span>);</div>
<div class="line"><span class="lineno">   71</span>  <span class="comment">// 分配 PID</span></div>
<div class="line"><span class="lineno">   72</span>  <span class="keywordflow">if</span> (task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a> == 0) {</div>
<div class="line"><span class="lineno">   73</span>    task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a> = <a class="code hl_function" href="classTaskManager.html#a69688c59dbd65567df780d024e6faa7c">AllocatePid</a>();</div>
<div class="line"><span class="lineno">   74</span>  }</div>
<div class="line"><span class="lineno">   75</span> </div>
<div class="line"><span class="lineno">   76</span>  <span class="comment">// 如果 tgid 未设置，则将其设为自己的 pid (单线程进程或线程组的主线程)</span></div>
<div class="line"><span class="lineno">   77</span>  <span class="keywordflow">if</span> (task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#acb0a79022e0b3c343512c8a135272bcc">tgid</a> == 0) {</div>
<div class="line"><span class="lineno">   78</span>    task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#acb0a79022e0b3c343512c8a135272bcc">tgid</a> = task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>;</div>
<div class="line"><span class="lineno">   79</span>  }</div>
<div class="line"><span class="lineno">   80</span> </div>
<div class="line"><span class="lineno">   81</span>  <span class="comment">// 加入全局任务表</span></div>
<div class="line"><span class="lineno">   82</span>  {</div>
<div class="line"><span class="lineno">   83</span>    <a class="code hl_class" href="classLockGuard.html">LockGuard</a> lock_guard{<a class="code hl_variable" href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">task_table_lock_</a>};</div>
<div class="line"><span class="lineno">   84</span>    <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>[task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>] = task;</div>
<div class="line"><span class="lineno">   85</span>  }</div>
<div class="line"><span class="lineno">   86</span> </div>
<div class="line"><span class="lineno">   87</span>  <span class="comment">// 设置任务状态为 kReady</span></div>
<div class="line"><span class="lineno">   88</span>  task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">status</a> = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a7f1984e27dfac1310a3ac5c981abf863">TaskStatus::kReady</a>;</div>
<div class="line"><span class="lineno">   89</span> </div>
<div class="line"><span class="lineno">   90</span>  <span class="comment">// 简单的负载均衡：如果指定了亲和性，放入对应核心，否则放入当前核心</span></div>
<div class="line"><span class="lineno">   91</span>  <span class="comment">// 更复杂的逻辑可以是：寻找最空闲的核心</span></div>
<div class="line"><span class="lineno">   92</span>  <span class="keywordtype">size_t</span> target_core = <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>();</div>
<div class="line"><span class="lineno">   93</span> </div>
<div class="line"><span class="lineno">   94</span>  <span class="keywordflow">if</span> (task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a82296b6fec3ae8a120ffec4f0e97ef81">cpu_affinity</a> != UINT64_MAX) {</div>
<div class="line"><span class="lineno">   95</span>    <span class="comment">// 寻找第一个允许的核心</span></div>
<div class="line"><span class="lineno">   96</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a> = 0; <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a> &lt; SIMPLEKERNEL_MAX_CORE_COUNT; ++<a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a>) {</div>
<div class="line"><span class="lineno">   97</span>      <span class="keywordflow">if</span> (task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a82296b6fec3ae8a120ffec4f0e97ef81">cpu_affinity</a> &amp; (1UL &lt;&lt; <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a>)) {</div>
<div class="line"><span class="lineno">   98</span>        target_core = <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a>;</div>
<div class="line"><span class="lineno">   99</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  100</span>      }</div>
<div class="line"><span class="lineno">  101</span>    }</div>
<div class="line"><span class="lineno">  102</span>  }</div>
<div class="line"><span class="lineno">  103</span> </div>
<div class="line"><span class="lineno">  104</span>  <span class="keyword">auto</span>&amp; cpu_sched = <a class="code hl_variable" href="classTaskManager.html#aaebe944e28d505769c2acc4ce1c8cca5">cpu_schedulers_</a>[target_core];</div>
<div class="line"><span class="lineno">  105</span> </div>
<div class="line"><span class="lineno">  106</span>  <span class="comment">// 加锁保护运行队列</span></div>
<div class="line"><span class="lineno">  107</span>  cpu_sched.lock.Lock();</div>
<div class="line"><span class="lineno">  108</span> </div>
<div class="line"><span class="lineno">  109</span>  <span class="keywordflow">if</span> (task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a017d7cfbc80709c0dfd826de0199a2a2">policy</a> &lt; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1ab4f971585d9e17099a7ae6926066cda0">SchedPolicy::kPolicyCount</a>) {</div>
<div class="line"><span class="lineno">  110</span>    <span class="keywordflow">if</span> (cpu_sched.schedulers[task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a017d7cfbc80709c0dfd826de0199a2a2">policy</a>]) {</div>
<div class="line"><span class="lineno">  111</span>      cpu_sched.schedulers[task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a017d7cfbc80709c0dfd826de0199a2a2">policy</a>]-&gt;Enqueue(task);</div>
<div class="line"><span class="lineno">  112</span>    }</div>
<div class="line"><span class="lineno">  113</span>  }</div>
<div class="line"><span class="lineno">  114</span> </div>
<div class="line"><span class="lineno">  115</span>  cpu_sched.lock.UnLock();</div>
<div class="line"><span class="lineno">  116</span> </div>
<div class="line"><span class="lineno">  117</span>  <span class="comment">// 如果是当前核心，且添加了比当前任务优先级更高的任务，触发抢占</span></div>
<div class="line"><span class="lineno">  118</span>  <span class="keywordflow">if</span> (target_core == <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>()) {</div>
<div class="line"><span class="lineno">  119</span>    <span class="keyword">auto</span>&amp; cpu_data = <a class="code hl_function" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f">per_cpu::GetCurrentCore</a>();</div>
<div class="line"><span class="lineno">  120</span>    <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* current = cpu_data.running_task;</div>
<div class="line"><span class="lineno">  121</span>    <span class="comment">// 如果当前是 idle 任务，或新任务的策略优先级更高，触发调度</span></div>
<div class="line"><span class="lineno">  122</span>    <span class="keywordflow">if</span> (current == cpu_data.idle_task ||</div>
<div class="line"><span class="lineno">  123</span>        (current &amp;&amp; task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a017d7cfbc80709c0dfd826de0199a2a2">policy</a> &lt; current-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a017d7cfbc80709c0dfd826de0199a2a2">policy</a>)) {</div>
<div class="line"><span class="lineno">  124</span>      <span class="comment">// 注意：这里不能直接调用 Schedule()，因为可能在中断上下文中</span></div>
<div class="line"><span class="lineno">  125</span>      <span class="comment">// 实际应该设置一个 need_resched 标志，在中断返回前检查</span></div>
<div class="line"><span class="lineno">  126</span>      <span class="comment">// 为简化，这里暂时不做抢占，只在时间片耗尽时调度</span></div>
<div class="line"><span class="lineno">  127</span>    }</div>
<div class="line"><span class="lineno">  128</span>  }</div>
<div class="line"><span class="lineno">  129</span>}</div>
<div class="ttc" id="aclassLockGuard_html"><div class="ttname"><a href="classLockGuard.html">LockGuard</a></div><div class="ttdoc">RAII 风格的锁守卫模板类</div><div class="ttdef"><b>Definition</b> <a href="spinlock_8hpp_source.html#l00127">spinlock.hpp:127</a></div></div>
<div class="ttc" id="aclassTaskManager_html_a69688c59dbd65567df780d024e6faa7c"><div class="ttname"><a href="classTaskManager.html#a69688c59dbd65567df780d024e6faa7c">TaskManager::AllocatePid</a></div><div class="ttdeci">size_t AllocatePid()</div><div class="ttdoc">分配新的 PID</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8cpp_source.html#l00131">task_manager.cpp:131</a></div></div>
<div class="ttc" id="aclassTaskManager_html_abc5030703356936b612fec5dd4c91c5b"><div class="ttname"><a href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">TaskManager::task_table_</a></div><div class="ttdeci">sk_std::unordered_map&lt; Pid, TaskControlBlock * &gt; task_table_</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8hpp_source.html#l00199">task_manager.hpp:199</a></div></div>
<div class="ttc" id="aclassTaskManager_html_af14711655dcdd45271bfcd36d30c435d"><div class="ttname"><a href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">TaskManager::task_table_lock_</a></div><div class="ttdeci">SpinLock task_table_lock_</div><div class="ttdoc">全局任务表 (PID -&gt; TCB 映射)</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8hpp_source.html#l00198">task_manager.hpp:198</a></div></div>
<div class="ttc" id="anamespacecpu__io_html_a52b8a7263a31e6670ef4dec7922d9e72"><div class="ttname"><a href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a></div><div class="ttdeci">auto GetCurrentCoreId() -&gt; size_t</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00026">cpu_io.h:26</a></div></div>
<div class="ttc" id="anamespaceper__cpu_html_ad9745465fefcd58504031bfcfcc1c13f"><div class="ttname"><a href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f">per_cpu::GetCurrentCore</a></div><div class="ttdeci">static __always_inline auto GetCurrentCore() -&gt; PerCpu &amp;</div><div class="ttdef"><b>Definition</b> <a href="per__cpu_8hpp_source.html#l00051">per_cpu.hpp:51</a></div></div>
<div class="ttc" id="aper__cpu_8hpp_html_af349ef2aacd2314294eac3283d14e3ca"><div class="ttname"><a href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a></div><div class="ttdeci">size_t core_id</div><div class="ttdoc">核心 ID</div><div class="ttdef"><b>Definition</b> <a href="per__cpu_8hpp_source.html#l00001">per_cpu.hpp:1</a></div></div>
<div class="ttc" id="ask__assert_8h_html_aca9cc707df79e034b240eaa8596b7e64"><div class="ttname"><a href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a></div><div class="ttdeci">#define sk_assert_msg(expr, fmt,...)</div><div class="ttdoc">带自定义消息的运行时断言宏（支持变长参数）</div><div class="ttdef"><b>Definition</b> <a href="sk__assert_8h_source.html#l00038">sk_assert.h:38</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html"><div class="ttname"><a href="structTaskControlBlock.html">TaskControlBlock</a></div><div class="ttdoc">任务控制块，管理进程/线程的核心数据结构</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00080">task_control_block.hpp:80</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_a017d7cfbc80709c0dfd826de0199a2a2"><div class="ttname"><a href="structTaskControlBlock.html#a017d7cfbc80709c0dfd826de0199a2a2">TaskControlBlock::policy</a></div><div class="ttdeci">SchedPolicy policy</div><div class="ttdoc">调度策略</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00121">task_control_block.hpp:121</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_a0ce7d1d1287b24fe59df20cdff362fea"><div class="ttname"><a href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">TaskControlBlock::status</a></div><div class="ttdeci">TaskStatus status</div><div class="ttdoc">线程状态</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00119">task_control_block.hpp:119</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_a82296b6fec3ae8a120ffec4f0e97ef81"><div class="ttname"><a href="structTaskControlBlock.html#a82296b6fec3ae8a120ffec4f0e97ef81">TaskControlBlock::cpu_affinity</a></div><div class="ttdeci">uint64_t cpu_affinity</div><div class="ttdoc">CPU 亲和性位掩码</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00181">task_control_block.hpp:181</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_aca9ca152ecda65751f10c515c4dbb867"><div class="ttname"><a href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">TaskControlBlock::pid</a></div><div class="ttdeci">Pid pid</div><div class="ttdoc">线程 ID (Task ID)</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00102">task_control_block.hpp:102</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_acb0a79022e0b3c343512c8a135272bcc"><div class="ttname"><a href="structTaskControlBlock.html#acb0a79022e0b3c343512c8a135272bcc">TaskControlBlock::tgid</a></div><div class="ttdeci">Pid tgid</div><div class="ttdoc">线程组 ID (主线程的 PID)</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00110">task_control_block.hpp:110</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a49a208767f4bf1cfd0e39b9db74b8af1ab4f971585d9e17099a7ae6926066cda0"><div class="ttname"><a href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1ab4f971585d9e17099a7ae6926066cda0">kPolicyCount</a></div><div class="ttdeci">@ kPolicyCount</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00075">task_control_block.hpp:74</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a5d987b98f8f913fcd928b7ab94e726a2a7f1984e27dfac1310a3ac5c981abf863"><div class="ttname"><a href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a7f1984e27dfac1310a3ac5c981abf863">kReady</a></div><div class="ttdeci">@ kReady</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00050">task_control_block.hpp:50</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a5d987b98f8f913fcd928b7ab94e726a2aea2cc5ef767941164ec1261929e4cd6e"><div class="ttname"><a href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2aea2cc5ef767941164ec1261929e4cd6e">kUnInit</a></div><div class="ttdeci">@ kUnInit</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00048">task_control_block.hpp:48</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_ae97ee6101a6462300666058cc4bedd05_cgraph.png" border="0" usemap="#aclassTaskManager_ae97ee6101a6462300666058cc4bedd05_cgraph" alt=""/></div>
<map name="aclassTaskManager_ae97ee6101a6462300666058cc4bedd05_cgraph" id="aclassTaskManager_ae97ee6101a6462300666058cc4bedd05_cgraph">
<area shape="rect" title="添加任务" alt="" coords="5,55,176,80"/>
<area shape="rect" href="classTaskManager.html#a69688c59dbd65567df780d024e6faa7c" title="分配新的 PID" alt="" coords="224,5,413,31"/>
<area shape="poly" title=" " alt="" coords="149,52,245,31,246,36,151,57"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="227,55,410,80"/>
<area shape="poly" title=" " alt="" coords="177,65,214,65,214,70,177,70"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="461,80,647,105"/>
<area shape="poly" title=" " alt="" coords="150,77,224,89,340,95,448,94,448,100,339,100,224,94,149,83"/>
<area shape="poly" title=" " alt="" coords="411,75,448,79,447,84,410,80"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="695,73,957,113"/>
<area shape="poly" title=" " alt="" coords="647,90,681,90,681,95,647,95"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_ae97ee6101a6462300666058cc4bedd05_icgraph.png" border="0" usemap="#aclassTaskManager_ae97ee6101a6462300666058cc4bedd05_icgraph" alt=""/></div>
<map name="aclassTaskManager_ae97ee6101a6462300666058cc4bedd05_icgraph" id="aclassTaskManager_ae97ee6101a6462300666058cc4bedd05_icgraph">
<area shape="rect" title="添加任务" alt="" coords="207,5,377,31"/>
<area shape="rect" href="classTaskManager.html#a101df6fadedb6dd4f93ee1a1e24550c2" title="克隆当前任务 (fork/clone 系统调用)" alt="" coords="5,5,159,31"/>
<area shape="poly" title=" " alt="" coords="193,21,159,21,159,15,193,15"/>
</map>
</div>

</div>
</div>
<a id="a69688c59dbd65567df780d024e6faa7c" name="a69688c59dbd65567df780d024e6faa7c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a69688c59dbd65567df780d024e6faa7c">&#9670;&#160;</a></span>AllocatePid()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">size_t TaskManager::AllocatePid </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>分配新的 PID </p>
<dl class="section return"><dt>Returns</dt><dd>size_t 新的 PID </dd></dl>

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00131">131</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  131</span>{ <span class="keywordflow">return</span> <a class="code hl_variable" href="classTaskManager.html#a64b37b4d49c7ebbf120520759138eafe">pid_allocator</a>.fetch_add(1); }</div>
<div class="ttc" id="aclassTaskManager_html_a64b37b4d49c7ebbf120520759138eafe"><div class="ttname"><a href="classTaskManager.html#a64b37b4d49c7ebbf120520759138eafe">TaskManager::pid_allocator</a></div><div class="ttdeci">std::atomic&lt; size_t &gt; pid_allocator</div><div class="ttdoc">PID 分配器</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8hpp_source.html#l00209">task_manager.hpp:209</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a69688c59dbd65567df780d024e6faa7c_icgraph.png" border="0" usemap="#aclassTaskManager_a69688c59dbd65567df780d024e6faa7c_icgraph" alt=""/></div>
<map name="aclassTaskManager_a69688c59dbd65567df780d024e6faa7c_icgraph" id="aclassTaskManager_a69688c59dbd65567df780d024e6faa7c_icgraph">
<area shape="rect" title="分配新的 PID" alt="" coords="425,31,615,56"/>
<area shape="rect" href="classTaskManager.html#ae97ee6101a6462300666058cc4bedd05" title="添加任务" alt="" coords="207,5,377,31"/>
<area shape="poly" title=" " alt="" coords="411,34,377,30,378,25,412,29"/>
<area shape="rect" href="classTaskManager.html#a101df6fadedb6dd4f93ee1a1e24550c2" title="克隆当前任务 (fork/clone 系统调用)" alt="" coords="5,31,159,56"/>
<area shape="poly" title=" " alt="" coords="412,46,159,46,159,41,412,41"/>
<area shape="poly" title=" " alt="" coords="193,33,159,37,159,31,193,27"/>
</map>
</div>

</div>
</div>
<a id="a68f938a4d8f069f9f4ead850bd75b0cd" name="a68f938a4d8f069f9f4ead850bd75b0cd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a68f938a4d8f069f9f4ead850bd75b0cd">&#9670;&#160;</a></span>Balance()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::Balance </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>负载均衡 (空闲 core 窃取任务) </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00139">139</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  139</span>                          {</div>
<div class="line"><span class="lineno">  140</span>  <span class="comment">// 算法留空</span></div>
<div class="line"><span class="lineno">  141</span>  <span class="comment">// TODO: 检查其他核心的运行队列长度，如果比当前核心长，则窃取任务</span></div>
<div class="line"><span class="lineno">  142</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a71763ebababa9aa90bad6a07c66edede" name="a71763ebababa9aa90bad6a07c66edede"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a71763ebababa9aa90bad6a07c66edede">&#9670;&#160;</a></span>Block()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::Block </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structResourceId.html">ResourceId</a>&#160;</td>
          <td class="paramname"><em>resource_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>阻塞当前任务 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">resource_id</td><td>等待的资源 ID</td></tr>
  </table>
  </dd>
</dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright The SimpleKernel Contributors </dd></dl>

<p class="definition">Definition at line <a class="el" href="block_8cpp_source.html#l00010">10</a> of file <a class="el" href="block_8cpp_source.html">block.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   10</span>                                              {</div>
<div class="line"><span class="lineno">   11</span>  <span class="keyword">auto</span>&amp; cpu_sched = <a class="code hl_function" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11">GetCurrentCpuSched</a>();</div>
<div class="line"><span class="lineno">   12</span> </div>
<div class="line"><span class="lineno">   13</span>  <span class="keyword">auto</span>* current = <a class="code hl_function" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0">GetCurrentTask</a>();</div>
<div class="line"><span class="lineno">   14</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(current != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;Block: No current task to block&quot;</span>);</div>
<div class="line"><span class="lineno">   15</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(current-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f">TaskStatus::kRunning</a>,</div>
<div class="line"><span class="lineno">   16</span>                <span class="stringliteral">&quot;Block: current task status must be kRunning&quot;</span>);</div>
<div class="line"><span class="lineno">   17</span> </div>
<div class="line"><span class="lineno">   18</span>  {</div>
<div class="line"><span class="lineno">   19</span>    <a class="code hl_class" href="classLockGuard.html">LockGuard&lt;SpinLock&gt;</a> lock_guard(cpu_sched.lock);</div>
<div class="line"><span class="lineno">   20</span> </div>
<div class="line"><span class="lineno">   21</span>    <span class="comment">// 将任务标记为阻塞状态</span></div>
<div class="line"><span class="lineno">   22</span>    current-&gt;status = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a825228abe8e14b673f73133b36daf2dc">TaskStatus::kBlocked</a>;</div>
<div class="line"><span class="lineno">   23</span> </div>
<div class="line"><span class="lineno">   24</span>    <span class="comment">// 记录阻塞的资源 ID</span></div>
<div class="line"><span class="lineno">   25</span>    current-&gt;blocked_on = resource_id;</div>
<div class="line"><span class="lineno">   26</span> </div>
<div class="line"><span class="lineno">   27</span>    <span class="comment">// 将任务加入阻塞队列（按资源 ID 分组）</span></div>
<div class="line"><span class="lineno">   28</span>    cpu_sched.blocked_tasks[resource_id].push_back(current);</div>
<div class="line"><span class="lineno">   29</span> </div>
<div class="line"><span class="lineno">   30</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Block: pid=%zu blocked on resource=%s, data=0x%lx\n&quot;</span>,</div>
<div class="line"><span class="lineno">   31</span>                current-&gt;pid, resource_id.<a class="code hl_function" href="structResourceId.html#ace28b59e657c4a031a54daabf85e59aa">GetTypeName</a>(), resource_id.<a class="code hl_function" href="structResourceId.html#ad6b4733a8896d35652c1969f1eca1651">GetData</a>());</div>
<div class="line"><span class="lineno">   32</span>  }</div>
<div class="line"><span class="lineno">   33</span> </div>
<div class="line"><span class="lineno">   34</span>  <span class="comment">// 调度到其他任务</span></div>
<div class="line"><span class="lineno">   35</span>  <a class="code hl_function" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78">Schedule</a>();</div>
<div class="line"><span class="lineno">   36</span> </div>
<div class="line"><span class="lineno">   37</span>  <span class="comment">// 任务被唤醒后会从这里继续执行</span></div>
<div class="line"><span class="lineno">   38</span>}</div>
<div class="ttc" id="aclassTaskManager_html_a4c1b1e56864ca791fe96710270acfc11"><div class="ttname"><a href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11">TaskManager::GetCurrentCpuSched</a></div><div class="ttdeci">CpuSchedData &amp; GetCurrentCpuSched()</div><div class="ttdoc">获取当前核心的调度数据</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8hpp_source.html#l00225">task_manager.hpp:225</a></div></div>
<div class="ttc" id="aclassTaskManager_html_a926010fadc0b0d1f1df608c59d4a57a0"><div class="ttname"><a href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0">TaskManager::GetCurrentTask</a></div><div class="ttdeci">TaskControlBlock * GetCurrentTask() const</div><div class="ttdoc">获取当前任务</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8hpp_source.html#l00091">task_manager.hpp:91</a></div></div>
<div class="ttc" id="aclassTaskManager_html_af7525954e852c09c1dd8ba50235f1d78"><div class="ttname"><a href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78">TaskManager::Schedule</a></div><div class="ttdeci">void Schedule()</div><div class="ttdoc">调度函数 选择下一个任务并切换上下文</div><div class="ttdef"><b>Definition</b> <a href="schedule_8cpp_source.html#l00027">schedule.cpp:27</a></div></div>
<div class="ttc" id="astructResourceId_html_ace28b59e657c4a031a54daabf85e59aa"><div class="ttname"><a href="structResourceId.html#ace28b59e657c4a031a54daabf85e59aa">ResourceId::GetTypeName</a></div><div class="ttdeci">constexpr const char * GetTypeName() const</div><div class="ttdoc">获取类型名称（用于调试）</div><div class="ttdef"><b>Definition</b> <a href="resource__id_8hpp_source.html#l00085">resource_id.hpp:85</a></div></div>
<div class="ttc" id="astructResourceId_html_ad6b4733a8896d35652c1969f1eca1651"><div class="ttname"><a href="structResourceId.html#ad6b4733a8896d35652c1969f1eca1651">ResourceId::GetData</a></div><div class="ttdeci">constexpr uint64_t GetData() const</div><div class="ttdoc">获取资源数据</div><div class="ttdef"><b>Definition</b> <a href="resource__id_8hpp_source.html#l00082">resource_id.hpp:82</a></div></div>
<div class="ttc" id="astructklog_1_1Debug_html"><div class="ttname"><a href="structklog_1_1Debug.html">klog::Debug</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00146">kernel_log.hpp:146</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f"><div class="ttname"><a href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f">kRunning</a></div><div class="ttdeci">@ kRunning</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00052">task_control_block.hpp:52</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a5d987b98f8f913fcd928b7ab94e726a2a825228abe8e14b673f73133b36daf2dc"><div class="ttname"><a href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a825228abe8e14b673f73133b36daf2dc">kBlocked</a></div><div class="ttdeci">@ kBlocked</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00056">task_control_block.hpp:56</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a71763ebababa9aa90bad6a07c66edede_cgraph.png" border="0" usemap="#aclassTaskManager_a71763ebababa9aa90bad6a07c66edede_cgraph" alt=""/></div>
<map name="aclassTaskManager_a71763ebababa9aa90bad6a07c66edede_cgraph" id="aclassTaskManager_a71763ebababa9aa90bad6a07c66edede_cgraph">
<area shape="rect" title="阻塞当前任务" alt="" coords="5,158,157,183"/>
<area shape="rect" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11" title="获取当前核心的调度数据" alt="" coords="450,5,662,45"/>
<area shape="poly" title=" " alt="" coords="98,156,144,124,204,92,262,72,322,57,436,35,437,41,323,62,264,77,206,97,147,128,101,160"/>
<area shape="rect" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0" title="获取当前任务" alt="" coords="448,171,664,197"/>
<area shape="poly" title=" " alt="" coords="158,170,434,178,434,183,157,175"/>
<area shape="rect" href="structResourceId.html#ad6b4733a8896d35652c1969f1eca1651" title="获取资源数据" alt="" coords="225,209,381,234"/>
<area shape="poly" title=" " alt="" coords="138,181,234,203,233,208,137,186"/>
<area shape="rect" href="structResourceId.html#ace28b59e657c4a031a54daabf85e59aa" title="获取类型名称（用于调试）" alt="" coords="205,258,400,283"/>
<area shape="poly" title=" " alt="" coords="101,181,147,213,206,244,226,251,224,256,204,249,145,217,98,186"/>
<area shape="rect" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78" title="调度函数 选择下一个任务并切换上下文" alt="" coords="215,107,390,133"/>
<area shape="poly" title=" " alt="" coords="137,155,233,133,234,138,138,160"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="943,19,1128,45"/>
<area shape="poly" title=" " alt="" coords="663,24,929,28,929,33,662,29"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="1176,37,1439,77"/>
<area shape="poly" title=" " alt="" coords="1128,38,1162,41,1162,46,1128,43"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="712,121,895,146"/>
<area shape="poly" title=" " alt="" coords="619,169,727,146,728,151,620,174"/>
<area shape="poly" title=" " alt="" coords="833,118,991,48,994,53,835,123"/>
<area shape="rect" href="resource__id_8hpp.html#afd66b2606db93ecfaf8b3972a9b953ad" title="获取资源类型的字符串表示（用于调试）" alt="" coords="469,233,643,258"/>
<area shape="poly" title=" " alt="" coords="400,258,455,253,455,258,400,264"/>
<area shape="rect" href="structResourceId.html#adc2ead50d28fd71ff0c0d9b2529af45c" title="获取资源类型" alt="" coords="479,282,633,307"/>
<area shape="poly" title=" " alt="" coords="400,277,465,283,465,289,400,283"/>
<area shape="poly" title=" " alt="" coords="330,105,447,55,469,47,471,52,449,60,332,110"/>
<area shape="poly" title=" " alt="" coords="355,130,492,165,491,170,353,135"/>
<area shape="poly" title=" " alt="" coords="390,120,698,128,698,133,390,125"/>
<area shape="rect" href="arch_8cpp.html#ad982abdb7f3d8729656c6b5422b2e61d" title=" " alt="" coords="514,70,598,95"/>
<area shape="poly" title=" " alt="" coords="389,105,500,88,501,93,390,110"/>
<area shape="poly" title=" " alt="" coords="598,79,1162,60,1163,65,598,84"/>
<area shape="poly" title=" " alt="" coords="599,89,728,115,727,120,598,94"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a71763ebababa9aa90bad6a07c66edede_icgraph.png" border="0" usemap="#aclassTaskManager_a71763ebababa9aa90bad6a07c66edede_icgraph" alt=""/></div>
<map name="aclassTaskManager_a71763ebababa9aa90bad6a07c66edede_icgraph" id="aclassTaskManager_a71763ebababa9aa90bad6a07c66edede_icgraph">
<area shape="rect" title="阻塞当前任务" alt="" coords="199,5,351,31"/>
<area shape="rect" href="classTaskManager.html#aadc206ac53400212078270833533f247" title="等待子进程退出" alt="" coords="5,5,151,31"/>
<area shape="poly" title=" " alt="" coords="185,21,151,21,151,15,185,15"/>
</map>
</div>

</div>
</div>
<a id="a101df6fadedb6dd4f93ee1a1e24550c2" name="a101df6fadedb6dd4f93ee1a1e24550c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a101df6fadedb6dd4f93ee1a1e24550c2">&#9670;&#160;</a></span>Clone()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected</a>&lt; <a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> &gt; TaskManager::Clone </td>
          <td>(</td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>user_stack</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>parent_tid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>child_tid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>tls</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structcpu__io_1_1TrapContext.html">cpu_io::TrapContext</a> &amp;&#160;</td>
          <td class="paramname"><em>parent_context</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>克隆当前任务 (fork/clone 系统调用) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">flags</td><td>克隆标志位<ul>
<li>kCloneVm: 共享地址空间</li>
<li>kCloneThread: 共享线程组</li>
<li>kCloneFiles: 共享文件描述符表</li>
<li>kCloneSighand: 共享信号处理器</li>
<li>0: 完全复制 (fork) </li>
</ul>
</td></tr>
    <tr><td class="paramname">user_stack</td><td>用户栈指针 (nullptr 表示复制父进程栈) </td></tr>
    <tr><td class="paramname">parent_tid</td><td>父进程 TID 存储地址 </td></tr>
    <tr><td class="paramname">child_tid</td><td>子进程 TID 存储地址 </td></tr>
    <tr><td class="paramname">tls</td><td>线程局部存储指针 </td></tr>
    <tr><td class="paramname">parent_context</td><td>父进程的 trap 上下文 (用于复制寄存器) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Expected&lt;Pid&gt; 父进程返回子进程 PID，子进程返回 0，失败返回错误</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright The SimpleKernel Contributors </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000019">Todo:</a></b></dt><dd>当前未实现文件系统，此标志暂时仅记录 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000020">Todo:</a></b></dt><dd>当前未实现信号机制，此标志暂时仅记录 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000021">Todo:</a></b></dt><dd>当前未实现文件系统，此标志暂时仅记录 </dd></dl>

<p class="definition">Definition at line <a class="el" href="clone_8cpp_source.html#l00014">14</a> of file <a class="el" href="clone_8cpp_source.html">clone.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   16</span>                                                                    {</div>
<div class="line"><span class="lineno">   17</span>  <span class="keyword">auto</span>* parent = <a class="code hl_function" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0">GetCurrentTask</a>();</div>
<div class="line"><span class="lineno">   18</span>  <span class="keywordflow">if</span> (!parent) {</div>
<div class="line"><span class="lineno">   19</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;Clone: No current task\n&quot;</span>);</div>
<div class="line"><span class="lineno">   20</span>    <span class="keywordflow">return</span> std::unexpected(<a class="code hl_struct" href="structError.html">Error</a>(<a class="code hl_enumvalue" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895fa8289607398b9e67b8e32d39836589a0f">ErrorCode::kTaskNoCurrentTask</a>));</div>
<div class="line"><span class="lineno">   21</span>  }</div>
<div class="line"><span class="lineno">   22</span> </div>
<div class="line"><span class="lineno">   23</span>  <span class="comment">// 验证克隆标志的合法性</span></div>
<div class="line"><span class="lineno">   24</span>  <span class="comment">// 如果设置了 kCloneThread，必须同时设置 kCloneVm, kCloneFiles, kCloneSighand</span></div>
<div class="line"><span class="lineno">   25</span>  <span class="keywordflow">if</span> ((<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aae66d5c84a141422ec33bc1d5a095f0c2">kCloneThread</a>) &amp;&amp;</div>
<div class="line"><span class="lineno">   26</span>      (!(<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa0ac877a691c7178aac585f9139553116">kCloneVm</a>) || !(<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aabd62342a60b500de9eab77f6e8a414b9">kCloneFiles</a>) ||</div>
<div class="line"><span class="lineno">   27</span>       !(<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa137ff90667f2e45b11ca9872bedae4f1">kCloneSighand</a>))) {</div>
<div class="line"><span class="lineno">   28</span>    <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(</div>
<div class="line"><span class="lineno">   29</span>        <span class="stringliteral">&quot;Clone: kCloneThread requires kCloneVm, kCloneFiles, kCloneSighand\n&quot;</span>);</div>
<div class="line"><span class="lineno">   30</span>    <span class="comment">// 自动补全必需的标志</span></div>
<div class="line"><span class="lineno">   31</span>    <a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> |= (<a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa0ac877a691c7178aac585f9139553116">kCloneVm</a> | <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aabd62342a60b500de9eab77f6e8a414b9">kCloneFiles</a> | <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa137ff90667f2e45b11ca9872bedae4f1">kCloneSighand</a>);</div>
<div class="line"><span class="lineno">   32</span>  }</div>
<div class="line"><span class="lineno">   33</span> </div>
<div class="line"><span class="lineno">   34</span>  <span class="comment">// 分配新的 PID</span></div>
<div class="line"><span class="lineno">   35</span>  <a class="code hl_typedef" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> new_pid = <a class="code hl_function" href="classTaskManager.html#a69688c59dbd65567df780d024e6faa7c">AllocatePid</a>();</div>
<div class="line"><span class="lineno">   36</span>  <span class="keywordflow">if</span> (new_pid == 0) {</div>
<div class="line"><span class="lineno">   37</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;Clone: Failed to allocate PID\n&quot;</span>);</div>
<div class="line"><span class="lineno">   38</span>    <span class="keywordflow">return</span> std::unexpected(<a class="code hl_struct" href="structError.html">Error</a>(<a class="code hl_enumvalue" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895fae774e683556860daced2efcf38ac9074">ErrorCode::kTaskPidAllocationFailed</a>));</div>
<div class="line"><span class="lineno">   39</span>  }</div>
<div class="line"><span class="lineno">   40</span> </div>
<div class="line"><span class="lineno">   41</span>  <span class="comment">// 创建子任务控制块</span></div>
<div class="line"><span class="lineno">   42</span>  <span class="keyword">auto</span>* child = <span class="keyword">new</span> <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>();</div>
<div class="line"><span class="lineno">   43</span>  <span class="keywordflow">if</span> (!child) {</div>
<div class="line"><span class="lineno">   44</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;Clone: Failed to allocate child task\n&quot;</span>);</div>
<div class="line"><span class="lineno">   45</span>    <span class="keywordflow">return</span> std::unexpected(<a class="code hl_struct" href="structError.html">Error</a>(<a class="code hl_enumvalue" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895faabbb7417b1f40d1dc1f5699f2154bcf6">ErrorCode::kTaskAllocationFailed</a>));</div>
<div class="line"><span class="lineno">   46</span>  }</div>
<div class="line"><span class="lineno">   47</span> </div>
<div class="line"><span class="lineno">   48</span>  <span class="comment">// 基本字段设置</span></div>
<div class="line"><span class="lineno">   49</span>  child-&gt;pid = new_pid;</div>
<div class="line"><span class="lineno">   50</span>  child-&gt;name = parent-&gt;name;</div>
<div class="line"><span class="lineno">   51</span>  child-&gt;status = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a7f1984e27dfac1310a3ac5c981abf863">TaskStatus::kReady</a>;</div>
<div class="line"><span class="lineno">   52</span>  child-&gt;policy = parent-&gt;policy;</div>
<div class="line"><span class="lineno">   53</span>  child-&gt;sched_info = parent-&gt;sched_info;</div>
<div class="line"><span class="lineno">   54</span> </div>
<div class="line"><span class="lineno">   55</span>  <span class="comment">// 设置父进程 ID</span></div>
<div class="line"><span class="lineno">   56</span>  <span class="keywordflow">if</span> (<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aac643601978e8b48da2ffa0a6263a40cc">kCloneParent</a>) {</div>
<div class="line"><span class="lineno">   57</span>    <span class="comment">// 保持与父进程相同的父进程</span></div>
<div class="line"><span class="lineno">   58</span>    child-&gt;parent_pid = parent-&gt;parent_pid;</div>
<div class="line"><span class="lineno">   59</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">   60</span>    child-&gt;parent_pid = parent-&gt;pid;</div>
<div class="line"><span class="lineno">   61</span>  }</div>
<div class="line"><span class="lineno">   62</span> </div>
<div class="line"><span class="lineno">   63</span>  <span class="comment">// 处理线程组 ID (TGID)</span></div>
<div class="line"><span class="lineno">   64</span>  <span class="keywordflow">if</span> (<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aae66d5c84a141422ec33bc1d5a095f0c2">kCloneThread</a>) {</div>
<div class="line"><span class="lineno">   65</span>    <span class="comment">// 创建线程: 共享线程组</span></div>
<div class="line"><span class="lineno">   66</span>    child-&gt;tgid = parent-&gt;tgid;</div>
<div class="line"><span class="lineno">   67</span>    child-&gt;pgid = parent-&gt;pgid;</div>
<div class="line"><span class="lineno">   68</span>    child-&gt;sid = parent-&gt;sid;</div>
<div class="line"><span class="lineno">   69</span> </div>
<div class="line"><span class="lineno">   70</span>    <span class="comment">// 将子线程加入父线程的线程组</span></div>
<div class="line"><span class="lineno">   71</span>    <span class="keywordflow">if</span> (parent-&gt;IsThreadGroupLeader()) {</div>
<div class="line"><span class="lineno">   72</span>      child-&gt;JoinThreadGroup(parent);</div>
<div class="line"><span class="lineno">   73</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">   74</span>      <span class="comment">// 找到线程组的主线程</span></div>
<div class="line"><span class="lineno">   75</span>      <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* leader = <a class="code hl_function" href="classTaskManager.html#a68d6b636f85f72416de99952e61a1508">FindTask</a>(parent-&gt;tgid);</div>
<div class="line"><span class="lineno">   76</span>      <span class="keywordflow">if</span> (leader) {</div>
<div class="line"><span class="lineno">   77</span>        child-&gt;JoinThreadGroup(leader);</div>
<div class="line"><span class="lineno">   78</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">   79</span>        <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;Clone: Thread group leader not found for tgid=%zu\n&quot;</span>,</div>
<div class="line"><span class="lineno">   80</span>                   parent-&gt;tgid);</div>
<div class="line"><span class="lineno">   81</span>        child-&gt;tgid = parent-&gt;tgid;</div>
<div class="line"><span class="lineno">   82</span>      }</div>
<div class="line"><span class="lineno">   83</span>    }</div>
<div class="line"><span class="lineno">   84</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">   85</span>    <span class="comment">// 创建进程: 新的线程组</span></div>
<div class="line"><span class="lineno">   86</span>    <span class="comment">// 新进程的 tgid 是自己的 pid</span></div>
<div class="line"><span class="lineno">   87</span>    child-&gt;tgid = new_pid;</div>
<div class="line"><span class="lineno">   88</span>    child-&gt;pgid = parent-&gt;pgid;</div>
<div class="line"><span class="lineno">   89</span>    child-&gt;sid = parent-&gt;sid;</div>
<div class="line"><span class="lineno">   90</span>  }</div>
<div class="line"><span class="lineno">   91</span> </div>
<div class="line"><span class="lineno">   92</span>  <span class="comment">// 克隆标志位</span></div>
<div class="line"><span class="lineno">   93</span>  child-&gt;clone_flags = <span class="keyword">static_cast&lt;</span><a class="code hl_enumeration" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6a">CloneFlags</a><span class="keyword">&gt;</span>(<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><span class="lineno">   94</span> </div>
<div class="line"><span class="lineno">   95</span>  <span class="comment">// 处理文件描述符表 (kCloneFiles)</span></div>
<div class="line"><span class="lineno">   97</span>  <span class="keywordflow">if</span> (<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aabd62342a60b500de9eab77f6e8a414b9">kCloneFiles</a>) {</div>
<div class="line"><span class="lineno">   98</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Clone: sharing file descriptor table (not implemented)\n&quot;</span>);</div>
<div class="line"><span class="lineno">   99</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  100</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Clone: copying file descriptor table (not implemented)\n&quot;</span>);</div>
<div class="line"><span class="lineno">  101</span>  }</div>
<div class="line"><span class="lineno">  102</span> </div>
<div class="line"><span class="lineno">  103</span>  <span class="comment">// 处理信号处理器 (kCloneSighand)</span></div>
<div class="line"><span class="lineno">  105</span>  <span class="keywordflow">if</span> (<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa137ff90667f2e45b11ca9872bedae4f1">kCloneSighand</a>) {</div>
<div class="line"><span class="lineno">  106</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Clone: sharing signal handlers (not implemented)\n&quot;</span>);</div>
<div class="line"><span class="lineno">  107</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  108</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Clone: copying signal handlers (not implemented)\n&quot;</span>);</div>
<div class="line"><span class="lineno">  109</span>  }</div>
<div class="line"><span class="lineno">  110</span> </div>
<div class="line"><span class="lineno">  111</span>  <span class="comment">// 处理文件系统信息 (kCloneFs)</span></div>
<div class="line"><span class="lineno">  113</span>  <span class="keywordflow">if</span> (<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa41409c871d0338db7c837734fa30421f">kCloneFs</a>) {</div>
<div class="line"><span class="lineno">  114</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Clone: sharing filesystem info (not implemented)\n&quot;</span>);</div>
<div class="line"><span class="lineno">  115</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  116</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Clone: copying filesystem info (not implemented)\n&quot;</span>);</div>
<div class="line"><span class="lineno">  117</span>  }</div>
<div class="line"><span class="lineno">  118</span> </div>
<div class="line"><span class="lineno">  119</span>  <span class="comment">// 处理地址空间</span></div>
<div class="line"><span class="lineno">  120</span>  <span class="keywordflow">if</span> (<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa0ac877a691c7178aac585f9139553116">kCloneVm</a>) {</div>
<div class="line"><span class="lineno">  121</span>    <span class="comment">// 共享地址空间（线程）</span></div>
<div class="line"><span class="lineno">  122</span>    child-&gt;page_table = parent-&gt;page_table;</div>
<div class="line"><span class="lineno">  123</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Clone: sharing page table %p\n&quot;</span>, child-&gt;page_table);</div>
<div class="line"><span class="lineno">  124</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  125</span>    <span class="comment">// 复制地址空间（进程）</span></div>
<div class="line"><span class="lineno">  126</span>    <span class="keywordflow">if</span> (parent-&gt;page_table) {</div>
<div class="line"><span class="lineno">  127</span>      <span class="comment">// copy_mappings=true 表示复制用户空间映射</span></div>
<div class="line"><span class="lineno">  128</span>      <span class="keyword">auto</span> result = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;VirtualMemory&gt;::GetInstance</a>().ClonePageDirectory(</div>
<div class="line"><span class="lineno">  129</span>          parent-&gt;page_table, <span class="keyword">true</span>);</div>
<div class="line"><span class="lineno">  130</span>      <span class="keywordflow">if</span> (!result.has_value()) {</div>
<div class="line"><span class="lineno">  131</span>        <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;Clone: Failed to clone page table: %s\n&quot;</span>,</div>
<div class="line"><span class="lineno">  132</span>                  result.error().message());</div>
<div class="line"><span class="lineno">  133</span>        <span class="keyword">delete</span> child;</div>
<div class="line"><span class="lineno">  134</span>        <span class="keywordflow">return</span> std::unexpected(<a class="code hl_struct" href="structError.html">Error</a>(<a class="code hl_enumvalue" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895fa204c13063865e4bf4b0666e41c04fe39">ErrorCode::kTaskPageTableCloneFailed</a>));</div>
<div class="line"><span class="lineno">  135</span>      }</div>
<div class="line"><span class="lineno">  136</span>      child-&gt;page_table = <span class="keyword">reinterpret_cast&lt;</span>uint64_t*<span class="keyword">&gt;</span>(result.value());</div>
<div class="line"><span class="lineno">  137</span>      <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Clone: cloned page table from %p to %p\n&quot;</span>,</div>
<div class="line"><span class="lineno">  138</span>                  parent-&gt;page_table, child-&gt;page_table);</div>
<div class="line"><span class="lineno">  139</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  140</span>      <span class="comment">// 父进程没有页表（内核线程），子进程也不需要</span></div>
<div class="line"><span class="lineno">  141</span>      child-&gt;page_table = <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">  142</span>    }</div>
<div class="line"><span class="lineno">  143</span>  }</div>
<div class="line"><span class="lineno">  144</span> </div>
<div class="line"><span class="lineno">  145</span>  <span class="comment">// 分配内核栈</span></div>
<div class="line"><span class="lineno">  146</span>  child-&gt;kernel_stack = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(</div>
<div class="line"><span class="lineno">  147</span>      <a class="code hl_function" href="sk__stdlib_8h.html#a8006724372b77924155bd8618fe57516">aligned_alloc</a>(<a class="code hl_variable" href="namespacecpu__io_1_1virtual__memory.html#a24fb424f54d414703cda572dc076d71a">cpu_io::virtual_memory::kPageSize</a>,</div>
<div class="line"><span class="lineno">  148</span>                    <a class="code hl_variable" href="structTaskControlBlock.html#a63b2165100c2ed6dcac074c61eebfdd9">TaskControlBlock::kDefaultKernelStackSize</a>));</div>
<div class="line"><span class="lineno">  149</span>  <span class="keywordflow">if</span> (!child-&gt;kernel_stack) {</div>
<div class="line"><span class="lineno">  150</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;Clone: Failed to allocate kernel stack\n&quot;</span>);</div>
<div class="line"><span class="lineno">  151</span>    <span class="comment">// 清理已分配的资源</span></div>
<div class="line"><span class="lineno">  152</span>    <span class="keywordflow">if</span> (child-&gt;page_table &amp;&amp; !(<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa0ac877a691c7178aac585f9139553116">kCloneVm</a>)) {</div>
<div class="line"><span class="lineno">  153</span>      <span class="comment">// 如果是独立的页表，需要释放</span></div>
<div class="line"><span class="lineno">  154</span>      <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;VirtualMemory&gt;::GetInstance</a>().DestroyPageDirectory(</div>
<div class="line"><span class="lineno">  155</span>          child-&gt;page_table, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  156</span>    }</div>
<div class="line"><span class="lineno">  157</span>    <span class="keyword">delete</span> child;</div>
<div class="line"><span class="lineno">  158</span>    <span class="keywordflow">return</span> std::unexpected(<a class="code hl_struct" href="structError.html">Error</a>(<a class="code hl_enumvalue" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895faf26b7603aac2c3614065124e03b12b07">ErrorCode::kTaskKernelStackAllocationFailed</a>));</div>
<div class="line"><span class="lineno">  159</span>  }</div>
<div class="line"><span class="lineno">  160</span> </div>
<div class="line"><span class="lineno">  161</span>  <span class="comment">// 初始化内核栈内容</span></div>
<div class="line"><span class="lineno">  162</span>  <a class="code hl_define" href="sk__string__test_8cpp.html#aac7987d1560131b4de61d23504cb3a0c">memset</a>(child-&gt;kernel_stack, 0, <a class="code hl_variable" href="structTaskControlBlock.html#a63b2165100c2ed6dcac074c61eebfdd9">TaskControlBlock::kDefaultKernelStackSize</a>);</div>
<div class="line"><span class="lineno">  163</span> </div>
<div class="line"><span class="lineno">  164</span>  <span class="comment">// 复制 trap context</span></div>
<div class="line"><span class="lineno">  165</span>  child-&gt;trap_context_ptr = <span class="keyword">reinterpret_cast&lt;</span><a class="code hl_struct" href="structcpu__io_1_1TrapContext.html">cpu_io::TrapContext</a>*<span class="keyword">&gt;</span>(</div>
<div class="line"><span class="lineno">  166</span>      child-&gt;kernel_stack + <a class="code hl_variable" href="structTaskControlBlock.html#a63b2165100c2ed6dcac074c61eebfdd9">TaskControlBlock::kDefaultKernelStackSize</a> -</div>
<div class="line"><span class="lineno">  167</span>      <span class="keyword">sizeof</span>(<a class="code hl_struct" href="structcpu__io_1_1TrapContext.html">cpu_io::TrapContext</a>));</div>
<div class="line"><span class="lineno">  168</span>  <a class="code hl_define" href="sk__string__test_8cpp.html#a30c75e139b07107ef1c8d3f8490aee7d">memcpy</a>(child-&gt;trap_context_ptr, &amp;parent_context, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="structcpu__io_1_1TrapContext.html">cpu_io::TrapContext</a>));</div>
<div class="line"><span class="lineno">  169</span> </div>
<div class="line"><span class="lineno">  170</span>  <span class="comment">// 设置用户栈</span></div>
<div class="line"><span class="lineno">  171</span>  <span class="keywordflow">if</span> (user_stack) {</div>
<div class="line"><span class="lineno">  172</span>    child-&gt;trap_context_ptr-&gt;UserStackPointer() =</div>
<div class="line"><span class="lineno">  173</span>        <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(user_stack);</div>
<div class="line"><span class="lineno">  174</span>  }</div>
<div class="line"><span class="lineno">  175</span> </div>
<div class="line"><span class="lineno">  176</span>  <span class="comment">// 设置 TLS (Thread Local Storage)</span></div>
<div class="line"><span class="lineno">  177</span>  <span class="keywordflow">if</span> (tls) {</div>
<div class="line"><span class="lineno">  178</span>    child-&gt;trap_context_ptr-&gt;ThreadPointer() = <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(tls);</div>
<div class="line"><span class="lineno">  179</span>  }</div>
<div class="line"><span class="lineno">  180</span> </div>
<div class="line"><span class="lineno">  181</span>  <span class="comment">// 父进程返回子进程 PID</span></div>
<div class="line"><span class="lineno">  182</span>  parent_context.<a class="code hl_function" href="structcpu__io_1_1TrapContext.html#a18be9aebb331edf000d87ab406ac6f75">ReturnValue</a>() = new_pid;</div>
<div class="line"><span class="lineno">  183</span>  <span class="comment">// 子进程返回 0</span></div>
<div class="line"><span class="lineno">  184</span>  child-&gt;trap_context_ptr-&gt;ReturnValue() = 0;</div>
<div class="line"><span class="lineno">  185</span> </div>
<div class="line"><span class="lineno">  186</span>  <span class="comment">// 写入 TID</span></div>
<div class="line"><span class="lineno">  187</span>  <span class="keywordflow">if</span> (parent_tid) {</div>
<div class="line"><span class="lineno">  188</span>    *parent_tid = new_pid;</div>
<div class="line"><span class="lineno">  189</span>  }</div>
<div class="line"><span class="lineno">  190</span>  <span class="keywordflow">if</span> (child_tid) {</div>
<div class="line"><span class="lineno">  191</span>    *child_tid = new_pid;</div>
<div class="line"><span class="lineno">  192</span>  }</div>
<div class="line"><span class="lineno">  193</span> </div>
<div class="line"><span class="lineno">  194</span>  <span class="comment">// 将子任务加入任务表</span></div>
<div class="line"><span class="lineno">  195</span>  {</div>
<div class="line"><span class="lineno">  196</span>    <a class="code hl_class" href="classLockGuard.html">LockGuard</a> lock_guard(<a class="code hl_variable" href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">task_table_lock_</a>);</div>
<div class="line"><span class="lineno">  197</span>    <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(<a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>.find(new_pid) == <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>.end(),</div>
<div class="line"><span class="lineno">  198</span>                  <span class="stringliteral">&quot;Clone: new_pid must not exist in task_table&quot;</span>);</div>
<div class="line"><span class="lineno">  199</span>    <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>[new_pid] = child;</div>
<div class="line"><span class="lineno">  200</span>  }</div>
<div class="line"><span class="lineno">  201</span> </div>
<div class="line"><span class="lineno">  202</span>  <span class="comment">// 将子任务添加到调度器</span></div>
<div class="line"><span class="lineno">  203</span>  <a class="code hl_function" href="classTaskManager.html#ae97ee6101a6462300666058cc4bedd05">AddTask</a>(child);</div>
<div class="line"><span class="lineno">  204</span> </div>
<div class="line"><span class="lineno">  205</span>  <span class="comment">// 打印详细的 clone 信息</span></div>
<div class="line"><span class="lineno">  206</span>  <span class="keyword">const</span> <span class="keywordtype">char</span>* clone_type = (<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aae66d5c84a141422ec33bc1d5a095f0c2">kCloneThread</a>) ? <span class="stringliteral">&quot;thread&quot;</span> : <span class="stringliteral">&quot;process&quot;</span>;</div>
<div class="line"><span class="lineno">  207</span>  <span class="keyword">const</span> <span class="keywordtype">char</span>* vm_type = (<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp; <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa0ac877a691c7178aac585f9139553116">kCloneVm</a>) ? <span class="stringliteral">&quot;shared&quot;</span> : <span class="stringliteral">&quot;copied&quot;</span>;</div>
<div class="line"><span class="lineno">  208</span>  <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(</div>
<div class="line"><span class="lineno">  209</span>      <span class="stringliteral">&quot;Clone: created %s - parent=%zu, child=%zu, tgid=%zu, vm=%s, &quot;</span></div>
<div class="line"><span class="lineno">  210</span>      <span class="stringliteral">&quot;flags=0x%lx\n&quot;</span>,</div>
<div class="line"><span class="lineno">  211</span>      clone_type, parent-&gt;pid, new_pid, child-&gt;tgid, vm_type, <a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><span class="lineno">  212</span> </div>
<div class="line"><span class="lineno">  213</span>  <span class="keywordflow">return</span> new_pid;</div>
<div class="line"><span class="lineno">  214</span>}</div>
<div class="ttc" id="aacpi_8h_html_a773b39d480759f67926cb18ae2219281"><div class="ttname"><a href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a></div><div class="ttdeci">uint32_t flags</div><div class="ttdef"><b>Definition</b> <a href="acpi_8h_source.html#l00038">acpi.h:38</a></div></div>
<div class="ttc" id="aclassSingleton_html_a68856b49e098eadba37b60366db33ebd"><div class="ttname"><a href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton::GetInstance</a></div><div class="ttdeci">static auto GetInstance() -&gt; T &amp;</div><div class="ttdef"><b>Definition</b> <a href="singleton_8hpp_source.html#l00023">singleton.hpp:23</a></div></div>
<div class="ttc" id="aclassTaskManager_html_a68d6b636f85f72416de99952e61a1508"><div class="ttname"><a href="classTaskManager.html#a68d6b636f85f72416de99952e61a1508">TaskManager::FindTask</a></div><div class="ttdeci">TaskControlBlock * FindTask(Pid pid)</div><div class="ttdoc">按 PID 查找任务</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8cpp_source.html#l00133">task_manager.cpp:133</a></div></div>
<div class="ttc" id="aclassTaskManager_html_ae97ee6101a6462300666058cc4bedd05"><div class="ttname"><a href="classTaskManager.html#ae97ee6101a6462300666058cc4bedd05">TaskManager::AddTask</a></div><div class="ttdeci">void AddTask(TaskControlBlock *task)</div><div class="ttdoc">添加任务</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8cpp_source.html#l00067">task_manager.cpp:67</a></div></div>
<div class="ttc" id="aexpected_8hpp_html_a4d45a9675d1bf454764383179f3c895fa204c13063865e4bf4b0666e41c04fe39"><div class="ttname"><a href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895fa204c13063865e4bf4b0666e41c04fe39">ErrorCode::kTaskPageTableCloneFailed</a></div><div class="ttdeci">@ kTaskPageTableCloneFailed</div></div>
<div class="ttc" id="aexpected_8hpp_html_a4d45a9675d1bf454764383179f3c895fa8289607398b9e67b8e32d39836589a0f"><div class="ttname"><a href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895fa8289607398b9e67b8e32d39836589a0f">ErrorCode::kTaskNoCurrentTask</a></div><div class="ttdeci">@ kTaskNoCurrentTask</div></div>
<div class="ttc" id="aexpected_8hpp_html_a4d45a9675d1bf454764383179f3c895faabbb7417b1f40d1dc1f5699f2154bcf6"><div class="ttname"><a href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895faabbb7417b1f40d1dc1f5699f2154bcf6">ErrorCode::kTaskAllocationFailed</a></div><div class="ttdeci">@ kTaskAllocationFailed</div></div>
<div class="ttc" id="aexpected_8hpp_html_a4d45a9675d1bf454764383179f3c895fae774e683556860daced2efcf38ac9074"><div class="ttname"><a href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895fae774e683556860daced2efcf38ac9074">ErrorCode::kTaskPidAllocationFailed</a></div><div class="ttdeci">@ kTaskPidAllocationFailed</div></div>
<div class="ttc" id="aexpected_8hpp_html_a4d45a9675d1bf454764383179f3c895faf26b7603aac2c3614065124e03b12b07"><div class="ttname"><a href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895faf26b7603aac2c3614065124e03b12b07">ErrorCode::kTaskKernelStackAllocationFailed</a></div><div class="ttdeci">@ kTaskKernelStackAllocationFailed</div></div>
<div class="ttc" id="anamespacecpu__io_1_1virtual__memory_html_a24fb424f54d414703cda572dc076d71a"><div class="ttname"><a href="namespacecpu__io_1_1virtual__memory.html#a24fb424f54d414703cda572dc076d71a">cpu_io::virtual_memory::kPageSize</a></div><div class="ttdeci">static constexpr size_t kPageSize</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00058">cpu_io.h:58</a></div></div>
<div class="ttc" id="ask__stdlib_8h_html_a8006724372b77924155bd8618fe57516"><div class="ttname"><a href="sk__stdlib_8h.html#a8006724372b77924155bd8618fe57516">aligned_alloc</a></div><div class="ttdeci">void * aligned_alloc(size_t alignment, size_t size)</div><div class="ttdef"><b>Definition</b> <a href="memory_8cpp_source.html#l00062">memory.cpp:62</a></div></div>
<div class="ttc" id="ask__string__test_8cpp_html_a30c75e139b07107ef1c8d3f8490aee7d"><div class="ttname"><a href="sk__string__test_8cpp.html#a30c75e139b07107ef1c8d3f8490aee7d">memcpy</a></div><div class="ttdeci">#define memcpy</div><div class="ttdef"><b>Definition</b> <a href="sk__string__test_8cpp_source.html#l00008">sk_string_test.cpp:8</a></div></div>
<div class="ttc" id="ask__string__test_8cpp_html_aac7987d1560131b4de61d23504cb3a0c"><div class="ttname"><a href="sk__string__test_8cpp.html#aac7987d1560131b4de61d23504cb3a0c">memset</a></div><div class="ttdeci">#define memset</div><div class="ttdef"><b>Definition</b> <a href="sk__string__test_8cpp_source.html#l00010">sk_string_test.cpp:10</a></div></div>
<div class="ttc" id="astructError_html"><div class="ttname"><a href="structError.html">Error</a></div><div class="ttdef"><b>Definition</b> <a href="expected_8hpp_source.html#l00150">expected.hpp:150</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_a63b2165100c2ed6dcac074c61eebfdd9"><div class="ttname"><a href="structTaskControlBlock.html#a63b2165100c2ed6dcac074c61eebfdd9">TaskControlBlock::kDefaultKernelStackSize</a></div><div class="ttdeci">static constexpr const size_t kDefaultKernelStackSize</div><div class="ttdoc">默认内核栈大小 (16 KB)</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00082">task_control_block.hpp:82</a></div></div>
<div class="ttc" id="astructcpu__io_1_1TrapContext_html"><div class="ttname"><a href="structcpu__io_1_1TrapContext.html">cpu_io::TrapContext</a></div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00181">cpu_io.h:181</a></div></div>
<div class="ttc" id="astructcpu__io_1_1TrapContext_html_a18be9aebb331edf000d87ab406ac6f75"><div class="ttname"><a href="structcpu__io_1_1TrapContext.html#a18be9aebb331edf000d87ab406ac6f75">cpu_io::TrapContext::ReturnValue</a></div><div class="ttdeci">__always_inline uint64_t &amp; ReturnValue()</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00191">cpu_io.h:191</a></div></div>
<div class="ttc" id="astructklog_1_1Err_html"><div class="ttname"><a href="structklog_1_1Err.html">klog::Err</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00188">kernel_log.hpp:188</a></div></div>
<div class="ttc" id="astructklog_1_1Warn_html"><div class="ttname"><a href="structklog_1_1Warn.html">klog::Warn</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00178">kernel_log.hpp:178</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a621e1ac4b663435d18b9ec55284dda6a"><div class="ttname"><a href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6a">CloneFlags</a></div><div class="ttdeci">CloneFlags</div><div class="ttdoc">Clone 标志位 (用于 sys_clone 系统调用)</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00026">task_control_block.hpp:26</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a621e1ac4b663435d18b9ec55284dda6aa0ac877a691c7178aac585f9139553116"><div class="ttname"><a href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa0ac877a691c7178aac585f9139553116">kCloneVm</a></div><div class="ttdeci">@ kCloneVm</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00030">task_control_block.hpp:30</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a621e1ac4b663435d18b9ec55284dda6aa137ff90667f2e45b11ca9872bedae4f1"><div class="ttname"><a href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa137ff90667f2e45b11ca9872bedae4f1">kCloneSighand</a></div><div class="ttdeci">@ kCloneSighand</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00036">task_control_block.hpp:36</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a621e1ac4b663435d18b9ec55284dda6aa41409c871d0338db7c837734fa30421f"><div class="ttname"><a href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aa41409c871d0338db7c837734fa30421f">kCloneFs</a></div><div class="ttdeci">@ kCloneFs</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00032">task_control_block.hpp:32</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a621e1ac4b663435d18b9ec55284dda6aabd62342a60b500de9eab77f6e8a414b9"><div class="ttname"><a href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aabd62342a60b500de9eab77f6e8a414b9">kCloneFiles</a></div><div class="ttdeci">@ kCloneFiles</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00034">task_control_block.hpp:34</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a621e1ac4b663435d18b9ec55284dda6aac643601978e8b48da2ffa0a6263a40cc"><div class="ttname"><a href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aac643601978e8b48da2ffa0a6263a40cc">kCloneParent</a></div><div class="ttdeci">@ kCloneParent</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00038">task_control_block.hpp:38</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a621e1ac4b663435d18b9ec55284dda6aae66d5c84a141422ec33bc1d5a095f0c2"><div class="ttname"><a href="task__control__block_8hpp.html#a621e1ac4b663435d18b9ec55284dda6aae66d5c84a141422ec33bc1d5a095f0c2">kCloneThread</a></div><div class="ttdeci">@ kCloneThread</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00040">task_control_block.hpp:40</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a7b3497faea769e764efc8647bc2103f1"><div class="ttname"><a href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a></div><div class="ttdeci">size_t Pid</div><div class="ttdoc">进程 ID 类型</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00017">task_control_block.hpp:17</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a101df6fadedb6dd4f93ee1a1e24550c2_cgraph.png" border="0" usemap="#aclassTaskManager_a101df6fadedb6dd4f93ee1a1e24550c2_cgraph" alt=""/></div>
<map name="aclassTaskManager_a101df6fadedb6dd4f93ee1a1e24550c2_cgraph" id="aclassTaskManager_a101df6fadedb6dd4f93ee1a1e24550c2_cgraph">
<area shape="rect" title="克隆当前任务 (fork/clone 系统调用)" alt="" coords="5,155,159,180"/>
<area shape="rect" href="classTaskManager.html#ae97ee6101a6462300666058cc4bedd05" title="添加任务" alt="" coords="229,56,400,81"/>
<area shape="poly" title=" " alt="" coords="99,152,146,121,206,90,228,83,230,88,208,95,148,126,102,157"/>
<area shape="rect" href="classTaskManager.html#a69688c59dbd65567df780d024e6faa7c" title="分配新的 PID" alt="" coords="471,5,660,31"/>
<area shape="poly" title=" " alt="" coords="89,153,133,97,166,66,206,41,268,19,333,8,398,3,457,4,457,9,398,8,334,13,269,25,208,46,170,70,137,100,93,156"/>
<area shape="rect" href="memory_8cpp.html#a8006724372b77924155bd8618fe57516" title=" " alt="" coords="261,105,369,131"/>
<area shape="poly" title=" " alt="" coords="142,152,247,130,248,135,143,157"/>
<area shape="rect" href="classTaskManager.html#a68d6b636f85f72416de99952e61a1508" title="按 PID 查找任务" alt="" coords="229,155,401,180"/>
<area shape="poly" title=" " alt="" coords="159,165,215,165,215,170,159,170"/>
<area shape="rect" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0" title="获取当前任务" alt="" coords="207,204,423,229"/>
<area shape="poly" title=" " alt="" coords="143,178,241,199,240,204,142,183"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="230,253,399,279"/>
<area shape="poly" title=" " alt="" coords="102,178,148,209,208,240,230,247,228,252,206,245,146,214,99,182"/>
<area shape="rect" href="structcpu__io_1_1TrapContext.html#a18be9aebb331edf000d87ab406ac6f75" title=" " alt="" coords="239,303,390,343"/>
<area shape="poly" title=" " alt="" coords="95,179,140,232,172,263,208,289,228,299,225,304,205,294,168,267,136,236,91,182"/>
<area shape="poly" title=" " alt="" coords="378,53,488,31,489,36,379,59"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="474,107,657,132"/>
<area shape="poly" title=" " alt="" coords="379,79,489,101,488,107,378,84"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="708,81,893,107"/>
<area shape="poly" title=" " alt="" coords="400,71,694,86,694,91,400,76"/>
<area shape="poly" title=" " alt="" coords="657,107,694,103,695,108,658,112"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="941,74,1204,114"/>
<area shape="poly" title=" " alt="" coords="894,91,927,91,927,97,894,97"/>
<area shape="poly" title=" " alt="" coords="384,201,422,190,480,164,531,137,533,141,483,169,424,195,386,207"/>
</map>
</div>

</div>
</div>
<a id="ae3444c55ab7b6ec348a56b596229fc0f" name="ae3444c55ab7b6ec348a56b596229fc0f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae3444c55ab7b6ec348a56b596229fc0f">&#9670;&#160;</a></span>Exit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::Exit </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>exit_code</em> = <code>0</code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>退出当前线程 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">exit_code</td><td>退出码</td></tr>
  </table>
  </dd>
</dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright The SimpleKernel Contributors </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000022">Todo:</a></b></dt><dd>实现信号机制后，发送 SIGKILL 给线程组中的所有线程 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000023">Todo:</a></b></dt><dd>通知父进程 (发送 SIGCHLD) </dd></dl>

<p class="definition">Definition at line <a class="el" href="exit_8cpp_source.html#l00010">10</a> of file <a class="el" href="exit_8cpp_source.html">exit.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   10</span>                                    {</div>
<div class="line"><span class="lineno">   11</span>  <span class="keyword">auto</span>&amp; cpu_sched = <a class="code hl_function" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11">GetCurrentCpuSched</a>();</div>
<div class="line"><span class="lineno">   12</span>  <span class="keyword">auto</span>* current = <a class="code hl_function" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0">GetCurrentTask</a>();</div>
<div class="line"><span class="lineno">   13</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(current != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;Exit: No current task to exit&quot;</span>);</div>
<div class="line"><span class="lineno">   14</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(current-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f">TaskStatus::kRunning</a>,</div>
<div class="line"><span class="lineno">   15</span>                <span class="stringliteral">&quot;Exit: current task status must be kRunning&quot;</span>);</div>
<div class="line"><span class="lineno">   16</span> </div>
<div class="line"><span class="lineno">   17</span>  {</div>
<div class="line"><span class="lineno">   18</span>    <a class="code hl_class" href="classLockGuard.html">LockGuard&lt;SpinLock&gt;</a> lock_guard(cpu_sched.lock);</div>
<div class="line"><span class="lineno">   19</span> </div>
<div class="line"><span class="lineno">   20</span>    <span class="comment">// 设置退出码</span></div>
<div class="line"><span class="lineno">   21</span>    current-&gt;exit_code = exit_code;</div>
<div class="line"><span class="lineno">   22</span> </div>
<div class="line"><span class="lineno">   23</span>    <span class="comment">// 检查是否是线程组的主线程</span></div>
<div class="line"><span class="lineno">   24</span>    <span class="keywordtype">bool</span> is_group_leader = current-&gt;IsThreadGroupLeader();</div>
<div class="line"><span class="lineno">   25</span> </div>
<div class="line"><span class="lineno">   26</span>    <span class="comment">// 如果是线程组的主线程，需要检查是否还有其他线程</span></div>
<div class="line"><span class="lineno">   27</span>    <span class="keywordflow">if</span> (is_group_leader &amp;&amp; current-&gt;GetThreadGroupSize() &gt; 1) {</div>
<div class="line"><span class="lineno">   28</span>      <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(</div>
<div class="line"><span class="lineno">   29</span>          <span class="stringliteral">&quot;Exit: Thread group leader (pid=%zu, tgid=%zu) exiting, but &quot;</span></div>
<div class="line"><span class="lineno">   30</span>          <span class="stringliteral">&quot;group still has %zu threads\n&quot;</span>,</div>
<div class="line"><span class="lineno">   31</span>          current-&gt;pid, current-&gt;tgid, current-&gt;GetThreadGroupSize());</div>
<div class="line"><span class="lineno">   33</span>    }</div>
<div class="line"><span class="lineno">   34</span> </div>
<div class="line"><span class="lineno">   35</span>    <span class="comment">// 从线程组中移除</span></div>
<div class="line"><span class="lineno">   36</span>    current-&gt;LeaveThreadGroup();</div>
<div class="line"><span class="lineno">   37</span> </div>
<div class="line"><span class="lineno">   38</span>    <span class="comment">// 将子进程过继给 init 进程 (仅当是进程时)</span></div>
<div class="line"><span class="lineno">   39</span>    <span class="keywordflow">if</span> (is_group_leader) {</div>
<div class="line"><span class="lineno">   40</span>      <a class="code hl_function" href="classTaskManager.html#acfa70286ca9b8c538d1f75ba4d953ec8">ReparentChildren</a>(current);</div>
<div class="line"><span class="lineno">   41</span>    }</div>
<div class="line"><span class="lineno">   42</span> </div>
<div class="line"><span class="lineno">   43</span>    <span class="keywordflow">if</span> (current-&gt;parent_pid != 0) {</div>
<div class="line"><span class="lineno">   44</span>      <span class="comment">// 有父进程，进入僵尸状态等待回收</span></div>
<div class="line"><span class="lineno">   45</span>      current-&gt;status = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2ae5bcea9577cc11324251f070f1e12f7c">TaskStatus::kZombie</a>;</div>
<div class="line"><span class="lineno">   47</span> </div>
<div class="line"><span class="lineno">   48</span>      <span class="comment">// 唤醒等待此进程退出的父进程</span></div>
<div class="line"><span class="lineno">   49</span>      <span class="comment">// 父进程会阻塞在 ChildExit 类型的资源上，数据是父进程自己的 PID</span></div>
<div class="line"><span class="lineno">   50</span>      <span class="keyword">auto</span> wait_resource_id =</div>
<div class="line"><span class="lineno">   51</span>          <a class="code hl_struct" href="structResourceId.html">ResourceId</a>(<a class="code hl_enumvalue" href="resource__id_8hpp.html#aeea667e01168927f6d83af2e203019bca7860d40e5c60ade25095b42e09306cc8">ResourceType::kChildExit</a>, current-&gt;parent_pid);</div>
<div class="line"><span class="lineno">   52</span>      <a class="code hl_function" href="classTaskManager.html#aecc6edadfbd8fd250db72884b1e23f93">Wakeup</a>(wait_resource_id);</div>
<div class="line"><span class="lineno">   53</span> </div>
<div class="line"><span class="lineno">   54</span>      <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Exit: pid=%zu waking up parent=%zu on resource=%s\n&quot;</span>,</div>
<div class="line"><span class="lineno">   55</span>                  current-&gt;pid, current-&gt;parent_pid,</div>
<div class="line"><span class="lineno">   56</span>                  wait_resource_id.GetTypeName());</div>
<div class="line"><span class="lineno">   57</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">   58</span>      <span class="comment">// 没有父进程，直接退出并释放资源</span></div>
<div class="line"><span class="lineno">   59</span>      current-&gt;status = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a829e9a9be95f71d0db69307258a97722">TaskStatus::kExited</a>;</div>
<div class="line"><span class="lineno">   60</span>      <a class="code hl_function" href="classTaskManager.html#a63b9cd5ec9df1dc6878eff6cc355fccb">ReapTask</a>(current);</div>
<div class="line"><span class="lineno">   61</span>    }</div>
<div class="line"><span class="lineno">   62</span>  }</div>
<div class="line"><span class="lineno">   63</span> </div>
<div class="line"><span class="lineno">   64</span>  <a class="code hl_function" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78">Schedule</a>();</div>
<div class="line"><span class="lineno">   65</span> </div>
<div class="line"><span class="lineno">   66</span>  <span class="comment">// 退出后不应执行到这里</span></div>
<div class="line"><span class="lineno">   67</span>  <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;Exit: Task %zu should not return from Schedule()\n&quot;</span>, current-&gt;pid);</div>
<div class="line"><span class="lineno">   68</span> </div>
<div class="line"><span class="lineno">   69</span>  __builtin_unreachable();</div>
<div class="line"><span class="lineno">   70</span>}</div>
<div class="ttc" id="aclassTaskManager_html_a63b9cd5ec9df1dc6878eff6cc355fccb"><div class="ttname"><a href="classTaskManager.html#a63b9cd5ec9df1dc6878eff6cc355fccb">TaskManager::ReapTask</a></div><div class="ttdeci">void ReapTask(TaskControlBlock *task)</div><div class="ttdoc">回收僵尸进程资源</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8cpp_source.html#l00144">task_manager.cpp:144</a></div></div>
<div class="ttc" id="aclassTaskManager_html_acfa70286ca9b8c538d1f75ba4d953ec8"><div class="ttname"><a href="classTaskManager.html#acfa70286ca9b8c538d1f75ba4d953ec8">TaskManager::ReparentChildren</a></div><div class="ttdeci">void ReparentChildren(TaskControlBlock *parent)</div><div class="ttdoc">将孤儿进程过继给 init 进程</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8cpp_source.html#l00167">task_manager.cpp:167</a></div></div>
<div class="ttc" id="aclassTaskManager_html_aecc6edadfbd8fd250db72884b1e23f93"><div class="ttname"><a href="classTaskManager.html#aecc6edadfbd8fd250db72884b1e23f93">TaskManager::Wakeup</a></div><div class="ttdeci">void Wakeup(ResourceId resource_id)</div><div class="ttdoc">唤醒等待指定资源的所有任务</div><div class="ttdef"><b>Definition</b> <a href="wakeup_8cpp_source.html#l00010">wakeup.cpp:10</a></div></div>
<div class="ttc" id="aresource__id_8hpp_html_aeea667e01168927f6d83af2e203019bca7860d40e5c60ade25095b42e09306cc8"><div class="ttname"><a href="resource__id_8hpp.html#aeea667e01168927f6d83af2e203019bca7860d40e5c60ade25095b42e09306cc8">ResourceType::kChildExit</a></div><div class="ttdeci">@ kChildExit</div></div>
<div class="ttc" id="astructResourceId_html"><div class="ttname"><a href="structResourceId.html">ResourceId</a></div><div class="ttdoc">资源 ID</div><div class="ttdef"><b>Definition</b> <a href="resource__id_8hpp_source.html#l00075">resource_id.hpp:75</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a5d987b98f8f913fcd928b7ab94e726a2a829e9a9be95f71d0db69307258a97722"><div class="ttname"><a href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a829e9a9be95f71d0db69307258a97722">kExited</a></div><div class="ttdeci">@ kExited</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00058">task_control_block.hpp:58</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a5d987b98f8f913fcd928b7ab94e726a2ae5bcea9577cc11324251f070f1e12f7c"><div class="ttname"><a href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2ae5bcea9577cc11324251f070f1e12f7c">kZombie</a></div><div class="ttdeci">@ kZombie</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00060">task_control_block.hpp:60</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_ae3444c55ab7b6ec348a56b596229fc0f_cgraph.png" border="0" usemap="#aclassTaskManager_ae3444c55ab7b6ec348a56b596229fc0f_cgraph" alt=""/></div>
<map name="aclassTaskManager_ae3444c55ab7b6ec348a56b596229fc0f_cgraph" id="aclassTaskManager_ae3444c55ab7b6ec348a56b596229fc0f_cgraph">
<area shape="rect" title="退出当前线程" alt="" coords="5,189,147,215"/>
<area shape="rect" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11" title="获取当前核心的调度数据" alt="" coords="474,157,686,197"/>
<area shape="poly" title=" " alt="" coords="147,196,460,180,460,185,147,201"/>
<area shape="rect" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0" title="获取当前任务" alt="" coords="472,107,688,132"/>
<area shape="poly" title=" " alt="" coords="123,187,194,170,331,147,458,130,459,135,331,152,195,175,124,192"/>
<area shape="rect" href="classTaskManager.html#a63b9cd5ec9df1dc6878eff6cc355fccb" title="回收僵尸进程资源" alt="" coords="220,264,399,289"/>
<area shape="poly" title=" " alt="" coords="104,212,146,232,195,250,225,258,223,263,194,255,144,237,102,217"/>
<area shape="rect" href="classTaskManager.html#acfa70286ca9b8c538d1f75ba4d953ec8" title="将孤儿进程过继给 init 进程" alt="" coords="195,313,424,339"/>
<area shape="poly" title=" " alt="" coords="90,213,133,256,163,280,196,300,212,307,210,311,193,304,160,284,130,260,86,217"/>
<area shape="rect" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78" title="调度函数 选择下一个任务并切换上下文" alt="" coords="222,63,397,88"/>
<area shape="poly" title=" " alt="" coords="88,187,132,147,162,124,193,105,232,89,234,94,196,110,165,129,135,151,92,191"/>
<area shape="rect" href="classTaskManager.html#aecc6edadfbd8fd250db72884b1e23f93" title="唤醒等待指定资源的所有任务" alt="" coords="226,215,393,240"/>
<area shape="poly" title=" " alt="" coords="147,207,213,214,212,219,147,212"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="967,56,1152,81"/>
<area shape="poly" title=" " alt="" coords="669,154,988,82,989,87,670,159"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="1200,23,1463,63"/>
<area shape="poly" title=" " alt="" coords="1152,57,1186,54,1186,60,1152,63"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="736,56,919,81"/>
<area shape="poly" title=" " alt="" coords="643,104,751,82,752,87,644,109"/>
<area shape="poly" title=" " alt="" coords="919,66,953,66,953,71,919,71"/>
<area shape="poly" title=" " alt="" coords="340,86,473,141,499,150,497,155,471,146,338,91"/>
<area shape="poly" title=" " alt="" coords="388,85,488,102,487,107,387,91"/>
<area shape="poly" title=" " alt="" coords="397,72,722,67,722,73,397,77"/>
<area shape="rect" href="arch_8cpp.html#ad982abdb7f3d8729656c6b5422b2e61d" title=" " alt="" coords="538,5,622,31"/>
<area shape="poly" title=" " alt="" coords="370,60,524,27,525,32,371,65"/>
<area shape="poly" title=" " alt="" coords="622,17,1187,36,1186,41,622,22"/>
<area shape="poly" title=" " alt="" coords="623,24,752,51,751,56,622,29"/>
<area shape="poly" title=" " alt="" coords="377,212,460,196,461,202,378,217"/>
<area shape="rect" href="structResourceId.html#ad6b4733a8896d35652c1969f1eca1651" title="获取资源数据" alt="" coords="502,221,658,247"/>
<area shape="poly" title=" " alt="" coords="393,227,488,229,488,234,393,232"/>
<area shape="rect" href="structResourceId.html#ace28b59e657c4a031a54daabf85e59aa" title="获取类型名称（用于调试）" alt="" coords="483,271,677,296"/>
<area shape="poly" title=" " alt="" coords="372,237,505,265,504,270,371,243"/>
<area shape="rect" href="resource__id_8hpp.html#afd66b2606db93ecfaf8b3972a9b953ad" title="获取资源类型的字符串表示（用于调试）" alt="" coords="740,295,915,320"/>
<area shape="poly" title=" " alt="" coords="678,290,727,295,726,300,677,295"/>
<area shape="rect" href="structResourceId.html#adc2ead50d28fd71ff0c0d9b2529af45c" title="获取资源类型" alt="" coords="750,245,905,271"/>
<area shape="poly" title=" " alt="" coords="677,271,736,265,736,270,678,276"/>
</map>
</div>

</div>
</div>
<a id="a68d6b636f85f72416de99952e61a1508" name="a68d6b636f85f72416de99952e61a1508"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a68d6b636f85f72416de99952e61a1508">&#9670;&#160;</a></span>FindTask()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> * TaskManager::FindTask </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a>&#160;</td>
          <td class="paramname"><em>pid</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>按 PID 查找任务 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pid</td><td>进程 ID </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TaskControlBlock* 找到的任务，未找到返回 nullptr </dd></dl>

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00133">133</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  133</span>                                               {</div>
<div class="line"><span class="lineno">  134</span>  <a class="code hl_class" href="classLockGuard.html">LockGuard</a> lock_guard{<a class="code hl_variable" href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">task_table_lock_</a>};</div>
<div class="line"><span class="lineno">  135</span>  <span class="keyword">auto</span> it = <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>.find(pid);</div>
<div class="line"><span class="lineno">  136</span>  <span class="keywordflow">return</span> (it != <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>.end()) ? it-&gt;second : <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">  137</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a68d6b636f85f72416de99952e61a1508_icgraph.png" border="0" usemap="#aclassTaskManager_a68d6b636f85f72416de99952e61a1508_icgraph" alt=""/></div>
<map name="aclassTaskManager_a68d6b636f85f72416de99952e61a1508_icgraph" id="aclassTaskManager_a68d6b636f85f72416de99952e61a1508_icgraph">
<area shape="rect" title="按 PID 查找任务" alt="" coords="207,5,379,31"/>
<area shape="rect" href="classTaskManager.html#a101df6fadedb6dd4f93ee1a1e24550c2" title="克隆当前任务 (fork/clone 系统调用)" alt="" coords="5,5,159,31"/>
<area shape="poly" title=" " alt="" coords="193,21,159,21,159,15,193,15"/>
</map>
</div>

</div>
</div>
<a id="a4c1b1e56864ca791fe96710270acfc11" name="a4c1b1e56864ca791fe96710270acfc11"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4c1b1e56864ca791fe96710270acfc11">&#9670;&#160;</a></span>GetCurrentCpuSched()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structCpuSchedData.html">CpuSchedData</a> &amp; TaskManager::GetCurrentCpuSched </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>获取当前核心的调度数据 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00225">225</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  225</span>                                     {</div>
<div class="line"><span class="lineno">  226</span>    <span class="keywordflow">return</span> <a class="code hl_variable" href="classTaskManager.html#aaebe944e28d505769c2acc4ce1c8cca5">cpu_schedulers_</a>[<a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>()];</div>
<div class="line"><span class="lineno">  227</span>  }</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a4c1b1e56864ca791fe96710270acfc11_cgraph.png" border="0" usemap="#aclassTaskManager_a4c1b1e56864ca791fe96710270acfc11_cgraph" alt=""/></div>
<map name="aclassTaskManager_a4c1b1e56864ca791fe96710270acfc11_cgraph" id="aclassTaskManager_a4c1b1e56864ca791fe96710270acfc11_cgraph">
<area shape="rect" title="获取当前核心的调度数据" alt="" coords="5,5,217,45"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="265,13,451,38"/>
<area shape="poly" title=" " alt="" coords="218,23,252,23,252,28,218,28"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="499,5,761,45"/>
<area shape="poly" title=" " alt="" coords="451,23,485,23,485,28,451,28"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a4c1b1e56864ca791fe96710270acfc11_icgraph.png" border="0" usemap="#aclassTaskManager_a4c1b1e56864ca791fe96710270acfc11_icgraph" alt=""/></div>
<map name="aclassTaskManager_a4c1b1e56864ca791fe96710270acfc11_icgraph" id="aclassTaskManager_a4c1b1e56864ca791fe96710270acfc11_icgraph">
<area shape="rect" title="获取当前核心的调度数据" alt="" coords="660,98,872,138"/>
<area shape="rect" href="classTaskManager.html#a71763ebababa9aa90bad6a07c66edede" title="阻塞当前任务" alt="" coords="218,5,370,31"/>
<area shape="poly" title=" " alt="" coords="718,94,667,69,611,49,549,35,485,26,370,20,370,15,485,21,550,30,613,43,670,64,720,89"/>
<area shape="rect" href="classTaskManager.html#ae3444c55ab7b6ec348a56b596229fc0f" title="退出当前线程" alt="" coords="223,80,365,105"/>
<area shape="poly" title=" " alt="" coords="704,96,659,81,612,70,542,64,472,66,407,73,353,83,352,77,407,68,472,61,542,59,612,65,661,76,706,91"/>
<area shape="rect" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78" title="调度函数 选择下一个任务并切换上下文" alt="" coords="437,129,612,155"/>
<area shape="poly" title=" " alt="" coords="647,133,613,136,612,131,646,127"/>
<area shape="rect" href="classTaskManager.html#a86fe8ff01e353a0acb150c90e8081811" title="线程睡眠" alt="" coords="218,155,370,180"/>
<area shape="poly" title=" " alt="" coords="702,145,659,159,612,169,549,176,484,178,370,176,370,171,484,173,548,170,612,163,657,153,701,140"/>
<area shape="rect" href="classTaskManager.html#aa1041f9ed06a9d0b6b738621c30e1921" title="更新系统 tick" alt="" coords="199,204,389,229"/>
<area shape="poly" title=" " alt="" coords="714,146,666,167,613,185,497,206,390,216,389,211,497,201,611,179,664,162,712,141"/>
<area shape="rect" href="classTaskManager.html#aecc6edadfbd8fd250db72884b1e23f93" title="唤醒等待指定资源的所有任务" alt="" coords="441,80,608,105"/>
<area shape="poly" title=" " alt="" coords="646,108,608,104,608,99,647,103"/>
<area shape="rect" href="classTaskManager.html#aadc206ac53400212078270833533f247" title="等待子进程退出" alt="" coords="5,5,151,31"/>
<area shape="poly" title=" " alt="" coords="204,21,151,21,151,15,204,15"/>
<area shape="poly" title=" " alt="" coords="451,127,436,119,420,107,411,95,402,82,388,69,356,49,324,33,326,28,358,44,391,65,405,79,415,91,424,103,439,114,454,122"/>
<area shape="poly" title=" " alt="" coords="451,129,354,108,355,103,452,124"/>
<area shape="poly" title=" " alt="" coords="424,156,370,162,370,156,423,150"/>
<area shape="poly" title=" " alt="" coords="479,162,390,194,347,207,345,201,389,189,477,157"/>
<area shape="poly" title=" " alt="" coords="427,95,365,95,365,90,427,90"/>
</map>
</div>

</div>
</div>
<a id="a926010fadc0b0d1f1df608c59d4a57a0" name="a926010fadc0b0d1f1df608c59d4a57a0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a926010fadc0b0d1f1df608c59d4a57a0">&#9670;&#160;</a></span>GetCurrentTask()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> * TaskManager::GetCurrentTask </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>获取当前任务 </p>
<dl class="section return"><dt>Returns</dt><dd>TaskControlBlock* 当前正在运行的任务 </dd></dl>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00091">91</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   91</span>                                           {</div>
<div class="line"><span class="lineno">   92</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f">per_cpu::GetCurrentCore</a>().running_task;</div>
<div class="line"><span class="lineno">   93</span>  }</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a926010fadc0b0d1f1df608c59d4a57a0_cgraph.png" border="0" usemap="#aclassTaskManager_a926010fadc0b0d1f1df608c59d4a57a0_cgraph" alt=""/></div>
<map name="aclassTaskManager_a926010fadc0b0d1f1df608c59d4a57a0_cgraph" id="aclassTaskManager_a926010fadc0b0d1f1df608c59d4a57a0_cgraph">
<area shape="rect" title="获取当前任务" alt="" coords="5,13,221,38"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="269,13,452,38"/>
<area shape="poly" title=" " alt="" coords="222,23,255,23,255,28,222,28"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="500,13,685,38"/>
<area shape="poly" title=" " alt="" coords="453,23,486,23,486,28,453,28"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="733,5,996,45"/>
<area shape="poly" title=" " alt="" coords="686,23,719,23,719,28,686,28"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a926010fadc0b0d1f1df608c59d4a57a0_icgraph.png" border="0" usemap="#aclassTaskManager_a926010fadc0b0d1f1df608c59d4a57a0_icgraph" alt=""/></div>
<map name="aclassTaskManager_a926010fadc0b0d1f1df608c59d4a57a0_icgraph" id="aclassTaskManager_a926010fadc0b0d1f1df608c59d4a57a0_icgraph">
<area shape="rect" title="获取当前任务" alt="" coords="660,132,876,157"/>
<area shape="rect" href="classTaskManager.html#a71763ebababa9aa90bad6a07c66edede" title="阻塞当前任务" alt="" coords="218,31,370,56"/>
<area shape="poly" title=" " alt="" coords="714,130,611,102,484,76,370,57,370,52,485,71,613,97,715,125"/>
<area shape="rect" href="classTaskManager.html#aadc206ac53400212078270833533f247" title="等待子进程退出" alt="" coords="5,5,151,31"/>
<area shape="poly" title=" " alt="" coords="734,127,678,96,611,67,550,47,502,35,389,21,263,14,151,16,151,11,263,9,390,15,503,30,552,42,613,62,680,92,736,123"/>
<area shape="rect" href="classTaskManager.html#a101df6fadedb6dd4f93ee1a1e24550c2" title="克隆当前任务 (fork/clone 系统调用)" alt="" coords="448,284,601,309"/>
<area shape="poly" title=" " alt="" coords="745,169,687,217,613,267,569,286,567,282,611,262,684,213,742,165"/>
<area shape="rect" href="classTaskManager.html#ae3444c55ab7b6ec348a56b596229fc0f" title="退出当前线程" alt="" coords="223,107,365,132"/>
<area shape="poly" title=" " alt="" coords="690,132,612,122,481,117,365,119,365,113,481,112,612,117,691,127"/>
<area shape="rect" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78" title="调度函数 选择下一个任务并切换上下文" alt="" coords="437,132,612,157"/>
<area shape="poly" title=" " alt="" coords="646,147,612,147,612,142,646,142"/>
<area shape="rect" href="classTaskManager.html#a86fe8ff01e353a0acb150c90e8081811" title="线程睡眠" alt="" coords="218,183,370,208"/>
<area shape="poly" title=" " alt="" coords="679,162,612,171,371,193,370,188,612,166,678,157"/>
<area shape="rect" href="classTaskManager.html#aa1041f9ed06a9d0b6b738621c30e1921" title="更新系统 tick" alt="" coords="199,232,389,257"/>
<area shape="poly" title=" " alt="" coords="717,164,613,194,497,217,390,235,389,229,496,212,611,189,715,159"/>
<area shape="poly" title=" " alt="" coords="204,35,151,29,151,24,204,30"/>
<area shape="poly" title=" " alt="" coords="481,129,323,58,325,54,483,124"/>
<area shape="poly" title=" " alt="" coords="423,136,365,130,365,124,424,131"/>
<area shape="poly" title=" " alt="" coords="453,163,353,185,352,180,452,158"/>
<area shape="poly" title=" " alt="" coords="495,167,447,196,390,223,356,234,354,229,388,218,444,191,492,163"/>
</map>
</div>

</div>
</div>
<a id="a73c6f04f5f8aa4a646f56aa940d46d3d" name="a73c6f04f5f8aa4a646f56aa940d46d3d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a73c6f04f5f8aa4a646f56aa940d46d3d">&#9670;&#160;</a></span>GetThreadGroup()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">sk_std::vector&lt; <a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> * &gt; TaskManager::GetThreadGroup </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a>&#160;</td>
          <td class="paramname"><em>tgid</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>获取线程组的所有线程 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tgid</td><td>线程组 ID </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>sk_std::vector&lt;TaskControlBlock*&gt; 线程组中的所有线程 </dd></dl>

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00192">192</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  192</span>                                                                    {</div>
<div class="line"><span class="lineno">  193</span>  sk_std::vector&lt;TaskControlBlock*&gt; result;</div>
<div class="line"><span class="lineno">  194</span> </div>
<div class="line"><span class="lineno">  195</span>  <a class="code hl_class" href="classLockGuard.html">LockGuard</a> lock_guard(<a class="code hl_variable" href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">task_table_lock_</a>);</div>
<div class="line"><span class="lineno">  196</span> </div>
<div class="line"><span class="lineno">  197</span>  <span class="comment">// 遍历任务表，找到所有 tgid 匹配的线程</span></div>
<div class="line"><span class="lineno">  198</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; [pid, task] : <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>) {</div>
<div class="line"><span class="lineno">  199</span>    <span class="keywordflow">if</span> (task &amp;&amp; task-&gt;tgid == tgid) {</div>
<div class="line"><span class="lineno">  200</span>      result.push_back(task);</div>
<div class="line"><span class="lineno">  201</span>    }</div>
<div class="line"><span class="lineno">  202</span>  }</div>
<div class="line"><span class="lineno">  203</span> </div>
<div class="line"><span class="lineno">  204</span>  <span class="keywordflow">return</span> result;</div>
<div class="line"><span class="lineno">  205</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aa997c36c40d00f38722808ab8db70f36" name="aa997c36c40d00f38722808ab8db70f36"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa997c36c40d00f38722808ab8db70f36">&#9670;&#160;</a></span>InitCurrentCore()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::InitCurrentCore </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>初始化 per cpu 的调度数据，创建 idle 线程 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00037">37</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   37</span>                                  {</div>
<div class="line"><span class="lineno">   38</span>  <span class="keyword">auto</span> <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a> = <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>();</div>
<div class="line"><span class="lineno">   39</span>  <span class="keyword">auto</span>&amp; cpu_sched = <a class="code hl_variable" href="classTaskManager.html#aaebe944e28d505769c2acc4ce1c8cca5">cpu_schedulers_</a>[<a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a>];</div>
<div class="line"><span class="lineno">   40</span> </div>
<div class="line"><span class="lineno">   41</span>  <a class="code hl_class" href="classLockGuard.html">LockGuard</a> lock_guard{cpu_sched.lock};</div>
<div class="line"><span class="lineno">   42</span> </div>
<div class="line"><span class="lineno">   43</span>  <span class="keywordflow">if</span> (!cpu_sched.schedulers[<a class="code hl_enumvalue" href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a227e8416235cd3b43077ca91504a463f">SchedPolicy::kNormal</a>]) {</div>
<div class="line"><span class="lineno">   44</span>    cpu_sched.schedulers[<a class="code hl_enumvalue" href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a083bf2e4794281bd20e819d17073840f">SchedPolicy::kRealTime</a>] = <span class="keyword">new</span> <a class="code hl_class" href="classFifoScheduler.html">FifoScheduler</a>();</div>
<div class="line"><span class="lineno">   45</span>    cpu_sched.schedulers[<a class="code hl_enumvalue" href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a227e8416235cd3b43077ca91504a463f">SchedPolicy::kNormal</a>] = <span class="keyword">new</span> <a class="code hl_class" href="classRoundRobinScheduler.html">RoundRobinScheduler</a>();</div>
<div class="line"><span class="lineno">   46</span>    cpu_sched.schedulers[<a class="code hl_enumvalue" href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a19d8199da79ca4c28eb644052b08f632">SchedPolicy::kIdle</a>] = <span class="keyword">new</span> <a class="code hl_class" href="classIdleScheduler.html">IdleScheduler</a>();</div>
<div class="line"><span class="lineno">   47</span>  }</div>
<div class="line"><span class="lineno">   48</span> </div>
<div class="line"><span class="lineno">   49</span>  <span class="comment">// 关联 PerCpu</span></div>
<div class="line"><span class="lineno">   50</span>  <span class="keyword">auto</span>&amp; cpu_data = <a class="code hl_function" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f">per_cpu::GetCurrentCore</a>();</div>
<div class="line"><span class="lineno">   51</span>  cpu_data.sched_data = &amp;cpu_sched;</div>
<div class="line"><span class="lineno">   52</span> </div>
<div class="line"><span class="lineno">   53</span>  <span class="comment">// 创建独立的 Idle 线程</span></div>
<div class="line"><span class="lineno">   54</span>  <span class="keyword">auto</span>* <a class="code hl_variable" href="per__cpu_8hpp.html#a9a31203c3769eb7cefbb5433eec968dd">idle_task</a> = <span class="keyword">new</span> <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>(<span class="stringliteral">&quot;Idle&quot;</span>, INT_MAX, idle_thread, <span class="keyword">nullptr</span>);</div>
<div class="line"><span class="lineno">   55</span>  <a class="code hl_variable" href="per__cpu_8hpp.html#a9a31203c3769eb7cefbb5433eec968dd">idle_task</a>-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">status</a> = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f">TaskStatus::kRunning</a>;</div>
<div class="line"><span class="lineno">   56</span>  <a class="code hl_variable" href="per__cpu_8hpp.html#a9a31203c3769eb7cefbb5433eec968dd">idle_task</a>-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a017d7cfbc80709c0dfd826de0199a2a2">policy</a> = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a19d8199da79ca4c28eb644052b08f632">SchedPolicy::kIdle</a>;</div>
<div class="line"><span class="lineno">   57</span> </div>
<div class="line"><span class="lineno">   58</span>  <span class="comment">// 将 idle 任务加入 Idle 调度器</span></div>
<div class="line"><span class="lineno">   59</span>  <span class="keywordflow">if</span> (cpu_sched.schedulers[<a class="code hl_enumvalue" href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a19d8199da79ca4c28eb644052b08f632">SchedPolicy::kIdle</a>]) {</div>
<div class="line"><span class="lineno">   60</span>    cpu_sched.schedulers[<a class="code hl_enumvalue" href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a19d8199da79ca4c28eb644052b08f632">SchedPolicy::kIdle</a>]-&gt;Enqueue(<a class="code hl_variable" href="per__cpu_8hpp.html#a9a31203c3769eb7cefbb5433eec968dd">idle_task</a>);</div>
<div class="line"><span class="lineno">   61</span>  }</div>
<div class="line"><span class="lineno">   62</span> </div>
<div class="line"><span class="lineno">   63</span>  cpu_data.idle_task = <a class="code hl_variable" href="per__cpu_8hpp.html#a9a31203c3769eb7cefbb5433eec968dd">idle_task</a>;</div>
<div class="line"><span class="lineno">   64</span>  cpu_data.running_task = <a class="code hl_variable" href="per__cpu_8hpp.html#a9a31203c3769eb7cefbb5433eec968dd">idle_task</a>;</div>
<div class="line"><span class="lineno">   65</span>}</div>
<div class="ttc" id="aclassFifoScheduler_html"><div class="ttname"><a href="classFifoScheduler.html">FifoScheduler</a></div><div class="ttdoc">先来先服务 (FIFO) 调度器</div><div class="ttdef"><b>Definition</b> <a href="fifo__scheduler_8hpp_source.html#l00021">fifo_scheduler.hpp:21</a></div></div>
<div class="ttc" id="aclassIdleScheduler_html"><div class="ttname"><a href="classIdleScheduler.html">IdleScheduler</a></div><div class="ttdoc">Idle 调度器</div><div class="ttdef"><b>Definition</b> <a href="idle__scheduler_8hpp_source.html#l00020">idle_scheduler.hpp:20</a></div></div>
<div class="ttc" id="aclassRoundRobinScheduler_html"><div class="ttname"><a href="classRoundRobinScheduler.html">RoundRobinScheduler</a></div><div class="ttdoc">Round-Robin 调度器</div><div class="ttdef"><b>Definition</b> <a href="rr__scheduler_8hpp_source.html#l00018">rr_scheduler.hpp:18</a></div></div>
<div class="ttc" id="aper__cpu_8hpp_html_a9a31203c3769eb7cefbb5433eec968dd"><div class="ttname"><a href="per__cpu_8hpp.html#a9a31203c3769eb7cefbb5433eec968dd">idle_task</a></div><div class="ttdeci">TaskControlBlock * idle_task</div><div class="ttdoc">空闲任务</div><div class="ttdef"><b>Definition</b> <a href="per__cpu_8hpp_source.html#l00006">per_cpu.hpp:6</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a49a208767f4bf1cfd0e39b9db74b8af1a083bf2e4794281bd20e819d17073840f"><div class="ttname"><a href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a083bf2e4794281bd20e819d17073840f">kRealTime</a></div><div class="ttdeci">@ kRealTime</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00068">task_control_block.hpp:68</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a49a208767f4bf1cfd0e39b9db74b8af1a19d8199da79ca4c28eb644052b08f632"><div class="ttname"><a href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a19d8199da79ca4c28eb644052b08f632">kIdle</a></div><div class="ttdeci">@ kIdle</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00072">task_control_block.hpp:72</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a49a208767f4bf1cfd0e39b9db74b8af1a227e8416235cd3b43077ca91504a463f"><div class="ttname"><a href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a227e8416235cd3b43077ca91504a463f">kNormal</a></div><div class="ttdeci">@ kNormal</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00070">task_control_block.hpp:70</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_aa997c36c40d00f38722808ab8db70f36_cgraph.png" border="0" usemap="#aclassTaskManager_aa997c36c40d00f38722808ab8db70f36_cgraph" alt=""/></div>
<map name="aclassTaskManager_aa997c36c40d00f38722808ab8db70f36_cgraph" id="aclassTaskManager_aa997c36c40d00f38722808ab8db70f36_cgraph">
<area shape="rect" title="初始化 per cpu 的调度数据，创建 idle 线程" alt="" coords="5,31,220,56"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="268,5,451,31"/>
<area shape="poly" title=" " alt="" coords="220,30,254,26,254,31,221,35"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="499,31,684,56"/>
<area shape="poly" title=" " alt="" coords="220,41,485,41,485,46,220,46"/>
<area shape="poly" title=" " alt="" coords="452,25,485,29,485,34,451,31"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="732,23,995,63"/>
<area shape="poly" title=" " alt="" coords="684,41,718,41,718,46,684,46"/>
</map>
</div>

</div>
</div>
<a id="a773d9dd15c6ebdafbd94c1c0abf1cfc8" name="a773d9dd15c6ebdafbd94c1c0abf1cfc8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a773d9dd15c6ebdafbd94c1c0abf1cfc8">&#9670;&#160;</a></span>operator=() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">auto TaskManager::operator= </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classTaskManager.html">TaskManager</a> &amp;&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td> -&gt;  <a class="el" href="classTaskManager.html">TaskManager</a> &amp;=delete</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">delete</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a4e4d2f9f4f5232d139fa6e489dd9be45" name="a4e4d2f9f4f5232d139fa6e489dd9be45"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4e4d2f9f4f5232d139fa6e489dd9be45">&#9670;&#160;</a></span>operator=() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">auto TaskManager::operator= </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classTaskManager.html">TaskManager</a> &amp;&amp;&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td> -&gt;  <a class="el" href="classTaskManager.html">TaskManager</a> &amp;=delete</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">delete</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a63b9cd5ec9df1dc6878eff6cc355fccb" name="a63b9cd5ec9df1dc6878eff6cc355fccb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a63b9cd5ec9df1dc6878eff6cc355fccb">&#9670;&#160;</a></span>ReapTask()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::ReapTask </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> *&#160;</td>
          <td class="paramname"><em>task</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>回收僵尸进程资源 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">task</td><td>要回收的任务 (必须处于 kZombie 状态) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>释放内核栈、页表、TCB，回收 PID </dd></dl>

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00144">144</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  144</span>                                                 {</div>
<div class="line"><span class="lineno">  145</span>  <span class="keywordflow">if</span> (!task) {</div>
<div class="line"><span class="lineno">  146</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  147</span>  }</div>
<div class="line"><span class="lineno">  148</span> </div>
<div class="line"><span class="lineno">  149</span>  <span class="comment">// 确保任务处于僵尸或退出状态</span></div>
<div class="line"><span class="lineno">  150</span>  <span class="keywordflow">if</span> (task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">status</a> != <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2ae5bcea9577cc11324251f070f1e12f7c">TaskStatus::kZombie</a> &amp;&amp;</div>
<div class="line"><span class="lineno">  151</span>      task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">status</a> != <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a829e9a9be95f71d0db69307258a97722">TaskStatus::kExited</a>) {</div>
<div class="line"><span class="lineno">  152</span>    <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;ReapTask: Task %zu is not in zombie/exited state\n&quot;</span>, task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>);</div>
<div class="line"><span class="lineno">  153</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  154</span>  }</div>
<div class="line"><span class="lineno">  155</span> </div>
<div class="line"><span class="lineno">  156</span>  <span class="comment">// 从全局任务表中移除</span></div>
<div class="line"><span class="lineno">  157</span>  {</div>
<div class="line"><span class="lineno">  158</span>    <a class="code hl_class" href="classLockGuard.html">LockGuard</a> lock_guard{<a class="code hl_variable" href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">task_table_lock_</a>};</div>
<div class="line"><span class="lineno">  159</span>    <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>.erase(task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>);</div>
<div class="line"><span class="lineno">  160</span>  }</div>
<div class="line"><span class="lineno">  161</span> </div>
<div class="line"><span class="lineno">  162</span>  <span class="keyword">delete</span> task;</div>
<div class="line"><span class="lineno">  163</span> </div>
<div class="line"><span class="lineno">  164</span>  <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;ReapTask: Task %zu resources freed\n&quot;</span>, task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>);</div>
<div class="line"><span class="lineno">  165</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a63b9cd5ec9df1dc6878eff6cc355fccb_icgraph.png" border="0" usemap="#aclassTaskManager_a63b9cd5ec9df1dc6878eff6cc355fccb_icgraph" alt=""/></div>
<map name="aclassTaskManager_a63b9cd5ec9df1dc6878eff6cc355fccb_icgraph" id="aclassTaskManager_a63b9cd5ec9df1dc6878eff6cc355fccb_icgraph">
<area shape="rect" title="回收僵尸进程资源" alt="" coords="195,5,373,31"/>
<area shape="rect" href="classTaskManager.html#ae3444c55ab7b6ec348a56b596229fc0f" title="退出当前线程" alt="" coords="5,5,147,31"/>
<area shape="poly" title=" " alt="" coords="181,21,147,21,147,15,181,15"/>
</map>
</div>

</div>
</div>
<a id="acfa70286ca9b8c538d1f75ba4d953ec8" name="acfa70286ca9b8c538d1f75ba4d953ec8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acfa70286ca9b8c538d1f75ba4d953ec8">&#9670;&#160;</a></span>ReparentChildren()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::ReparentChildren </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structTaskControlBlock.html">TaskControlBlock</a> *&#160;</td>
          <td class="paramname"><em>parent</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>将孤儿进程过继给 init 进程 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">parent</td><td>退出的父进程 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>在父进程退出时调用，防止子进程变成僵尸无人回收 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000026">Todo:</a></b></dt><dd>当前的 pid 是自增的，需要考虑多核情况 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000027">Todo:</a></b></dt><dd>实现向 init 进程发送 SIGCHLD 信号 </dd></dl>

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00167">167</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  167</span>                                                           {</div>
<div class="line"><span class="lineno">  168</span>  <span class="keywordflow">if</span> (!parent) {</div>
<div class="line"><span class="lineno">  169</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  170</span>  }</div>
<div class="line"><span class="lineno">  171</span> </div>
<div class="line"><span class="lineno">  172</span>  <span class="comment">// init 进程的 PID 通常是 1</span></div>
<div class="line"><span class="lineno">  174</span>  <span class="keyword">constexpr</span> <a class="code hl_typedef" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> kInitPid = 1;</div>
<div class="line"><span class="lineno">  175</span> </div>
<div class="line"><span class="lineno">  176</span>  <a class="code hl_class" href="classLockGuard.html">LockGuard</a> lock_guard{<a class="code hl_variable" href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">task_table_lock_</a>};</div>
<div class="line"><span class="lineno">  177</span> </div>
<div class="line"><span class="lineno">  178</span>  <span class="comment">// 遍历所有任务，找到父进程是当前任务的子进程</span></div>
<div class="line"><span class="lineno">  179</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; [pid, task] : <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>) {</div>
<div class="line"><span class="lineno">  180</span>    <span class="keywordflow">if</span> (task &amp;&amp; task-&gt;parent_pid == parent-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>) {</div>
<div class="line"><span class="lineno">  181</span>      <span class="comment">// 将子进程过继给 init 进程</span></div>
<div class="line"><span class="lineno">  182</span>      task-&gt;parent_pid = kInitPid;</div>
<div class="line"><span class="lineno">  183</span>      <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;ReparentChildren: Task %zu reparented to init (PID %zu)\n&quot;</span>,</div>
<div class="line"><span class="lineno">  184</span>                  task-&gt;pid, kInitPid);</div>
<div class="line"><span class="lineno">  185</span> </div>
<div class="line"><span class="lineno">  186</span>      <span class="comment">// 如果子进程已经是僵尸状态，通知 init 进程回收</span></div>
<div class="line"><span class="lineno">  188</span>    }</div>
<div class="line"><span class="lineno">  189</span>  }</div>
<div class="line"><span class="lineno">  190</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_acfa70286ca9b8c538d1f75ba4d953ec8_icgraph.png" border="0" usemap="#aclassTaskManager_acfa70286ca9b8c538d1f75ba4d953ec8_icgraph" alt=""/></div>
<map name="aclassTaskManager_acfa70286ca9b8c538d1f75ba4d953ec8_icgraph" id="aclassTaskManager_acfa70286ca9b8c538d1f75ba4d953ec8_icgraph">
<area shape="rect" title="将孤儿进程过继给 init 进程" alt="" coords="195,5,424,31"/>
<area shape="rect" href="classTaskManager.html#ae3444c55ab7b6ec348a56b596229fc0f" title="退出当前线程" alt="" coords="5,5,147,31"/>
<area shape="poly" title=" " alt="" coords="181,21,147,21,147,15,181,15"/>
</map>
</div>

</div>
</div>
<a id="af7525954e852c09c1dd8ba50235f1d78" name="af7525954e852c09c1dd8ba50235f1d78"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af7525954e852c09c1dd8ba50235f1d78">&#9670;&#160;</a></span>Schedule()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::Schedule </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>调度函数 选择下一个任务并切换上下文 </p>
<dl class="section note"><dt>Note</dt><dd>被调用意味着需要调度决策，可能是 时间片耗尽（TickUpdate 检测到需要抢占） 主动让出 CPU (yield) 任务阻塞、睡眠或退出</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright The SimpleKernel Contributors </dd></dl>

<p class="definition">Definition at line <a class="el" href="schedule_8cpp_source.html#l00027">27</a> of file <a class="el" href="schedule_8cpp_source.html">schedule.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   27</span>                           {</div>
<div class="line"><span class="lineno">   28</span>  <span class="keyword">auto</span>&amp; cpu_sched = <a class="code hl_function" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11">GetCurrentCpuSched</a>();</div>
<div class="line"><span class="lineno">   29</span>  cpu_sched.lock.Lock();</div>
<div class="line"><span class="lineno">   30</span> </div>
<div class="line"><span class="lineno">   31</span>  <span class="keyword">auto</span>* current = <a class="code hl_function" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0">GetCurrentTask</a>();</div>
<div class="line"><span class="lineno">   32</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(current != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;Schedule: No current task to schedule&quot;</span>);</div>
<div class="line"><span class="lineno">   33</span> </div>
<div class="line"><span class="lineno">   34</span>  <span class="comment">// 处理当前任务状态</span></div>
<div class="line"><span class="lineno">   35</span>  <span class="keywordflow">if</span> (current-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f">TaskStatus::kRunning</a>) {</div>
<div class="line"><span class="lineno">   36</span>    <span class="comment">// 将当前任务标记为就绪并重新入队（如果它还能运行）</span></div>
<div class="line"><span class="lineno">   37</span>    current-&gt;status = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a7f1984e27dfac1310a3ac5c981abf863">TaskStatus::kReady</a>;</div>
<div class="line"><span class="lineno">   38</span>    <span class="keyword">auto</span>* scheduler = cpu_sched.schedulers[current-&gt;policy];</div>
<div class="line"><span class="lineno">   39</span> </div>
<div class="line"><span class="lineno">   40</span>    <span class="keywordflow">if</span> (scheduler) {</div>
<div class="line"><span class="lineno">   41</span>      scheduler-&gt;OnPreempted(current);</div>
<div class="line"><span class="lineno">   42</span>      <span class="comment">// 调度器决定如何处理被抢占的任务</span></div>
<div class="line"><span class="lineno">   43</span>      <span class="comment">// 大多数情况下需要重新入队，除非是特殊策略</span></div>
<div class="line"><span class="lineno">   44</span>      <span class="keywordflow">if</span> (scheduler-&gt;OnTimeSliceExpired(current)) {</div>
<div class="line"><span class="lineno">   45</span>        scheduler-&gt;Enqueue(current);</div>
<div class="line"><span class="lineno">   46</span>      }</div>
<div class="line"><span class="lineno">   47</span>    }</div>
<div class="line"><span class="lineno">   48</span>  }</div>
<div class="line"><span class="lineno">   49</span> </div>
<div class="line"><span class="lineno">   50</span>  <span class="comment">// 选择下一个任务 (按策略优先级: RealTime &gt; Normal &gt; Idle)</span></div>
<div class="line"><span class="lineno">   51</span>  <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* next = <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">   52</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span>* scheduler : cpu_sched.schedulers) {</div>
<div class="line"><span class="lineno">   53</span>    <span class="keywordflow">if</span> (scheduler &amp;&amp; !scheduler-&gt;IsEmpty()) {</div>
<div class="line"><span class="lineno">   54</span>      next = scheduler-&gt;PickNext();</div>
<div class="line"><span class="lineno">   55</span>      <span class="keywordflow">if</span> (next) {</div>
<div class="line"><span class="lineno">   56</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   57</span>      }</div>
<div class="line"><span class="lineno">   58</span>    }</div>
<div class="line"><span class="lineno">   59</span>  }</div>
<div class="line"><span class="lineno">   60</span> </div>
<div class="line"><span class="lineno">   61</span>  <span class="comment">// 如果没有任务可运行</span></div>
<div class="line"><span class="lineno">   62</span>  <span class="keywordflow">if</span> (!next) {</div>
<div class="line"><span class="lineno">   63</span>    <span class="comment">// 如果当前任务仍然可以运行，继续运行它</span></div>
<div class="line"><span class="lineno">   64</span>    <span class="keywordflow">if</span> (current-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a7f1984e27dfac1310a3ac5c981abf863">TaskStatus::kReady</a>) {</div>
<div class="line"><span class="lineno">   65</span>      next = current;</div>
<div class="line"><span class="lineno">   66</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">   67</span>      <span class="comment">// 否则统计空闲时间并返回</span></div>
<div class="line"><span class="lineno">   68</span>      cpu_sched.idle_time++;</div>
<div class="line"><span class="lineno">   69</span>      cpu_sched.lock.UnLock();</div>
<div class="line"><span class="lineno">   70</span>      <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">   71</span>    }</div>
<div class="line"><span class="lineno">   72</span>  }</div>
<div class="line"><span class="lineno">   73</span> </div>
<div class="line"><span class="lineno">   74</span>  <span class="comment">// 切换到下一个任务</span></div>
<div class="line"><span class="lineno">   75</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(next != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;Schedule: next task must not be null&quot;</span>);</div>
<div class="line"><span class="lineno">   76</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(</div>
<div class="line"><span class="lineno">   77</span>      next-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">status</a> == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a7f1984e27dfac1310a3ac5c981abf863">TaskStatus::kReady</a> || next-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a017d7cfbc80709c0dfd826de0199a2a2">policy</a> == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a49a208767f4bf1cfd0e39b9db74b8af1a19d8199da79ca4c28eb644052b08f632">SchedPolicy::kIdle</a>,</div>
<div class="line"><span class="lineno">   78</span>      <span class="stringliteral">&quot;Schedule: next task must be kReady or kIdle policy&quot;</span>);</div>
<div class="line"><span class="lineno">   79</span> </div>
<div class="line"><span class="lineno">   80</span>  next-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">status</a> = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f">TaskStatus::kRunning</a>;</div>
<div class="line"><span class="lineno">   81</span>  <span class="comment">// 重置时间片（对于 RR 和 FIFO 有效，CFS 使用 vruntime 不依赖此字段）</span></div>
<div class="line"><span class="lineno">   82</span>  next-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a3075e45ca454dbb5309161896e432ace">sched_info</a>.<a class="code hl_variable" href="structTaskControlBlock_1_1SchedInfo.html#acbbd6ad7913e4f93e31eabd16c1691ee">time_slice_remaining</a> = next-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a3075e45ca454dbb5309161896e432ace">sched_info</a>.<a class="code hl_variable" href="structTaskControlBlock_1_1SchedInfo.html#a1285800eebf37bb44c68ebc43ccdbc86">time_slice_default</a>;</div>
<div class="line"><span class="lineno">   83</span>  next-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a3075e45ca454dbb5309161896e432ace">sched_info</a>.<a class="code hl_variable" href="structTaskControlBlock_1_1SchedInfo.html#a624c068b546e06d50d9b512c04df5ab2">context_switches</a>++;</div>
<div class="line"><span class="lineno">   84</span>  cpu_sched.total_schedules++;</div>
<div class="line"><span class="lineno">   85</span> </div>
<div class="line"><span class="lineno">   86</span>  <span class="comment">// 调用调度器钩子</span></div>
<div class="line"><span class="lineno">   87</span>  <span class="keyword">auto</span>* scheduler = cpu_sched.schedulers[next-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a017d7cfbc80709c0dfd826de0199a2a2">policy</a>];</div>
<div class="line"><span class="lineno">   88</span>  <span class="keywordflow">if</span> (scheduler) {</div>
<div class="line"><span class="lineno">   89</span>    scheduler-&gt;OnScheduled(next);</div>
<div class="line"><span class="lineno">   90</span>  }</div>
<div class="line"><span class="lineno">   91</span> </div>
<div class="line"><span class="lineno">   92</span>  <span class="comment">// 更新 per-CPU running_task</span></div>
<div class="line"><span class="lineno">   93</span>  <a class="code hl_function" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f">per_cpu::GetCurrentCore</a>().running_task = next;</div>
<div class="line"><span class="lineno">   94</span> </div>
<div class="line"><span class="lineno">   95</span>  cpu_sched.lock.UnLock();</div>
<div class="line"><span class="lineno">   96</span> </div>
<div class="line"><span class="lineno">   97</span>  <span class="comment">// 上下文切换</span></div>
<div class="line"><span class="lineno">   98</span>  <span class="keywordflow">if</span> (current != next) {</div>
<div class="line"><span class="lineno">   99</span>    <a class="code hl_function" href="arch_8h.html#a1a5356ccbae40313871a4877d89cc53d">switch_to</a>(&amp;current-&gt;task_context, &amp;next-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#af087bcb6f419c7484c1200719e0751a9">task_context</a>);</div>
<div class="line"><span class="lineno">  100</span>  }</div>
<div class="line"><span class="lineno">  101</span>}</div>
<div class="ttc" id="aarch_8h_html_a1a5356ccbae40313871a4877d89cc53d"><div class="ttname"><a href="arch_8h.html#a1a5356ccbae40313871a4877d89cc53d">switch_to</a></div><div class="ttdeci">void switch_to(cpu_io::CalleeSavedContext *prev, cpu_io::CalleeSavedContext *next)</div><div class="ttdef"><b>Definition</b> <a href="arch_8cpp_source.html#l00015">arch.cpp:15</a></div></div>
<div class="ttc" id="astructTaskControlBlock_1_1SchedInfo_html_a1285800eebf37bb44c68ebc43ccdbc86"><div class="ttname"><a href="structTaskControlBlock_1_1SchedInfo.html#a1285800eebf37bb44c68ebc43ccdbc86">TaskControlBlock::SchedInfo::time_slice_default</a></div><div class="ttdeci">uint64_t time_slice_default</div><div class="ttdoc">默认时间片</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00144">task_control_block.hpp:144</a></div></div>
<div class="ttc" id="astructTaskControlBlock_1_1SchedInfo_html_a624c068b546e06d50d9b512c04df5ab2"><div class="ttname"><a href="structTaskControlBlock_1_1SchedInfo.html#a624c068b546e06d50d9b512c04df5ab2">TaskControlBlock::SchedInfo::context_switches</a></div><div class="ttdeci">uint64_t context_switches</div><div class="ttdoc">上下文切换次数</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00148">task_control_block.hpp:148</a></div></div>
<div class="ttc" id="astructTaskControlBlock_1_1SchedInfo_html_acbbd6ad7913e4f93e31eabd16c1691ee"><div class="ttname"><a href="structTaskControlBlock_1_1SchedInfo.html#acbbd6ad7913e4f93e31eabd16c1691ee">TaskControlBlock::SchedInfo::time_slice_remaining</a></div><div class="ttdeci">uint64_t time_slice_remaining</div><div class="ttdoc">剩余时间片</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00142">task_control_block.hpp:142</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_a3075e45ca454dbb5309161896e432ace"><div class="ttname"><a href="structTaskControlBlock.html#a3075e45ca454dbb5309161896e432ace">TaskControlBlock::sched_info</a></div><div class="ttdeci">struct TaskControlBlock::SchedInfo sched_info</div></div>
<div class="ttc" id="astructTaskControlBlock_html_af087bcb6f419c7484c1200719e0751a9"><div class="ttname"><a href="structTaskControlBlock.html#af087bcb6f419c7484c1200719e0751a9">TaskControlBlock::task_context</a></div><div class="ttdeci">cpu_io::CalleeSavedContext task_context</div><div class="ttdoc">任务上下文</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00176">task_control_block.hpp:176</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_af7525954e852c09c1dd8ba50235f1d78_cgraph.png" border="0" usemap="#aclassTaskManager_af7525954e852c09c1dd8ba50235f1d78_cgraph" alt=""/></div>
<map name="aclassTaskManager_af7525954e852c09c1dd8ba50235f1d78_cgraph" id="aclassTaskManager_af7525954e852c09c1dd8ba50235f1d78_cgraph">
<area shape="rect" title="调度函数 选择下一个任务并切换上下文" alt="" coords="5,66,180,91"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="507,91,689,117"/>
<area shape="poly" title=" " alt="" coords="181,80,493,96,492,101,180,86"/>
<area shape="rect" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11" title="获取当前核心的调度数据" alt="" coords="492,5,704,45"/>
<area shape="poly" title=" " alt="" coords="118,63,168,43,227,25,291,16,357,12,478,13,478,18,357,17,292,22,229,31,170,48,120,68"/>
<area shape="rect" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0" title="获取当前任务" alt="" coords="228,41,444,66"/>
<area shape="poly" title=" " alt="" coords="180,67,214,63,214,69,180,72"/>
<area shape="rect" href="arch_8cpp.html#ad982abdb7f3d8729656c6b5422b2e61d" title=" " alt="" coords="294,142,378,167"/>
<area shape="poly" title=" " alt="" coords="133,89,229,120,281,136,280,141,227,125,131,94"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="752,91,937,117"/>
<area shape="poly" title=" " alt="" coords="689,101,738,101,738,107,689,107"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="985,109,1248,149"/>
<area shape="poly" title=" " alt="" coords="938,110,972,113,971,118,937,115"/>
<area shape="poly" title=" " alt="" coords="662,43,792,85,790,90,661,48"/>
<area shape="poly" title=" " alt="" coords="403,63,519,86,518,91,402,69"/>
<area shape="poly" title=" " alt="" coords="378,144,518,117,519,122,379,149"/>
<area shape="poly" title=" " alt="" coords="378,151,971,131,972,137,378,156"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_af7525954e852c09c1dd8ba50235f1d78_icgraph.png" border="0" usemap="#aclassTaskManager_af7525954e852c09c1dd8ba50235f1d78_icgraph" alt=""/></div>
<map name="aclassTaskManager_af7525954e852c09c1dd8ba50235f1d78_icgraph" id="aclassTaskManager_af7525954e852c09c1dd8ba50235f1d78_icgraph">
<area shape="rect" title="调度函数 选择下一个任务并切换上下文" alt="" coords="437,80,612,105"/>
<area shape="rect" href="classTaskManager.html#a71763ebababa9aa90bad6a07c66edede" title="阻塞当前任务" alt="" coords="218,5,370,31"/>
<area shape="poly" title=" " alt="" coords="479,77,389,45,349,33,350,28,390,39,481,72"/>
<area shape="rect" href="classTaskManager.html#ae3444c55ab7b6ec348a56b596229fc0f" title="退出当前线程" alt="" coords="223,55,365,80"/>
<area shape="poly" title=" " alt="" coords="423,84,365,78,365,72,424,79"/>
<area shape="rect" href="classTaskManager.html#a86fe8ff01e353a0acb150c90e8081811" title="线程睡眠" alt="" coords="218,104,370,129"/>
<area shape="poly" title=" " alt="" coords="424,106,370,111,370,106,423,101"/>
<area shape="rect" href="classTaskManager.html#aa1041f9ed06a9d0b6b738621c30e1921" title="更新系统 tick" alt="" coords="199,153,389,179"/>
<area shape="poly" title=" " alt="" coords="478,113,390,143,347,156,345,151,389,138,476,108"/>
<area shape="rect" href="classTaskManager.html#aadc206ac53400212078270833533f247" title="等待子进程退出" alt="" coords="5,5,151,31"/>
<area shape="poly" title=" " alt="" coords="204,21,151,21,151,15,204,15"/>
</map>
</div>

</div>
</div>
<a id="aee251dfccf1511abff3458d75f4aa034" name="aee251dfccf1511abff3458d75f4aa034"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aee251dfccf1511abff3458d75f4aa034">&#9670;&#160;</a></span>SignalThreadGroup()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::SignalThreadGroup </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a>&#160;</td>
          <td class="paramname"><em>tgid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>signal</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>向线程组中的所有线程发送信号 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tgid</td><td>线程组 ID </td></tr>
    <tr><td class="paramname">signal</td><td>信号编号 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>暂未实现信号机制，预留接口 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000028">Todo:</a></b></dt><dd>实现信号机制后，向线程组中的所有线程发送信号 </dd></dl>

<p class="definition">Definition at line <a class="el" href="task__manager_8cpp_source.html#l00207">207</a> of file <a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  207</span>                                                        {</div>
<div class="line"><span class="lineno">  209</span>  <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;SignalThreadGroup: tgid=%zu, signal=%d (not implemented)\n&quot;</span>,</div>
<div class="line"><span class="lineno">  210</span>              tgid, signal);</div>
<div class="line"><span class="lineno">  211</span> </div>
<div class="line"><span class="lineno">  212</span>  <span class="comment">// 预期实现：</span></div>
<div class="line"><span class="lineno">  213</span>  <span class="comment">// auto threads = GetThreadGroup(tgid);</span></div>
<div class="line"><span class="lineno">  214</span>  <span class="comment">// for (auto* thread : threads) {</span></div>
<div class="line"><span class="lineno">  215</span>  <span class="comment">//   SendSignal(thread, signal);</span></div>
<div class="line"><span class="lineno">  216</span>  <span class="comment">// }</span></div>
<div class="line"><span class="lineno">  217</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a86fe8ff01e353a0acb150c90e8081811" name="a86fe8ff01e353a0acb150c90e8081811"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a86fe8ff01e353a0acb150c90e8081811">&#9670;&#160;</a></span>Sleep()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::Sleep </td>
          <td>(</td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>ms</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>线程睡眠 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ms</td><td>睡眠毫秒数 </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="sleep_8cpp_source.html#l00014">14</a> of file <a class="el" href="sleep_8cpp_source.html">sleep.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   14</span>                                   {</div>
<div class="line"><span class="lineno">   15</span>  <span class="keyword">auto</span>&amp; cpu_sched = <a class="code hl_function" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11">GetCurrentCpuSched</a>();</div>
<div class="line"><span class="lineno">   16</span> </div>
<div class="line"><span class="lineno">   17</span>  <span class="keyword">auto</span>* current = <a class="code hl_function" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0">GetCurrentTask</a>();</div>
<div class="line"><span class="lineno">   18</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(current != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;Sleep: No current task to sleep&quot;</span>);</div>
<div class="line"><span class="lineno">   19</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(current-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f">TaskStatus::kRunning</a>,</div>
<div class="line"><span class="lineno">   20</span>                <span class="stringliteral">&quot;Sleep: current task status must be kRunning&quot;</span>);</div>
<div class="line"><span class="lineno">   21</span> </div>
<div class="line"><span class="lineno">   22</span>  <span class="comment">// 如果睡眠时间为 0，仅让出 CPU（相当于 yield）</span></div>
<div class="line"><span class="lineno">   23</span>  <span class="keywordflow">if</span> (ms == 0) {</div>
<div class="line"><span class="lineno">   24</span>    <a class="code hl_function" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78">Schedule</a>();</div>
<div class="line"><span class="lineno">   25</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">   26</span>  }</div>
<div class="line"><span class="lineno">   27</span> </div>
<div class="line"><span class="lineno">   28</span>  {</div>
<div class="line"><span class="lineno">   29</span>    <a class="code hl_class" href="classLockGuard.html">LockGuard&lt;SpinLock&gt;</a> lock_guard(cpu_sched.lock);</div>
<div class="line"><span class="lineno">   30</span> </div>
<div class="line"><span class="lineno">   31</span>    <span class="comment">// 计算唤醒时间 (当前 tick + 睡眠时间)</span></div>
<div class="line"><span class="lineno">   32</span>    uint64_t sleep_ticks = (ms * SIMPLEKERNEL_TICK) / kMillisecondsPerSecond;</div>
<div class="line"><span class="lineno">   33</span>    current-&gt;sched_info.wake_tick = cpu_sched.local_tick + sleep_ticks;</div>
<div class="line"><span class="lineno">   34</span> </div>
<div class="line"><span class="lineno">   35</span>    <span class="comment">// 将任务标记为睡眠状态</span></div>
<div class="line"><span class="lineno">   36</span>    current-&gt;status = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2acf8962434c9f2b7be945c9766c6db9df">TaskStatus::kSleeping</a>;</div>
<div class="line"><span class="lineno">   37</span> </div>
<div class="line"><span class="lineno">   38</span>    <span class="comment">// 将任务加入睡眠队列（优先队列会自动按 wake_tick 排序）</span></div>
<div class="line"><span class="lineno">   39</span>    cpu_sched.sleeping_tasks.push(current);</div>
<div class="line"><span class="lineno">   40</span>  }</div>
<div class="line"><span class="lineno">   41</span> </div>
<div class="line"><span class="lineno">   42</span>  <span class="comment">// 调度到其他任务</span></div>
<div class="line"><span class="lineno">   43</span>  <a class="code hl_function" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78">Schedule</a>();</div>
<div class="line"><span class="lineno">   44</span> </div>
<div class="line"><span class="lineno">   45</span>  <span class="comment">// 任务被唤醒后会从这里继续执行</span></div>
<div class="line"><span class="lineno">   46</span>}</div>
<div class="ttc" id="atask__control__block_8hpp_html_a5d987b98f8f913fcd928b7ab94e726a2acf8962434c9f2b7be945c9766c6db9df"><div class="ttname"><a href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2acf8962434c9f2b7be945c9766c6db9df">kSleeping</a></div><div class="ttdeci">@ kSleeping</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00054">task_control_block.hpp:54</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_a86fe8ff01e353a0acb150c90e8081811_cgraph.png" border="0" usemap="#aclassTaskManager_a86fe8ff01e353a0acb150c90e8081811_cgraph" alt=""/></div>
<map name="aclassTaskManager_a86fe8ff01e353a0acb150c90e8081811_cgraph" id="aclassTaskManager_a86fe8ff01e353a0acb150c90e8081811_cgraph">
<area shape="rect" title="线程睡眠" alt="" coords="5,83,157,109"/>
<area shape="rect" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11" title="获取当前核心的调度数据" alt="" coords="430,5,642,45"/>
<area shape="poly" title=" " alt="" coords="140,81,205,68,416,37,417,42,206,73,141,86"/>
<area shape="rect" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0" title="获取当前任务" alt="" coords="428,171,644,197"/>
<area shape="poly" title=" " alt="" coords="144,106,206,119,453,166,452,171,205,124,143,111"/>
<area shape="rect" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78" title="调度函数 选择下一个任务并切换上下文" alt="" coords="205,83,380,109"/>
<area shape="poly" title=" " alt="" coords="157,93,192,93,192,99,157,99"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="923,19,1108,45"/>
<area shape="poly" title=" " alt="" coords="643,24,909,28,909,33,642,29"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="1156,37,1419,77"/>
<area shape="poly" title=" " alt="" coords="1108,38,1142,41,1142,46,1108,43"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="692,121,875,146"/>
<area shape="poly" title=" " alt="" coords="599,169,707,146,708,151,600,174"/>
<area shape="poly" title=" " alt="" coords="813,118,971,48,974,53,815,123"/>
<area shape="poly" title=" " alt="" coords="337,81,453,47,454,52,338,86"/>
<area shape="poly" title=" " alt="" coords="323,106,429,149,476,165,474,170,427,155,321,111"/>
<area shape="poly" title=" " alt="" coords="380,101,428,105,679,124,678,129,428,111,380,107"/>
<area shape="rect" href="arch_8cpp.html#ad982abdb7f3d8729656c6b5422b2e61d" title=" " alt="" coords="494,70,578,95"/>
<area shape="poly" title=" " alt="" coords="380,89,480,83,480,88,380,94"/>
<area shape="poly" title=" " alt="" coords="578,79,1142,60,1143,65,578,84"/>
<area shape="poly" title=" " alt="" coords="579,89,708,115,707,120,578,94"/>
</map>
</div>

</div>
</div>
<a id="aa1041f9ed06a9d0b6b738621c30e1921" name="aa1041f9ed06a9d0b6b738621c30e1921"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa1041f9ed06a9d0b6b738621c30e1921">&#9670;&#160;</a></span>TickUpdate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::TickUpdate </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>更新系统 tick </p>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright The SimpleKernel Contributors </dd></dl>

<p class="definition">Definition at line <a class="el" href="tick__update_8cpp_source.html#l00008">8</a> of file <a class="el" href="tick__update_8cpp_source.html">tick_update.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">    8</span>                             {</div>
<div class="line"><span class="lineno">    9</span>  <span class="keyword">auto</span>&amp; cpu_sched = <a class="code hl_function" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11">GetCurrentCpuSched</a>();</div>
<div class="line"><span class="lineno">   10</span> </div>
<div class="line"><span class="lineno">   11</span>  <span class="keywordtype">bool</span> need_preempt = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">   12</span> </div>
<div class="line"><span class="lineno">   13</span>  {</div>
<div class="line"><span class="lineno">   14</span>    <a class="code hl_class" href="classLockGuard.html">LockGuard&lt;SpinLock&gt;</a> lock_guard(cpu_sched.lock);</div>
<div class="line"><span class="lineno">   15</span> </div>
<div class="line"><span class="lineno">   16</span>    <span class="comment">// 递增本核心的 tick 计数</span></div>
<div class="line"><span class="lineno">   17</span>    cpu_sched.local_tick++;</div>
<div class="line"><span class="lineno">   18</span> </div>
<div class="line"><span class="lineno">   19</span>    <span class="keyword">auto</span>* current = <a class="code hl_function" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0">GetCurrentTask</a>();</div>
<div class="line"><span class="lineno">   20</span> </div>
<div class="line"><span class="lineno">   21</span>    <span class="comment">// 唤醒睡眠队列中到时间的任务</span></div>
<div class="line"><span class="lineno">   22</span>    <span class="keywordflow">while</span> (!cpu_sched.sleeping_tasks.empty()) {</div>
<div class="line"><span class="lineno">   23</span>      <span class="keyword">auto</span>* task = cpu_sched.sleeping_tasks.top();</div>
<div class="line"><span class="lineno">   24</span> </div>
<div class="line"><span class="lineno">   25</span>      <span class="comment">// 检查是否到达唤醒时间</span></div>
<div class="line"><span class="lineno">   26</span>      <span class="keywordflow">if</span> (task-&gt;sched_info.wake_tick &gt; cpu_sched.local_tick) {</div>
<div class="line"><span class="lineno">   27</span>        <span class="comment">// sleeping_tasks 是一个 priority_queue，只需要检查队首元素</span></div>
<div class="line"><span class="lineno">   28</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   29</span>      }</div>
<div class="line"><span class="lineno">   30</span> </div>
<div class="line"><span class="lineno">   31</span>      <span class="comment">// 唤醒任务</span></div>
<div class="line"><span class="lineno">   32</span>      cpu_sched.sleeping_tasks.pop();</div>
<div class="line"><span class="lineno">   33</span>      task-&gt;status = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a7f1984e27dfac1310a3ac5c981abf863">TaskStatus::kReady</a>;</div>
<div class="line"><span class="lineno">   34</span> </div>
<div class="line"><span class="lineno">   35</span>      <span class="comment">// 将任务重新加入对应调度器的就绪队列</span></div>
<div class="line"><span class="lineno">   36</span>      <span class="keyword">auto</span>* scheduler = cpu_sched.schedulers[task-&gt;policy];</div>
<div class="line"><span class="lineno">   37</span>      <span class="keywordflow">if</span> (scheduler) {</div>
<div class="line"><span class="lineno">   38</span>        scheduler-&gt;Enqueue(task);</div>
<div class="line"><span class="lineno">   39</span>      }</div>
<div class="line"><span class="lineno">   40</span>    }</div>
<div class="line"><span class="lineno">   41</span> </div>
<div class="line"><span class="lineno">   42</span>    <span class="comment">// 更新当前任务的统计信息</span></div>
<div class="line"><span class="lineno">   43</span>    <span class="keywordflow">if</span> (current &amp;&amp; current-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f">TaskStatus::kRunning</a>) {</div>
<div class="line"><span class="lineno">   44</span>      <span class="comment">// 更新总运行时间</span></div>
<div class="line"><span class="lineno">   45</span>      current-&gt;sched_info.total_runtime++;</div>
<div class="line"><span class="lineno">   46</span> </div>
<div class="line"><span class="lineno">   47</span>      <span class="comment">// 减少剩余时间片</span></div>
<div class="line"><span class="lineno">   48</span>      <span class="keywordflow">if</span> (current-&gt;sched_info.time_slice_remaining &gt; 0) {</div>
<div class="line"><span class="lineno">   49</span>        current-&gt;sched_info.time_slice_remaining--;</div>
<div class="line"><span class="lineno">   50</span>      }</div>
<div class="line"><span class="lineno">   51</span> </div>
<div class="line"><span class="lineno">   52</span>      <span class="comment">// 调用调度器的 OnTick，检查是否需要抢占</span></div>
<div class="line"><span class="lineno">   53</span>      <span class="keyword">auto</span>* scheduler = cpu_sched.schedulers[current-&gt;policy];</div>
<div class="line"><span class="lineno">   54</span> </div>
<div class="line"><span class="lineno">   55</span>      <span class="keywordflow">if</span> (scheduler) {</div>
<div class="line"><span class="lineno">   56</span>        <span class="comment">// 调度器可能基于自己的策略决定是否抢占</span></div>
<div class="line"><span class="lineno">   57</span>        need_preempt = scheduler-&gt;OnTick(current);</div>
<div class="line"><span class="lineno">   58</span>      }</div>
<div class="line"><span class="lineno">   59</span> </div>
<div class="line"><span class="lineno">   60</span>      <span class="comment">// 检查时间片是否耗尽（对于基于时间片的调度器）</span></div>
<div class="line"><span class="lineno">   61</span>      <span class="keywordflow">if</span> (!need_preempt &amp;&amp; current-&gt;sched_info.time_slice_remaining == 0) {</div>
<div class="line"><span class="lineno">   62</span>        need_preempt = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">   63</span>      }</div>
<div class="line"><span class="lineno">   64</span>    }</div>
<div class="line"><span class="lineno">   65</span>  }</div>
<div class="line"><span class="lineno">   66</span> </div>
<div class="line"><span class="lineno">   67</span>  <span class="comment">// 如果需要抢占，触发调度</span></div>
<div class="line"><span class="lineno">   68</span>  <span class="keywordflow">if</span> (need_preempt) {</div>
<div class="line"><span class="lineno">   69</span>    <a class="code hl_function" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78">Schedule</a>();</div>
<div class="line"><span class="lineno">   70</span>  }</div>
<div class="line"><span class="lineno">   71</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_aa1041f9ed06a9d0b6b738621c30e1921_cgraph.png" border="0" usemap="#aclassTaskManager_aa1041f9ed06a9d0b6b738621c30e1921_cgraph" alt=""/></div>
<map name="aclassTaskManager_aa1041f9ed06a9d0b6b738621c30e1921_cgraph" id="aclassTaskManager_aa1041f9ed06a9d0b6b738621c30e1921_cgraph">
<area shape="rect" title="更新系统 tick" alt="" coords="5,83,196,109"/>
<area shape="rect" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11" title="获取当前核心的调度数据" alt="" coords="469,5,681,45"/>
<area shape="poly" title=" " alt="" coords="170,81,244,68,455,38,455,43,244,73,171,86"/>
<area shape="rect" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0" title="获取当前任务" alt="" coords="467,171,683,197"/>
<area shape="poly" title=" " alt="" coords="171,106,492,166,491,171,170,111"/>
<area shape="rect" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78" title="调度函数 选择下一个任务并切换上下文" alt="" coords="244,83,419,109"/>
<area shape="poly" title=" " alt="" coords="196,93,230,93,230,99,196,99"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="961,19,1147,45"/>
<area shape="poly" title=" " alt="" coords="681,24,948,28,948,33,681,29"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="1195,37,1457,77"/>
<area shape="poly" title=" " alt="" coords="1147,38,1181,41,1180,46,1147,43"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="731,121,913,146"/>
<area shape="poly" title=" " alt="" coords="637,169,745,146,746,151,638,174"/>
<area shape="poly" title=" " alt="" coords="851,118,1010,48,1012,53,853,123"/>
<area shape="poly" title=" " alt="" coords="375,81,491,47,493,52,377,86"/>
<area shape="poly" title=" " alt="" coords="362,106,468,149,514,165,513,170,466,155,360,111"/>
<area shape="poly" title=" " alt="" coords="419,101,467,105,717,124,717,129,466,111,419,107"/>
<area shape="rect" href="arch_8cpp.html#ad982abdb7f3d8729656c6b5422b2e61d" title=" " alt="" coords="533,70,617,95"/>
<area shape="poly" title=" " alt="" coords="419,89,519,83,519,88,419,94"/>
<area shape="poly" title=" " alt="" coords="617,79,1181,60,1181,65,617,84"/>
<area shape="poly" title=" " alt="" coords="617,89,746,115,745,120,616,94"/>
</map>
</div>

</div>
</div>
<a id="aadc206ac53400212078270833533f247" name="aadc206ac53400212078270833533f247"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aadc206ac53400212078270833533f247">&#9670;&#160;</a></span>Wait()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected</a>&lt; <a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> &gt; TaskManager::Wait </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a>&#160;</td>
          <td class="paramname"><em>pid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>status</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>no_hang</em> = <code>false</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>untraced</em> = <code>false</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>等待子进程退出 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pid</td><td>子进程 PID (-1 表示任意子进程，0 表示同组，&gt;0 表示指定进程) </td></tr>
    <tr><td class="paramname">status</td><td>退出状态存储位置 (可为 nullptr) </td></tr>
    <tr><td class="paramname">no_hang</td><td>非阻塞等待，立即返回 (类似 WNOHANG) </td></tr>
    <tr><td class="paramname">untraced</td><td>报告已停止的子进程 (类似 WUNTRACED) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Expected&lt;Pid&gt; 成功返回子进程 PID，无子进程或被中断返回错误</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright The SimpleKernel Contributors </dd></dl>

<p class="definition">Definition at line <a class="el" href="wait_8cpp_source.html#l00011">11</a> of file <a class="el" href="wait_8cpp_source.html">wait.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   12</span>                                               {</div>
<div class="line"><span class="lineno">   13</span>  <span class="keyword">auto</span>* current = <a class="code hl_function" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0">GetCurrentTask</a>();</div>
<div class="line"><span class="lineno">   14</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(current != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;Wait: No current task&quot;</span>);</div>
<div class="line"><span class="lineno">   15</span>  <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(current-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a24f35cf992cb19498f5a83aa6cadfa8f">TaskStatus::kRunning</a>,</div>
<div class="line"><span class="lineno">   16</span>                <span class="stringliteral">&quot;Wait: current task status must be kRunning&quot;</span>);</div>
<div class="line"><span class="lineno">   17</span> </div>
<div class="line"><span class="lineno">   18</span>  <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line"><span class="lineno">   19</span>    <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* target = <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">   20</span> </div>
<div class="line"><span class="lineno">   21</span>    {</div>
<div class="line"><span class="lineno">   22</span>      <a class="code hl_class" href="classLockGuard.html">LockGuard</a> lock_guard(<a class="code hl_variable" href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">task_table_lock_</a>);</div>
<div class="line"><span class="lineno">   23</span> </div>
<div class="line"><span class="lineno">   24</span>      <span class="comment">// 遍历任务表寻找符合条件的子进程</span></div>
<div class="line"><span class="lineno">   25</span>      <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; [task_pid, task] : <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>) {</div>
<div class="line"><span class="lineno">   26</span>        <span class="comment">// 检查是否是当前进程的子进程</span></div>
<div class="line"><span class="lineno">   27</span>        <span class="keywordtype">bool</span> is_child = (task-&gt;parent_pid == current-&gt;pid);</div>
<div class="line"><span class="lineno">   28</span> </div>
<div class="line"><span class="lineno">   29</span>        <span class="comment">// 检查 PID 匹配条件</span></div>
<div class="line"><span class="lineno">   30</span>        <span class="keywordtype">bool</span> pid_match = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">   31</span>        <span class="keywordflow">if</span> (pid == <span class="keyword">static_cast&lt;</span><a class="code hl_typedef" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a><span class="keyword">&gt;</span>(-1)) {</div>
<div class="line"><span class="lineno">   32</span>          <span class="comment">// 等待任意子进程</span></div>
<div class="line"><span class="lineno">   33</span>          pid_match = is_child;</div>
<div class="line"><span class="lineno">   34</span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid == 0) {</div>
<div class="line"><span class="lineno">   35</span>          <span class="comment">// 等待同进程组的任意子进程</span></div>
<div class="line"><span class="lineno">   36</span>          pid_match = is_child &amp;&amp; (task-&gt;pgid == current-&gt;pgid);</div>
<div class="line"><span class="lineno">   37</span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid &gt; 0) {</div>
<div class="line"><span class="lineno">   38</span>          <span class="comment">// 等待指定 PID 的子进程</span></div>
<div class="line"><span class="lineno">   39</span>          pid_match = is_child &amp;&amp; (task-&gt;pid == pid);</div>
<div class="line"><span class="lineno">   40</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">   41</span>          <span class="comment">// pid &lt; -1: 等待进程组 ID 为 |pid| 的任意子进程</span></div>
<div class="line"><span class="lineno">   42</span>          pid_match = is_child &amp;&amp; (task-&gt;pgid == <span class="keyword">static_cast&lt;</span><a class="code hl_typedef" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a><span class="keyword">&gt;</span>(-pid));</div>
<div class="line"><span class="lineno">   43</span>        }</div>
<div class="line"><span class="lineno">   44</span> </div>
<div class="line"><span class="lineno">   45</span>        <span class="keywordflow">if</span> (!pid_match) {</div>
<div class="line"><span class="lineno">   46</span>          <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">   47</span>        }</div>
<div class="line"><span class="lineno">   48</span> </div>
<div class="line"><span class="lineno">   49</span>        <span class="comment">// 检查任务状态</span></div>
<div class="line"><span class="lineno">   50</span>        <span class="keywordflow">if</span> (task-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2ae5bcea9577cc11324251f070f1e12f7c">TaskStatus::kZombie</a> ||</div>
<div class="line"><span class="lineno">   51</span>            task-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a829e9a9be95f71d0db69307258a97722">TaskStatus::kExited</a>) {</div>
<div class="line"><span class="lineno">   52</span>          target = task;</div>
<div class="line"><span class="lineno">   53</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   54</span>        }</div>
<div class="line"><span class="lineno">   55</span> </div>
<div class="line"><span class="lineno">   56</span>        <span class="comment">// untraced: 报告已停止的子进程</span></div>
<div class="line"><span class="lineno">   57</span>        <span class="keywordflow">if</span> (untraced &amp;&amp; task-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a825228abe8e14b673f73133b36daf2dc">TaskStatus::kBlocked</a>) {</div>
<div class="line"><span class="lineno">   58</span>          <span class="keywordflow">if</span> (status) {</div>
<div class="line"><span class="lineno">   59</span>            <span class="comment">// 表示停止状态</span></div>
<div class="line"><span class="lineno">   60</span>            *status = 0;</div>
<div class="line"><span class="lineno">   61</span>          }</div>
<div class="line"><span class="lineno">   62</span>          <span class="keywordflow">return</span> task-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>;</div>
<div class="line"><span class="lineno">   63</span>        }</div>
<div class="line"><span class="lineno">   64</span>      }</div>
<div class="line"><span class="lineno">   65</span>    }</div>
<div class="line"><span class="lineno">   66</span> </div>
<div class="line"><span class="lineno">   67</span>    <span class="comment">// 找到了退出的子进程</span></div>
<div class="line"><span class="lineno">   68</span>    <span class="keywordflow">if</span> (target) {</div>
<div class="line"><span class="lineno">   69</span>      <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(target-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">status</a> == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2ae5bcea9577cc11324251f070f1e12f7c">TaskStatus::kZombie</a> ||</div>
<div class="line"><span class="lineno">   70</span>                        target-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a0ce7d1d1287b24fe59df20cdff362fea">status</a> == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a829e9a9be95f71d0db69307258a97722">TaskStatus::kExited</a>,</div>
<div class="line"><span class="lineno">   71</span>                    <span class="stringliteral">&quot;Wait: target task must be kZombie or kExited&quot;</span>);</div>
<div class="line"><span class="lineno">   72</span>      <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(target-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a9ba9b0da6c408d7b4ef9e9e6637f0556">parent_pid</a> == current-&gt;pid,</div>
<div class="line"><span class="lineno">   73</span>                    <span class="stringliteral">&quot;Wait: target parent_pid must match current pid&quot;</span>);</div>
<div class="line"><span class="lineno">   74</span> </div>
<div class="line"><span class="lineno">   75</span>      <a class="code hl_typedef" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> result_pid = target-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>;</div>
<div class="line"><span class="lineno">   76</span> </div>
<div class="line"><span class="lineno">   77</span>      <span class="comment">// 返回退出状态</span></div>
<div class="line"><span class="lineno">   78</span>      <span class="keywordflow">if</span> (status) {</div>
<div class="line"><span class="lineno">   79</span>        *status = target-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a8bbeb5cef9a8125fee0b15a471a511ea">exit_code</a>;</div>
<div class="line"><span class="lineno">   80</span>      }</div>
<div class="line"><span class="lineno">   81</span> </div>
<div class="line"><span class="lineno">   82</span>      <span class="comment">// 清理僵尸进程</span></div>
<div class="line"><span class="lineno">   83</span>      {</div>
<div class="line"><span class="lineno">   84</span>        <a class="code hl_class" href="classLockGuard.html">LockGuard</a> lock_guard(<a class="code hl_variable" href="classTaskManager.html#af14711655dcdd45271bfcd36d30c435d">task_table_lock_</a>);</div>
<div class="line"><span class="lineno">   85</span>        <span class="keyword">auto</span> it = <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>.find(target-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>);</div>
<div class="line"><span class="lineno">   86</span>        <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(it != <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>.end(),</div>
<div class="line"><span class="lineno">   87</span>                      <span class="stringliteral">&quot;Wait: target must exist in task_table&quot;</span>);</div>
<div class="line"><span class="lineno">   88</span>        <a class="code hl_variable" href="classTaskManager.html#abc5030703356936b612fec5dd4c91c5b">task_table_</a>.erase(it-&gt;first);</div>
<div class="line"><span class="lineno">   89</span>      }</div>
<div class="line"><span class="lineno">   90</span> </div>
<div class="line"><span class="lineno">   91</span>      <span class="keyword">delete</span> target;</div>
<div class="line"><span class="lineno">   92</span> </div>
<div class="line"><span class="lineno">   93</span>      <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Wait: pid=%zu reaped child=%zu\n&quot;</span>, current-&gt;pid, result_pid);</div>
<div class="line"><span class="lineno">   94</span>      <span class="keywordflow">return</span> result_pid;</div>
<div class="line"><span class="lineno">   95</span>    }</div>
<div class="line"><span class="lineno">   96</span> </div>
<div class="line"><span class="lineno">   97</span>    <span class="comment">// 如果设置了 no_hang，立即返回</span></div>
<div class="line"><span class="lineno">   98</span>    <span class="keywordflow">if</span> (no_hang) {</div>
<div class="line"><span class="lineno">   99</span>      <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  100</span>    }</div>
<div class="line"><span class="lineno">  101</span> </div>
<div class="line"><span class="lineno">  102</span>    <span class="comment">// 没有找到符合条件的子进程，阻塞等待</span></div>
<div class="line"><span class="lineno">  103</span>    <span class="comment">// 使用 ChildExit 类型的资源 ID，数据部分是当前进程的 PID</span></div>
<div class="line"><span class="lineno">  104</span>    <span class="keyword">auto</span> wait_resource_id = <a class="code hl_struct" href="structResourceId.html">ResourceId</a>(<a class="code hl_enumvalue" href="resource__id_8hpp.html#aeea667e01168927f6d83af2e203019bca7860d40e5c60ade25095b42e09306cc8">ResourceType::kChildExit</a>, current-&gt;pid);</div>
<div class="line"><span class="lineno">  105</span> </div>
<div class="line"><span class="lineno">  106</span>    <a class="code hl_function" href="classTaskManager.html#a71763ebababa9aa90bad6a07c66edede">Block</a>(wait_resource_id);</div>
<div class="line"><span class="lineno">  107</span> </div>
<div class="line"><span class="lineno">  108</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Wait: pid=%zu blocked on resource=%s, data=%zu\n&quot;</span>,</div>
<div class="line"><span class="lineno">  109</span>                current-&gt;pid, wait_resource_id.GetTypeName(),</div>
<div class="line"><span class="lineno">  110</span>                wait_resource_id.GetData());</div>
<div class="line"><span class="lineno">  111</span> </div>
<div class="line"><span class="lineno">  112</span>    <span class="comment">// 被唤醒后重新检查</span></div>
<div class="line"><span class="lineno">  113</span>  }</div>
<div class="line"><span class="lineno">  114</span>}</div>
<div class="ttc" id="aclassTaskManager_html_a71763ebababa9aa90bad6a07c66edede"><div class="ttname"><a href="classTaskManager.html#a71763ebababa9aa90bad6a07c66edede">TaskManager::Block</a></div><div class="ttdeci">void Block(ResourceId resource_id)</div><div class="ttdoc">阻塞当前任务</div><div class="ttdef"><b>Definition</b> <a href="block_8cpp_source.html#l00010">block.cpp:10</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_a8bbeb5cef9a8125fee0b15a471a511ea"><div class="ttname"><a href="structTaskControlBlock.html#a8bbeb5cef9a8125fee0b15a471a511ea">TaskControlBlock::exit_code</a></div><div class="ttdeci">int exit_code</div><div class="ttdoc">退出码</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00124">task_control_block.hpp:124</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_a9ba9b0da6c408d7b4ef9e9e6637f0556"><div class="ttname"><a href="structTaskControlBlock.html#a9ba9b0da6c408d7b4ef9e9e6637f0556">TaskControlBlock::parent_pid</a></div><div class="ttdeci">Pid parent_pid</div><div class="ttdoc">父线程 ID</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00104">task_control_block.hpp:104</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_aadc206ac53400212078270833533f247_cgraph.png" border="0" usemap="#aclassTaskManager_aadc206ac53400212078270833533f247_cgraph" alt=""/></div>
<map name="aclassTaskManager_aadc206ac53400212078270833533f247_cgraph" id="aclassTaskManager_aadc206ac53400212078270833533f247_cgraph">
<area shape="rect" title="等待子进程退出" alt="" coords="5,268,151,293"/>
<area shape="rect" href="classTaskManager.html#a71763ebababa9aa90bad6a07c66edede" title="阻塞当前任务" alt="" coords="199,192,351,217"/>
<area shape="poly" title=" " alt="" coords="111,265,227,220,229,225,113,270"/>
<area shape="rect" href="classTaskManager.html#a926010fadc0b0d1f1df608c59d4a57a0" title="获取当前任务" alt="" coords="641,271,857,296"/>
<area shape="poly" title=" " alt="" coords="151,287,350,304,472,307,593,303,663,295,663,301,594,309,472,313,350,309,151,292"/>
<area shape="rect" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11" title="获取当前核心的调度数据" alt="" coords="643,105,855,145"/>
<area shape="poly" title=" " alt="" coords="301,189,345,170,398,153,517,133,630,124,630,129,517,138,399,158,347,175,303,194"/>
<area shape="poly" title=" " alt="" coords="351,214,594,254,662,266,661,271,593,259,351,219"/>
<area shape="rect" href="structResourceId.html#ad6b4733a8896d35652c1969f1eca1651" title="获取资源数据" alt="" coords="418,268,574,293"/>
<area shape="poly" title=" " alt="" coords="312,215,400,246,444,261,442,266,398,251,310,220"/>
<area shape="rect" href="structResourceId.html#ace28b59e657c4a031a54daabf85e59aa" title="获取类型名称（用于调试）" alt="" coords="399,55,593,80"/>
<area shape="poly" title=" " alt="" coords="288,190,334,150,397,105,444,83,446,87,400,110,338,154,291,194"/>
<area shape="rect" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78" title="调度函数 选择下一个任务并切换上下文" alt="" coords="409,167,583,192"/>
<area shape="poly" title=" " alt="" coords="351,193,395,188,395,194,352,199"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="1136,119,1321,144"/>
<area shape="poly" title=" " alt="" coords="856,123,1122,127,1122,133,856,129"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="1369,137,1632,177"/>
<area shape="poly" title=" " alt="" coords="1322,137,1356,140,1355,146,1321,143"/>
<area shape="rect" href="namespaceper__cpu.html#ad9745465fefcd58504031bfcfcc1c13f" title=" " alt="" coords="905,220,1088,245"/>
<area shape="poly" title=" " alt="" coords="812,268,920,246,921,251,813,273"/>
<area shape="poly" title=" " alt="" coords="1026,217,1185,147,1187,152,1028,222"/>
<area shape="rect" href="resource__id_8hpp.html#afd66b2606db93ecfaf8b3972a9b953ad" title="获取资源类型的字符串表示（用于调试）" alt="" coords="662,5,837,31"/>
<area shape="poly" title=" " alt="" coords="561,52,669,31,670,36,562,57"/>
<area shape="rect" href="structResourceId.html#adc2ead50d28fd71ff0c0d9b2529af45c" title="获取资源类型" alt="" coords="672,55,827,80"/>
<area shape="poly" title=" " alt="" coords="594,65,658,65,658,70,594,70"/>
<area shape="poly" title=" " alt="" coords="555,164,642,145,643,150,556,169"/>
<area shape="poly" title=" " alt="" coords="548,190,595,209,619,230,629,239,643,249,679,264,677,269,640,254,625,243,615,233,592,214,546,195"/>
<area shape="poly" title=" " alt="" coords="555,189,642,205,772,218,892,226,892,231,771,223,641,210,554,195"/>
<area shape="rect" href="arch_8cpp.html#ad982abdb7f3d8729656c6b5422b2e61d" title=" " alt="" coords="707,169,791,195"/>
<area shape="poly" title=" " alt="" coords="584,178,694,179,694,184,584,183"/>
<area shape="poly" title=" " alt="" coords="791,178,1356,159,1356,164,792,183"/>
<area shape="poly" title=" " alt="" coords="792,188,921,215,920,220,791,193"/>
</map>
</div>

</div>
</div>
<a id="aecc6edadfbd8fd250db72884b1e23f93" name="aecc6edadfbd8fd250db72884b1e23f93"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aecc6edadfbd8fd250db72884b1e23f93">&#9670;&#160;</a></span>Wakeup()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TaskManager::Wakeup </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structResourceId.html">ResourceId</a>&#160;</td>
          <td class="paramname"><em>resource_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>唤醒等待指定资源的所有任务 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">resource_id</td><td>资源 ID </td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>会唤醒所有阻塞在此资源上的任务</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright The SimpleKernel Contributors </dd></dl>

<p class="definition">Definition at line <a class="el" href="wakeup_8cpp_source.html#l00010">10</a> of file <a class="el" href="wakeup_8cpp_source.html">wakeup.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   10</span>                                               {</div>
<div class="line"><span class="lineno">   11</span>  <span class="keyword">auto</span>&amp; cpu_sched = <a class="code hl_function" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11">GetCurrentCpuSched</a>();</div>
<div class="line"><span class="lineno">   12</span> </div>
<div class="line"><span class="lineno">   13</span>  <a class="code hl_class" href="classLockGuard.html">LockGuard&lt;SpinLock&gt;</a> lock_guard(cpu_sched.lock);</div>
<div class="line"><span class="lineno">   14</span> </div>
<div class="line"><span class="lineno">   15</span>  <span class="comment">// 查找等待该资源的任务列表</span></div>
<div class="line"><span class="lineno">   16</span>  <span class="keyword">auto</span> it = cpu_sched.blocked_tasks.find(resource_id);</div>
<div class="line"><span class="lineno">   17</span> </div>
<div class="line"><span class="lineno">   18</span>  <span class="keywordflow">if</span> (it == cpu_sched.blocked_tasks.end()) {</div>
<div class="line"><span class="lineno">   19</span>    <span class="comment">// 没有任务等待该资源</span></div>
<div class="line"><span class="lineno">   20</span>    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Wakeup: No tasks waiting on resource=%s, data=0x%lx\n&quot;</span>,</div>
<div class="line"><span class="lineno">   21</span>                resource_id.<a class="code hl_function" href="structResourceId.html#ace28b59e657c4a031a54daabf85e59aa">GetTypeName</a>(), resource_id.<a class="code hl_function" href="structResourceId.html#ad6b4733a8896d35652c1969f1eca1651">GetData</a>());</div>
<div class="line"><span class="lineno">   22</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">   23</span>  }</div>
<div class="line"><span class="lineno">   24</span> </div>
<div class="line"><span class="lineno">   25</span>  <span class="comment">// 唤醒所有等待该资源的任务</span></div>
<div class="line"><span class="lineno">   26</span>  <span class="keyword">auto</span>&amp; waiting_tasks = it-&gt;second;</div>
<div class="line"><span class="lineno">   27</span>  <span class="keywordtype">size_t</span> wakeup_count = 0;</div>
<div class="line"><span class="lineno">   28</span> </div>
<div class="line"><span class="lineno">   29</span>  <span class="keywordflow">while</span> (!waiting_tasks.empty()) {</div>
<div class="line"><span class="lineno">   30</span>    <span class="keyword">auto</span>* task = waiting_tasks.front();</div>
<div class="line"><span class="lineno">   31</span>    waiting_tasks.pop_front();</div>
<div class="line"><span class="lineno">   32</span> </div>
<div class="line"><span class="lineno">   33</span>    <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(task-&gt;status == <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a825228abe8e14b673f73133b36daf2dc">TaskStatus::kBlocked</a>,</div>
<div class="line"><span class="lineno">   34</span>                  <span class="stringliteral">&quot;Wakeup: task status must be kBlocked&quot;</span>);</div>
<div class="line"><span class="lineno">   35</span>    <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(task-&gt;blocked_on == resource_id,</div>
<div class="line"><span class="lineno">   36</span>                  <span class="stringliteral">&quot;Wakeup: task blocked_on must match resource_id&quot;</span>);</div>
<div class="line"><span class="lineno">   37</span> </div>
<div class="line"><span class="lineno">   38</span>    <span class="comment">// 将任务标记为就绪</span></div>
<div class="line"><span class="lineno">   39</span>    task-&gt;status = <a class="code hl_enumvalue" href="task__control__block_8hpp.html#a5d987b98f8f913fcd928b7ab94e726a2a7f1984e27dfac1310a3ac5c981abf863">TaskStatus::kReady</a>;</div>
<div class="line"><span class="lineno">   40</span>    task-&gt;blocked_on = <a class="code hl_struct" href="structResourceId.html">ResourceId</a>{};</div>
<div class="line"><span class="lineno">   41</span> </div>
<div class="line"><span class="lineno">   42</span>    <span class="comment">// 将任务重新加入对应调度器的就绪队列</span></div>
<div class="line"><span class="lineno">   43</span>    <span class="keyword">auto</span>* scheduler = cpu_sched.schedulers[task-&gt;policy];</div>
<div class="line"><span class="lineno">   44</span>    <a class="code hl_define" href="sk__assert_8h.html#aca9cc707df79e034b240eaa8596b7e64">sk_assert_msg</a>(scheduler != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;Wakeup: scheduler must not be null&quot;</span>);</div>
<div class="line"><span class="lineno">   45</span>    scheduler-&gt;Enqueue(task);</div>
<div class="line"><span class="lineno">   46</span>    wakeup_count++;</div>
<div class="line"><span class="lineno">   47</span>  }</div>
<div class="line"><span class="lineno">   48</span> </div>
<div class="line"><span class="lineno">   49</span>  <span class="comment">// 移除空的资源队列</span></div>
<div class="line"><span class="lineno">   50</span>  cpu_sched.blocked_tasks.erase(resource_id);</div>
<div class="line"><span class="lineno">   51</span> </div>
<div class="line"><span class="lineno">   52</span>  <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;Wakeup: Woke up %zu tasks from resource=%s, data=0x%lx\n&quot;</span>,</div>
<div class="line"><span class="lineno">   53</span>              wakeup_count, resource_id.<a class="code hl_function" href="structResourceId.html#ace28b59e657c4a031a54daabf85e59aa">GetTypeName</a>(), resource_id.<a class="code hl_function" href="structResourceId.html#ad6b4733a8896d35652c1969f1eca1651">GetData</a>());</div>
<div class="line"><span class="lineno">   54</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_aecc6edadfbd8fd250db72884b1e23f93_cgraph.png" border="0" usemap="#aclassTaskManager_aecc6edadfbd8fd250db72884b1e23f93_cgraph" alt=""/></div>
<map name="aclassTaskManager_aecc6edadfbd8fd250db72884b1e23f93_cgraph" id="aclassTaskManager_aecc6edadfbd8fd250db72884b1e23f93_cgraph">
<area shape="rect" title="唤醒等待指定资源的所有任务" alt="" coords="5,70,172,95"/>
<area shape="rect" href="classTaskManager.html#a4c1b1e56864ca791fe96710270acfc11" title="获取当前核心的调度数据" alt="" coords="220,5,432,45"/>
<area shape="poly" title=" " alt="" coords="141,67,229,46,230,51,143,73"/>
<area shape="rect" href="structResourceId.html#ad6b4733a8896d35652c1969f1eca1651" title="获取资源数据" alt="" coords="248,70,404,95"/>
<area shape="poly" title=" " alt="" coords="172,80,234,80,234,85,172,85"/>
<area shape="rect" href="structResourceId.html#ace28b59e657c4a031a54daabf85e59aa" title="获取类型名称（用于调试）" alt="" coords="229,119,423,145"/>
<area shape="poly" title=" " alt="" coords="151,93,252,114,250,119,150,98"/>
<area shape="rect" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72" title=" " alt="" coords="480,13,665,38"/>
<area shape="poly" title=" " alt="" coords="432,23,466,23,466,28,432,28"/>
<area shape="rect" href="classtest__env_1_1TestEnvironmentState.html#a562424679984595e70361b0dad2ef96d" title="获取当前线程的环境实例指针（供 Mock 层调用）" alt="" coords="713,5,976,45"/>
<area shape="poly" title=" " alt="" coords="666,23,699,23,699,28,666,28"/>
<area shape="rect" href="resource__id_8hpp.html#afd66b2606db93ecfaf8b3972a9b953ad" title="获取资源类型的字符串表示（用于调试）" alt="" coords="485,94,660,119"/>
<area shape="poly" title=" " alt="" coords="423,119,472,114,472,120,424,125"/>
<area shape="rect" href="structResourceId.html#adc2ead50d28fd71ff0c0d9b2529af45c" title="获取资源类型" alt="" coords="495,143,650,169"/>
<area shape="poly" title=" " alt="" coords="424,139,482,145,481,150,423,144"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classTaskManager_aecc6edadfbd8fd250db72884b1e23f93_icgraph.png" border="0" usemap="#aclassTaskManager_aecc6edadfbd8fd250db72884b1e23f93_icgraph" alt=""/></div>
<map name="aclassTaskManager_aecc6edadfbd8fd250db72884b1e23f93_icgraph" id="aclassTaskManager_aecc6edadfbd8fd250db72884b1e23f93_icgraph">
<area shape="rect" title="唤醒等待指定资源的所有任务" alt="" coords="195,5,361,31"/>
<area shape="rect" href="classTaskManager.html#ae3444c55ab7b6ec348a56b596229fc0f" title="退出当前线程" alt="" coords="5,5,147,31"/>
<area shape="poly" title=" " alt="" coords="181,21,147,21,147,15,181,15"/>
</map>
</div>

</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="aaebe944e28d505769c2acc4ce1c8cca5" name="aaebe944e28d505769c2acc4ce1c8cca5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaebe944e28d505769c2acc4ce1c8cca5">&#9670;&#160;</a></span>cpu_schedulers_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::array&lt;<a class="el" href="structCpuSchedData.html">CpuSchedData</a>, SIMPLEKERNEL_MAX_CORE_COUNT&gt; TaskManager::cpu_schedulers_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>每个核心的调度数据 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00195">195</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>

</div>
</div>
<a id="a5d6830c00a3e81dca6d2dc3c5379fc83" name="a5d6830c00a3e81dca6d2dc3c5379fc83"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5d6830c00a3e81dca6d2dc3c5379fc83">&#9670;&#160;</a></span>interrupt_threads_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">sk_std::unordered_map&lt;uint64_t, <a class="el" href="structTaskControlBlock.html">TaskControlBlock</a>*&gt; TaskManager::interrupt_threads_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>中断号 -&gt; 中断线程映射 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00204">204</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>

</div>
</div>
<a id="aa130b9c08feb39a8d8c653fbff4a4fa6" name="aa130b9c08feb39a8d8c653fbff4a4fa6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa130b9c08feb39a8d8c653fbff4a4fa6">&#9670;&#160;</a></span>interrupt_threads_lock_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classSpinLock.html">SpinLock</a> TaskManager::interrupt_threads_lock_ {&quot;interrupt_threads_lock&quot;}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>中断线程相关数据保护锁 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00202">202</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  202</span>{<span class="stringliteral">&quot;interrupt_threads_lock&quot;</span>};</div>
</div><!-- fragment -->
</div>
</div>
<a id="a82c2ca716e81aba77419830f345aaa05" name="a82c2ca716e81aba77419830f345aaa05"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a82c2ca716e81aba77419830f345aaa05">&#9670;&#160;</a></span>interrupt_work_queues_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">sk_std::unordered_map&lt;uint64_t, <a class="el" href="classTaskManager.html#ab0adec238f0d8ec99595bcc3522f8031">InterruptWorkQueue</a>*&gt; TaskManager::interrupt_work_queues_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>中断号 -&gt; 工作队列映射 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00206">206</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>

</div>
</div>
<a id="ae9f12b6fc28eb32b79ded767eb7ea405" name="ae9f12b6fc28eb32b79ded767eb7ea405"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae9f12b6fc28eb32b79ded767eb7ea405">&#9670;&#160;</a></span>kInterruptQueueCapacity</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">constexpr const size_t TaskManager::kInterruptQueueCapacity = 256</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span><span class="mlabel">constexpr</span><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>中断工作队列容量 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00174">174</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>

</div>
</div>
<a id="a64b37b4d49c7ebbf120520759138eafe" name="a64b37b4d49c7ebbf120520759138eafe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a64b37b4d49c7ebbf120520759138eafe">&#9670;&#160;</a></span>pid_allocator</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::atomic&lt;size_t&gt; TaskManager::pid_allocator {1}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>PID 分配器 </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00209">209</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  209</span>{1};</div>
</div><!-- fragment -->
</div>
</div>
<a id="abc5030703356936b612fec5dd4c91c5b" name="abc5030703356936b612fec5dd4c91c5b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abc5030703356936b612fec5dd4c91c5b">&#9670;&#160;</a></span>task_table_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">sk_std::unordered_map&lt;<a class="el" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a>, <a class="el" href="structTaskControlBlock.html">TaskControlBlock</a>*&gt; TaskManager::task_table_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00199">199</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>

</div>
</div>
<a id="af14711655dcdd45271bfcd36d30c435d" name="af14711655dcdd45271bfcd36d30c435d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af14711655dcdd45271bfcd36d30c435d">&#9670;&#160;</a></span>task_table_lock_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classSpinLock.html">SpinLock</a> TaskManager::task_table_lock_ {&quot;task_table_lock&quot;}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>全局任务表 (PID -&gt; TCB 映射) </p>

<p class="definition">Definition at line <a class="el" href="task__manager_8hpp_source.html#l00198">198</a> of file <a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  198</span>{<span class="stringliteral">&quot;task_table_lock&quot;</span>};</div>
</div><!-- fragment -->
</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>/root/src/task/include/<a class="el" href="task__manager_8hpp_source.html">task_manager.hpp</a></li>
<li>/root/src/task/<a class="el" href="block_8cpp_source.html">block.cpp</a></li>
<li>/root/src/task/<a class="el" href="clone_8cpp_source.html">clone.cpp</a></li>
<li>/root/src/task/<a class="el" href="exit_8cpp_source.html">exit.cpp</a></li>
<li>/root/src/task/<a class="el" href="schedule_8cpp_source.html">schedule.cpp</a></li>
<li>/root/src/task/<a class="el" href="sleep_8cpp_source.html">sleep.cpp</a></li>
<li>/root/src/task/<a class="el" href="task__manager_8cpp_source.html">task_manager.cpp</a></li>
<li>/root/src/task/<a class="el" href="tick__update_8cpp_source.html">tick_update.cpp</a></li>
<li>/root/src/task/<a class="el" href="wait_8cpp_source.html">wait.cpp</a></li>
<li>/root/src/task/<a class="el" href="wakeup_8cpp_source.html">wakeup.cpp</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="classTaskManager.html">TaskManager</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
