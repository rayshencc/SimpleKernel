<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: 工具链</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_0___xE5_xB7_xA5_xE5_x85_xB7_xE9_x93_xBE.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">工具链</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a> SimpleKernel 为了保证在各个平台上的可用性，选择了较为通用的工具链，主要分为四个部分：</p>
<ol type="1">
<li><p class="startli"><b>构建系统</b></p>
<p class="startli">使用 CMake 对代码进行管理，同时控制编译选项。支持 CMake Presets 进行预配置管理。</p>
</li>
<li><p class="startli"><b>内核的编译</b></p>
<p class="startli">使用 GCC 工具链进行交叉编译，支持 x86_64、RISC-V 64、AArch64 三种架构。</p>
</li>
<li><p class="startli"><b>模拟器</b></p>
<p class="startli">主要使用 QEMU 作为统一的模拟器，支持所有目标架构。</p>
</li>
<li><p class="startli"><b>辅助工具</b></p>
<p class="startli">包括 Docker 容器化构建、自动化脚本、代码检查工具等。</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md1"></a>
CMake</h1>
<p>SimpleKernel 采用现代化的 CMake 构建系统，具有以下特点：</p>
<h2><a class="anchor" id="autotoc_md2"></a>
1. 主要 CMake 文件</h2>
<ul>
<li><p class="startli">**./CMakeLists.txt**</p>
<p class="startli">项目的根 CMake 文件，设置最小 CMake 版本要求（3.27+），定义项目信息，并通过模块化的方式组织构建配置：</p><ul>
<li>导入项目配置 (<code>project_config</code>)</li>
<li>导入构建函数 (<code>functions</code>)</li>
<li>导入第三方依赖 (<code>3rd</code>)</li>
<li>导入编译配置 (<code>compile_config</code>)</li>
<li>添加子目录 (<code>src/</code>, <code>test/</code>, <code>doc/</code>)</li>
</ul>
</li>
<li><p class="startli">**./src/CMakeLists.txt**</p>
<p class="startli">规定 GCC 的编译选项，指定生成的二进制文件名称，并管理内核各模块的依赖关系。</p>
</li>
<li><p class="startli">**./src/*/CMakeLists.txt**</p>
<p class="startli">各个模块（如驱动、架构相关代码等）的具体编译规则。</p>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
2. CMake Presets 配置</h2>
<p>项目使用 <code>CMakePresets.json</code> 提供预定义的构建配置：</p>
<ul>
<li><b>build_x86_64</b>: x86_64 架构构建配置</li>
<li><b>build_riscv64</b>: RISC-V 64 架构构建配置</li>
<li><b>build_aarch64</b>: AArch64 架构构建配置</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
3. 辅助 CMake 模块</h2>
<p>位于 <code>./cmake/</code> 目录下的模块文件：</p>
<ul>
<li><b>工具链文件</b>: <code>x86_64-gcc.cmake</code>, <code>riscv64-gcc.cmake</code>, <code>aarch64-gcc.cmake</code> - 定义各架构的交叉编译工具链</li>
<li><b>3rd.cmake</b>: 管理第三方依赖库</li>
<li><b>project_config.cmake</b>: 项目配置和变量定义</li>
<li><b>compile_config.cmake</b>: 编译选项和标志配置</li>
<li><b>functions.cmake</b>: 通用 CMake 函数和宏定义</li>
<li><b>replace_kv.cmake</b>: 模板替换功能</li>
<li><b>clang.cmake</b>: Clang 编译器支持</li>
</ul>
<h2><a class="anchor" id="autotoc_md5"></a>
4. 使用方法</h2>
<div class="fragment"><div class="line"># 使用预设配置构建</div>
<div class="line">cmake --preset build_x86_64</div>
<div class="line">cd build_x86_64</div>
<div class="line">make kernel</div>
<div class="line">make run</div>
<div class="line"> </div>
<div class="line"># 或者手动指定配置</div>
<div class="line">cmake -B build_custom -DTARGET_ARCH=x86_64</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
GCC 交叉编译工具链</h1>
<p>SimpleKernel 支持多架构交叉编译，需要根据目标平台配置相应的 GCC 工具链。</p>
<h2><a class="anchor" id="autotoc_md7"></a>
支持的架构</h2>
<ul>
<li><b>x86_64</b>: 64位 x86 架构</li>
<li><b>riscv64</b>: 64位 RISC-V 架构</li>
<li><b>aarch64</b>: 64位 ARM 架构</li>
</ul>
<h2><a class="anchor" id="autotoc_md8"></a>
工具链获取</h2>
<h3><a class="anchor" id="autotoc_md9"></a>
使用预编译工具链（推荐）</h3>
<p><b>RISC-V 工具链</b>:</p><ul>
<li>macOS: <code>brew install riscv64-elf-gcc</code> (通过 <a href="https://github.com/riscv/homebrew-riscv">homebrew-riscv</a>)</li>
<li>Ubuntu: <code>sudo apt install gcc-riscv64-linux-gnu</code></li>
</ul>
<p><b>AArch64 工具链</b>:</p><ul>
<li>从 <a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-a/downloads">ARM Developer</a> 下载</li>
<li>Ubuntu: <code>sudo apt install gcc-aarch64-linux-gnu</code></li>
</ul>
<p><b>x86_64 工具链</b>:</p><ul>
<li>通常使用系统自带的 GCC，或安装 <code>gcc-multilib</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md10"></a>
VS Code 任务集成</h2>
<p>项目提供了预配置的 VS Code 任务，位于 <code>.vscode/tasks.json</code>：</p>
<ul>
<li><b>build_x86_64</b>: 构建 x86_64 内核</li>
<li><b>build_riscv64</b>: 构建 RISC-V 64 内核</li>
<li><b>build_aarch64</b>: 构建 AArch64 内核</li>
<li><b>run_x86_64</b>: 在 QEMU 中运行 x86_64 内核</li>
<li><b>run_riscv64</b>: 在 QEMU 中运行 RISC-V 64 内核</li>
<li><b>run_aarch64</b>: 在 QEMU 中运行 ARM 64 内核</li>
<li><b>debug_x86_64</b>: 在 QEMU 中调试 x86_64 内核</li>
<li><b>debug_riscv64</b>: 在 QEMU 中调试 RISC-V 64 内核</li>
<li><b>debug_aarch64</b>: 在 QEMU 中调试 ARM 64 内核</li>
</ul>
<h1><a class="anchor" id="autotoc_md11"></a>
QEMU 模拟器</h1>
<p>QEMU 是 SimpleKernel 的主要运行环境，支持所有目标架构的模拟。</p>
<h2><a class="anchor" id="autotoc_md12"></a>
安装 QEMU</h2>
<div class="fragment"><div class="line"># Ubuntu/Debian</div>
<div class="line">sudo apt install qemu-system-x86 qemu-system-riscv64 qemu-system-aarch64</div>
<div class="line"> </div>
<div class="line"># macOS</div>
<div class="line">brew install qemu</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md13"></a>
架构支持</h2>
<ul>
<li><b>qemu-system-x86_64</b>: 运行 x86_64 内核</li>
<li><b>qemu-system-riscv64</b>: 运行 RISC-V 64 内核</li>
<li><b>qemu-system-aarch64</b>: 运行 AArch64 内核</li>
</ul>
<h2><a class="anchor" id="autotoc_md14"></a>
运行方式</h2>
<div class="fragment"><div class="line"># 构建并运行</div>
<div class="line">cd build_x86_64</div>
<div class="line">make run</div>
<div class="line"> </div>
<div class="line"># 或者直接使用 VS Code 任务</div>
<div class="line"># 按 Ctrl+Shift+P，选择 &quot;Tasks: Run Task&quot;，然后选择相应的运行任务</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md15"></a>
调试支持</h2>
<p>QEMU 支持 GDB 远程调试：</p>
<div class="fragment"><div class="line"># 启动内核并等待 GDB 连接</div>
<div class="line">make debug</div>
<div class="line"> </div>
<div class="line"># 在另一个终端连接 GDB</div>
<div class="line">gdb bin/kernel.elf</div>
<div class="line">(gdb) target remote localhost:1234</div>
<div class="line">(gdb) continue</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md16"></a>
辅助工具</h1>
<h2><a class="anchor" id="autotoc_md17"></a>
Docker 容器化构建</h2>
<p>项目提供 Docker 支持，确保构建环境的一致性：</p>
<ul>
<li><b>Dockerfile</b>: 定义了包含所有必要工具链的构建镜像</li>
<li>支持所有目标架构的交叉编译</li>
<li>详细使用方法见 <a class="el" href="docker_8md.html">doc/docker.md</a></li>
</ul>
<div class="fragment"><div class="line"># 使用预构建的 Docker 镜像</div>
<div class="line">docker run -it simplekernel/dev</div>
<div class="line"> </div>
<div class="line"># 或从源码构建镜像</div>
<div class="line">docker build -t simplekernel-dev .</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md18"></a>
项目配置工具</h2>
<ul>
<li><p class="startli">**./tools/project_config.h.in**</p>
<p class="startli">项目配置模板文件，用于生成编译时配置头文件。</p>
</li>
<li><p class="startli">**./tools/cppcheck-suppressions.xml**</p>
<p class="startli">CPPCheck 静态代码分析工具的配置文件，定义了要忽略的警告类型。</p>
</li>
<li><p class="startli">**./tools/.pre-commit-config.yaml.in**</p>
<p class="startli">Pre-commit 钩子配置模板，用于自动化代码质量检查。</p>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md19"></a>
架构特定工具</h2>
<p>项目为每个支持的架构提供了专门的工具：</p>
<ul>
<li><b>启动配置</b>: <code>{arch}_boot_scr.txt</code> - 各架构的 U-Boot 启动脚本</li>
<li><b>FIT 镜像模板</b>: <code>{arch}_qemu_virt.its.in</code> - 用于生成可启动镜像的设备树配置</li>
</ul>
<h2><a class="anchor" id="autotoc_md20"></a>
VS Code 集成</h2>
<p>项目完全集成了 VS Code 开发环境：</p>
<ul>
<li>**.vscode/tasks.json**: 预定义的构建和运行任务</li>
<li>**.vscode/launch.json**: 调试配置</li>
<li>**.devcontainer/**: 开发容器配置，支持一键环境搭建</li>
</ul>
<h2><a class="anchor" id="autotoc_md21"></a>
代码质量工具</h2>
<ul>
<li><b>Clang-format</b>: <code>.clang-format</code> 定义代码格式化规则</li>
<li><b>Clang-tidy</b>: <code>.clang-tidy</code> 定义静态代码分析规则</li>
<li><b>CMake-format</b>: <code>.cmake-format.json</code> 定义 CMake 文件格式化规则</li>
</ul>
<h1><a class="anchor" id="autotoc_md22"></a>
相关文档</h1>
<p>关于交叉编译的详细说明：https://wiki.osdev.org/GCC_Cross-Compiler</p>
<p>ARM 工具链：https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-a/downloads</p>
<p>RISC-V 工具链：https://github.com/riscv/riscv-gnu-toolchain</p>
<p>构建系统详细文档：doc/build_system.md</p>
<p>Docker 使用说明：<a class="el" href="md_docker.html">doc/docker.md</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
