<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: 系统启动</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_1___xE7_xB3_xBB_xE7_xBB_x9F_xE5_x90_xAF_xE5_x8A_xA8.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">系统启动</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md23"></a> </p>
<h1><a class="anchor" id="autotoc_md24"></a>
x86_64</h1>
<h2><a class="anchor" id="autotoc_md25"></a>
概述</h2>
<p>x86_64 架构的多核唤醒机制基于 APIC (Advanced Programmable <a class="el" href="classInterrupt.html" title="中断处理">Interrupt</a> Controller) 系统，通过 INIT-SIPI-SIPI 序列来唤醒应用处理器 (Application Processors, APs)。</p>
<h2><a class="anchor" id="autotoc_md26"></a>
关键组件</h2>
<h3><a class="anchor" id="autotoc_md27"></a>
1. APIC 系统</h3>
<ul>
<li><b>Local APIC</b>: 每个 CPU 核心都有一个 Local APIC，负责处理核心间通信</li>
<li><b>IO APIC</b>: 系统级别的中断控制器，处理外部中断</li>
<li><b>支持两种模式</b>:<ul>
<li>xAPIC: 传统模式，通过内存映射访问</li>
<li>x2APIC: 扩展模式，通过 MSR 访问，性能更好</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md28"></a>
2. 核心数据结构</h3>
<p><b>SIPI 参数结构</b> (<code><a class="el" href="sipi_8h.html">src/arch/x86_64/sipi.h</a></code>): </p><div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structsipi__params__t.html">sipi_params_t</a> {</div>
<div class="line">  uint32_t <a class="code hl_variable" href="structsipi__params__t.html#acd63dd6204be72bf6dc528a77e8fa74c">cr3</a>;  <span class="comment">// 页表基地址</span></div>
<div class="line">} <a class="code hl_function" href="include_2sipi_8h.html#a763d4c58430a5a94703eba0ed093d12a">__attribute__</a>((packed));</div>
<div class="ttc" id="ainclude_2sipi_8h_html_a763d4c58430a5a94703eba0ed093d12a"><div class="ttname"><a href="include_2sipi_8h.html#a763d4c58430a5a94703eba0ed093d12a">__attribute__</a></div><div class="ttdeci">struct sipi_params_t __attribute__((packed))</div></div>
<div class="ttc" id="astructsipi__params__t_html"><div class="ttname"><a href="structsipi__params__t.html">sipi_params_t</a></div><div class="ttdef"><b>Definition</b> <a href="include_2sipi_8h_source.html#l00020">sipi.h:20</a></div></div>
<div class="ttc" id="astructsipi__params__t_html_acd63dd6204be72bf6dc528a77e8fa74c"><div class="ttname"><a href="structsipi__params__t.html#acd63dd6204be72bf6dc528a77e8fa74c">sipi_params_t::cr3</a></div><div class="ttdeci">uint32_t cr3</div><div class="ttdef"><b>Definition</b> <a href="include_2sipi_8h_source.html#l00021">sipi.h:21</a></div></div>
</div><!-- fragment --><p><b>Per-CPU 数据</b> (<code><a class="el" href="per__cpu_8hpp.html">src/include/per_cpu.hpp</a></code>): </p><div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_function" href="per__cpu_8hpp.html#af9f69638066e596aabf0ff6f3b58ced9">PerCpu</a> {</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keywordtype">size_t</span> kMaxCoreCount = 4;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> core_id_;</div>
<div class="line">  ssize_t noff_{0};          <span class="comment">// 中断嵌套深度</span></div>
<div class="line">  <span class="keywordtype">bool</span> intr_enable_{<span class="keyword">false</span>};  <span class="comment">// 中断使能状态</span></div>
<div class="line">};</div>
<div class="ttc" id="aper__cpu_8hpp_html_af9f69638066e596aabf0ff6f3b58ced9"><div class="ttname"><a href="per__cpu_8hpp.html#af9f69638066e596aabf0ff6f3b58ced9">PerCpu</a></div><div class="ttdeci">PerCpu()=default</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md29"></a>
多核启动流程</h2>
<h3><a class="anchor" id="autotoc_md30"></a>
1. BSP (Bootstrap Processor) 初始化</h3>
<p>在 <code><a class="el" href="x86__64_2arch__main_8cpp.html">src/arch/x86_64/arch_main.cpp</a></code> 的 <code><a class="el" href="aarch64_2arch__main_8cpp.html#aa26c42c34bbb6c8c7cd4a8664dc7952f">ArchInit()</a></code> 函数中：</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> <a class="code hl_function" href="aarch64_2arch__main_8cpp.html#aa26c42c34bbb6c8c7cd4a8664dc7952f">ArchInit</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **) -&gt; <span class="keywordtype">int</span> {</div>
<div class="line">  <span class="comment">// 1. 初始化串口和基本信息</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;cpu_io::Serial&gt;::GetInstance</a>() = cpu_io::Serial(cpu_io::kCom1);</div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;BasicInfo&gt;::GetInstance</a>() = <a class="code hl_struct" href="structBasicInfo.html">BasicInfo</a>(0, <span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 2. 解析内核 ELF 信息</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelElf&gt;::GetInstance</a>() =</div>
<div class="line">      <a class="code hl_class" href="classKernelElf.html">KernelElf</a>(<a class="code hl_class" href="classSingleton.html">Singleton&lt;BasicInfo&gt;::GetInstance</a>().elf_addr);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 3. 初始化 APIC 系统</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>() =</div>
<div class="line">      <a class="code hl_class" href="classApic.html">Apic</a>(<a class="code hl_class" href="classSingleton.html">Singleton&lt;BasicInfo&gt;::GetInstance</a>().core_count);</div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>().InitCurrentCpuLocalApic();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 4. 填充 SIPI 参数</span></div>
<div class="line">  <span class="keyword">auto</span> target_sipi_params = <span class="keyword">reinterpret_cast&lt;</span><a class="code hl_struct" href="structsipi__params__t.html">sipi_params_t</a> *<span class="keyword">&gt;</span>(<a class="code hl_variable" href="include_2sipi_8h.html#a32702e3ad83c6b6890156c1019d9b212">sipi_params</a>);</div>
<div class="line">  target_sipi_params-&gt;<a class="code hl_variable" href="structsipi__params__t.html#acd63dd6204be72bf6dc528a77e8fa74c">cr3</a> = cpu_io::Cr3::Read();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 5. 唤醒所有 AP</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>().StartupAllAps(</div>
<div class="line">      <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="include_2sipi_8h.html#a07a57de9cb60e2d021c86cad5661685d">ap_start16</a>),</div>
<div class="line">      <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(<a class="code hl_variable" href="include_2sipi_8h.html#a09112885e666deab3901a558c383fa20">ap_start64_end</a>) -</div>
<div class="line">          <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(<a class="code hl_variable" href="include_2sipi_8h.html#a07a57de9cb60e2d021c86cad5661685d">ap_start16</a>),</div>
<div class="line">      <a class="code hl_variable" href="include_2sipi_8h.html#aa69ae5dfed08043489ffa640ffc81521">kDefaultAPBase</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aaarch64_2arch__main_8cpp_html_aa26c42c34bbb6c8c7cd4a8664dc7952f"><div class="ttname"><a href="aarch64_2arch__main_8cpp.html#aa26c42c34bbb6c8c7cd4a8664dc7952f">ArchInit</a></div><div class="ttdeci">void ArchInit(int argc, const char **argv)</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2arch__main_8cpp_source.html#l00047">arch_main.cpp:47</a></div></div>
<div class="ttc" id="aclassApic_html"><div class="ttname"><a href="classApic.html">Apic</a></div><div class="ttdoc">APIC 管理类，管理整个系统的 Local APIC 和 IO APIC.</div><div class="ttdef"><b>Definition</b> <a href="apic_8h_source.html#l00023">apic.h:23</a></div></div>
<div class="ttc" id="aclassKernelElf_html"><div class="ttname"><a href="classKernelElf.html">KernelElf</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__elf_8hpp_source.html#l00023">kernel_elf.hpp:23</a></div></div>
<div class="ttc" id="aclassSingleton_html"><div class="ttname"><a href="classSingleton.html">Singleton</a></div><div class="ttdef"><b>Definition</b> <a href="singleton_8hpp_source.html#l00010">singleton.hpp:10</a></div></div>
<div class="ttc" id="aclassSingleton_html_a68856b49e098eadba37b60366db33ebd"><div class="ttname"><a href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton::GetInstance</a></div><div class="ttdeci">static auto GetInstance() -&gt; T &amp;</div><div class="ttdef"><b>Definition</b> <a href="singleton_8hpp_source.html#l00023">singleton.hpp:23</a></div></div>
<div class="ttc" id="ainclude_2sipi_8h_html_a07a57de9cb60e2d021c86cad5661685d"><div class="ttname"><a href="include_2sipi_8h.html#a07a57de9cb60e2d021c86cad5661685d">ap_start16</a></div><div class="ttdeci">void * ap_start16[]</div><div class="ttdef"><b>Definition</b> <a href="include_2sipi_8h_source.html#l00016">sipi.h:16</a></div></div>
<div class="ttc" id="ainclude_2sipi_8h_html_a09112885e666deab3901a558c383fa20"><div class="ttname"><a href="include_2sipi_8h.html#a09112885e666deab3901a558c383fa20">ap_start64_end</a></div><div class="ttdeci">void * ap_start64_end[]</div><div class="ttdef"><b>Definition</b> <a href="include_2sipi_8h_source.html#l00017">sipi.h:17</a></div></div>
<div class="ttc" id="ainclude_2sipi_8h_html_a32702e3ad83c6b6890156c1019d9b212"><div class="ttname"><a href="include_2sipi_8h.html#a32702e3ad83c6b6890156c1019d9b212">sipi_params</a></div><div class="ttdeci">void * sipi_params[]</div><div class="ttdef"><b>Definition</b> <a href="include_2sipi_8h_source.html#l00018">sipi.h:18</a></div></div>
<div class="ttc" id="ainclude_2sipi_8h_html_aa69ae5dfed08043489ffa640ffc81521"><div class="ttname"><a href="include_2sipi_8h.html#aa69ae5dfed08043489ffa640ffc81521">kDefaultAPBase</a></div><div class="ttdeci">static constexpr uint64_t kDefaultAPBase</div><div class="ttdoc">启动 APs 的默认地址</div><div class="ttdef"><b>Definition</b> <a href="include_2sipi_8h_source.html#l00014">sipi.h:14</a></div></div>
<div class="ttc" id="astructBasicInfo_html"><div class="ttname"><a href="structBasicInfo.html">BasicInfo</a></div><div class="ttdef"><b>Definition</b> <a href="basic__info_8hpp_source.html#l00026">basic_info.hpp:26</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md31"></a>
2. AP 启动代码</h3>
<p>位于 <code>src/arch/x86_64/boot.S</code>，包含完整的模式切换序列：</p>
<p><b>16位实模式启动</b> (<code>ap_start16</code>): </p><div class="fragment"><div class="line">// 关中断，清除 TLB</div>
<div class="line">cli</div>
<div class="line">xor %eax, %eax</div>
<div class="line">mov %eax, %cr3</div>
<div class="line"> </div>
<div class="line">// 加载 GDT 并启用保护模式</div>
<div class="line">mov $gdtdesc, %ebx</div>
<div class="line">sub $ap_start16, %ebx</div>
<div class="line">data32 lgdt (%ebx)</div>
<div class="line"> </div>
<div class="line">mov %cr0, %eax</div>
<div class="line">or $PROTECTION_MODE_BIT,%eax</div>
<div class="line">mov %eax, %cr0</div>
</div><!-- fragment --><p><b>32位保护模式</b> (<code>ap_start32</code>): </p><div class="fragment"><div class="line">// 启用 PAE</div>
<div class="line">mov %cr4, %eax</div>
<div class="line">or $PAE_BIT, %eax</div>
<div class="line">mov %eax, %cr4</div>
<div class="line"> </div>
<div class="line">// 设置页表（使用 BSP 的 CR3）</div>
<div class="line">mov $cr3, %ebx</div>
<div class="line">sub $ap_start16, %ebx</div>
<div class="line">mov (%ebx), %eax</div>
<div class="line">mov %eax, %cr3</div>
<div class="line"> </div>
<div class="line">// 启用长模式</div>
<div class="line">mov $IA32_EFER_MSR, %ecx</div>
<div class="line">rdmsr</div>
<div class="line">or $LONG_MODE_BIT, %eax</div>
<div class="line">wrmsr</div>
<div class="line"> </div>
<div class="line">// 启用分页</div>
<div class="line">mov %cr0, %eax</div>
<div class="line">or $PAGING_BIT, %eax</div>
<div class="line">mov %eax, %cr0</div>
</div><!-- fragment --><p><b>64位长模式</b> (<code>_boot</code>): </p><div class="fragment"><div class="line">// 关中断</div>
<div class="line">cli</div>
<div class="line"> </div>
<div class="line">// 获取 APIC ID 作为 CPU ID</div>
<div class="line">mov $CPUID_LEAF_1, %eax</div>
<div class="line">cpuid</div>
<div class="line">// EBX bits 31-24 是初始 APIC ID</div>
<div class="line">shr $APIC_ID_SHIFT, %ebx</div>
<div class="line">// 保留低 8 位</div>
<div class="line">and $APIC_ID_MASK, %ebx</div>
<div class="line"> </div>
<div class="line">// 根据 CPU ID 设置独立栈</div>
<div class="line">mov %ebx, %eax</div>
<div class="line">mov $STACK_SIZE_PER_CPU, %edx</div>
<div class="line">mul %edx</div>
<div class="line"> </div>
<div class="line">// 计算该 CPU 的栈顶地址</div>
<div class="line">mov $stack_top, %rsp</div>
<div class="line">add %rax, %rsp</div>
<div class="line">add $STACK_SIZE_PER_CPU, %rsp</div>
<div class="line"> </div>
<div class="line">// 跳转到内核入口</div>
<div class="line">call _start</div>
<div class="line">hlt</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md32"></a>
3. INIT-SIPI-SIPI 序列</h3>
<p>在 <code><a class="el" href="local__apic_8cpp.html">src/driver/apic/local_apic.cpp</a></code> 的 <code>WakeupAp()</code> 函数中实现：</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classLocalApic.html#a088e472bc2424550e72bf1155608ecca">LocalApic::WakeupAp</a>(uint32_t destination_apic_id, uint8_t start_vector)<span class="keyword"> const </span>{</div>
<div class="line">  <span class="comment">// 1. 发送 INIT IPI</span></div>
<div class="line">  <a class="code hl_function" href="classLocalApic.html#a6b837d6e2763369280afc50976b1064a">SendInitIpi</a>(destination_apic_id);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 2. 等待 10ms (INIT IPI 后的标准等待时间)</span></div>
<div class="line">  <span class="keyword">auto</span> delay = 10 * <a class="code hl_variable" href="classLocalApic.html#a31b67cb7cf0571d12699fbc517128dab">kCalibrationDelayLoop</a>;</div>
<div class="line">  <span class="keywordflow">while</span> (delay--) { __asm__ <span class="keyword">volatile</span>(<span class="stringliteral">&quot;nop&quot;</span>); }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 3. 发送第一个 SIPI</span></div>
<div class="line">  <a class="code hl_function" href="classLocalApic.html#acd008bf0645ca650746c65287ad109de">SendStartupIpi</a>(destination_apic_id, start_vector);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 4. 等待 200μs (SIPI 后的标准等待时间)</span></div>
<div class="line">  delay = 200 * (<a class="code hl_variable" href="classLocalApic.html#a31b67cb7cf0571d12699fbc517128dab">kCalibrationDelayLoop</a> / 1000);</div>
<div class="line">  <span class="keywordflow">while</span> (delay--) { __asm__ <span class="keyword">volatile</span>(<span class="stringliteral">&quot;nop&quot;</span>); }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 5. 发送第二个 SIPI（提高可靠性）</span></div>
<div class="line">  <a class="code hl_function" href="classLocalApic.html#acd008bf0645ca650746c65287ad109de">SendStartupIpi</a>(destination_apic_id, start_vector);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 6. 等待 200μs</span></div>
<div class="line">  delay = 200 * (<a class="code hl_variable" href="classLocalApic.html#a31b67cb7cf0571d12699fbc517128dab">kCalibrationDelayLoop</a> / 1000);</div>
<div class="line">  <span class="keywordflow">while</span> (delay--) { __asm__ <span class="keyword">volatile</span>(<span class="stringliteral">&quot;nop&quot;</span>); }</div>
<div class="line">}</div>
<div class="ttc" id="aclassLocalApic_html_a088e472bc2424550e72bf1155608ecca"><div class="ttname"><a href="classLocalApic.html#a088e472bc2424550e72bf1155608ecca">LocalApic::WakeupAp</a></div><div class="ttdeci">void WakeupAp(uint32_t destination_apic_id, uint8_t start_vector) const</div><div class="ttdoc">唤醒应用处理器 (AP)</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00431">local_apic.cpp:431</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a31b67cb7cf0571d12699fbc517128dab"><div class="ttname"><a href="classLocalApic.html#a31b67cb7cf0571d12699fbc517128dab">LocalApic::kCalibrationDelayLoop</a></div><div class="ttdeci">static constexpr uint32_t kCalibrationDelayLoop</div><div class="ttdoc">校准延时循环次数</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00227">local_apic.h:227</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a6b837d6e2763369280afc50976b1064a"><div class="ttname"><a href="classLocalApic.html#a6b837d6e2763369280afc50976b1064a">LocalApic::SendInitIpi</a></div><div class="ttdeci">void SendInitIpi(uint32_t destination_apic_id) const</div><div class="ttdoc">发送 INIT IPI</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00247">local_apic.cpp:247</a></div></div>
<div class="ttc" id="aclassLocalApic_html_acd008bf0645ca650746c65287ad109de"><div class="ttname"><a href="classLocalApic.html#acd008bf0645ca650746c65287ad109de">LocalApic::SendStartupIpi</a></div><div class="ttdeci">void SendStartupIpi(uint32_t destination_apic_id, uint8_t start_page) const</div><div class="ttdoc">发送 SIPI (Startup IPI)</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00275">local_apic.cpp:275</a></div></div>
</div><!-- fragment --><p>其中 <code>kCalibrationDelayLoop = 1000000</code> 用于延时校准。</p>
<h3><a class="anchor" id="autotoc_md33"></a>
4. AP 入口处理</h3>
<p>AP 启动后通过 <code><a class="el" href="src_2main_8cpp.html">src/main.cpp</a></code> 的 <code><a class="el" href="kernel_8h.html#a1051fb5b0c9ae8b443c542089ac538bd" title="负责 crtbegin 的工作">_start()</a></code> 函数进入：</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="kernel_8h.html#a1051fb5b0c9ae8b443c542089ac538bd">_start</a>(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> **argv) {</div>
<div class="line">  <span class="keywordflow">if</span> (argv != <span class="keyword">nullptr</span>) {</div>
<div class="line">    <span class="comment">// BSP 路径</span></div>
<div class="line">    <a class="code hl_function" href="sk__libcxx_8h.html#a8c22041b9886ca00cff1e90cd43eb3f2">CppInit</a>();</div>
<div class="line">    <a class="code hl_function" href="tests_2integration__test_2aarch64__minimal_2main_8cpp.html#acdef7a1fd863a6d3770c1268cb06add3">main</a>(argc, argv);</div>
<div class="line">    <a class="code hl_function" href="sk__libcxx_8h.html#ace4b6de6e1ac3081329da66be1b45f76">CppDeInit</a>();</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">// AP 路径</span></div>
<div class="line">    main_smp(argc, argv);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 进入死循环</span></div>
<div class="line">  <span class="keywordflow">while</span> (<span class="keyword">true</span>) { ; }</div>
<div class="line">}</div>
<div class="ttc" id="akernel_8h_html_a1051fb5b0c9ae8b443c542089ac538bd"><div class="ttname"><a href="kernel_8h.html#a1051fb5b0c9ae8b443c542089ac538bd">_start</a></div><div class="ttdeci">void _start(int argc, const char **argv)</div><div class="ttdoc">负责 crtbegin 的工作</div><div class="ttdef"><b>Definition</b> <a href="src_2main_8cpp_source.html#l00134">main.cpp:134</a></div></div>
<div class="ttc" id="ask__libcxx_8h_html_a8c22041b9886ca00cff1e90cd43eb3f2"><div class="ttname"><a href="sk__libcxx_8h.html#a8c22041b9886ca00cff1e90cd43eb3f2">CppInit</a></div><div class="ttdeci">void CppInit()</div><div class="ttdoc">构造 c++ 全局对象</div><div class="ttdef"><b>Definition</b> <a href="sk__libcxx_8cpp_source.html#l00193">sk_libcxx.cpp:193</a></div></div>
<div class="ttc" id="ask__libcxx_8h_html_ace4b6de6e1ac3081329da66be1b45f76"><div class="ttname"><a href="sk__libcxx_8h.html#ace4b6de6e1ac3081329da66be1b45f76">CppDeInit</a></div><div class="ttdeci">void CppDeInit()</div><div class="ttdoc">析构 c++ 全局对象</div><div class="ttdef"><b>Definition</b> <a href="sk__libcxx_8cpp_source.html#l00202">sk_libcxx.cpp:202</a></div></div>
<div class="ttc" id="atests_2integration__test_2aarch64__minimal_2main_8cpp_html_acdef7a1fd863a6d3770c1268cb06add3"><div class="ttname"><a href="tests_2integration__test_2aarch64__minimal_2main_8cpp.html#acdef7a1fd863a6d3770c1268cb06add3">main</a></div><div class="ttdeci">void main()</div><div class="ttdef"><b>Definition</b> <a href="tests_2integration__test_2aarch64__minimal_2main_8cpp_source.html#l00033">main.cpp:33</a></div></div>
</div><!-- fragment --><p>AP 执行 <code>main_smp()</code> -&gt; <code><a class="el" href="aarch64_2arch__main_8cpp.html#ad90b12c5e1b1a5911044c7c1286289da">ArchInitSMP()</a></code> -&gt; <code>InitCurrentCpuLocalApic()</code>：</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> <a class="code hl_function" href="aarch64_2arch__main_8cpp.html#ad90b12c5e1b1a5911044c7c1286289da">ArchInitSMP</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **) -&gt; <span class="keywordtype">int</span> {</div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>().InitCurrentCpuLocalApic();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aaarch64_2arch__main_8cpp_html_ad90b12c5e1b1a5911044c7c1286289da"><div class="ttname"><a href="aarch64_2arch__main_8cpp.html#ad90b12c5e1b1a5911044c7c1286289da">ArchInitSMP</a></div><div class="ttdeci">void ArchInitSMP(int, const char **)</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2arch__main_8cpp_source.html#l00068">arch_main.cpp:68</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md34"></a>
内存布局</h2>
<h3><a class="anchor" id="autotoc_md35"></a>
栈分配</h3>
<p>每个 CPU 分配 4KB 独立栈空间： </p><div class="fragment"><div class="line"><span class="comment">// 每个 CPU 的栈大小：4KB</span></div>
<div class="line"><span class="preprocessor">#define STACK_SIZE_PER_CPU      0x1000</span></div>
<div class="line"><span class="comment">// 最大 CPU 数量</span></div>
<div class="line"><span class="preprocessor">#define MAX_CPU_COUNT           4</span></div>
<div class="line"><span class="comment">// 总栈大小</span></div>
<div class="line"><span class="preprocessor">#define TOTAL_STACK_SIZE        (STACK_SIZE_PER_CPU * MAX_CPU_COUNT)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// CPU ID * 4KB + stack_top 作为该 CPU 的栈顶</span></div>
</div><!-- fragment --><div class="fragment"><div class="line">// 声明所属段</div>
<div class="line">.section .bss</div>
<div class="line">// MAX_CPU_COUNT 个 CPU × STACK_SIZE_PER_CPU 每个 = TOTAL_STACK_SIZE 总栈空间</div>
<div class="line">stack_top:</div>
<div class="line">    .space TOTAL_STACK_SIZE</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md36"></a>
AP 启动代码位置</h3>
<ul>
<li>默认复制到物理地址 <code>0x30000</code> (<code>kDefaultAPBase</code>)</li>
<li>必须在 1MB 以下（实模式限制）</li>
<li>必须 4KB 对齐（SIPI 要求）</li>
</ul>
<h2><a class="anchor" id="autotoc_md37"></a>
APIC 配置</h2>
<h3><a class="anchor" id="autotoc_md38"></a>
Local APIC 初始化</h3>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code hl_function" href="classLocalApic.html#ad94b3e7dc5659cd5bf9378cf9fa308dc">LocalApic::Init</a>() {</div>
<div class="line">  <span class="comment">// 1. 检查并启用 APIC 模式（优先 x2APIC）</span></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code hl_function" href="classLocalApic.html#a3f7b7c00383f231e77c8b33ff340a2f9">EnableX2Apic</a>()) {</div>
<div class="line">    <a class="code hl_variable" href="classLocalApic.html#a4a63c5378da856c2a5f1ea0460a6744e">is_x2apic_mode_</a> = <span class="keyword">true</span>;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code hl_function" href="classLocalApic.html#a385380dd373545bb139e0a36068c46fc">EnableXApic</a>()) {</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code hl_variable" href="classLocalApic.html#a4a63c5378da856c2a5f1ea0460a6744e">is_x2apic_mode_</a> = <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 2. 启用 Local APIC (通过设置 SIVR)</span></div>
<div class="line">  uint32_t sivr = <a class="code hl_variable" href="classLocalApic.html#a4a63c5378da856c2a5f1ea0460a6744e">is_x2apic_mode_</a> ?</div>
<div class="line">      cpu_io::msr::apic::ReadSivr() :</div>
<div class="line">      <a class="code hl_namespace" href="namespaceio.html">io</a>::In&lt;uint32_t&gt;(<a class="code hl_variable" href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">apic_base_</a> + <a class="code hl_variable" href="classLocalApic.html#a2f1b868d6d1f37f3a1e61d23d84cc05b">kXApicSivrOffset</a>);</div>
<div class="line"> </div>
<div class="line">  sivr |= <a class="code hl_variable" href="classLocalApic.html#a2699706a3c2b0dd4b351e4a4890dc679">kApicSoftwareEnableBit</a>;  <span class="comment">// 启用 APIC</span></div>
<div class="line">  sivr |= <a class="code hl_variable" href="classLocalApic.html#a5c5ad4a79967cb4aedf6955ecd1606db">kSpuriousVector</a>;         <span class="comment">// 设置虚假中断向量</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 3. 清除任务优先级</span></div>
<div class="line">  <a class="code hl_function" href="classLocalApic.html#a37c7f90ad3933cce3ca36ff2a6370593">SetTaskPriority</a>(0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 4. 屏蔽所有 LVT 条目</span></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code hl_variable" href="classLocalApic.html#a4a63c5378da856c2a5f1ea0460a6744e">is_x2apic_mode_</a>) {</div>
<div class="line">    cpu_io::msr::apic::WriteLvtTimer(<a class="code hl_variable" href="classLocalApic.html#a6b0f3174fb096b99ee386a0a9c40f933">kLvtMaskBit</a>);</div>
<div class="line">    cpu_io::msr::apic::WriteLvtLint0(<a class="code hl_variable" href="classLocalApic.html#a6b0f3174fb096b99ee386a0a9c40f933">kLvtMaskBit</a>);</div>
<div class="line">    cpu_io::msr::apic::WriteLvtLint1(<a class="code hl_variable" href="classLocalApic.html#a6b0f3174fb096b99ee386a0a9c40f933">kLvtMaskBit</a>);</div>
<div class="line">    cpu_io::msr::apic::WriteLvtError(<a class="code hl_variable" href="classLocalApic.html#a6b0f3174fb096b99ee386a0a9c40f933">kLvtMaskBit</a>);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    io::Out&lt;uint32_t&gt;(<a class="code hl_variable" href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">apic_base_</a> + <a class="code hl_variable" href="classLocalApic.html#aeecdfbc459bb53490b50ef3ff0652c27">kXApicLvtTimerOffset</a>, <a class="code hl_variable" href="classLocalApic.html#a6b0f3174fb096b99ee386a0a9c40f933">kLvtMaskBit</a>);</div>
<div class="line">    io::Out&lt;uint32_t&gt;(<a class="code hl_variable" href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">apic_base_</a> + <a class="code hl_variable" href="classLocalApic.html#a0b0e7fd16a723057766596953363bbf5">kXApicLvtLint0Offset</a>, <a class="code hl_variable" href="classLocalApic.html#a6b0f3174fb096b99ee386a0a9c40f933">kLvtMaskBit</a>);</div>
<div class="line">    io::Out&lt;uint32_t&gt;(<a class="code hl_variable" href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">apic_base_</a> + <a class="code hl_variable" href="classLocalApic.html#a34b2b41f250ef010adfe4c1fe680a53d">kXApicLvtLint1Offset</a>, <a class="code hl_variable" href="classLocalApic.html#a6b0f3174fb096b99ee386a0a9c40f933">kLvtMaskBit</a>);</div>
<div class="line">    io::Out&lt;uint32_t&gt;(<a class="code hl_variable" href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">apic_base_</a> + <a class="code hl_variable" href="classLocalApic.html#a8c7af96d0822ef425029761b383195b5">kXApicLvtErrorOffset</a>, <a class="code hl_variable" href="classLocalApic.html#a6b0f3174fb096b99ee386a0a9c40f933">kLvtMaskBit</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="ttc" id="aclassLocalApic_html_a0b0e7fd16a723057766596953363bbf5"><div class="ttname"><a href="classLocalApic.html#a0b0e7fd16a723057766596953363bbf5">LocalApic::kXApicLvtLint0Offset</a></div><div class="ttdeci">static constexpr uint32_t kXApicLvtLint0Offset</div><div class="ttdoc">LVT LINT0 寄存器偏移</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00171">local_apic.h:171</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a14dea9be5f7231166d31af785352a911"><div class="ttname"><a href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">LocalApic::apic_base_</a></div><div class="ttdeci">uint64_t apic_base_</div><div class="ttdoc">APIC 基地址（仅用于 xAPIC 模式）</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00252">local_apic.h:252</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a2699706a3c2b0dd4b351e4a4890dc679"><div class="ttname"><a href="classLocalApic.html#a2699706a3c2b0dd4b351e4a4890dc679">LocalApic::kApicSoftwareEnableBit</a></div><div class="ttdeci">static constexpr uint32_t kApicSoftwareEnableBit</div><div class="ttdoc">APIC 软件启用位</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00191">local_apic.h:191</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a2f1b868d6d1f37f3a1e61d23d84cc05b"><div class="ttname"><a href="classLocalApic.html#a2f1b868d6d1f37f3a1e61d23d84cc05b">LocalApic::kXApicSivrOffset</a></div><div class="ttdeci">static constexpr uint32_t kXApicSivrOffset</div><div class="ttdoc">虚假中断向量寄存器偏移</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00161">local_apic.h:161</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a34b2b41f250ef010adfe4c1fe680a53d"><div class="ttname"><a href="classLocalApic.html#a34b2b41f250ef010adfe4c1fe680a53d">LocalApic::kXApicLvtLint1Offset</a></div><div class="ttdeci">static constexpr uint32_t kXApicLvtLint1Offset</div><div class="ttdoc">LVT LINT1 寄存器偏移</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00173">local_apic.h:173</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a37c7f90ad3933cce3ca36ff2a6370593"><div class="ttname"><a href="classLocalApic.html#a37c7f90ad3933cce3ca36ff2a6370593">LocalApic::SetTaskPriority</a></div><div class="ttdeci">void SetTaskPriority(uint8_t priority) const</div><div class="ttdoc">设置任务优先级</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00140">local_apic.cpp:140</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a385380dd373545bb139e0a36068c46fc"><div class="ttname"><a href="classLocalApic.html#a385380dd373545bb139e0a36068c46fc">LocalApic::EnableXApic</a></div><div class="ttdeci">auto EnableXApic() const -&gt; bool</div><div class="ttdoc">启用传统 xAPIC 模式</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00387">local_apic.cpp:387</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a3f7b7c00383f231e77c8b33ff340a2f9"><div class="ttname"><a href="classLocalApic.html#a3f7b7c00383f231e77c8b33ff340a2f9">LocalApic::EnableX2Apic</a></div><div class="ttdeci">auto EnableX2Apic() const -&gt; bool</div><div class="ttdoc">启用 x2APIC 模式</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00407">local_apic.cpp:407</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a4a63c5378da856c2a5f1ea0460a6744e"><div class="ttname"><a href="classLocalApic.html#a4a63c5378da856c2a5f1ea0460a6744e">LocalApic::is_x2apic_mode_</a></div><div class="ttdeci">bool is_x2apic_mode_</div><div class="ttdoc">当前 APIC 模式（true = x2APIC, false = xAPIC）</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00249">local_apic.h:249</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a5c5ad4a79967cb4aedf6955ecd1606db"><div class="ttname"><a href="classLocalApic.html#a5c5ad4a79967cb4aedf6955ecd1606db">LocalApic::kSpuriousVector</a></div><div class="ttdeci">static constexpr uint32_t kSpuriousVector</div><div class="ttdoc">虚假中断向量</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00193">local_apic.h:193</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a6b0f3174fb096b99ee386a0a9c40f933"><div class="ttname"><a href="classLocalApic.html#a6b0f3174fb096b99ee386a0a9c40f933">LocalApic::kLvtMaskBit</a></div><div class="ttdeci">static constexpr uint32_t kLvtMaskBit</div><div class="ttdoc">LVT 掩码位</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00195">local_apic.h:195</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a8c7af96d0822ef425029761b383195b5"><div class="ttname"><a href="classLocalApic.html#a8c7af96d0822ef425029761b383195b5">LocalApic::kXApicLvtErrorOffset</a></div><div class="ttdeci">static constexpr uint32_t kXApicLvtErrorOffset</div><div class="ttdoc">LVT 错误寄存器偏移</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00175">local_apic.h:175</a></div></div>
<div class="ttc" id="aclassLocalApic_html_ad94b3e7dc5659cd5bf9378cf9fa308dc"><div class="ttname"><a href="classLocalApic.html#ad94b3e7dc5659cd5bf9378cf9fa308dc">LocalApic::Init</a></div><div class="ttdeci">auto Init() -&gt; Expected&lt; void &gt;</div><div class="ttdoc">初始化 Local APIC</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00009">local_apic.cpp:9</a></div></div>
<div class="ttc" id="aclassLocalApic_html_aeecdfbc459bb53490b50ef3ff0652c27"><div class="ttname"><a href="classLocalApic.html#aeecdfbc459bb53490b50ef3ff0652c27">LocalApic::kXApicLvtTimerOffset</a></div><div class="ttdeci">static constexpr uint32_t kXApicLvtTimerOffset</div><div class="ttdoc">LVT 定时器寄存器偏移</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00169">local_apic.h:169</a></div></div>
<div class="ttc" id="anamespaceio_html"><div class="ttname"><a href="namespaceio.html">io</a></div><div class="ttdef"><b>Definition</b> <a href="io_8hpp_source.html#l00017">io.hpp:17</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md39"></a>
IPI 发送机制</h3>
<p>支持两种 IPI 类型：</p><ul>
<li><b>点对点 IPI</b>: <code>SendIpi(target_apic_id, vector)</code></li>
<li><b>广播 IPI</b>: <code>BroadcastIpi(vector)</code></li>
</ul>
<p><b>INIT IPI 发送</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classLocalApic.html#a6b837d6e2763369280afc50976b1064a">LocalApic::SendInitIpi</a>(uint32_t destination_apic_id)<span class="keyword"> const </span>{</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code hl_variable" href="classLocalApic.html#a4a63c5378da856c2a5f1ea0460a6744e">is_x2apic_mode_</a>) {</div>
<div class="line">    <span class="keyword">auto</span> icr = <a class="code hl_variable" href="classLocalApic.html#ab2eb29834e6af43ecb26fc60702d6161">kInitIpiMode</a>;  <span class="comment">// 0x500</span></div>
<div class="line">    icr |= <span class="keyword">static_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(destination_apic_id) &lt;&lt; 32;</div>
<div class="line">    cpu_io::msr::apic::WriteIcr(icr);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">// xAPIC 模式通过内存映射访问</span></div>
<div class="line">    <span class="keyword">auto</span> icr_high = (destination_apic_id &amp; <a class="code hl_variable" href="classLocalApic.html#a539a57e81b47d6c352d9d187b0f095cf">kApicIdMask</a>) &lt;&lt; <a class="code hl_variable" href="classLocalApic.html#a0e39371e01acd73f35fe96b8111b32f9">kIcrDestShift</a>;</div>
<div class="line">    io::Out&lt;uint32_t&gt;(<a class="code hl_variable" href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">apic_base_</a> + <a class="code hl_variable" href="classLocalApic.html#aa4158043664830ff0d09c9c9297d6d0d">kXApicIcrHighOffset</a>, icr_high);</div>
<div class="line">    io::Out&lt;uint32_t&gt;(<a class="code hl_variable" href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">apic_base_</a> + <a class="code hl_variable" href="classLocalApic.html#a34703c093c2de15bba9a3a0bb985c49f">kXApicIcrLowOffset</a>, <a class="code hl_variable" href="classLocalApic.html#ab2eb29834e6af43ecb26fc60702d6161">kInitIpiMode</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 等待传递状态清除</span></div>
<div class="line">  <span class="keywordflow">while</span> ((ReadIcr() &amp; <a class="code hl_variable" href="classLocalApic.html#a71161337180fb23c37d8fd9b1bfb9731">kIcrDeliveryStatusBit</a>) != 0) { ; }</div>
<div class="line">}</div>
<div class="ttc" id="aclassLocalApic_html_a0e39371e01acd73f35fe96b8111b32f9"><div class="ttname"><a href="classLocalApic.html#a0e39371e01acd73f35fe96b8111b32f9">LocalApic::kIcrDestShift</a></div><div class="ttdeci">static constexpr uint32_t kIcrDestShift</div><div class="ttdoc">ICR 目标位移</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00201">local_apic.h:201</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a34703c093c2de15bba9a3a0bb985c49f"><div class="ttname"><a href="classLocalApic.html#a34703c093c2de15bba9a3a0bb985c49f">LocalApic::kXApicIcrLowOffset</a></div><div class="ttdeci">static constexpr uint32_t kXApicIcrLowOffset</div><div class="ttdoc">ICR 低位寄存器偏移</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00165">local_apic.h:165</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a539a57e81b47d6c352d9d187b0f095cf"><div class="ttname"><a href="classLocalApic.html#a539a57e81b47d6c352d9d187b0f095cf">LocalApic::kApicIdMask</a></div><div class="ttdeci">static constexpr uint32_t kApicIdMask</div><div class="ttdoc">xAPIC ID 掩码</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00189">local_apic.h:189</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a71161337180fb23c37d8fd9b1bfb9731"><div class="ttname"><a href="classLocalApic.html#a71161337180fb23c37d8fd9b1bfb9731">LocalApic::kIcrDeliveryStatusBit</a></div><div class="ttdeci">static constexpr uint32_t kIcrDeliveryStatusBit</div><div class="ttdoc">ICR 传递状态位</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00199">local_apic.h:199</a></div></div>
<div class="ttc" id="aclassLocalApic_html_aa4158043664830ff0d09c9c9297d6d0d"><div class="ttname"><a href="classLocalApic.html#aa4158043664830ff0d09c9c9297d6d0d">LocalApic::kXApicIcrHighOffset</a></div><div class="ttdeci">static constexpr uint32_t kXApicIcrHighOffset</div><div class="ttdoc">ICR 高位寄存器偏移</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00167">local_apic.h:167</a></div></div>
<div class="ttc" id="aclassLocalApic_html_ab2eb29834e6af43ecb26fc60702d6161"><div class="ttname"><a href="classLocalApic.html#ab2eb29834e6af43ecb26fc60702d6161">LocalApic::kInitIpiMode</a></div><div class="ttdeci">static constexpr uint32_t kInitIpiMode</div><div class="ttdoc">INIT IPI 模式</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00205">local_apic.h:205</a></div></div>
</div><!-- fragment --><p><b>SIPI 发送</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classLocalApic.html#acd008bf0645ca650746c65287ad109de">LocalApic::SendStartupIpi</a>(uint32_t destination_apic_id,</div>
<div class="line">                               uint8_t start_page)<span class="keyword"> const </span>{</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code hl_variable" href="classLocalApic.html#a4a63c5378da856c2a5f1ea0460a6744e">is_x2apic_mode_</a>) {</div>
<div class="line">    <span class="keyword">auto</span> icr = <a class="code hl_variable" href="classLocalApic.html#a33d4d4ec4aa19a4af8667b4215c93710">kSipiMode</a> | start_page;  <span class="comment">// 0x600 | start_page</span></div>
<div class="line">    icr |= <span class="keyword">static_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(destination_apic_id) &lt;&lt; 32;</div>
<div class="line">    cpu_io::msr::apic::WriteIcr(icr);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="keyword">auto</span> icr_high = (destination_apic_id &amp; <a class="code hl_variable" href="classLocalApic.html#a539a57e81b47d6c352d9d187b0f095cf">kApicIdMask</a>) &lt;&lt; <a class="code hl_variable" href="classLocalApic.html#a0e39371e01acd73f35fe96b8111b32f9">kIcrDestShift</a>;</div>
<div class="line">    io::Out&lt;uint32_t&gt;(<a class="code hl_variable" href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">apic_base_</a> + <a class="code hl_variable" href="classLocalApic.html#aa4158043664830ff0d09c9c9297d6d0d">kXApicIcrHighOffset</a>, icr_high);</div>
<div class="line">    io::Out&lt;uint32_t&gt;(<a class="code hl_variable" href="classLocalApic.html#a14dea9be5f7231166d31af785352a911">apic_base_</a> + <a class="code hl_variable" href="classLocalApic.html#a34703c093c2de15bba9a3a0bb985c49f">kXApicIcrLowOffset</a>, <a class="code hl_variable" href="classLocalApic.html#a33d4d4ec4aa19a4af8667b4215c93710">kSipiMode</a> | start_page);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 等待传递状态清除</span></div>
<div class="line">  <span class="keywordflow">while</span> ((ReadIcr() &amp; <a class="code hl_variable" href="classLocalApic.html#a71161337180fb23c37d8fd9b1bfb9731">kIcrDeliveryStatusBit</a>) != 0) { ; }</div>
<div class="line">}</div>
<div class="ttc" id="aclassLocalApic_html_a33d4d4ec4aa19a4af8667b4215c93710"><div class="ttname"><a href="classLocalApic.html#a33d4d4ec4aa19a4af8667b4215c93710">LocalApic::kSipiMode</a></div><div class="ttdeci">static constexpr uint32_t kSipiMode</div><div class="ttdoc">SIPI 模式</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8h_source.html#l00207">local_apic.h:207</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md40"></a>
关键常量定义</h2>
<div class="fragment"><div class="line"><span class="comment">// APIC 基址和向量</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t <a class="code hl_variable" href="include_2sipi_8h.html#aa69ae5dfed08043489ffa640ffc81521">kDefaultAPBase</a> = 0x30000;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 模式切换位</span></div>
<div class="line"><span class="preprocessor">#define PAE_BIT                 0x20        </span><span class="comment">// CR4.PAE</span></div>
<div class="line"><span class="preprocessor">#define PROTECTION_MODE_BIT     0x1         </span><span class="comment">// CR0.PE</span></div>
<div class="line"><span class="preprocessor">#define LONG_MODE_BIT           0x100       </span><span class="comment">// EFER.LME</span></div>
<div class="line"><span class="preprocessor">#define PAGING_BIT              0x80000000  </span><span class="comment">// CR0.PG</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// APIC ID 相关</span></div>
<div class="line"><span class="preprocessor">#define APIC_ID_SHIFT           24</span></div>
<div class="line"><span class="preprocessor">#define APIC_ID_MASK            0xFF</span></div>
<div class="line"><span class="preprocessor">#define CPUID_LEAF_1            1</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// IPI 模式</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint32_t kInitIpiMode = 0x500;     <span class="comment">// INIT</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint32_t kSipiMode = 0x600;        <span class="comment">// SIPI</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 栈配置</span></div>
<div class="line"><span class="preprocessor">#define STACK_SIZE_PER_CPU      0x1000      </span><span class="comment">// 4KB per CPU</span></div>
<div class="line"><span class="preprocessor">#define MAX_CPU_COUNT           4</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 延时校准</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint32_t kCalibrationDelayLoop = 1000000;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md41"></a>
特性和限制</h2>
<h3><a class="anchor" id="autotoc_md42"></a>
支持特性</h3>
<ul>
<li>支持最多 4 个 CPU 核心</li>
<li>支持 x2APIC 和 xAPIC 两种模式</li>
<li>完整的 INIT-SIPI-SIPI 启动序列</li>
<li>每个 CPU 独立的栈空间</li>
<li>Per-CPU 数据结构管理</li>
<li>基于 APIC ID 的 CPU 标识</li>
</ul>
<h3><a class="anchor" id="autotoc_md43"></a>
当前限制</h3>
<ul>
<li>最大 CPU 数量硬编码为 4</li>
<li>IO APIC 功能部分待实现</li>
<li>缺少 CPU 热插拔支持</li>
<li>简化的错误处理机制</li>
<li>延时使用简单的循环计数，不够精确</li>
</ul>
<h2><a class="anchor" id="autotoc_md44"></a>
调试和监控</h2>
<p>系统提供 APIC 信息打印功能： </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classLocalApic.html#af0eac16550b73a6d87d505bf3295d62c">LocalApic::PrintInfo</a>()<span class="keyword"> const </span>{</div>
<div class="line">  <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;=== Local APIC Information ===\n&quot;</span>);</div>
<div class="line">  <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;APIC Version: 0x%x\n&quot;</span>, <a class="code hl_function" href="classLocalApic.html#a5d8915494fa6031ccde79ee1b24cdbf6">GetApicVersion</a>());</div>
<div class="line">  <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;Mode: %s\n&quot;</span>, <a class="code hl_variable" href="classLocalApic.html#a4a63c5378da856c2a5f1ea0460a6744e">is_x2apic_mode_</a> ? <span class="stringliteral">&quot;x2APIC&quot;</span> : <span class="stringliteral">&quot;xAPIC&quot;</span>);</div>
<div class="line">  <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;Task Priority: 0x%x\n&quot;</span>, <a class="code hl_function" href="classLocalApic.html#a933b92b105f223a4e31cab92958dedba">GetTaskPriority</a>());</div>
<div class="line">  <span class="comment">// ... 更多寄存器状态</span></div>
<div class="line">}</div>
<div class="ttc" id="aclassLocalApic_html_a5d8915494fa6031ccde79ee1b24cdbf6"><div class="ttname"><a href="classLocalApic.html#a5d8915494fa6031ccde79ee1b24cdbf6">LocalApic::GetApicVersion</a></div><div class="ttdeci">auto GetApicVersion() const -&gt; uint32_t</div><div class="ttdoc">获取 APIC 版本信息</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00064">local_apic.cpp:64</a></div></div>
<div class="ttc" id="aclassLocalApic_html_a933b92b105f223a4e31cab92958dedba"><div class="ttname"><a href="classLocalApic.html#a933b92b105f223a4e31cab92958dedba">LocalApic::GetTaskPriority</a></div><div class="ttdeci">auto GetTaskPriority() const -&gt; uint8_t</div><div class="ttdoc">获取任务优先级</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00149">local_apic.cpp:149</a></div></div>
<div class="ttc" id="aclassLocalApic_html_af0eac16550b73a6d87d505bf3295d62c"><div class="ttname"><a href="classLocalApic.html#af0eac16550b73a6d87d505bf3295d62c">LocalApic::PrintInfo</a></div><div class="ttdeci">void PrintInfo() const</div><div class="ttdoc">打印 Local APIC 信息（调试用）</div><div class="ttdef"><b>Definition</b> <a href="local__apic_8cpp_source.html#l00338">local_apic.cpp:338</a></div></div>
<div class="ttc" id="astructklog_1_1Info_html"><div class="ttname"><a href="structklog_1_1Info.html">klog::Info</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00168">kernel_log.hpp:168</a></div></div>
</div><!-- fragment --><p><b>CPU ID 获取机制</b>: </p><div class="fragment"><div class="line"><span class="comment">// 通过 APIC ID 获取当前 CPU ID</span></div>
<div class="line"><span class="keyword">static</span> __always_inline <span class="keyword">auto</span> GetCurrentCoreId() -&gt; <span class="keywordtype">size_t</span> {</div>
<div class="line">  <span class="keyword">auto</span> apic_info = GetApicInfo();</div>
<div class="line">  <span class="keywordflow">return</span> apic_info.apic_id;</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>多核启动管理</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classApic.html#ade18168e69461b8ee4c8d34d91091b58">Apic::StartupAllAps</a>(uint64_t ap_code_addr, <span class="keywordtype">size_t</span> ap_code_size,</div>
<div class="line">                         uint64_t target_addr)<span class="keyword"> const </span>{</div>
<div class="line">  <span class="comment">// 尝试启动 APIC ID 0 到 cpu_count_-1 的所有处理器</span></div>
<div class="line">  <span class="comment">// 跳过当前的 BSP (Bootstrap Processor)</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> apic_id = 0; apic_id &lt; <a class="code hl_variable" href="classApic.html#ac4f645668b3c41bdffc63a52825c96f2">cpu_count_</a>; apic_id++) {</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">static_cast&lt;</span>uint32_t<span class="keyword">&gt;</span>(apic_id) == cpu_io::GetApicInfo().apic_id) {</div>
<div class="line">      <span class="keywordflow">continue</span>;  <span class="comment">// 跳过当前 BSP</span></div>
<div class="line">    }</div>
<div class="line">    <a class="code hl_function" href="classApic.html#a9777b7b1e7864680faba6e8bafd529dc">StartupAp</a>(<span class="keyword">static_cast&lt;</span>uint32_t<span class="keyword">&gt;</span>(apic_id), ap_code_addr,</div>
<div class="line">              ap_code_size, target_addr);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="aclassApic_html_a9777b7b1e7864680faba6e8bafd529dc"><div class="ttname"><a href="classApic.html#a9777b7b1e7864680faba6e8bafd529dc">Apic::StartupAp</a></div><div class="ttdeci">auto StartupAp(uint32_t apic_id, uint64_t ap_code_addr, size_t ap_code_size, uint64_t target_addr) const -&gt; Expected&lt; void &gt;</div><div class="ttdoc">启动 AP (Application Processor)</div><div class="ttdef"><b>Definition</b> <a href="apic_8cpp_source.html#l00082">apic.cpp:82</a></div></div>
<div class="ttc" id="aclassApic_html_ac4f645668b3c41bdffc63a52825c96f2"><div class="ttname"><a href="classApic.html#ac4f645668b3c41bdffc63a52825c96f2">Apic::cpu_count_</a></div><div class="ttdeci">size_t cpu_count_</div><div class="ttdoc">系统 CPU 数量</div><div class="ttdef"><b>Definition</b> <a href="apic_8h_source.html#l00133">apic.h:133</a></div></div>
<div class="ttc" id="aclassApic_html_ade18168e69461b8ee4c8d34d91091b58"><div class="ttname"><a href="classApic.html#ade18168e69461b8ee4c8d34d91091b58">Apic::StartupAllAps</a></div><div class="ttdeci">void StartupAllAps(uint64_t ap_code_addr, size_t ap_code_size, uint64_t target_addr) const</div><div class="ttdoc">唤醒所有应用处理器 (AP)</div><div class="ttdef"><b>Definition</b> <a href="apic_8cpp_source.html#l00120">apic.cpp:120</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md45"></a>
RISCV64</h1>
<h2><a class="anchor" id="autotoc_md46"></a>
概述</h2>
<p>RISC-V64 架构的多核唤醒机制基于 OpenSBI (Supervisor Binary Interface) 标准，通过 HSM (Hart State Management) 扩展来管理硬件线程（Hart）的启动和状态。与x86_64的复杂INIT-SIPI-SIPI序列不同，RISC-V提供了更简单统一的多核启动接口。</p>
<h2><a class="anchor" id="autotoc_md47"></a>
关键组件</h2>
<h3><a class="anchor" id="autotoc_md48"></a>
1. OpenSBI HSM 扩展</h3>
<ul>
<li><b>HSM (Hart State Management)</b>: RISC-V标准的硬件线程管理接口</li>
<li><b>SBI调用</b>: 通过<code>ecall</code>指令与Machine模式的OpenSBI固件通信</li>
<li><b>Hart状态管理</b>: 包括STARTED、STOPPED、START_PENDING等状态</li>
</ul>
<h3><a class="anchor" id="autotoc_md49"></a>
2. 核心数据结构</h3>
<p><b>Hart状态枚举</b> (<code>3rd/opensbi_interface/src/include/opensbi_interface.h</code>): </p><div class="fragment"><div class="line"><span class="keyword">enum</span> {</div>
<div class="line">  HSM_HART_STATE_STARTED = 0,</div>
<div class="line">  HSM_HART_STATE_STOPPED = 1,</div>
<div class="line">  HSM_HART_STATE_START_PENDING = 2,</div>
<div class="line">  HSM_HART_STATE_STOP_PENDING = 3,</div>
<div class="line">  HSM_HART_STATE_SUSPENDED = 4,</div>
<div class="line">  HSM_HART_STATE_SUSPEND_PENDING = 5,</div>
<div class="line">  HSM_HART_STATE_RESUME_PENDING = 6,</div>
<div class="line">};</div>
</div><!-- fragment --><p><b>SBI返回值结构</b>: </p><div class="fragment"><div class="line"><span class="keyword">struct </span>sbiret {</div>
<div class="line">  <span class="keywordtype">long</span> error;   <span class="comment">// 错误码</span></div>
<div class="line">  <span class="keywordtype">long</span> value;   <span class="comment">// 返回值</span></div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md50"></a>
多核启动流程</h2>
<h3><a class="anchor" id="autotoc_md51"></a>
1. BSP (Bootstrap Processor) 初始化</h3>
<p>在 <code><a class="el" href="riscv64_2arch__main_8cpp.html">src/arch/riscv64/arch_main.cpp</a></code> 的 <code><a class="el" href="aarch64_2arch__main_8cpp.html#aa26c42c34bbb6c8c7cd4a8664dc7952f">ArchInit()</a></code> 函数中：</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2arch__main_8cpp.html#aa26c42c34bbb6c8c7cd4a8664dc7952f">ArchInit</a>(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> **argv) {</div>
<div class="line">  <span class="comment">// 1. 解析设备树获取基本信息</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>() =</div>
<div class="line">      <a class="code hl_class" href="classKernelFdt.html">KernelFdt</a>(<span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(argv));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 2. 初始化基本信息</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;BasicInfo&gt;::GetInstance</a>() = <a class="code hl_struct" href="structBasicInfo.html">BasicInfo</a>(argc, argv);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 3. 解析内核ELF信息</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelElf&gt;::GetInstance</a>() =</div>
<div class="line">      <a class="code hl_class" href="classKernelElf.html">KernelElf</a>(<a class="code hl_class" href="classSingleton.html">Singleton&lt;BasicInfo&gt;::GetInstance</a>().elf_addr);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 4. 通过SBI唤醒所有Hart</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; Singleton&lt;BasicInfo&gt;::GetInstance().core_count; i++) {</div>
<div class="line">    <span class="keyword">auto</span> ret = sbi_hart_start(i, <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(<a class="code hl_function" href="basic__info_8hpp.html#a698036b5e342c2164fb7fd7249d0e801">_boot</a>), 0);</div>
<div class="line">    <span class="keywordflow">if</span> ((ret.error != SBI_SUCCESS) &amp;&amp;</div>
<div class="line">        (ret.error != SBI_ERR_ALREADY_AVAILABLE)) {</div>
<div class="line">      <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;hart %d start failed: %d\n&quot;</span>, i, ret.error);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="abasic__info_8hpp_html_a698036b5e342c2164fb7fd7249d0e801"><div class="ttname"><a href="basic__info_8hpp.html#a698036b5e342c2164fb7fd7249d0e801">_boot</a></div><div class="ttdeci">void _boot()</div><div class="ttdoc">内核入口，在 boot.S 中定义</div></div>
<div class="ttc" id="aclassKernelFdt_html"><div class="ttname"><a href="classKernelFdt.html">KernelFdt</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__fdt_8hpp_source.html#l00034">kernel_fdt.hpp:34</a></div></div>
<div class="ttc" id="astructklog_1_1Warn_html"><div class="ttname"><a href="structklog_1_1Warn.html">klog::Warn</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00178">kernel_log.hpp:178</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md52"></a>
2. Hart 启动代码</h3>
<p>位于 <code>src/arch/riscv64/boot.S</code>，实现简洁的64位启动序列：</p>
<div class="fragment"><div class="line">.section .text.boot</div>
<div class="line">.global _boot</div>
<div class="line">_boot:</div>
<div class="line">    // 检查设备树地址是否有效</div>
<div class="line">    beqz a1, 2f</div>
<div class="line"> </div>
<div class="line">    // 初始化全局指针寄存器 (可选)</div>
<div class="line">    #if USE_NO_RELAX == 0</div>
<div class="line">.option push</div>
<div class="line">.option norelax</div>
<div class="line">1:  auipc gp, %pcrel_hi(__global_pointer$)</div>
<div class="line">    addi  gp, gp, %pcrel_lo(1b)</div>
<div class="line">.option pop</div>
<div class="line">    #endif</div>
<div class="line"> </div>
<div class="line">2:  // 根据Hart ID设置独立栈</div>
<div class="line">    add t0, a0, 1        // t0 = hart_id + 1</div>
<div class="line">    slli t0, t0, 12      // t0 *= 4096 (4KB per hart)</div>
<div class="line">    la sp, stack_top     // 加载栈顶基址</div>
<div class="line">    add sp, sp, t0       // sp = stack_top + hart_id * 4KB</div>
<div class="line"> </div>
<div class="line">    // 保存Hart ID到tp寄存器 (用于获取当前核心ID)</div>
<div class="line">    mv tp, a0</div>
<div class="line"> </div>
<div class="line">    // 保存SBI传递的参数到栈</div>
<div class="line">    addi sp, sp, -8*2    // 开辟栈空间</div>
<div class="line">    sd a0, 0(sp)         // 保存Hart ID</div>
<div class="line">    sd a1, 8(sp)         // 保存设备树地址</div>
<div class="line"> </div>
<div class="line">    // 跳转到C代码入口</div>
<div class="line">    call _start</div>
<div class="line"> </div>
<div class="line">    // 如果返回则进入等待状态</div>
<div class="line">    wfi</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md53"></a>
3. SBI Hart启动接口</h3>
<p><code>sbi_hart_start()</code> 函数实现 (<code>3rd/opensbi_interface/src/opensbi_interface.c</code>):</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>sbiret sbi_hart_start(unsigned long hartid, unsigned long start_addr,</div>
<div class="line">                             unsigned long opaque) {</div>
<div class="line">  <span class="keywordflow">return</span> ecall(hartid, start_addr, opaque, 0, 0, 0,</div>
<div class="line">               SBI_EXT_HSM_HART_START, SBI_EXT_HSM);</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md54"></a>
4. Hart入口处理</h3>
<p>Hart启动后通过 <code><a class="el" href="src_2main_8cpp.html">src/main.cpp</a></code> 的 <code><a class="el" href="kernel_8h.html#a1051fb5b0c9ae8b443c542089ac538bd" title="负责 crtbegin 的工作">_start()</a></code> 函数进入：</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="kernel_8h.html#a1051fb5b0c9ae8b443c542089ac538bd">_start</a>(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> **argv) {</div>
<div class="line">  <span class="keywordflow">if</span> (argv != <span class="keyword">nullptr</span>) {</div>
<div class="line">    <span class="comment">// BSP路径 (设备树地址有效)</span></div>
<div class="line">    <a class="code hl_function" href="sk__libcxx_8h.html#a8c22041b9886ca00cff1e90cd43eb3f2">CppInit</a>();</div>
<div class="line">    <a class="code hl_function" href="tests_2integration__test_2aarch64__minimal_2main_8cpp.html#acdef7a1fd863a6d3770c1268cb06add3">main</a>(argc, argv);</div>
<div class="line">    <a class="code hl_function" href="sk__libcxx_8h.html#ace4b6de6e1ac3081329da66be1b45f76">CppDeInit</a>();</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">// AP路径 (设备树地址为空)</span></div>
<div class="line">    main_smp(argc, argv);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 进入死循环</span></div>
<div class="line">  <span class="keywordflow">while</span> (<span class="keyword">true</span>) { ; }</div>
<div class="line">}</div>
</div><!-- fragment --><p>AP执行 <code>main_smp()</code> -&gt; <code><a class="el" href="aarch64_2arch__main_8cpp.html#ad90b12c5e1b1a5911044c7c1286289da">ArchInitSMP()</a></code> (当前为空实现)：</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2arch__main_8cpp.html#ad90b12c5e1b1a5911044c7c1286289da">ArchInitSMP</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **) {}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md55"></a>
核心ID获取机制</h2>
<h3><a class="anchor" id="autotoc_md56"></a>
Hart ID管理</h3>
<p>RISC-V使用 <code>tp</code> (Thread Pointer) 寄存器存储当前Hart ID：</p>
<div class="fragment"><div class="line">// 在boot.S中设置</div>
<div class="line">mv tp, a0  // 将Hart ID保存到tp寄存器</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// 在C代码中获取</span></div>
<div class="line"><span class="keyword">static</span> __always_inline <span class="keyword">auto</span> GetCurrentCoreId() -&gt; <span class="keywordtype">size_t</span> {</div>
<div class="line">  <span class="keywordflow">return</span> Tp::Read();</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md57"></a>
Tp寄存器访问</h3>
<p>通过内联汇编实现： </p><div class="fragment"><div class="line"><span class="comment">// 读取tp寄存器</span></div>
<div class="line"><span class="keyword">static</span> __always_inline <span class="keyword">auto</span> Read() -&gt; <span class="keyword">typename</span> RegInfo::DataType {</div>
<div class="line">  <span class="keyword">typename</span> RegInfo::DataType value{};</div>
<div class="line">  __asm__ <span class="keyword">volatile</span>(<span class="stringliteral">&quot;mv %0, tp&quot;</span> : <span class="stringliteral">&quot;=r&quot;</span>(value) : :);</div>
<div class="line">  <span class="keywordflow">return</span> value;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 写入tp寄存器</span></div>
<div class="line"><span class="keyword">static</span> __always_inline <span class="keywordtype">void</span> Write(<span class="keyword">typename</span> RegInfo::DataType value) {</div>
<div class="line">  __asm__ <span class="keyword">volatile</span>(<span class="stringliteral">&quot;mv tp, %0&quot;</span> : : <span class="stringliteral">&quot;r&quot;</span>(value) :);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md58"></a>
设备树信息获取</h2>
<h3><a class="anchor" id="autotoc_md59"></a>
CPU核心数量获取</h3>
<p>通过解析设备树获取系统CPU核心数：</p>
<div class="fragment"><div class="line">[[nodiscard]] <span class="keyword">auto</span> GetCoreCount() const -&gt; <span class="keywordtype">size_t</span> {</div>
<div class="line">  <span class="keywordtype">size_t</span> core_count = 0;</div>
<div class="line">  <span class="keyword">auto</span> offset = -1;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">    offset = fdt_next_node(fdt_header_, offset, <span class="keyword">nullptr</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (offset &lt; 0) <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> *prop = fdt_get_property(fdt_header_, offset, <span class="stringliteral">&quot;device_type&quot;</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (prop != <span class="keyword">nullptr</span>) {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">char</span> *device_type = <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">char</span> *<span class="keyword">&gt;</span>(prop-&gt;data);</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code hl_define" href="sk__string__test_8cpp.html#a6b5d9a1031ac2602e31df1ba551bfafe">strcmp</a>(device_type, <span class="stringliteral">&quot;cpu&quot;</span>) == 0) {</div>
<div class="line">        ++core_count;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> core_count;</div>
<div class="line">}</div>
<div class="ttc" id="ask__string__test_8cpp_html_a6b5d9a1031ac2602e31df1ba551bfafe"><div class="ttname"><a href="sk__string__test_8cpp.html#a6b5d9a1031ac2602e31df1ba551bfafe">strcmp</a></div><div class="ttdeci">#define strcmp</div><div class="ttdef"><b>Definition</b> <a href="sk__string__test_8cpp_source.html#l00016">sk_string_test.cpp:16</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md60"></a>
基本信息初始化</h3>
<div class="fragment"><div class="line"><a class="code hl_function" href="structBasicInfo.html#a625c7f57e4c10bce67b5acc5f71d4423">BasicInfo::BasicInfo</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **argv) {</div>
<div class="line">  <span class="comment">// 从设备树获取内存信息</span></div>
<div class="line">  <span class="keyword">auto</span> [memory_base, memory_size] =</div>
<div class="line">      <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>().GetMemory();</div>
<div class="line">  <a class="code hl_variable" href="structBasicInfo.html#a112ca865b11d6e6fdb47eb42c902e47e">physical_memory_addr</a> = memory_base;</div>
<div class="line">  <a class="code hl_variable" href="structBasicInfo.html#a5ba8394c69be0fb4d2de460905e77e84">physical_memory_size</a> = memory_size;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 内核地址和大小</span></div>
<div class="line">  <a class="code hl_variable" href="structBasicInfo.html#a4020826d3d2755a9e5ad8f3cc5d68bc4">kernel_addr</a> = <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="basic__info_8hpp.html#a9c6fbf9a57242794712975337a624b43">__executable_start</a>);</div>
<div class="line">  <a class="code hl_variable" href="structBasicInfo.html#afcc7549719d077196d96fe64cd4debbd">kernel_size</a> = <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="basic__info_8hpp.html#a6a57db0096456f14176cf7e7affa1929">end</a>) -</div>
<div class="line">                <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="basic__info_8hpp.html#a9c6fbf9a57242794712975337a624b43">__executable_start</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 设备树地址</span></div>
<div class="line">  <a class="code hl_variable" href="structBasicInfo.html#a0948f05fbea22eae3fd445ee206afffb">fdt_addr</a> = <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(argv);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// CPU核心数</span></div>
<div class="line">  <a class="code hl_variable" href="structBasicInfo.html#a00488d4b1702eb6c75ef2bf2a54dd9eb">core_count</a> = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>().GetCoreCount();</div>
<div class="line">}</div>
<div class="ttc" id="abasic__info_8hpp_html_a6a57db0096456f14176cf7e7affa1929"><div class="ttname"><a href="basic__info_8hpp.html#a6a57db0096456f14176cf7e7affa1929">end</a></div><div class="ttdeci">void * end[]</div><div class="ttdoc">内核结束</div><div class="ttdef"><b>Definition</b> <a href="basic__info_8hpp_source.html#l00022">basic_info.hpp:22</a></div></div>
<div class="ttc" id="abasic__info_8hpp_html_a9c6fbf9a57242794712975337a624b43"><div class="ttname"><a href="basic__info_8hpp.html#a9c6fbf9a57242794712975337a624b43">__executable_start</a></div><div class="ttdeci">void * __executable_start[]</div><div class="ttdef"><b>Definition</b> <a href="basic__info_8hpp_source.html#l00018">basic_info.hpp:18</a></div></div>
<div class="ttc" id="astructBasicInfo_html_a00488d4b1702eb6c75ef2bf2a54dd9eb"><div class="ttname"><a href="structBasicInfo.html#a00488d4b1702eb6c75ef2bf2a54dd9eb">BasicInfo::core_count</a></div><div class="ttdeci">size_t core_count</div><div class="ttdoc">cpu 核数</div><div class="ttdef"><b>Definition</b> <a href="basic__info_8hpp_source.html#l00044">basic_info.hpp:44</a></div></div>
<div class="ttc" id="astructBasicInfo_html_a0948f05fbea22eae3fd445ee206afffb"><div class="ttname"><a href="structBasicInfo.html#a0948f05fbea22eae3fd445ee206afffb">BasicInfo::fdt_addr</a></div><div class="ttdeci">uint64_t fdt_addr</div><div class="ttdoc">fdt 地址</div><div class="ttdef"><b>Definition</b> <a href="basic__info_8hpp_source.html#l00041">basic_info.hpp:41</a></div></div>
<div class="ttc" id="astructBasicInfo_html_a112ca865b11d6e6fdb47eb42c902e47e"><div class="ttname"><a href="structBasicInfo.html#a112ca865b11d6e6fdb47eb42c902e47e">BasicInfo::physical_memory_addr</a></div><div class="ttdeci">uint64_t physical_memory_addr</div><div class="ttdoc">physical_memory 地址</div><div class="ttdef"><b>Definition</b> <a href="basic__info_8hpp_source.html#l00028">basic_info.hpp:28</a></div></div>
<div class="ttc" id="astructBasicInfo_html_a4020826d3d2755a9e5ad8f3cc5d68bc4"><div class="ttname"><a href="structBasicInfo.html#a4020826d3d2755a9e5ad8f3cc5d68bc4">BasicInfo::kernel_addr</a></div><div class="ttdeci">uint64_t kernel_addr</div><div class="ttdoc">kernel 地址</div><div class="ttdef"><b>Definition</b> <a href="basic__info_8hpp_source.html#l00033">basic_info.hpp:33</a></div></div>
<div class="ttc" id="astructBasicInfo_html_a5ba8394c69be0fb4d2de460905e77e84"><div class="ttname"><a href="structBasicInfo.html#a5ba8394c69be0fb4d2de460905e77e84">BasicInfo::physical_memory_size</a></div><div class="ttdeci">size_t physical_memory_size</div><div class="ttdoc">physical_memory 大小</div><div class="ttdef"><b>Definition</b> <a href="basic__info_8hpp_source.html#l00030">basic_info.hpp:30</a></div></div>
<div class="ttc" id="astructBasicInfo_html_a625c7f57e4c10bce67b5acc5f71d4423"><div class="ttname"><a href="structBasicInfo.html#a625c7f57e4c10bce67b5acc5f71d4423">BasicInfo::BasicInfo</a></div><div class="ttdeci">BasicInfo()=default</div></div>
<div class="ttc" id="astructBasicInfo_html_afcc7549719d077196d96fe64cd4debbd"><div class="ttname"><a href="structBasicInfo.html#afcc7549719d077196d96fe64cd4debbd">BasicInfo::kernel_size</a></div><div class="ttdeci">size_t kernel_size</div><div class="ttdoc">kernel 大小</div><div class="ttdef"><b>Definition</b> <a href="basic__info_8hpp_source.html#l00035">basic_info.hpp:35</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md61"></a>
内存布局</h3>
<h3><a class="anchor" id="autotoc_md62"></a>
栈分配</h3>
<p>每个Hart分配4KB独立栈空间： </p><div class="fragment"><div class="line">// Hart栈地址计算: stack_top + (hart_id + 1) * 4KB</div>
<div class="line">add t0, a0, 1        // hart_id + 1</div>
<div class="line">slli t0, t0, 12      // * 4096</div>
<div class="line">la sp, stack_top     // 栈基址</div>
<div class="line">add sp, sp, t0       // 最终栈指针</div>
<div class="line"> </div>
<div class="line">.section .bss.boot</div>
<div class="line">.align 16</div>
<div class="line">.global stack_top</div>
<div class="line">stack_top:</div>
<div class="line">    .space 4096 * 4  // 总共16KB栈空间</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md63"></a>
SBI接口详解</h2>
<h3><a class="anchor" id="autotoc_md64"></a>
Hart状态管理接口</h3>
<div class="fragment"><div class="line"><span class="comment">// 启动Hart</span></div>
<div class="line"><span class="keyword">struct </span>sbiret sbi_hart_start(unsigned long hartid,</div>
<div class="line">                             unsigned long start_addr,</div>
<div class="line">                             unsigned long opaque);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 停止Hart</span></div>
<div class="line"><span class="keyword">struct </span>sbiret sbi_hart_stop(void);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 获取Hart状态</span></div>
<div class="line"><span class="keyword">struct </span>sbiret sbi_hart_get_status(unsigned long hartid);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Hart挂起</span></div>
<div class="line"><span class="keyword">struct </span>sbiret sbi_hart_suspend(uint32_t suspend_type,</div>
<div class="line">                               unsigned long resume_addr,</div>
<div class="line">                               unsigned long opaque);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md65"></a>
错误码定义</h3>
<div class="fragment"><div class="line"><span class="keyword">enum</span> {</div>
<div class="line">  SBI_SUCCESS = 0,</div>
<div class="line">  SBI_ERR_FAILED = -1,</div>
<div class="line">  SBI_ERR_NOT_SUPPORTED = -2,</div>
<div class="line">  SBI_ERR_INVALID_PARAM = -3,</div>
<div class="line">  SBI_ERR_DENIED = -4,</div>
<div class="line">  SBI_ERR_INVALID_ADDRESS = -5,</div>
<div class="line">  SBI_ERR_ALREADY_AVAILABLE = -6,  <span class="comment">// Hart已经启动</span></div>
<div class="line">  SBI_ERR_ALREADY_STARTED = -7,</div>
<div class="line">  SBI_ERR_ALREADY_STOPPED = -8,</div>
<div class="line">  SBI_ERR_NO_SHMEM = -9,</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md66"></a>
特性和限制</h2>
<h3><a class="anchor" id="autotoc_md67"></a>
支持特性</h3>
<ul>
<li>基于标准SBI HSM扩展的多核启动</li>
<li>简洁的64位启动序列，无需模式切换</li>
<li>通过设备树动态获取CPU核心数</li>
<li>基于tp寄存器的高效核心ID管理</li>
<li>完整的Hart状态管理支持</li>
<li>使用OpenSBI固件接口</li>
</ul>
<h3><a class="anchor" id="autotoc_md68"></a>
当前限制</h3>
<ul>
<li><a class="el" href="aarch64_2arch__main_8cpp.html#ad90b12c5e1b1a5911044c7c1286289da">ArchInitSMP()</a>函数为空实现，缺少AP特定初始化</li>
<li>缺少Hart间通信机制（IPI）</li>
<li>固定的栈大小分配（4KB per Hart）</li>
<li>简化的错误处理机制</li>
<li>依赖外部OpenSBI固件支持</li>
</ul>
<h2><a class="anchor" id="autotoc_md69"></a>
调试和监控</h2>
<p>系统提供Hart状态查询功能： </p><div class="fragment"><div class="line"><span class="keyword">auto</span> status = sbi_hart_get_status(hart_id);</div>
<div class="line"><span class="keywordflow">if</span> (status.error == SBI_SUCCESS) {</div>
<div class="line">  <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;Hart %d status: %s\n&quot;</span>, hart_id,</div>
<div class="line">             HSM_HART_STATES_NAME[status.value]);</div>
<div class="line">}</div>
</div><!-- fragment --><p>支持的状态包括：</p><ul>
<li>STARTED: Hart正在运行</li>
<li>STOPPED: Hart已停止</li>
<li>START_PENDING: Hart启动中</li>
<li>STOP_PENDING: Hart停止中</li>
<li>SUSPENDED: Hart已挂起</li>
<li>SUSPEND_PENDING: Hart挂起中</li>
<li>RESUME_PENDING: Hart恢复中</li>
</ul>
<h1><a class="anchor" id="autotoc_md70"></a>
AARCH64</h1>
<h2><a class="anchor" id="autotoc_md71"></a>
概述</h2>
<p>AArch64 架构的多核唤醒机制基于 PSCI (Power State Coordination Interface) 标准，通过 SMC (Secure Monitor Call) 指令与 EL3 固件通信来管理 CPU 核心的电源状态。PSCI 提供了标准化的多核管理接口，简化了操作系统的多核启动流程。</p>
<h2><a class="anchor" id="autotoc_md72"></a>
关键组件</h2>
<h3><a class="anchor" id="autotoc_md73"></a>
1. PSCI (Power State Coordination Interface)</h3>
<ul>
<li><b>标准化接口</b>: ARM 标准的电源管理和多核控制接口</li>
<li><b>SMC调用</b>: 通过 Secure Monitor Call 与 EL3 固件通信</li>
<li><b>电源状态管理</b>: 支持 CPU ON/OFF、SUSPEND/RESUME 等状态转换</li>
</ul>
<h3><a class="anchor" id="autotoc_md74"></a>
2. 核心数据结构</h3>
<p><b>PSCI错误码</b> (<code>3rd/cpu_io/include/aarch64/cpu.hpp</code>): </p><div class="fragment"><div class="line"><span class="keyword">enum</span> <a class="code hl_enumeration" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895f">ErrorCode</a> {</div>
<div class="line">  SUCCESS = 0,</div>
<div class="line">  NOT_SUPPORTED = -1,</div>
<div class="line">  INVALID_PARAMETERS = -2,</div>
<div class="line">  DENIED = -3,</div>
<div class="line">  ALREADY_ON = -4,          <span class="comment">// CPU已经启动</span></div>
<div class="line">  ON_PENDING = -5,          <span class="comment">// CPU启动中</span></div>
<div class="line">  INTERNAL_FAILURE = -6,</div>
<div class="line">  NOT_PRESENT = -7,</div>
<div class="line">  DISABLED = -8,</div>
<div class="line">  INVALID_ADDRESS = -9,</div>
<div class="line">};</div>
<div class="ttc" id="aexpected_8hpp_html_a4d45a9675d1bf454764383179f3c895f"><div class="ttname"><a href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895f">ErrorCode</a></div><div class="ttdeci">ErrorCode</div><div class="ttdoc">内核错误码</div><div class="ttdef"><b>Definition</b> <a href="expected_8hpp_source.html#l00012">expected.hpp:12</a></div></div>
</div><!-- fragment --><p><b>SMC返回值结构</b>: </p><div class="fragment"><div class="line"><span class="keyword">struct </span>SMCReturnValue {</div>
<div class="line">  uint64_t a0;  <span class="comment">// 返回码/状态</span></div>
<div class="line">  uint64_t a1;  <span class="comment">// 附加返回值</span></div>
<div class="line">  uint64_t a2;  <span class="comment">// 附加返回值</span></div>
<div class="line">  uint64_t a3;  <span class="comment">// 附加返回值</span></div>
<div class="line">};</div>
</div><!-- fragment --><p><b>MPIDR_EL1寄存器字段</b> (多处理器亲和性寄存器): </p><div class="fragment"><div class="line"><span class="keyword">struct </span>MPIDR_EL1Info {</div>
<div class="line">  <span class="keyword">struct </span>Aff3 { <span class="comment">/* 位[39:32] 亲和性级别3 */</span> };</div>
<div class="line">  <span class="keyword">struct </span>Aff2 { <span class="comment">/* 位[23:16] 亲和性级别2 */</span> };</div>
<div class="line">  <span class="keyword">struct </span>Aff1 { <span class="comment">/* 位[15:8]  亲和性级别1 */</span> };</div>
<div class="line">  <span class="keyword">struct </span>Aff0 { <span class="comment">/* 位[7:0]   亲和性级别0 */</span> };</div>
<div class="line">  <span class="keyword">struct </span>MT   { <span class="comment">/* 位[24]    多线程标志 */</span> };</div>
<div class="line">  <span class="keyword">struct </span>U    { <span class="comment">/* 位[30]    单/多处理器标志 */</span> };</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md75"></a>
多核启动流程</h2>
<h3><a class="anchor" id="autotoc_md76"></a>
1. BSP (Bootstrap Processor) 初始化</h3>
<p>在 <code><a class="el" href="aarch64_2arch__main_8cpp.html">src/arch/aarch64/arch_main.cpp</a></code> 的 <code><a class="el" href="aarch64_2arch__main_8cpp.html#aa26c42c34bbb6c8c7cd4a8664dc7952f">ArchInit()</a></code> 函数中：</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2arch__main_8cpp.html#aa26c42c34bbb6c8c7cd4a8664dc7952f">ArchInit</a>(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> **argv) {</div>
<div class="line">  <span class="comment">// 1. 解析设备树获取系统信息</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>() = <a class="code hl_class" href="classKernelFdt.html">KernelFdt</a>(<a class="code hl_define" href="sk__libc__test_8cpp.html#acbc25345a39784031ea891c317ab6f4e">strtoull</a>(argv[2], <span class="keyword">nullptr</span>, 16));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 2. 初始化串口</span></div>
<div class="line">  <span class="keyword">auto</span> [serial_base, serial_size, irq] =</div>
<div class="line">      <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>().GetSerial();</div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Pl011&gt;::GetInstance</a>() = <a class="code hl_class" href="classPl011.html">Pl011</a>(serial_base);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 3. 初始化基本信息</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;BasicInfo&gt;::GetInstance</a>() = <a class="code hl_struct" href="structBasicInfo.html">BasicInfo</a>(argc, argv);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 4. 解析内核ELF信息</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelElf&gt;::GetInstance</a>() =</div>
<div class="line">      <a class="code hl_class" href="classKernelElf.html">KernelElf</a>(<a class="code hl_class" href="classSingleton.html">Singleton&lt;BasicInfo&gt;::GetInstance</a>().elf_addr);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 5. 检查PSCI支持</span></div>
<div class="line">  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>().CheckPSCI();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 6. 启动所有CPU核心</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; Singleton&lt;BasicInfo&gt;::GetInstance().core_count; i++) {</div>
<div class="line">    <span class="keyword">auto</span> ret = cpu_io::psci::CpuOn(i, <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(<a class="code hl_function" href="basic__info_8hpp.html#a698036b5e342c2164fb7fd7249d0e801">_boot</a>), 0);</div>
<div class="line">    <span class="keywordflow">if</span> ((ret != cpu_io::psci::SUCCESS) &amp;&amp; (ret != cpu_io::psci::ALREADY_ON)) {</div>
<div class="line">      <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;cpu %d start failed: %d\n&quot;</span>, i, ret);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="aclassPl011_html"><div class="ttname"><a href="classPl011.html">Pl011</a></div><div class="ttdoc">PL011 串口驱动</div><div class="ttdef"><b>Definition</b> <a href="pl011_8h_source.html#l00014">pl011.h:14</a></div></div>
<div class="ttc" id="ask__libc__test_8cpp_html_acbc25345a39784031ea891c317ab6f4e"><div class="ttname"><a href="sk__libc__test_8cpp.html#acbc25345a39784031ea891c317ab6f4e">strtoull</a></div><div class="ttdeci">#define strtoull</div><div class="ttdef"><b>Definition</b> <a href="sk__libc__test_8cpp_source.html#l00018">sk_libc_test.cpp:18</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md77"></a>
2. CPU启动代码</h3>
<p>位于 <code>src/arch/aarch64/boot.S</code>，实现简洁的AArch64启动序列：</p>
<div class="fragment"><div class="line">.section .text.boot</div>
<div class="line">.global _boot</div>
<div class="line">_boot:</div>
<div class="line">    // 获取CPU ID (从MPIDR_EL1寄存器)</div>
<div class="line">    mrs x10, mpidr_el1</div>
<div class="line">    and x10, x10, #0xFF     // 提取Aff0字段作为CPU ID</div>
<div class="line"> </div>
<div class="line">    // 根据CPU ID设置独立栈</div>
<div class="line">    add x10, x10, #1        // x10 = cpu_id + 1</div>
<div class="line">    lsl x10, x10, #12       // x10 *= 4096 (4KB per CPU)</div>
<div class="line">    ldr x11, =stack_top     // 加载栈顶基址</div>
<div class="line">    add x11, x11, x10       // 计算该CPU的栈顶</div>
<div class="line">    mov sp, x11             // 设置栈指针</div>
<div class="line"> </div>
<div class="line">    // 保存传递的参数到栈</div>
<div class="line">    stp x0, x1, [sp, #-16]! // 保存参数并调整栈指针</div>
<div class="line"> </div>
<div class="line">    // 跳转到C代码入口</div>
<div class="line">    bl _start</div>
<div class="line"> </div>
<div class="line">    // 如果返回则进入死循环</div>
<div class="line">    b .</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md78"></a>
3. PSCI CpuOn接口</h3>
<p><code>cpu_io::psci::CpuOn()</code> 函数实现：</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> __always_inline <span class="keyword">auto</span> CpuOn(uint64_t target_cpu,</div>
<div class="line">                                  uint64_t entry_point_address,</div>
<div class="line">                                  uint64_t context_id) -&gt; <span class="keyword">enum</span> <a class="code hl_enumeration" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895f">ErrorCode</a> {</div>
<div class="line">  <span class="keywordflow">return</span> (<a class="code hl_enumeration" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895f">ErrorCode</a>)SecureMonitorCall(kCPU_ON_64, target_cpu,</div>
<div class="line">                                      entry_point_address, context_id,</div>
<div class="line">                                      0, 0, 0, 0).a0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>其中<code>kCPU_ON_64 = 0xC4000003</code>是PSCI标准定义的64位CPU启动功能码。</p>
<h3><a class="anchor" id="autotoc_md79"></a>
4. SMC (Secure Monitor Call) 实现</h3>
<div class="fragment"><div class="line"><span class="keyword">static</span> __always_inline <span class="keyword">auto</span> SecureMonitorCall(uint64_t a0, uint64_t a1,</div>
<div class="line">                                              uint64_t a2, uint64_t a3,</div>
<div class="line">                                              uint64_t a4, uint64_t a5,</div>
<div class="line">                                              uint64_t a6, uint64_t a7)</div>
<div class="line">    -&gt; <span class="keyword">const</span> SMCReturnValue {</div>
<div class="line">  SMCReturnValue result;</div>
<div class="line">  <span class="keyword">register</span> uint64_t x0 __asm__(<span class="stringliteral">&quot;x0&quot;</span>) = a0;</div>
<div class="line">  <span class="keyword">register</span> uint64_t x1 __asm__(<span class="stringliteral">&quot;x1&quot;</span>) = a1;</div>
<div class="line">  <span class="keyword">register</span> uint64_t x2 __asm__(<span class="stringliteral">&quot;x2&quot;</span>) = a2;</div>
<div class="line">  <span class="keyword">register</span> uint64_t x3 __asm__(<span class="stringliteral">&quot;x3&quot;</span>) = a3;</div>
<div class="line">  <span class="keyword">register</span> uint64_t x4 __asm__(<span class="stringliteral">&quot;x4&quot;</span>) = a4;</div>
<div class="line">  <span class="keyword">register</span> uint64_t x5 __asm__(<span class="stringliteral">&quot;x5&quot;</span>) = a5;</div>
<div class="line">  <span class="keyword">register</span> uint64_t x6 __asm__(<span class="stringliteral">&quot;x6&quot;</span>) = a6;</div>
<div class="line">  <span class="keyword">register</span> uint64_t x7 __asm__(<span class="stringliteral">&quot;x7&quot;</span>) = a7;</div>
<div class="line"> </div>
<div class="line">  __asm__ <span class="keyword">volatile</span>(<span class="stringliteral">&quot;smc #0&quot;</span></div>
<div class="line">                   : <span class="stringliteral">&quot;+r&quot;</span>(x0), <span class="stringliteral">&quot;+r&quot;</span>(x1), <span class="stringliteral">&quot;+r&quot;</span>(x2), <span class="stringliteral">&quot;+r&quot;</span>(x3)</div>
<div class="line">                   : <span class="stringliteral">&quot;r&quot;</span>(x4), <span class="stringliteral">&quot;r&quot;</span>(x5), <span class="stringliteral">&quot;r&quot;</span>(x6), <span class="stringliteral">&quot;r&quot;</span>(x7)</div>
<div class="line">                   : <span class="stringliteral">&quot;memory&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  result.a0 = x0;  <span class="comment">// 返回码</span></div>
<div class="line">  result.a1 = x1;  <span class="comment">// 附加返回值</span></div>
<div class="line">  result.a2 = x2;</div>
<div class="line">  result.a3 = x3;</div>
<div class="line">  <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md80"></a>
5. CPU入口处理</h3>
<p>CPU启动后通过 <code><a class="el" href="src_2main_8cpp.html">src/main.cpp</a></code> 的 <code><a class="el" href="kernel_8h.html#a1051fb5b0c9ae8b443c542089ac538bd" title="负责 crtbegin 的工作">_start()</a></code> 函数进入：</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="kernel_8h.html#a1051fb5b0c9ae8b443c542089ac538bd">_start</a>(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> **argv) {</div>
<div class="line">  <span class="keywordflow">if</span> (argv != <span class="keyword">nullptr</span>) {</div>
<div class="line">    <span class="comment">// BSP路径 (参数有效)</span></div>
<div class="line">    <a class="code hl_function" href="sk__libcxx_8h.html#a8c22041b9886ca00cff1e90cd43eb3f2">CppInit</a>();</div>
<div class="line">    <a class="code hl_function" href="tests_2integration__test_2aarch64__minimal_2main_8cpp.html#acdef7a1fd863a6d3770c1268cb06add3">main</a>(argc, argv);</div>
<div class="line">    <a class="code hl_function" href="sk__libcxx_8h.html#ace4b6de6e1ac3081329da66be1b45f76">CppDeInit</a>();</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">// AP路径 (参数为空)</span></div>
<div class="line">    main_smp(argc, argv);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 进入死循环</span></div>
<div class="line">  <span class="keywordflow">while</span> (<span class="keyword">true</span>) { ; }</div>
<div class="line">}</div>
</div><!-- fragment --><p>AP执行 <code>main_smp()</code> -&gt; <code><a class="el" href="aarch64_2arch__main_8cpp.html#ad90b12c5e1b1a5911044c7c1286289da">ArchInitSMP()</a></code> (当前为空实现)</p>
<h2><a class="anchor" id="autotoc_md81"></a>
核心ID获取机制</h2>
<h3><a class="anchor" id="autotoc_md82"></a>
MPIDR_EL1寄存器</h3>
<p>AArch64使用MPIDR_EL1 (Multiprocessor Affinity Register) 获取CPU亲和性信息：</p>
<div class="fragment"><div class="line"><span class="comment">// 获取当前CPU ID</span></div>
<div class="line"><span class="keyword">static</span> __always_inline <span class="keyword">auto</span> GetCurrentCoreId() -&gt; <span class="keywordtype">size_t</span> {</div>
<div class="line">  <span class="keywordflow">return</span> MPIDR_EL1::Aff0::Get();  <span class="comment">// 返回亲和性级别0值</span></div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md83"></a>
亲和性级别含义</h3>
<ul>
<li><b>Aff0 [7:0]</b>: 核心级别 - 同一集群内的核心编号</li>
<li><b>Aff1 [15:8]</b>: 集群级别 - 集群编号</li>
<li><b>Aff2 [23:16]</b>: 更高级别亲和性</li>
<li><b>Aff3 [39:32]</b>: 最高级别亲和性</li>
</ul>
<h3><a class="anchor" id="autotoc_md84"></a>
寄存器访问实现</h3>
<div class="fragment"><div class="line"><span class="comment">// 读取MPIDR_EL1寄存器</span></div>
<div class="line"><span class="keyword">static</span> __always_inline <span class="keyword">auto</span> Read() -&gt; <span class="keyword">typename</span> RegInfo::DataType {</div>
<div class="line">  <span class="keyword">typename</span> RegInfo::DataType value{};</div>
<div class="line">  __asm__ <span class="keyword">volatile</span>(<span class="stringliteral">&quot;mrs %0, MPIDR_EL1&quot;</span> : <span class="stringliteral">&quot;=r&quot;</span>(value) : :);</div>
<div class="line">  <span class="keywordflow">return</span> value;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 提取Aff0字段</span></div>
<div class="line"><span class="keyword">static</span> __always_inline <span class="keyword">auto</span> Get() -&gt; <span class="keyword">typename</span> RegInfo::DataType {</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>typename RegInfo::DataType<span class="keyword">&gt;</span>(</div>
<div class="line">      (Read() &amp; RegInfo::kBitMask) &gt;&gt; RegInfo::kBitOffset);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md85"></a>
PSCI设备树检查</h2>
<h3><a class="anchor" id="autotoc_md86"></a>
CheckPSCI实现</h3>
<p>验证设备树中的PSCI配置：</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> CheckPSCI()<span class="keyword"> const </span>{</div>
<div class="line">  <span class="comment">// 1. 查找PSCI节点</span></div>
<div class="line">  <span class="keyword">auto</span> offset = fdt_path_offset(fdt_header_, <span class="stringliteral">&quot;/psci&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (offset &lt; 0) {</div>
<div class="line">    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;Error finding /psci node: %s\n&quot;</span>, fdt_strerror(offset));</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 2. 检查调用方法</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> *method_prop = fdt_get_property(fdt_header_, offset, <span class="stringliteral">&quot;method&quot;</span>, &amp;len);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *method_str = <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">char</span> *<span class="keyword">&gt;</span>(method_prop-&gt;data);</div>
<div class="line">  <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;PSCI method: %s\n&quot;</span>, method_str);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 当前只支持SMC方法</span></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code hl_define" href="sk__string__test_8cpp.html#a6b5d9a1031ac2602e31df1ba551bfafe">strcmp</a>(method_str, <span class="stringliteral">&quot;smc&quot;</span>) != 0) {</div>
<div class="line">    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;Unsupported PSCI method: %s\n&quot;</span>, method_str);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 3. 验证功能ID</span></div>
<div class="line">  assert_function_id(<span class="stringliteral">&quot;cpu_on&quot;</span>, 0xC4000003);</div>
<div class="line">  assert_function_id(<span class="stringliteral">&quot;cpu_off&quot;</span>, 0x84000002);</div>
<div class="line">  assert_function_id(<span class="stringliteral">&quot;cpu_suspend&quot;</span>, 0xC4000001);</div>
<div class="line">}</div>
<div class="ttc" id="astructklog_1_1Debug_html"><div class="ttname"><a href="structklog_1_1Debug.html">klog::Debug</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00146">kernel_log.hpp:146</a></div></div>
<div class="ttc" id="astructklog_1_1Err_html"><div class="ttname"><a href="structklog_1_1Err.html">klog::Err</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00188">kernel_log.hpp:188</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md87"></a>
内存布局</h2>
<h3><a class="anchor" id="autotoc_md88"></a>
栈分配</h3>
<p>每个CPU分配4KB独立栈空间： </p><div class="fragment"><div class="line">// CPU栈地址计算: stack_top + (cpu_id + 1) * 4KB</div>
<div class="line">add x10, x10, #1        // cpu_id + 1</div>
<div class="line">lsl x10, x10, #12       // * 4096</div>
<div class="line">ldr x11, =stack_top     // 栈基址</div>
<div class="line">add x11, x11, x10       // 最终栈指针</div>
<div class="line"> </div>
<div class="line">.section .bss.boot</div>
<div class="line">.align 16</div>
<div class="line">.global stack_top</div>
<div class="line">stack_top:</div>
<div class="line">    .space 4096 * 4     // 总共16KB栈空间</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md89"></a>
PSCI功能接口</h2>
<h3><a class="anchor" id="autotoc_md90"></a>
核心电源管理</h3>
<div class="fragment"><div class="line"><span class="comment">// CPU启动</span></div>
<div class="line"><span class="keyword">auto</span> CpuOn(uint64_t target_cpu, uint64_t entry_point_address,</div>
<div class="line">           uint64_t context_id) -&gt; <span class="keyword">enum</span> <a class="code hl_enumeration" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895f">ErrorCode</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// CPU关闭</span></div>
<div class="line"><span class="keyword">auto</span> CpuOff() -&gt; <span class="keyword">enum</span> <a class="code hl_enumeration" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895f">ErrorCode</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// CPU挂起</span></div>
<div class="line"><span class="keyword">auto</span> CpuSuspend(PowerState power_state, uint64_t entry_point_address,</div>
<div class="line">                uint64_t context_id) -&gt; <span class="keyword">enum</span> <a class="code hl_enumeration" href="expected_8hpp.html#a4d45a9675d1bf454764383179f3c895f">ErrorCode</a>;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md91"></a>
target_cpu参数格式</h3>
<p>CPU标识符遵循MPIDR格式：</p><ul>
<li><b>位[39:32]</b>: Aff3 - 匹配目标CPU的MPIDR Aff3</li>
<li><b>位[23:16]</b>: Aff2 - 匹配目标CPU的MPIDR Aff2</li>
<li><b>位[15:8]</b>: Aff1 - 匹配目标CPU的MPIDR Aff1</li>
<li><b>位[7:0]</b>: Aff0 - 匹配目标CPU的MPIDR Aff0</li>
<li><b>位[63:40]</b> 和 <b>位[31:24]</b>: 必须为0</li>
</ul>
<h3><a class="anchor" id="autotoc_md92"></a>
电源状态结构</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span>PowerState {</div>
<div class="line">  uint32_t reserved1 : 6;      <span class="comment">// [31:26] 保留</span></div>
<div class="line">  uint32_t power_level : 2;    <span class="comment">// [25:24] 电源级别</span></div>
<div class="line">  uint32_t reserved0 : 7;      <span class="comment">// [23:17] 保留</span></div>
<div class="line">  uint32_t state_type : 1;     <span class="comment">// [16] 状态类型</span></div>
<div class="line">  <span class="keyword">struct </span>StateID state_id;     <span class="comment">// [15:0] 状态ID</span></div>
<div class="line">} <a class="code hl_function" href="include_2sipi_8h.html#a763d4c58430a5a94703eba0ed093d12a">__attribute__</a>((packed));</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md93"></a>
特性和限制</h2>
<h3><a class="anchor" id="autotoc_md94"></a>
支持特性</h3>
<ul>
<li>基于ARM标准PSCI接口的多核启动</li>
<li>通过SMC与EL3固件安全通信</li>
<li>基于MPIDR_EL1的层次化CPU标识</li>
<li>设备树驱动的动态配置</li>
<li>完整的CPU电源状态管理</li>
</ul>
<h3><a class="anchor" id="autotoc_md95"></a>
当前限制</h3>
<ul>
<li><a class="el" href="aarch64_2arch__main_8cpp.html#ad90b12c5e1b1a5911044c7c1286289da">ArchInitSMP()</a>函数为空实现，缺少AP特定初始化</li>
<li>只支持SMC调用方法，不支持HVC</li>
<li>固定的栈大小分配（4KB per CPU）</li>
<li>简化的错误处理机制</li>
</ul>
<h2><a class="anchor" id="autotoc_md96"></a>
调试和监控</h2>
<h3><a class="anchor" id="autotoc_md97"></a>
PSCI功能验证</h3>
<div class="fragment"><div class="line"><span class="comment">// 检查PSCI版本</span></div>
<div class="line"><span class="keyword">auto</span> version = SecureMonitorCall(kVERSION, 0, 0, 0, 0, 0, 0, 0);</div>
<div class="line"><a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;PSCI Version: %d.%d\n&quot;</span>,</div>
<div class="line">           (version.a0 &gt;&gt; 16) &amp; 0xFFFF, version.a0 &amp; 0xFFFF);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 检查功能支持</span></div>
<div class="line"><span class="keyword">auto</span> features = SecureMonitorCall(kFEATURES, kCPU_ON_64, 0, 0, 0, 0, 0, 0);</div>
<div class="line"><span class="keywordflow">if</span> (features.a0 == SUCCESS) {</div>
<div class="line">  <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;PSCI CPU_ON_64 supported\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md98"></a>
CPU状态查询</h3>
<div class="fragment"><div class="line"><span class="comment">// 获取CPU亲和性信息</span></div>
<div class="line"><span class="keyword">auto</span> affinity_info = SecureMonitorCall(kAFFINITY_INFO_64, target_cpu,</div>
<div class="line">                                      0, 0, 0, 0, 0, 0);</div>
<div class="line"><a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;CPU %d affinity state: %d\n&quot;</span>, target_cpu, affinity_info.a0);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md99"></a>
错误处理</h2>
<p>常见的PSCI错误码处理：</p><ul>
<li><b>ALREADY_ON</b>: CPU已经在运行，可以忽略</li>
<li><b>ON_PENDING</b>: CPU正在启动过程中，需要等待</li>
<li><b>NOT_PRESENT</b>: CPU不存在，检查设备树配置</li>
<li><b>INVALID_PARAMETERS</b>: 参数错误，检查target_cpu格式</li>
<li><b>DENIED</b>: 权限不足，检查EL3固件配置 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
