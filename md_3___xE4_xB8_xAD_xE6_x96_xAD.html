<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: å¤šæ¶æ„ä¸­æ–­å¤„ç†ç³»ç»Ÿ</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_3___xE4_xB8_xAD_xE6_x96_xAD.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">å¤šæ¶æ„ä¸­æ–­å¤„ç†ç³»ç»Ÿ</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md143"></a> SimpleKernel å®ç°äº†è·¨å¤šä¸ªæ¶æ„çš„å®Œæ•´ä¸­æ–­å¤„ç†ç³»ç»Ÿï¼Œæ¯ä¸ªæ¶æ„éƒ½æœ‰å…¶ç‰¹å®šçš„ä¸­æ–­æ§åˆ¶å™¨å’Œå¤„ç†æœºåˆ¶ã€‚</p>
<h1><a class="anchor" id="autotoc_md144"></a>
ğŸ—ï¸ æ¶æ„å¯¹æ¯”æ€»è§ˆ</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">ç‰¹æ€§   </th><th class="markdownTableHeadNone">x86_64   </th><th class="markdownTableHeadNone">RISC-V 64   </th><th class="markdownTableHeadNone">AArch64    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ä¸­æ–­æ§åˆ¶å™¨   </td><td class="markdownTableBodyNone">APIC/IO-APIC   </td><td class="markdownTableBodyNone">PLIC/CLINT   </td><td class="markdownTableBodyNone">GIC    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ä¸­æ–­æè¿°ç¬¦   </td><td class="markdownTableBodyNone">IDT (256æ¡ç›®)   </td><td class="markdownTableBodyNone">CSR + trap handler   </td><td class="markdownTableBodyNone">å¼‚å¸¸å‘é‡è¡¨    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">å®šæ—¶å™¨   </td><td class="markdownTableBodyNone">APIC Timer   </td><td class="markdownTableBodyNone">SBI Timer   </td><td class="markdownTableBodyNone">Generic Timer    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">å¤–éƒ¨ä¸­æ–­   </td><td class="markdownTableBodyNone">IRQé‡å®šå‘   </td><td class="markdownTableBodyNone">PLICä¸­æ–­è·¯ç”±   </td><td class="markdownTableBodyNone">GICåˆ†å‘    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">å¤šæ ¸å¯åŠ¨   </td><td class="markdownTableBodyNone">SIPI   </td><td class="markdownTableBodyNone">SBI Hartç®¡ç†   </td><td class="markdownTableBodyNone">PSCI    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ç‰¹æƒçº§åˆ«   </td><td class="markdownTableBodyNone">Ring 0-3   </td><td class="markdownTableBodyNone">M/S/U Mode   </td><td class="markdownTableBodyNone">EL0-3   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md146"></a>
x86_64 ä¸­æ–­å¤„ç†ç³»ç»Ÿ</h1>
<h2><a class="anchor" id="autotoc_md147"></a>
ğŸ—ï¸ ç³»ç»Ÿæ¶æ„</h2>
<h3><a class="anchor" id="autotoc_md148"></a>
æ ¸å¿ƒç»„ä»¶</h3>
<div class="fragment"><div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚                    x86_64 ä¸­æ–­å¤„ç†ç³»ç»Ÿ                       â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  InterruptBase (æŠ½è±¡åŸºç±»)                                   â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ Do(cause, context)                                    â”‚</div>
<div class="line">â”‚  â””â”€â”€ RegisterInterruptFunc(cause, func)                    â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  Interrupt (x86_64å®ç°)                                     â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ä¸­æ–­æè¿°ç¬¦è¡¨(IDT) åˆå§‹åŒ–                                â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ä¸­æ–­å¤„ç†å‡½æ•°æ•°ç»„ç®¡ç†                                    â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ æ¨¡æ¿é€’å½’åˆå§‹åŒ– IDT æ¡ç›®                                 â”‚</div>
<div class="line">â”‚  â””â”€â”€ ä¸­æ–­åˆ†å‘æœºåˆ¶                                           â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  APIC æ§åˆ¶å™¨é›†æˆ                                            â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ Local APIC å®šæ—¶å™¨                                     â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ä¸­æ–­å‘é‡åˆ†é…                                           â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ EOI (End of Interrupt) å¤„ç†                          â”‚</div>
<div class="line">â”‚  â””â”€â”€ IRQ é‡å®šå‘é…ç½®                                         â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  å…·ä½“ä¸­æ–­å¤„ç†å™¨                                             â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ APIC å®šæ—¶å™¨ä¸­æ–­ (0xF0)                                â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ é”®ç›˜ä¸­æ–­ (0xF1)                                       â”‚</div>
<div class="line">â”‚  â””â”€â”€ é»˜è®¤å¼‚å¸¸å¤„ç†å™¨                                         â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md149"></a>
ğŸ“‹ ä¸­æ–­æè¿°ç¬¦è¡¨ (IDT) ç®¡ç†</h2>
<h3><a class="anchor" id="autotoc_md150"></a>
IDT åˆå§‹åŒ–æµç¨‹</h3>
<div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_class" href="classInterrupt.html">Interrupt</a> {</div>
<div class="line">    <span class="comment">// 256ä¸ªä¸­æ–­å¤„ç†å‡½æ•°æ•°ç»„</span></div>
<div class="line">    <span class="keyword">static</span> std::array&lt;InterruptFunc, 256&gt; <a class="code hl_variable" href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">interrupt_handlers</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 256ä¸ªä¸­æ–­æè¿°ç¬¦æ¡ç›®</span></div>
<div class="line">    <span class="keyword">static</span> std::array&lt;cpu_io::IdtrInfo::Idt, 256&gt; <a class="code hl_variable" href="classInterrupt.html#a39f9b021fba2ecfa98709fb0bc0b8aeb">idts</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// æ¨¡æ¿é€’å½’åˆå§‹åŒ–æ‰€æœ‰IDTæ¡ç›®</span></div>
<div class="line">    <span class="keyword">template</span> &lt;u<span class="keywordtype">int</span>8_t no = 0&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">SetUpIdtr</a>();</div>
<div class="line">};</div>
<div class="ttc" id="aclassInterrupt_html"><div class="ttname"><a href="classInterrupt.html">Interrupt</a></div><div class="ttdoc">ä¸­æ–­å¤„ç†</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2include_2interrupt_8h_source.html#l00017">interrupt.h:17</a></div></div>
<div class="ttc" id="aclassInterrupt_html_a39f9b021fba2ecfa98709fb0bc0b8aeb"><div class="ttname"><a href="classInterrupt.html#a39f9b021fba2ecfa98709fb0bc0b8aeb">Interrupt::idts</a></div><div class="ttdeci">static std::array&lt; cpu_io::detail::register_info::IdtrInfo::Idt, cpu_io::detail::register_info::IdtrInfo::kInterruptMaxCount &gt; idts</div><div class="ttdef"><b>Definition</b> <a href="x86__64_2include_2interrupt_8h_source.html#l00050">interrupt.h:50</a></div></div>
<div class="ttc" id="aclassInterrupt_html_a796c78d73d686e605d0cccd332a600e1"><div class="ttname"><a href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">Interrupt::interrupt_handlers</a></div><div class="ttdeci">static std::array&lt; InterruptFunc, kMaxInterrupt &gt; interrupt_handlers</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2include_2interrupt_8h_source.html#l00049">interrupt.h:49</a></div></div>
<div class="ttc" id="aclassInterrupt_html_aa65a42b62d85b12d8da83ad7e68fbe59"><div class="ttname"><a href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">Interrupt::SetUpIdtr</a></div><div class="ttdeci">void SetUpIdtr()</div><div class="ttdoc">åˆå§‹åŒ– idtr</div><div class="ttdef"><b>Definition</b> <a href="x86__64_2interrupt_8cpp_source.html#l00071">interrupt.cpp:71</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md151"></a>
æ¨¡æ¿é€’å½’åˆå§‹åŒ–æœºåˆ¶</h3>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;u<span class="keywordtype">int</span>8_t no&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">Interrupt::SetUpIdtr</a>() {</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keyword">constexpr</span> (<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">no</a> &lt; kInterruptMaxCount - 1) {</div>
<div class="line">        <span class="comment">// ä¸ºæ¯ä¸ªä¸­æ–­å·åˆ›å»ºIDTæ¡ç›®</span></div>
<div class="line">        <a class="code hl_variable" href="classInterrupt.html#a39f9b021fba2ecfa98709fb0bc0b8aeb">idts</a>[<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">no</a>] = cpu_io::IdtrInfo::Idt(</div>
<div class="line">            <span class="keyword">reinterpret_cast&lt;</span><a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint64_t</a><span class="keyword">&gt;</span>(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">TarpEntry&lt;no&gt;</a>),  <span class="comment">// ä¸­æ–­å…¥å£åœ°å€</span></div>
<div class="line">            8,                                          <span class="comment">// ä»£ç æ®µé€‰æ‹©å­</span></div>
<div class="line">            0x0,                                        <span class="comment">// IST (ä¸­æ–­æ ˆè¡¨)</span></div>
<div class="line">            Idt::Type::k64BitInterruptGate,            <span class="comment">// 64ä½ä¸­æ–­é—¨</span></div>
<div class="line">            Idt::DPL::kRing0,                          <span class="comment">// ç‰¹æƒçº§åˆ«0</span></div>
<div class="line">            Idt::P::kPresent                           <span class="comment">// å­˜åœ¨ä½</span></div>
<div class="line">        );</div>
<div class="line">        <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">SetUpIdtr&lt;no + 1&gt;</a>();  <span class="comment">// é€’å½’åˆå§‹åŒ–ä¸‹ä¸€ä¸ª</span></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// æœ€åä¸€æ­¥ï¼šå†™å…¥IDTRå¯„å­˜å™¨</span></div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">auto</span> <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">idtr</a> = IdtrInfo::Idtr{</div>
<div class="line">            .limit = <span class="keyword">sizeof</span>(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">Idt</a>) * kInterruptMaxCount - 1,</div>
<div class="line">            .<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">base</a> = <a class="code hl_variable" href="classInterrupt.html#a39f9b021fba2ecfa98709fb0bc0b8aeb">idts</a>.data(),</div>
<div class="line">        };</div>
<div class="line">        cpu_io::Idtr::Write(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">idtr</a>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md152"></a>
ä¸­æ–­å…¥å£æ¨¡æ¿</h3>
<p>æ¯ä¸ªä¸­æ–­å·éƒ½æœ‰ç‹¬ç«‹çš„å…¥å£å‡½æ•°ï¼š</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;u<span class="keywordtype">int</span>8_t no&gt;</div>
<div class="line"><a class="code hl_function" href="include_2sipi_8h.html#a763d4c58430a5a94703eba0ed093d12a">__attribute__</a>((target(<span class="stringliteral">&quot;general-regs-only&quot;</span>)))</div>
<div class="line"><a class="code hl_function" href="include_2sipi_8h.html#a763d4c58430a5a94703eba0ed093d12a">__attribute__</a>((interrupt))</div>
<div class="line"><span class="keywordtype">void</span> TarpEntry(uint8_t *interrupt_context) {</div>
<div class="line">    <span class="comment">// è°ƒç”¨ç»Ÿä¸€çš„ä¸­æ–­åˆ†å‘å™¨</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().Do(no, interrupt_context);</div>
<div class="line">}</div>
<div class="ttc" id="aclassSingleton_html_a68856b49e098eadba37b60366db33ebd"><div class="ttname"><a href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton::GetInstance</a></div><div class="ttdeci">static auto GetInstance() -&gt; T &amp;</div><div class="ttdef"><b>Definition</b> <a href="singleton_8hpp_source.html#l00023">singleton.hpp:23</a></div></div>
<div class="ttc" id="ainclude_2sipi_8h_html_a763d4c58430a5a94703eba0ed093d12a"><div class="ttname"><a href="include_2sipi_8h.html#a763d4c58430a5a94703eba0ed093d12a">__attribute__</a></div><div class="ttdeci">struct sipi_params_t __attribute__((packed))</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md153"></a>
ğŸ¯ ä¸­æ–­å¤„ç†æµç¨‹</h2>
<h3><a class="anchor" id="autotoc_md154"></a>
1. ç¡¬ä»¶ä¸­æ–­è§¦å‘</h3>
<div class="fragment"><div class="line">ç¡¬ä»¶äº‹ä»¶ â†’ CPU ä¸­æ–­ â†’ æŸ¥æ‰¾ IDT[vector] â†’ è°ƒç”¨ TarpEntry&lt;vector&gt;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md155"></a>
2. è½¯ä»¶ä¸­æ–­åˆ†å‘</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classInterrupt.html#a51915f51ae69c1062c70af4ee128f4d8">Interrupt::Do</a>(uint64_t cause, uint8_t *context) {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a> &lt; kInterruptMaxCount) {</div>
<div class="line">        <span class="comment">// è°ƒç”¨æ³¨å†Œçš„ä¸­æ–­å¤„ç†å‡½æ•°</span></div>
<div class="line">        <a class="code hl_variable" href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">interrupt_handlers</a>[<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>](<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">context</a>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclassInterrupt_html_a51915f51ae69c1062c70af4ee128f4d8"><div class="ttname"><a href="classInterrupt.html#a51915f51ae69c1062c70af4ee128f4d8">Interrupt::Do</a></div><div class="ttdeci">void Do(uint64_t cause, cpu_io::TrapContext *context) override</div><div class="ttdoc">æ‰§è¡Œä¸­æ–­å¤„ç†</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2interrupt_8cpp_source.html#l00039">interrupt.cpp:39</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md156"></a>
3. ä¸­æ–­å¤„ç†å‡½æ•°æ³¨å†Œ</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classInterrupt.html#ad2bbed1f4b7aeda8804d950080d0ebbf">Interrupt::RegisterInterruptFunc</a>(uint64_t cause, InterruptFunc func) {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a> &lt; kInterruptMaxCount) {</div>
<div class="line">        <a class="code hl_variable" href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">interrupt_handlers</a>[<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>] = func;</div>
<div class="line">        <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;RegisterInterruptFunc [%s] 0x%X\n&quot;</span>,</div>
<div class="line">                   <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">kInterruptNames</a>[<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>], <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclassInterrupt_html_ad2bbed1f4b7aeda8804d950080d0ebbf"><div class="ttname"><a href="classInterrupt.html#ad2bbed1f4b7aeda8804d950080d0ebbf">Interrupt::RegisterInterruptFunc</a></div><div class="ttdeci">void RegisterInterruptFunc(uint64_t cause, InterruptFunc func) override</div><div class="ttdoc">æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2interrupt_8cpp_source.html#l00044">interrupt.cpp:44</a></div></div>
<div class="ttc" id="astructklog_1_1Debug_html"><div class="ttname"><a href="structklog_1_1Debug.html">klog::Debug</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00146">kernel_log.hpp:146</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md157"></a>
â° APIC å®šæ—¶å™¨ä¸­æ–­</h2>
<h3><a class="anchor" id="autotoc_md158"></a>
å®šæ—¶å™¨é…ç½®</h3>
<div class="fragment"><div class="line"><span class="comment">// å®šæ—¶å™¨é…ç½®å¸¸é‡</span></div>
<div class="line"><span class="keyword">constexpr</span> uint8_t kApicTimerVector = 0xF0;      <span class="comment">// å®šæ—¶å™¨ä¸­æ–­å‘é‡</span></div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kApicTimerFrequencyHz = 100; <span class="comment">// 100Hz é¢‘ç‡</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// åˆå§‹åŒ–å®šæ—¶å™¨</span></div>
<div class="line"><a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>().SetupPeriodicTimer(</div>
<div class="line">    kApicTimerFrequencyHz,</div>
<div class="line">    kApicTimerVector</div>
<div class="line">);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md159"></a>
å®šæ—¶å™¨ä¸­æ–­å¤„ç†</h3>
<div class="fragment"><div class="line">uint64_t ApicTimerHandler(uint64_t cause, uint8_t *context) {</div>
<div class="line">    <span class="keyword">static</span> uint64_t tick_count = 0;</div>
<div class="line">    tick_count++;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// é™ä½æ—¥å¿—è¾“å‡ºé¢‘ç‡</span></div>
<div class="line">    <span class="keywordflow">if</span> (tick_count % 100 == 0) {</div>
<div class="line">        <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;APIC Timer interrupt %lu, vector 0x%X\n&quot;</span>,</div>
<div class="line">                   tick_count, cause);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å‘é€EOIä¿¡å·ç¡®è®¤ä¸­æ–­å¤„ç†å®Œæˆ</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>().SendEoi();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="astructklog_1_1Info_html"><div class="ttname"><a href="structklog_1_1Info.html">klog::Info</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00168">kernel_log.hpp:168</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md160"></a>
âŒ¨ï¸ é”®ç›˜ä¸­æ–­å¤„ç†</h2>
<h3><a class="anchor" id="autotoc_md161"></a>
é”®ç›˜ä¸­æ–­é…ç½®</h3>
<div class="fragment"><div class="line"><span class="keyword">constexpr</span> uint8_t kKeyboardVector = 0xF1;  <span class="comment">// é”®ç›˜ä¸­æ–­å‘é‡</span></div>
<div class="line"><span class="keyword">constexpr</span> uint8_t kKeyboardIrq = 1;        <span class="comment">// é”®ç›˜ä½¿ç”¨IRQ1</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> EnableKeyboardInterrupt(uint8_t vector) {</div>
<div class="line">    <span class="comment">// è·å–å½“å‰CPUçš„APIC ID</span></div>
<div class="line">    uint32_t destination_apic_id = <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// é…ç½®IRQé‡å®šå‘</span></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>().SetIrqRedirection(</div>
<div class="line">        kKeyboardIrq, vector, destination_apic_id, <span class="keyword">false</span></div>
<div class="line">    );</div>
<div class="line">}</div>
<div class="ttc" id="anamespacecpu__io_html_a52b8a7263a31e6670ef4dec7922d9e72"><div class="ttname"><a href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a></div><div class="ttdeci">auto GetCurrentCoreId() -&gt; size_t</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00026">cpu_io.h:26</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md162"></a>
é”®ç›˜æ‰«æç å¤„ç†</h3>
<div class="fragment"><div class="line">uint64_t KeyboardHandler(uint64_t cause, uint8_t *context) {</div>
<div class="line">    <span class="comment">// è¯»å–é”®ç›˜æ‰«æç  (ç«¯å£0x60)</span></div>
<div class="line">    uint8_t scancode = cpu_io::In&lt;uint8_t&gt;(0x60);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å¤„ç†æŒ‰é”®æŒ‰ä¸‹äº‹ä»¶ (æœ€é«˜ä½ä¸º0)</span></div>
<div class="line">    <span class="keywordflow">if</span> (!(scancode &amp; 0x80)) {</div>
<div class="line">        <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;Key pressed: scancode 0x%02X\n&quot;</span>, scancode);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// æ‰«æç åˆ°ASCIIè½¬æ¢</span></div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> scancode_to_ascii[] = {</div>
<div class="line">            0, 27, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;3&#39;</span>, <span class="charliteral">&#39;4&#39;</span>, <span class="charliteral">&#39;5&#39;</span>, <span class="charliteral">&#39;6&#39;</span>, <span class="charliteral">&#39;7&#39;</span>, <span class="charliteral">&#39;8&#39;</span>, <span class="charliteral">&#39;9&#39;</span>, <span class="charliteral">&#39;0&#39;</span>,</div>
<div class="line">            <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;=&#39;</span>, <span class="charliteral">&#39;\b&#39;</span>, <span class="charliteral">&#39;\t&#39;</span>, <span class="charliteral">&#39;q&#39;</span>, <span class="charliteral">&#39;w&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;r&#39;</span>, <span class="charliteral">&#39;t&#39;</span>, <span class="charliteral">&#39;y&#39;</span>, <span class="charliteral">&#39;u&#39;</span>, <span class="charliteral">&#39;i&#39;</span>,</div>
<div class="line">            <span class="charliteral">&#39;o&#39;</span>, <span class="charliteral">&#39;p&#39;</span>, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;]&#39;</span>, <span class="charliteral">&#39;\n&#39;</span>, 0, <span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;s&#39;</span>, <span class="charliteral">&#39;d&#39;</span>, <span class="charliteral">&#39;f&#39;</span>, <span class="charliteral">&#39;g&#39;</span>, <span class="charliteral">&#39;h&#39;</span>,</div>
<div class="line">            <span class="charliteral">&#39;j&#39;</span>, <span class="charliteral">&#39;k&#39;</span>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;\&#39;&#39;</span>, <span class="charliteral">&#39;`&#39;</span>, 0, <span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;z&#39;</span>, <span class="charliteral">&#39;x&#39;</span>, <span class="charliteral">&#39;c&#39;</span>, <span class="charliteral">&#39;v&#39;</span>,</div>
<div class="line">            <span class="charliteral">&#39;b&#39;</span>, <span class="charliteral">&#39;n&#39;</span>, <span class="charliteral">&#39;m&#39;</span>, <span class="charliteral">&#39;,&#39;</span>, <span class="charliteral">&#39;.&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, 0, <span class="charliteral">&#39;*&#39;</span>, 0, <span class="charliteral">&#39; &#39;</span></div>
<div class="line">        };</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (scancode &lt; <span class="keyword">sizeof</span>(scancode_to_ascii) &amp;&amp;</div>
<div class="line">            scancode_to_ascii[scancode]) {</div>
<div class="line">            <span class="keywordtype">char</span> ascii_char = scancode_to_ascii[scancode];</div>
<div class="line">            <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;Key: &#39;%c&#39;\n&quot;</span>, ascii_char);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å‘é€EOIä¿¡å·</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>().SendEoi();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md163"></a>
ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–</h2>
<h3><a class="anchor" id="autotoc_md164"></a>
ä¸»å¤„ç†å™¨åˆå§‹åŒ– (BSP)</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#a660e4785391d83bb3aa43f15ae53a530">InterruptInit</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **) {</div>
<div class="line">    <span class="comment">// 1. åˆå§‹åŒ–IDT</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().SetUpIdtr();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. æ³¨å†ŒAPICå®šæ—¶å™¨ä¸­æ–­å¤„ç†å‡½æ•°</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        kApicTimerVector, ApicTimerHandler</div>
<div class="line">    );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. æ³¨å†Œé”®ç›˜ä¸­æ–­å¤„ç†å‡½æ•°</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        kKeyboardVector, KeyboardHandler</div>
<div class="line">    );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 4. å¯ç”¨å¤–éƒ¨ä¸­æ–­</span></div>
<div class="line">    <a class="code hl_function" href="namespacecpu__io.html#afe7f925ac3cb632ed212166712288451">cpu_io::EnableInterrupt</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 5. å¯åŠ¨å®šæ—¶å™¨</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>().SetupPeriodicTimer(</div>
<div class="line">        kApicTimerFrequencyHz, kApicTimerVector</div>
<div class="line">    );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 6. å¯ç”¨é”®ç›˜ä¸­æ–­</span></div>
<div class="line">    EnableKeyboardInterrupt(kKeyboardVector);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;x86_64 interrupt system initialized\n&quot;</span>);</div>
<div class="line">}</div>
<div class="ttc" id="aaarch64_2interrupt__main_8cpp_html_a660e4785391d83bb3aa43f15ae53a530"><div class="ttname"><a href="aarch64_2interrupt__main_8cpp.html#a660e4785391d83bb3aa43f15ae53a530">InterruptInit</a></div><div class="ttdeci">void InterruptInit(int, const char **)</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2interrupt__main_8cpp_source.html#l00146">interrupt_main.cpp:146</a></div></div>
<div class="ttc" id="anamespacecpu__io_html_afe7f925ac3cb632ed212166712288451"><div class="ttname"><a href="namespacecpu__io.html#afe7f925ac3cb632ed212166712288451">cpu_io::EnableInterrupt</a></div><div class="ttdeci">void EnableInterrupt()</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00034">cpu_io.h:34</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md165"></a>
ä»å¤„ç†å™¨åˆå§‹åŒ– (AP)</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#ac31c690eba7c84c9327f9f813d4b3fea">InterruptInitSMP</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **) {</div>
<div class="line">    <span class="comment">// 1. æ¯ä¸ªæ ¸å¿ƒéƒ½éœ€è¦åˆå§‹åŒ–è‡ªå·±çš„IDT</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().SetUpIdtr();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. å¯ç”¨ä¸­æ–­</span></div>
<div class="line">    <a class="code hl_function" href="namespacecpu__io.html#afe7f925ac3cb632ed212166712288451">cpu_io::EnableInterrupt</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;x86_64 SMP interrupt initialization complete\n&quot;</span>);</div>
<div class="line">}</div>
<div class="ttc" id="aaarch64_2interrupt__main_8cpp_html_ac31c690eba7c84c9327f9f813d4b3fea"><div class="ttname"><a href="aarch64_2interrupt__main_8cpp.html#ac31c690eba7c84c9327f9f813d4b3fea">InterruptInitSMP</a></div><div class="ttdeci">void InterruptInitSMP(int, const char **)</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2interrupt__main_8cpp_source.html#l00170">interrupt_main.cpp:170</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md166"></a>
ğŸ“Š æ€§èƒ½ç‰¹ç‚¹</h2>
<h3><a class="anchor" id="autotoc_md167"></a>
ä¼˜åŠ¿</h3>
<ul>
<li>**æ¨¡æ¿é€’å½’åˆå§‹åŒ–**ï¼šç¼–è¯‘æ—¶ç”Ÿæˆæ‰€æœ‰IDTæ¡ç›®ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€</li>
<li>**ç±»å‹å®‰å…¨**ï¼šå¼ºç±»å‹çº¦æŸé˜²æ­¢ä¸­æ–­å‘é‡é”™è¯¯</li>
<li>**APICé›†æˆ**ï¼šç°ä»£å¤šæ ¸å¤„ç†å™¨é«˜æ•ˆä¸­æ–­å¤„ç†</li>
<li>**ç»Ÿä¸€æ¥å£**ï¼šInterruptBase æŠ½è±¡å±‚æ”¯æŒè·¨æ¶æ„å…¼å®¹</li>
</ul>
<h3><a class="anchor" id="autotoc_md168"></a>
è®¾è®¡è€ƒé‡</h3>
<ul>
<li>**256ä¸ªä¸­æ–­å‘é‡**ï¼šå®Œæ•´è¦†ç›–x86_64ä¸­æ–­ç©ºé—´</li>
<li>**æ¨¡æ¿å…ƒç¼–ç¨‹**ï¼šå‡å°‘ä»£ç é‡å¤ï¼Œæé«˜æ€§èƒ½</li>
<li>**EOIå¤„ç†**ï¼šç¡®ä¿ä¸­æ–­æ§åˆ¶å™¨çŠ¶æ€æ­£ç¡®</li>
<li>**IRQé‡å®šå‘**ï¼šæ”¯æŒå¤šæ ¸ä¸­æ–­è´Ÿè½½å‡è¡¡</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md170"></a>
RISC-V 64 ä¸­æ–­å¤„ç†ç³»ç»Ÿ</h1>
<h2><a class="anchor" id="autotoc_md171"></a>
ğŸ—ï¸ ç³»ç»Ÿæ¶æ„</h2>
<h3><a class="anchor" id="autotoc_md172"></a>
æ ¸å¿ƒç»„ä»¶</h3>
<div class="fragment"><div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚                   RISC-V ä¸­æ–­å¤„ç†ç³»ç»Ÿ                        â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  InterruptBase (æŠ½è±¡åŸºç±»)                                   â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ Do(cause, context)                                    â”‚</div>
<div class="line">â”‚  â””â”€â”€ RegisterInterruptFunc(cause, func)                    â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  Interrupt (RISC-Vå®ç°)                                     â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ trap å¤„ç†ç¨‹åºå…¥å£                                      â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ å¼‚å¸¸/ä¸­æ–­åˆ†å‘æœºåˆ¶                                       â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ä¸­æ–­å¤„ç†å‡½æ•°æ•°ç»„ç®¡ç†                                    â”‚</div>
<div class="line">â”‚  â””â”€â”€ PLIC ä¸­æ–­æ§åˆ¶å™¨é›†æˆ                                    â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  PLIC (Platform-Level Interrupt Controller)                â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ å¤–éƒ¨ä¸­æ–­æºç®¡ç†                                         â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ä¼˜å…ˆçº§ä»²è£æœºåˆ¶                                         â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ä¸­æ–­è·¯ç”±é…ç½®                                           â”‚</div>
<div class="line">â”‚  â””â”€â”€ ä¸­æ–­å®Œæˆç¡®è®¤                                           â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  SBI å®šæ—¶å™¨é›†æˆ                                             â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ æœºå™¨æ¨¡å¼å®šæ—¶å™¨ä¸­æ–­                                      â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ç›‘ç®¡æ¨¡å¼å®šæ—¶å™¨ä»£ç†                                      â”‚</div>
<div class="line">â”‚  â””â”€â”€ æ—¶é—´ç‰‡è°ƒåº¦æ”¯æŒ                                         â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  è®¾å¤‡æ ‘(DT)ä¸­æ–­é…ç½®                                         â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ PLIC åŸºåœ°å€è§£æ                                       â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ä¸­æ–­å·æ˜ å°„                                             â”‚</div>
<div class="line">â”‚  â””â”€â”€ è®¾å¤‡ä¸­æ–­é…ç½®                                           â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md173"></a>
ğŸ“‹ CSR å¯„å­˜å™¨ç®¡ç†</h2>
<h3><a class="anchor" id="autotoc_md174"></a>
å…³é”®æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨</h3>
<div class="fragment"><div class="line"><span class="comment">// ä¸­æ–­ä½¿èƒ½é…ç½®</span></div>
<div class="line"><span class="keywordtype">void</span> SetupInterrupts() {</div>
<div class="line">    <span class="comment">// ä½¿èƒ½ç›‘ç®¡æ¨¡å¼å¤–éƒ¨ä¸­æ–­ã€å®šæ—¶å™¨ä¸­æ–­å’Œè½¯ä»¶ä¸­æ–­</span></div>
<div class="line">    cpu_io::SIE::SEIE::Set();  <span class="comment">// å¤–éƒ¨ä¸­æ–­ä½¿èƒ½</span></div>
<div class="line">    cpu_io::SIE::STIE::Set();  <span class="comment">// å®šæ—¶å™¨ä¸­æ–­ä½¿èƒ½</span></div>
<div class="line">    cpu_io::SIE::SSIE::Set();  <span class="comment">// è½¯ä»¶ä¸­æ–­ä½¿èƒ½</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// è®¾ç½® trap å¤„ç†ç¨‹åºå…¥å£</span></div>
<div class="line">    cpu_io::STVEC::Write(<span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(TrapEntry));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å…¨å±€ä¸­æ–­ä½¿èƒ½</span></div>
<div class="line">    cpu_io::SSTATUS::SIE::Set();</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md175"></a>
Trap å¤„ç†ç¨‹åºå…¥å£</h3>
<div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> TrapEntry();  <span class="comment">// æ±‡ç¼–å®ç°çš„trapå…¥å£</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// trap åˆ†å‘å‡½æ•°</span></div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> uint64_t TrapHandler(uint64_t cause, uint64_t epc,</div>
<div class="line">                               uint64_t context) {</div>
<div class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦ä¸ºä¸­æ–­ï¼ˆæœ€é«˜ä½ä¸º1ï¼‰</span></div>
<div class="line">    <span class="keywordflow">if</span> (cause &amp; (1ULL &lt;&lt; 63)) {</div>
<div class="line">        uint64_t interrupt_cause = cause &amp; ~(1ULL &lt;&lt; 63);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().Do(</div>
<div class="line">            interrupt_cause,</div>
<div class="line">            <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(context)</div>
<div class="line">        );</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// å¤„ç†å¼‚å¸¸ï¼ˆæœ€é«˜ä½ä¸º0ï¼‰</span></div>
<div class="line">        <span class="keywordflow">return</span> HandleException(cause, epc, context);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md176"></a>
ğŸ¯ ä¸­æ–­å¤„ç†æµç¨‹</h2>
<h3><a class="anchor" id="autotoc_md177"></a>
1. ç¡¬ä»¶ä¸­æ–­æµç¨‹</h3>
<div class="fragment"><div class="line">å¤–éƒ¨è®¾å¤‡ â†’ PLIC â†’ Hart ä¸­æ–­çº¿ â†’ è¯»å– SCAUSE â†’ åˆ†å‘å¤„ç†</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md178"></a>
2. å®šæ—¶å™¨ä¸­æ–­æµç¨‹</h3>
<div class="fragment"><div class="line">SBIå®šæ—¶å™¨ â†’ Mæ¨¡å¼ä¸­æ–­ â†’ ä»£ç†åˆ°Sæ¨¡å¼ â†’ SCAUSE[5] â†’ å¤„ç†å‡½æ•°</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md179"></a>
3. ä¸­æ–­åˆ†å‘æœºåˆ¶</h3>
<div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_class" href="classInterrupt.html">Interrupt</a> : <span class="keyword">public</span> <a class="code hl_class" href="classInterruptBase.html">InterruptBase</a> {</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keywordtype">size_t</span> kInterruptMaxCount = 64;</div>
<div class="line">    <span class="keyword">static</span> std::array&lt;InterruptFunc, kInterruptMaxCount&gt; <a class="code hl_variable" href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">interrupt_handlers</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint64_t</a> <a class="code hl_function" href="classInterrupt.html#a51915f51ae69c1062c70af4ee128f4d8">Do</a>(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint64_t</a> <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint8_t</a> *<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">context</a>)<span class="keyword"> override </span>{</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a> &lt; kInterruptMaxCount &amp;&amp; <a class="code hl_variable" href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">interrupt_handlers</a>[<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>]) {</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code hl_variable" href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">interrupt_handlers</a>[<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>](<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">context</a>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;Unhandled interrupt: cause=%lu\n&quot;</span>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="ttc" id="aclassInterruptBase_html"><div class="ttname"><a href="classInterruptBase.html">InterruptBase</a></div><div class="ttdef"><b>Definition</b> <a href="interrupt__base_8h_source.html#l00014">interrupt_base.h:14</a></div></div>
<div class="ttc" id="astructklog_1_1Warn_html"><div class="ttname"><a href="structklog_1_1Warn.html">klog::Warn</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00178">kernel_log.hpp:178</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md180"></a>
ğŸ›ï¸ PLIC ä¸­æ–­æ§åˆ¶å™¨</h2>
<h3><a class="anchor" id="autotoc_md181"></a>
PLIC åˆå§‹åŒ–é…ç½®</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SetupPlic() {</div>
<div class="line">    <span class="keyword">auto</span> plic_base = GetPlicBaseFromDT();  <span class="comment">// ä»è®¾å¤‡æ ‘è·å–åŸºåœ°å€</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 1. è®¾ç½®æ‰€æœ‰ä¸­æ–­æºä¼˜å…ˆçº§ï¼ˆéé›¶å€¼å¯ç”¨ï¼‰</span></div>
<div class="line">    <span class="keywordflow">for</span> (uint32_t irq = 1; irq &lt;= kMaxInterruptSources; irq++) {</div>
<div class="line">        WritePlicReg(plic_base, PLIC_PRIORITY_BASE + irq * 4, 1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. ä¸ºå½“å‰hartå¯ç”¨æ‰€æœ‰ä¸­æ–­æº</span></div>
<div class="line">    uint32_t hart_id = <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>();</div>
<div class="line">    uint64_t enable_reg = plic_base + PLIC_ENABLE_BASE +</div>
<div class="line">                         hart_id * PLIC_ENABLE_STRIDE;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å¯ç”¨ä¸­æ–­æº 1-63 (æ¯ä¸ªbitä»£è¡¨ä¸€ä¸ªä¸­æ–­æº)</span></div>
<div class="line">    WritePlicReg(enable_reg, 0x0, 0xFFFFFFFE);  <span class="comment">// bits 1-31</span></div>
<div class="line">    WritePlicReg(enable_reg, 0x4, 0xFFFFFFFF);  <span class="comment">// bits 32-63</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. è®¾ç½®ä¸­æ–­ä¼˜å…ˆçº§é˜ˆå€¼ï¼ˆ0è¡¨ç¤ºæ¥å—æ‰€æœ‰ä¼˜å…ˆçº§ï¼‰</span></div>
<div class="line">    uint64_t threshold_reg = plic_base + PLIC_THRESHOLD_BASE +</div>
<div class="line">                            hart_id * PLIC_THRESHOLD_STRIDE;</div>
<div class="line">    WritePlicReg(threshold_reg, 0x0, 0);</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md182"></a>
PLIC ä¸­æ–­å¤„ç†</h3>
<div class="fragment"><div class="line">uint64_t PlicInterruptHandler(uint64_t cause, uint8_t *context) {</div>
<div class="line">    uint32_t hart_id = <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>();</div>
<div class="line">    uint64_t plic_base = GetPlicBaseFromDT();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 1. å£°æ˜(claim)ä¸­æ–­ - è·å–æœ€é«˜ä¼˜å…ˆçº§çš„å¾…å¤„ç†ä¸­æ–­</span></div>
<div class="line">    uint64_t claim_reg = plic_base + PLIC_CLAIM_BASE +</div>
<div class="line">                        hart_id * PLIC_CLAIM_STRIDE;</div>
<div class="line">    uint32_t irq = ReadPlicReg(claim_reg, 0x0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (irq == 0) {</div>
<div class="line">        <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;Spurious PLIC interrupt\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;PLIC interrupt: IRQ %u\n&quot;</span>, irq);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. è°ƒç”¨ç‰¹å®šè®¾å¤‡çš„ä¸­æ–­å¤„ç†ç¨‹åº</span></div>
<div class="line">    <span class="keyword">auto</span> device_handler = GetDeviceHandler(irq);</div>
<div class="line">    <span class="keywordflow">if</span> (device_handler) {</div>
<div class="line">        device_handler(irq, context);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. å®Œæˆ(complete)ä¸­æ–­ - é€šçŸ¥PLICä¸­æ–­å¤„ç†å®Œæˆ</span></div>
<div class="line">    WritePlicReg(claim_reg, 0x0, irq);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md183"></a>
â° SBI å®šæ—¶å™¨ä¸­æ–­</h2>
<h3><a class="anchor" id="autotoc_md184"></a>
å®šæ—¶å™¨é…ç½®</h3>
<div class="fragment"><div class="line"><span class="keyword">constexpr</span> uint64_t kTimerIntervalCycles = 10000000;  <span class="comment">// 10M cycles â‰ˆ 100Hz</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> SetupTimer() {</div>
<div class="line">    <span class="comment">// è®¾ç½®ä¸‹ä¸€æ¬¡å®šæ—¶å™¨ä¸­æ–­æ—¶é—´</span></div>
<div class="line">    uint64_t current_time = cpu_io::Time::Read();</div>
<div class="line">    sbi::SetTimer(current_time + kTimerIntervalCycles);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// æ³¨å†Œå®šæ—¶å™¨ä¸­æ–­å¤„ç†å‡½æ•° (ç›‘ç®¡æ¨¡å¼å®šæ—¶å™¨ä¸­æ–­ = 5)</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        5, TimerInterruptHandler</div>
<div class="line">    );</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md185"></a>
å®šæ—¶å™¨ä¸­æ–­å¤„ç†</h3>
<div class="fragment"><div class="line">uint64_t TimerInterruptHandler(uint64_t cause, uint8_t *context) {</div>
<div class="line">    <span class="keyword">static</span> uint64_t tick_count = 0;</div>
<div class="line">    tick_count++;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// è®¾ç½®ä¸‹ä¸€æ¬¡å®šæ—¶å™¨ä¸­æ–­</span></div>
<div class="line">    uint64_t current_time = cpu_io::Time::Read();</div>
<div class="line">    sbi::SetTimer(current_time + kTimerIntervalCycles);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// é™ä½æ—¥å¿—è¾“å‡ºé¢‘ç‡</span></div>
<div class="line">    <span class="keywordflow">if</span> (tick_count % 100 == 0) {</div>
<div class="line">        <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;Timer interrupt %lu, cause %lu\n&quot;</span>, tick_count, cause);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md186"></a>
ğŸ”Œ UART ä¸­æ–­å¤„ç†</h2>
<h3><a class="anchor" id="autotoc_md187"></a>
UART ä¸­æ–­é…ç½®</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SetupUartInterrupt() {</div>
<div class="line">    <span class="comment">// ä»è®¾å¤‡æ ‘è·å–UARTä¸­æ–­å·</span></div>
<div class="line">    uint32_t uart_irq = GetUartIrqFromDT();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// åœ¨PLICä¸­å¯ç”¨UARTä¸­æ–­</span></div>
<div class="line">    EnablePlicInterrupt(uart_irq);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// æ³¨å†ŒUARTä¸­æ–­å¤„ç†å‡½æ•°</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        uart_irq, UartInterruptHandler</div>
<div class="line">    );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// é…ç½®UARTç¡¬ä»¶å¯ç”¨ä¸­æ–­</span></div>
<div class="line">    ConfigureUartInterrupts();</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md188"></a>
UART ä¸­æ–­å¤„ç†</h3>
<div class="fragment"><div class="line">uint64_t UartInterruptHandler(uint64_t cause, uint8_t *context) {</div>
<div class="line">    <span class="comment">// è¯»å–UARTä¸­æ–­çŠ¶æ€</span></div>
<div class="line">    <span class="keyword">auto</span> uart_base = GetUartBaseFromDT();</div>
<div class="line">    uint32_t interrupt_status = ReadUartReg(uart_base, UART_IIR_OFFSET);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å¤„ç†æ¥æ”¶ä¸­æ–­</span></div>
<div class="line">    <span class="keywordflow">if</span> (interrupt_status &amp; UART_IIR_RDI) {</div>
<div class="line">        <span class="keywordflow">while</span> (ReadUartReg(uart_base, UART_LSR_OFFSET) &amp; UART_LSR_DR) {</div>
<div class="line">            <span class="keywordtype">char</span> received_char = ReadUartReg(uart_base, UART_RBR_OFFSET);</div>
<div class="line">            <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;UART received: &#39;%c&#39; (0x%02X)\n&quot;</span>,</div>
<div class="line">                      received_char, received_char);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// å›æ˜¾å­—ç¬¦</span></div>
<div class="line">            WriteUartReg(uart_base, UART_THR_OFFSET, received_char);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md189"></a>
ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–</h2>
<h3><a class="anchor" id="autotoc_md190"></a>
ä¸»hartåˆå§‹åŒ–</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#a660e4785391d83bb3aa43f15ae53a530">InterruptInit</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **) {</div>
<div class="line">    <span class="comment">// 1. è§£æè®¾å¤‡æ ‘è·å–ä¸­æ–­é…ç½®</span></div>
<div class="line">    <span class="keyword">auto</span> kernel_fdt = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. è®¾ç½®trapå‘é‡</span></div>
<div class="line">    cpu_io::STVEC::Write(<span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(TrapEntry));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. åˆå§‹åŒ–PLIC</span></div>
<div class="line">    SetupPlic();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 4. æ³¨å†Œå®šæ—¶å™¨ä¸­æ–­å¤„ç†å‡½æ•°</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        5, TimerInterruptHandler  <span class="comment">// ç›‘ç®¡æ¨¡å¼å®šæ—¶å™¨ä¸­æ–­</span></div>
<div class="line">    );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 5. æ³¨å†Œå¤–éƒ¨ä¸­æ–­å¤„ç†å‡½æ•°</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        9, PlicInterruptHandler   <span class="comment">// ç›‘ç®¡æ¨¡å¼å¤–éƒ¨ä¸­æ–­</span></div>
<div class="line">    );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 6. å¯ç”¨ä¸­æ–­</span></div>
<div class="line">    cpu_io::SIE::SEIE::Set();   <span class="comment">// å¤–éƒ¨ä¸­æ–­</span></div>
<div class="line">    cpu_io::SIE::STIE::Set();   <span class="comment">// å®šæ—¶å™¨ä¸­æ–­</span></div>
<div class="line">    cpu_io::SSTATUS::SIE::Set(); <span class="comment">// å…¨å±€ä¸­æ–­ä½¿èƒ½</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 7. å¯åŠ¨å®šæ—¶å™¨</span></div>
<div class="line">    SetupTimer();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 8. å¯åŠ¨å…¶ä»–hart</span></div>
<div class="line">    StartSecondaryHarts();</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;RISC-V interrupt system initialized\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md191"></a>
ä»hartåˆå§‹åŒ–</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#ac31c690eba7c84c9327f9f813d4b3fea">InterruptInitSMP</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **) {</div>
<div class="line">    <span class="comment">// 1. è®¾ç½®trapå‘é‡</span></div>
<div class="line">    cpu_io::STVEC::Write(<span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(TrapEntry));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. å¯ç”¨ä¸­æ–­</span></div>
<div class="line">    cpu_io::SIE::SEIE::Set();</div>
<div class="line">    cpu_io::SIE::STIE::Set();</div>
<div class="line">    cpu_io::SSTATUS::SIE::Set();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. å¯åŠ¨å®šæ—¶å™¨</span></div>
<div class="line">    SetupTimer();</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;RISC-V SMP hart %lu initialized\n&quot;</span>,</div>
<div class="line">               <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>());</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md192"></a>
ğŸ“Š æ€§èƒ½ç‰¹ç‚¹</h2>
<h3><a class="anchor" id="autotoc_md193"></a>
ä¼˜åŠ¿</h3>
<ul>
<li>**PLICä¼˜å…ˆçº§ä»²è£**ï¼šç¡¬ä»¶çº§ä¸­æ–­ä¼˜å…ˆçº§ç®¡ç†</li>
<li>**SBIå®šæ—¶å™¨**ï¼šé«˜ç²¾åº¦å®šæ—¶å™¨æœåŠ¡</li>
<li>**è®¾å¤‡æ ‘é…ç½®**ï¼šåŠ¨æ€ç¡¬ä»¶é…ç½®å‘ç°</li>
<li>**å¤šhartæ”¯æŒ**ï¼šåŸç”Ÿå¤šæ ¸ä¸­æ–­å¤„ç†</li>
</ul>
<h3><a class="anchor" id="autotoc_md194"></a>
è®¾è®¡è€ƒé‡</h3>
<ul>
<li>**CSRç›´æ¥è®¿é—®**ï¼šé¿å…ç‰¹æƒçº§åˆ‡æ¢å¼€é”€</li>
<li>**PLICå£°æ˜/å®Œæˆæœºåˆ¶**ï¼šç¡®ä¿ä¸­æ–­ä¸ä¸¢å¤±</li>
<li>**OpenSBIé›†æˆ**ï¼šåˆ©ç”¨å›ºä»¶æœåŠ¡</li>
<li>**trapç»Ÿä¸€å…¥å£**ï¼šç®€åŒ–å¼‚å¸¸å’Œä¸­æ–­å¤„ç†</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md196"></a>
AArch64 ä¸­æ–­å¤„ç†ç³»ç»Ÿ</h1>
<h2><a class="anchor" id="autotoc_md197"></a>
ğŸ—ï¸ ç³»ç»Ÿæ¶æ„</h2>
<h3><a class="anchor" id="autotoc_md198"></a>
æ ¸å¿ƒç»„ä»¶</h3>
<div class="fragment"><div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚                   AArch64 ä¸­æ–­å¤„ç†ç³»ç»Ÿ                       â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  InterruptBase (æŠ½è±¡åŸºç±»)                                   â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ Do(cause, context)                                    â”‚</div>
<div class="line">â”‚  â””â”€â”€ RegisterInterruptFunc(cause, func)                    â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  Interrupt (AArch64å®ç°)                                    â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ å¼‚å¸¸å‘é‡è¡¨(Vector Table)                              â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ å¼‚å¸¸çº§åˆ«ç®¡ç† (EL0-EL3)                                â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ä¸­æ–­å¤„ç†å‡½æ•°æ•°ç»„ç®¡ç†                                    â”‚</div>
<div class="line">â”‚  â””â”€â”€ GIC ä¸­æ–­æ§åˆ¶å™¨é›†æˆ                                    â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  GIC (Generic Interrupt Controller)                        â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ SGI (Software Generated Interrupts)                  â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ PPI (Private Peripheral Interrupts)                  â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ SPI (Shared Peripheral Interrupts)                   â”‚</div>
<div class="line">â”‚  â””â”€â”€ ä¸­æ–­ä¼˜å…ˆçº§å’Œè·¯ç”±ç®¡ç†                                    â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  Generic Timer                                             â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ è™šæ‹Ÿå®šæ—¶å™¨ (EL1 Virtual Timer)                        â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ç‰©ç†å®šæ—¶å™¨ (EL1 Physical Timer)                       â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ é«˜åˆ†è¾¨ç‡æ—¶é—´è®¡æ•°                                        â”‚</div>
<div class="line">â”‚  â””â”€â”€ å®šæ—¶å™¨ä¸­æ–­ç”Ÿæˆ                                         â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚  è®¾å¤‡æ ‘(DT)ä¸­æ–­é…ç½®                                         â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ GIC åŸºåœ°å€è§£æ                                        â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ ä¸­æ–­å·æ˜ å°„å…³ç³»                                         â”‚</div>
<div class="line">â”‚  â”œâ”€â”€ è®¾å¤‡ä¸­æ–­é…ç½®                                           â”‚</div>
<div class="line">â”‚  â””â”€â”€ PSCI å¤šæ ¸å¯åŠ¨ç®¡ç†                                      â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md199"></a>
ğŸ“‹ å¼‚å¸¸å‘é‡è¡¨ç®¡ç†</h2>
<h3><a class="anchor" id="autotoc_md200"></a>
å¼‚å¸¸å‘é‡è¡¨ç»“æ„</h3>
<div class="fragment"><div class="line"><span class="comment">// å¼‚å¸¸å‘é‡è¡¨å…¥å£å®šä¹‰</span></div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#a2a09df74b4cb8ba4d0fe481aaa679816">vector_table</a>();  <span class="comment">// æ±‡ç¼–å®ç°çš„å‘é‡è¡¨</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// å‘é‡è¡¨åŒ…å«16ä¸ªå…¥å£ï¼Œæ¯ä¸ªå…¥å£128å­—èŠ‚</span></div>
<div class="line"><span class="keyword">struct </span>ExceptionVectors {</div>
<div class="line">    <span class="comment">// Current EL with SP0</span></div>
<div class="line">    <span class="keywordtype">void</span> curr_el_sp0_sync();     <span class="comment">// åŒæ­¥å¼‚å¸¸</span></div>
<div class="line">    <span class="keywordtype">void</span> curr_el_sp0_irq();      <span class="comment">// IRQä¸­æ–­</span></div>
<div class="line">    <span class="keywordtype">void</span> curr_el_sp0_fiq();      <span class="comment">// FIQä¸­æ–­</span></div>
<div class="line">    <span class="keywordtype">void</span> curr_el_sp0_serror();   <span class="comment">// SErrorå¼‚å¸¸</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Current EL with SPx</span></div>
<div class="line">    <span class="keywordtype">void</span> curr_el_spx_sync();</div>
<div class="line">    <span class="keywordtype">void</span> curr_el_spx_irq();</div>
<div class="line">    <span class="keywordtype">void</span> curr_el_spx_fiq();</div>
<div class="line">    <span class="keywordtype">void</span> curr_el_spx_serror();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Lower EL using AArch64</span></div>
<div class="line">    <span class="keywordtype">void</span> lower_el_aarch64_sync();</div>
<div class="line">    <span class="keywordtype">void</span> lower_el_aarch64_irq();</div>
<div class="line">    <span class="keywordtype">void</span> lower_el_aarch64_fiq();</div>
<div class="line">    <span class="keywordtype">void</span> lower_el_aarch64_serror();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Lower EL using AArch32</span></div>
<div class="line">    <span class="keywordtype">void</span> lower_el_aarch32_sync();</div>
<div class="line">    <span class="keywordtype">void</span> lower_el_aarch32_irq();</div>
<div class="line">    <span class="keywordtype">void</span> lower_el_aarch32_fiq();</div>
<div class="line">    <span class="keywordtype">void</span> lower_el_aarch32_serror();</div>
<div class="line">};</div>
<div class="ttc" id="aaarch64_2interrupt__main_8cpp_html_a2a09df74b4cb8ba4d0fe481aaa679816"><div class="ttname"><a href="aarch64_2interrupt__main_8cpp.html#a2a09df74b4cb8ba4d0fe481aaa679816">vector_table</a></div><div class="ttdeci">void vector_table()</div><div class="ttdoc">ä¸­æ–­å¤„ç†å‡½æ•°</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md201"></a>
å¼‚å¸¸å¤„ç†å™¨å®ç°</h3>
<div class="fragment"><div class="line"><span class="comment">// C++å¼‚å¸¸å¤„ç†å‡½æ•°</span></div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> sync_exception_handler(uint64_t esr, uint64_t elr,</div>
<div class="line">                                       uint64_t context) {</div>
<div class="line">    uint32_t ec = (esr &gt;&gt; 26) &amp; 0x3F;  <span class="comment">// Exception Class</span></div>
<div class="line">    uint32_t iss = esr &amp; 0xFFFFFF;     <span class="comment">// Instruction Specific Syndrome</span></div>
<div class="line"> </div>
<div class="line">    klog::Error(<span class="stringliteral">&quot;Sync exception: EC=0x%X, ISS=0x%X, ELR=0x%lX\n&quot;</span>,</div>
<div class="line">                ec, iss, elr);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// æ ¹æ®å¼‚å¸¸ç±»å‹è¿›è¡Œå¤„ç†</span></div>
<div class="line">    <span class="keywordflow">switch</span> (ec) {</div>
<div class="line">        <span class="keywordflow">case</span> 0x15:  <span class="comment">// SVC instruction execution in AArch64 state</span></div>
<div class="line">            HandleSvc(iss, context);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x21:  <span class="comment">// Instruction abort from lower EL</span></div>
<div class="line">            HandleInstructionAbort(iss, elr);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x25:  <span class="comment">// Data abort from lower EL</span></div>
<div class="line">            HandleDataAbort(iss, elr);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            klog::Error(<span class="stringliteral">&quot;Unhandled sync exception\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> irq_exception_handler(uint64_t context) {</div>
<div class="line">    <span class="comment">// è¯»å–ä¸­æ–­ç¡®è®¤å¯„å­˜å™¨è·å–ä¸­æ–­ID</span></div>
<div class="line">    uint32_t intid = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Gic&gt;::GetInstance</a>().GetInterruptId();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (intid == 1023) {  <span class="comment">// Spurious interrupt</span></div>
<div class="line">        <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;Spurious interrupt\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// è°ƒç”¨æ³¨å†Œçš„ä¸­æ–­å¤„ç†å‡½æ•°</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().Do(intid,</div>
<div class="line">        <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(context));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å‘é€End of Interruptä¿¡å·</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Gic&gt;::GetInstance</a>().EndOfInterrupt(intid);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md202"></a>
ğŸ¯ ä¸­æ–­å¤„ç†æµç¨‹</h2>
<h3><a class="anchor" id="autotoc_md203"></a>
1. ç¡¬ä»¶ä¸­æ–­æµç¨‹</h3>
<div class="fragment"><div class="line">å¤–éƒ¨è®¾å¤‡ â†’ GICåˆ†å‘å™¨ â†’ CPUæ¥å£ â†’ å¼‚å¸¸å‘é‡è¡¨ â†’ IRQå¤„ç†å™¨</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md204"></a>
2. ä¸­æ–­IDè·å–å’Œå¤„ç†</h3>
<div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_class" href="classInterrupt.html">Interrupt</a> : <span class="keyword">public</span> <a class="code hl_class" href="classInterruptBase.html">InterruptBase</a> {</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keywordtype">size_t</span> kInterruptMaxCount = 1024;  <span class="comment">// GICæ”¯æŒ1024ä¸ªä¸­æ–­</span></div>
<div class="line">    <span class="keyword">static</span> std::array&lt;InterruptFunc, kInterruptMaxCount&gt; <a class="code hl_variable" href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">interrupt_handlers</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint64_t</a> <a class="code hl_function" href="classInterrupt.html#a51915f51ae69c1062c70af4ee128f4d8">Do</a>(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint64_t</a> <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint8_t</a> *<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">context</a>)<span class="keyword"> override </span>{</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a> &lt; kInterruptMaxCount &amp;&amp; <a class="code hl_variable" href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">interrupt_handlers</a>[<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>]) {</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code hl_variable" href="classInterrupt.html#a796c78d73d686e605d0cccd332a600e1">interrupt_handlers</a>[<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>](<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">context</a>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;Unhandled interrupt: INTID=%lu\n&quot;</span>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cause</a>);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// è®¾ç½®ä¸­æ–­ä¸ºSPIç±»å‹</span></div>
<div class="line">    <span class="keywordtype">void</span> <a class="code hl_function" href="classInterrupt.html#a97a05ff3ce620392d7d1681dfadf119a">SPI</a>(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint32_t</a> <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">intid</a>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint32_t</a> <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cpu_id</a>) {</div>
<div class="line">        <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Gic&gt;::GetInstance</a>().SetInterruptType(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">intid</a>,</div>
<div class="line">            Gic::InterruptType::SPI);</div>
<div class="line">        <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Gic&gt;::GetInstance</a>().SetTargetCpu(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">intid</a>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cpu_id</a>);</div>
<div class="line">        <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Gic&gt;::GetInstance</a>().EnableInterrupt(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">intid</a>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// è®¾ç½®ä¸­æ–­ä¸ºPPIç±»å‹</span></div>
<div class="line">    <span class="keywordtype">void</span> <a class="code hl_function" href="classInterrupt.html#a724313558675f9b3c0f1504907519ec7">PPI</a>(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint32_t</a> <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">intid</a>, <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">uint32_t</a> <a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">cpu_id</a>) {</div>
<div class="line">        <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Gic&gt;::GetInstance</a>().SetInterruptType(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">intid</a>,</div>
<div class="line">            Gic::InterruptType::PPI);</div>
<div class="line">        <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Gic&gt;::GetInstance</a>().EnableInterrupt(<a class="code hl_function" href="classInterrupt.html#aa65a42b62d85b12d8da83ad7e68fbe59">intid</a>);</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="ttc" id="aclassInterrupt_html_a724313558675f9b3c0f1504907519ec7"><div class="ttname"><a href="classInterrupt.html#a724313558675f9b3c0f1504907519ec7">Interrupt::PPI</a></div><div class="ttdeci">__always_inline void PPI(uint32_t intid, uint32_t cpuid) const</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2include_2interrupt_8h_source.html#l00041">interrupt.h:41</a></div></div>
<div class="ttc" id="aclassInterrupt_html_a97a05ff3ce620392d7d1681dfadf119a"><div class="ttname"><a href="classInterrupt.html#a97a05ff3ce620392d7d1681dfadf119a">Interrupt::SPI</a></div><div class="ttdeci">__always_inline void SPI(uint32_t intid, uint32_t cpuid) const</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2include_2interrupt_8h_source.html#l00038">interrupt.h:38</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md205"></a>
ğŸ›ï¸ GIC ä¸­æ–­æ§åˆ¶å™¨</h2>
<h3><a class="anchor" id="autotoc_md206"></a>
GIC åˆå§‹åŒ–é…ç½®</h3>
<div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_class" href="classGic.html">Gic</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> uint32_t <a class="code hl_variable" href="classGic.html#aada584a8107ea93e10754834166cd1f5">kSGIBase</a> = 0;      <span class="comment">// SGI: 0-15</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> uint32_t <a class="code hl_variable" href="classGic.html#a56c9c92897f2819cbcf33cda56f13ebc">kPPIBase</a> = 16;     <span class="comment">// PPI: 16-31</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> uint32_t <a class="code hl_variable" href="classGic.html#a4cce758a89d33ca112a0c42d162fed99">kSPIBase</a> = 32;     <span class="comment">// SPI: 32-1019</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code hl_function" href="classGic.html#a95e93d4c431de2b81969c6503801301e">SetUP</a>() {</div>
<div class="line">        <span class="keyword">auto</span> gic_base = GetGicBaseFromDT();  <span class="comment">// ä»è®¾å¤‡æ ‘è·å–åŸºåœ°å€</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// 1. åˆå§‹åŒ–åˆ†å‘å™¨(Distributor)</span></div>
<div class="line">        InitDistributor(gic_base);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// 2. åˆå§‹åŒ–CPUæ¥å£</span></div>
<div class="line">        InitCpuInterface(gic_base);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// 3. å¯ç”¨åˆ†å‘å™¨</span></div>
<div class="line">        EnableDistributor();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> InitDistributor(uint64_t dist_base) {</div>
<div class="line">        <span class="comment">// ç¦ç”¨åˆ†å‘å™¨è¿›è¡Œé…ç½®</span></div>
<div class="line">        WriteReg(dist_base + GICD_CTLR, 0);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// é…ç½®æ‰€æœ‰SPIä¸ºè¾¹æ²¿è§¦å‘ï¼Œé«˜ä¼˜å…ˆçº§</span></div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t i = <a class="code hl_variable" href="classGic.html#a4cce758a89d33ca112a0c42d162fed99">kSPIBase</a>; i &lt; 1020; i += 32) {</div>
<div class="line">            WriteReg(dist_base + GICD_ICFGR + (i/16)*4, 0x55555555);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// è®¾ç½®æ‰€æœ‰ä¸­æ–­ä¼˜å…ˆçº§</span></div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; 1020; i += 4) {</div>
<div class="line">            WriteReg(dist_base + GICD_IPRIORITYR + i, 0xA0A0A0A0);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// è®¾ç½®SPIç›®æ ‡CPUä¸ºCPU0</span></div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t i = <a class="code hl_variable" href="classGic.html#a4cce758a89d33ca112a0c42d162fed99">kSPIBase</a>; i &lt; 1020; i += 4) {</div>
<div class="line">            WriteReg(dist_base + GICD_ITARGETSR + i, 0x01010101);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> InitCpuInterface(uint64_t cpu_base) {</div>
<div class="line">        <span class="comment">// è®¾ç½®ä¼˜å…ˆçº§æ©ç (å…è®¸æ‰€æœ‰ä¼˜å…ˆçº§)</span></div>
<div class="line">        WriteReg(cpu_base + GICC_PMR, 0xFF);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// å¯ç”¨CPUæ¥å£</span></div>
<div class="line">        WriteReg(cpu_base + GICC_CTLR, GICC_CTLR_ENABLE);</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="ttc" id="aclassGic_html"><div class="ttname"><a href="classGic.html">Gic</a></div><div class="ttdoc">gic ä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨</div><div class="ttdef"><b>Definition</b> <a href="gic_8h_source.html#l00020">gic.h:20</a></div></div>
<div class="ttc" id="aclassGic_html_a4cce758a89d33ca112a0c42d162fed99"><div class="ttname"><a href="classGic.html#a4cce758a89d33ca112a0c42d162fed99">Gic::kSPIBase</a></div><div class="ttdeci">static constexpr size_t kSPIBase</div><div class="ttdef"><b>Definition</b> <a href="gic_8h_source.html#l00028">gic.h:28</a></div></div>
<div class="ttc" id="aclassGic_html_a56c9c92897f2819cbcf33cda56f13ebc"><div class="ttname"><a href="classGic.html#a56c9c92897f2819cbcf33cda56f13ebc">Gic::kPPIBase</a></div><div class="ttdeci">static constexpr size_t kPPIBase</div><div class="ttdef"><b>Definition</b> <a href="gic_8h_source.html#l00026">gic.h:26</a></div></div>
<div class="ttc" id="aclassGic_html_a95e93d4c431de2b81969c6503801301e"><div class="ttname"><a href="classGic.html#a95e93d4c431de2b81969c6503801301e">Gic::SetUP</a></div><div class="ttdeci">void SetUP() const</div><div class="ttdef"><b>Definition</b> <a href="gic_8cpp_source.html#l00023">gic.cpp:23</a></div></div>
<div class="ttc" id="aclassGic_html_aada584a8107ea93e10754834166cd1f5"><div class="ttname"><a href="classGic.html#aada584a8107ea93e10754834166cd1f5">Gic::kSGIBase</a></div><div class="ttdeci">static constexpr size_t kSGIBase</div><div class="ttdef"><b>Definition</b> <a href="gic_8h_source.html#l00024">gic.h:24</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md207"></a>
GIC ä¸­æ–­å¤„ç†</h3>
<div class="fragment"><div class="line">uint32_t Gic::GetInterruptId() {</div>
<div class="line">    uint64_t cpu_base = GetGicCpuBaseFromDT();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// è¯»å–ä¸­æ–­ç¡®è®¤å¯„å­˜å™¨</span></div>
<div class="line">    uint32_t iar = ReadReg(cpu_base + GICC_IAR);</div>
<div class="line">    <span class="keywordflow">return</span> iar &amp; 0x3FF;  <span class="comment">// INTIDåœ¨ä½10ä½</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> Gic::EndOfInterrupt(uint32_t intid) {</div>
<div class="line">    uint64_t cpu_base = GetGicCpuBaseFromDT();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å†™å…¥ä¸­æ–­ç»“æŸå¯„å­˜å™¨</span></div>
<div class="line">    WriteReg(cpu_base + GICC_EOIR, intid);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> Gic::EnableInterrupt(uint32_t intid) {</div>
<div class="line">    uint64_t dist_base = GetGicDistBaseFromDT();</div>
<div class="line"> </div>
<div class="line">    uint32_t reg_offset = (intid / 32) * 4;</div>
<div class="line">    uint32_t bit_offset = intid % 32;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// è®¾ç½®ä½¿èƒ½ä½</span></div>
<div class="line">    WriteReg(dist_base + GICD_ISENABLER + reg_offset,</div>
<div class="line">             1U &lt;&lt; bit_offset);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md208"></a>
â° Generic Timer ä¸­æ–­</h2>
<h3><a class="anchor" id="autotoc_md209"></a>
å®šæ—¶å™¨é…ç½®</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SetupTimer() {</div>
<div class="line">    <span class="comment">// ä»è®¾å¤‡æ ‘è·å–å®šæ—¶å™¨ä¸­æ–­ID</span></div>
<div class="line">    <span class="keyword">auto</span> timer_intid = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>()</div>
<div class="line">        .GetAarch64Intid(<span class="stringliteral">&quot;arm,armv8-timer&quot;</span>) + <a class="code hl_variable" href="classGic.html#a56c9c92897f2819cbcf33cda56f13ebc">Gic::kPPIBase</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// é…ç½®ä¸ºPPIç±»å‹ä¸­æ–­</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().PPI(timer_intid,</div>
<div class="line">        <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// æ³¨å†Œå®šæ—¶å™¨ä¸­æ–­å¤„ç†å‡½æ•°</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        timer_intid, timer_handler);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// é…ç½®è™šæ‹Ÿå®šæ—¶å™¨</span></div>
<div class="line">    cpu_io::CNTV_CTL_EL0::ENABLE::Clear();  <span class="comment">// å…ˆç¦ç”¨</span></div>
<div class="line">    cpu_io::CNTV_CTL_EL0::IMASK::Set();     <span class="comment">// å±è”½ä¸­æ–­</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// è®¾ç½®å®šæ—¶å™¨é—´éš” (2ç§’)</span></div>
<div class="line">    uint64_t interval_clk = 2 * cpu_io::CNTFRQ_EL0::Read();</div>
<div class="line">    cpu_io::CNTV_TVAL_EL0::Write(interval_clk);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å¯ç”¨å®šæ—¶å™¨å’Œä¸­æ–­</span></div>
<div class="line">    cpu_io::CNTV_CTL_EL0::ENABLE::Set();    <span class="comment">// å¯ç”¨å®šæ—¶å™¨</span></div>
<div class="line">    cpu_io::CNTV_CTL_EL0::IMASK::Clear();   <span class="comment">// å–æ¶ˆä¸­æ–­å±è”½</span></div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md210"></a>
å®šæ—¶å™¨ä¸­æ–­å¤„ç†</h3>
<div class="fragment"><div class="line">uint64_t timer_handler(uint64_t cause, uint8_t *context) {</div>
<div class="line">    <span class="keyword">static</span> uint64_t tick_count = 0;</div>
<div class="line">    tick_count++;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// é‡æ–°è®¾ç½®ä¸‹ä¸€æ¬¡å®šæ—¶å™¨ä¸­æ–­</span></div>
<div class="line">    uint64_t interval_clk = 2 * cpu_io::CNTFRQ_EL0::Read();</div>
<div class="line">    cpu_io::CNTV_TVAL_EL0::Write(interval_clk);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// é™ä½æ—¥å¿—è¾“å‡ºé¢‘ç‡</span></div>
<div class="line">    <span class="keywordflow">if</span> (tick_count % 10 == 0) {</div>
<div class="line">        <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;Timer interrupt %lu, INTID %lu\n&quot;</span>, tick_count, cause);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md211"></a>
ğŸ”Œ UART ä¸­æ–­å¤„ç†</h2>
<h3><a class="anchor" id="autotoc_md212"></a>
UART ä¸­æ–­é…ç½®</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SetupUartInterrupt() {</div>
<div class="line">    <span class="comment">// ä»è®¾å¤‡æ ‘è·å–UARTä¸­æ–­ID</span></div>
<div class="line">    <span class="keyword">auto</span> uart_intid = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>()</div>
<div class="line">        .GetAarch64Intid(<span class="stringliteral">&quot;arm,pl011&quot;</span>) + <a class="code hl_variable" href="classGic.html#a4cce758a89d33ca112a0c42d162fed99">Gic::kSPIBase</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// é…ç½®ä¸ºSPIç±»å‹ä¸­æ–­ï¼Œè·¯ç”±åˆ°å½“å‰CPU</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().SPI(uart_intid,</div>
<div class="line">        <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// æ³¨å†ŒUARTä¸­æ–­å¤„ç†å‡½æ•°</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        uart_intid, <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#afeb27dda805c973ef825d7f26ea196c8">uart_handler</a>);</div>
<div class="line">}</div>
<div class="ttc" id="aaarch64_2interrupt__main_8cpp_html_afeb27dda805c973ef825d7f26ea196c8"><div class="ttname"><a href="aarch64_2interrupt__main_8cpp.html#afeb27dda805c973ef825d7f26ea196c8">uart_handler</a></div><div class="ttdeci">auto uart_handler(uint64_t cause, cpu_io::TrapContext *) -&gt; uint64_t</div><div class="ttdef"><b>Definition</b> <a href="aarch64_2interrupt__main_8cpp_source.html#l00141">interrupt_main.cpp:141</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md213"></a>
UART ä¸­æ–­å¤„ç†</h3>
<div class="fragment"><div class="line">uint64_t <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#afeb27dda805c973ef825d7f26ea196c8">uart_handler</a>(uint64_t cause, uint8_t *context) {</div>
<div class="line">    <span class="keyword">auto</span> uart_base = GetUartBaseFromDT();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// è¯»å–ä¸­æ–­çŠ¶æ€</span></div>
<div class="line">    uint32_t mis = ReadReg(uart_base + PL011_MIS);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å¤„ç†æ¥æ”¶ä¸­æ–­</span></div>
<div class="line">    <span class="keywordflow">if</span> (mis &amp; PL011_MIS_RXMIS) {</div>
<div class="line">        <span class="keywordflow">while</span> (!(ReadReg(uart_base + PL011_FR) &amp; PL011_FR_RXFE)) {</div>
<div class="line">            <span class="keywordtype">char</span> received_char = ReadReg(uart_base + PL011_DR) &amp; 0xFF;</div>
<div class="line">            <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;UART received: &#39;%c&#39; (0x%02X)\n&quot;</span>,</div>
<div class="line">                      received_char, received_char);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// å›æ˜¾å­—ç¬¦</span></div>
<div class="line">            WriteReg(uart_base + PL011_DR, received_char);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// æ¸…é™¤æ¥æ”¶ä¸­æ–­</span></div>
<div class="line">        WriteReg(uart_base + PL011_ICR, PL011_ICR_RXIC);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// å¤„ç†å‘é€ä¸­æ–­</span></div>
<div class="line">    <span class="keywordflow">if</span> (mis &amp; PL011_MIS_TXMIS) {</div>
<div class="line">        <span class="comment">// å‘é€ç¼“å†²åŒºç©ºï¼Œå¯ä»¥å‘é€æ›´å¤šæ•°æ®</span></div>
<div class="line">        WriteReg(uart_base + PL011_ICR, PL011_ICR_TXIC);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md214"></a>
ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–</h2>
<h3><a class="anchor" id="autotoc_md215"></a>
ä¸»å¤„ç†å™¨åˆå§‹åŒ– (Primary CPU)</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#a660e4785391d83bb3aa43f15ae53a530">InterruptInit</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **) {</div>
<div class="line">    <span class="comment">// 1. è®¾ç½®å¼‚å¸¸å‘é‡è¡¨åŸºåœ°å€</span></div>
<div class="line">    cpu_io::VBAR_EL1::Write(<span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(<a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#a2a09df74b4cb8ba4d0fe481aaa679816">vector_table</a>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. åˆå§‹åŒ–GIC</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().SetUP();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. é…ç½®å®šæ—¶å™¨ä¸­æ–­</span></div>
<div class="line">    <span class="keyword">auto</span> timer_intid = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>()</div>
<div class="line">        .GetAarch64Intid(<span class="stringliteral">&quot;arm,armv8-timer&quot;</span>) + <a class="code hl_variable" href="classGic.html#a56c9c92897f2819cbcf33cda56f13ebc">Gic::kPPIBase</a>;</div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().PPI(timer_intid,</div>
<div class="line">        <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>());</div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        timer_intid, timer_handler);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 4. é…ç½®UARTä¸­æ–­</span></div>
<div class="line">    <span class="keyword">auto</span> uart_intid = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>()</div>
<div class="line">        .GetAarch64Intid(<span class="stringliteral">&quot;arm,pl011&quot;</span>) + <a class="code hl_variable" href="classGic.html#a4cce758a89d33ca112a0c42d162fed99">Gic::kSPIBase</a>;</div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().SPI(uart_intid,</div>
<div class="line">        <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>());</div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        uart_intid, <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#afeb27dda805c973ef825d7f26ea196c8">uart_handler</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 5. å¯ç”¨ä¸­æ–­</span></div>
<div class="line">    <a class="code hl_function" href="namespacecpu__io.html#afe7f925ac3cb632ed212166712288451">cpu_io::EnableInterrupt</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 6. å¯åŠ¨å®šæ—¶å™¨</span></div>
<div class="line">    SetupTimer();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 7. å¯åŠ¨å…¶ä»–CPUæ ¸å¿ƒ</span></div>
<div class="line">    StartSecondaryCpus();</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;AArch64 interrupt system initialized\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md216"></a>
ä»å¤„ç†å™¨åˆå§‹åŒ– (Secondary CPUs)</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#ac31c690eba7c84c9327f9f813d4b3fea">InterruptInitSMP</a>(<span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> **) {</div>
<div class="line">    <span class="comment">// 1. è®¾ç½®å¼‚å¸¸å‘é‡è¡¨</span></div>
<div class="line">    cpu_io::VBAR_EL1::Write(<span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(<a class="code hl_function" href="aarch64_2interrupt__main_8cpp.html#a2a09df74b4cb8ba4d0fe481aaa679816">vector_table</a>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. åˆå§‹åŒ–GIC CPUæ¥å£</span></div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().SetUP();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. é…ç½®å®šæ—¶å™¨ä¸­æ–­</span></div>
<div class="line">    <span class="keyword">auto</span> timer_intid = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance</a>()</div>
<div class="line">        .GetAarch64Intid(<span class="stringliteral">&quot;arm,armv8-timer&quot;</span>) + <a class="code hl_variable" href="classGic.html#a56c9c92897f2819cbcf33cda56f13ebc">Gic::kPPIBase</a>;</div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().PPI(timer_intid,</div>
<div class="line">        <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>());</div>
<div class="line">    <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance</a>().RegisterInterruptFunc(</div>
<div class="line">        timer_intid, timer_handler);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 4. å¯ç”¨ä¸­æ–­</span></div>
<div class="line">    <a class="code hl_function" href="namespacecpu__io.html#afe7f925ac3cb632ed212166712288451">cpu_io::EnableInterrupt</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 5. å¯åŠ¨å®šæ—¶å™¨</span></div>
<div class="line">    SetupTimer();</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;AArch64 SMP CPU %u initialized\n&quot;</span>,</div>
<div class="line">               <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>());</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md217"></a>
å¤šæ ¸å¯åŠ¨æµç¨‹</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> StartSecondaryCpus() {</div>
<div class="line">    <span class="keywordtype">size_t</span> core_count = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;BasicInfo&gt;::GetInstance</a>().core_count;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 1; i &lt; core_count; i++) {  <span class="comment">// è·³è¿‡CPU 0</span></div>
<div class="line">        <span class="comment">// ä½¿ç”¨PSCIå¯åŠ¨CPU</span></div>
<div class="line">        <span class="keyword">auto</span> ret = cpu_io::psci::CpuOn(i,</div>
<div class="line">            <span class="keyword">reinterpret_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(<a class="code hl_function" href="basic__info_8hpp.html#a698036b5e342c2164fb7fd7249d0e801">_boot</a>), 0);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((ret != cpu_io::psci::SUCCESS) &amp;&amp;</div>
<div class="line">            (ret != cpu_io::psci::ALREADY_ON)) {</div>
<div class="line">            <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;CPU %d start failed: %d\n&quot;</span>, i, ret);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;CPU %d started successfully\n&quot;</span>, i);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="abasic__info_8hpp_html_a698036b5e342c2164fb7fd7249d0e801"><div class="ttname"><a href="basic__info_8hpp.html#a698036b5e342c2164fb7fd7249d0e801">_boot</a></div><div class="ttdeci">void _boot()</div><div class="ttdoc">å†…æ ¸å…¥å£ï¼Œåœ¨ boot.S ä¸­å®šä¹‰</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md218"></a>
ğŸ“Š æ€§èƒ½ç‰¹ç‚¹</h2>
<h3><a class="anchor" id="autotoc_md219"></a>
ä¼˜åŠ¿</h3>
<ul>
<li>**å¼‚å¸¸çº§åˆ«éš”ç¦»**ï¼šEL0-EL3æä¾›å®Œæ•´çš„ç‰¹æƒçº§ä¿æŠ¤</li>
<li>**GICç¡¬ä»¶ä¼˜å…ˆçº§**ï¼šé«˜æ•ˆçš„ä¸­æ–­ä»²è£å’Œè·¯ç”±</li>
<li>**Generic Timer**ï¼šé«˜ç²¾åº¦ç³»ç»Ÿå®šæ—¶å™¨</li>
<li>**PSCIæ ‡å‡†**ï¼šæ ‡å‡†åŒ–çš„å¤šæ ¸ç”µæºç®¡ç†</li>
</ul>
<h3><a class="anchor" id="autotoc_md220"></a>
è®¾è®¡è€ƒé‡</h3>
<ul>
<li>**å‘é‡è¡¨å¯¹é½**ï¼š2KBå¯¹é½è¦æ±‚ç¡®ä¿æ€§èƒ½</li>
<li>**ä¸­æ–­ç±»å‹åˆ†ç±»**ï¼šSGI/PPI/SPIæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚</li>
<li>**è®¾å¤‡æ ‘é›†æˆ**ï¼šåŠ¨æ€ç¡¬ä»¶é…ç½®å‘ç°</li>
<li>**ç¼–è¯‘å™¨é™åˆ¶**ï¼šæ‰‹åŠ¨å¼‚å¸¸å¤„ç†é¿å…å±æ€§é™åˆ¶</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md222"></a>
ğŸ” å¤šæ¶æ„å¯¹æ¯”åˆ†æ</h1>
<h2><a class="anchor" id="autotoc_md223"></a>
ä¸­æ–­æ§åˆ¶å™¨å¯¹æ¯”</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">ç‰¹æ€§   </th><th class="markdownTableHeadNone">x86_64 APIC   </th><th class="markdownTableHeadNone">RISC-V PLIC   </th><th class="markdownTableHeadNone">AArch64 GIC    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ä¸­æ–­æ•°é‡   </td><td class="markdownTableBodyNone">256ä¸ªå‘é‡   </td><td class="markdownTableBodyNone">å¯é…ç½®(é€šå¸¸1024)   </td><td class="markdownTableBodyNone">1024ä¸ªINTID    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ä¼˜å…ˆçº§æ”¯æŒ   </td><td class="markdownTableBodyNone">16çº§(ç¡¬ä»¶)   </td><td class="markdownTableBodyNone">å¯é…ç½®çº§åˆ«   </td><td class="markdownTableBodyNone">256çº§    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">å¤šæ ¸æ”¯æŒ   </td><td class="markdownTableBodyNone">Local+IO APIC   </td><td class="markdownTableBodyNone">æ¯hartç‹¬ç«‹   </td><td class="markdownTableBodyNone">åˆ†å‘å™¨+CPUæ¥å£    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ä¸­æ–­ç±»å‹   </td><td class="markdownTableBodyNone">IRQ/NMI   </td><td class="markdownTableBodyNone">å¤–éƒ¨ä¸­æ–­   </td><td class="markdownTableBodyNone">SGI/PPI/SPI    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">EOIæœºåˆ¶   </td><td class="markdownTableBodyNone">APIC EOIå¯„å­˜å™¨   </td><td class="markdownTableBodyNone">PLIC Complete   </td><td class="markdownTableBodyNone">GIC EOIRå¯„å­˜å™¨   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md224"></a>
å®šæ—¶å™¨æœºåˆ¶å¯¹æ¯”</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">æ¶æ„   </th><th class="markdownTableHeadNone">å®šæ—¶å™¨ç±»å‹   </th><th class="markdownTableHeadNone">ç²¾åº¦   </th><th class="markdownTableHeadNone">ç¼–ç¨‹æ¥å£    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">x86_64   </td><td class="markdownTableBodyNone">APIC Timer   </td><td class="markdownTableBodyNone">å¯ç¼–ç¨‹åˆ†é¢‘   </td><td class="markdownTableBodyNone">Local APICå¯„å­˜å™¨    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">RISC-V   </td><td class="markdownTableBodyNone">Machine Timer   </td><td class="markdownTableBodyNone">å›ºå®šé¢‘ç‡   </td><td class="markdownTableBodyNone">SBIè°ƒç”¨    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AArch64   </td><td class="markdownTableBodyNone">Generic Timer   </td><td class="markdownTableBodyNone">ç³»ç»Ÿé¢‘ç‡   </td><td class="markdownTableBodyNone">ç³»ç»Ÿå¯„å­˜å™¨   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md225"></a>
åˆå§‹åŒ–å¤æ‚åº¦</h2>
<ol type="1">
<li><b>x86_64</b>: æ¨¡æ¿é€’å½’åˆå§‹åŒ–ï¼Œç¼–è¯‘æ—¶ä¼˜åŒ–</li>
<li><b>RISC-V</b>: è®¾å¤‡æ ‘è§£æ + CSRé…ç½®</li>
<li><b>AArch64</b>: å¼‚å¸¸å‘é‡è¡¨ + GICå¤šé˜¶æ®µåˆå§‹åŒ–</li>
</ol>
<h2><a class="anchor" id="autotoc_md226"></a>
æ€§èƒ½ç‰¹å¾</h2>
<ul>
<li><b>x86_64</b>: æ¨¡æ¿å…ƒç¼–ç¨‹ä¼˜åŒ–ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€</li>
<li><b>RISC-V</b>: ç®€æ´çš„CSRæ¥å£ï¼ŒSBIæœåŠ¡é›†æˆ</li>
<li><b>AArch64</b>: ç¡¬ä»¶ä¼˜å…ˆçº§ä»²è£ï¼Œå¤šçº§å¼‚å¸¸å¤„ç†</li>
</ul>
<p>è¿™ç§å¤šæ¶æ„è®¾è®¡ç¡®ä¿äº†SimpleKernelåœ¨ä¸åŒç¡¬ä»¶å¹³å°ä¸Šçš„é«˜æ•ˆè¿è¡Œï¼ŒåŒæ—¶ä¿æŒäº†ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£ã€‚ kKeyboardVector, KeyboardHandler );</p>
<p>// 4. å¯ç”¨é”®ç›˜ä¸­æ–­ EnableKeyboardInterrupt(kKeyboardVector);</p>
<p>// 5. å¯ç”¨APICå®šæ—¶å™¨ <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance()</a>.SetupPeriodicTimer(
        kApicTimerFrequencyHz, kApicTimerVector
    );</p>
<p>// 6. å¼€å¯å…¨å±€ä¸­æ–­ cpu_io::Rflags::If::Set();</p>
<p><a class="el" href="structklog_1_1Info.html">klog::Info</a>("Hello InterruptInit\n"); } </p><div class="fragment"><div class="line">### åº”ç”¨å¤„ç†å™¨åˆå§‹åŒ– (SMP)</div>
</div><!-- fragment --><p> cpp void <a class="el" href="aarch64_2interrupt__main_8cpp.html#ac31c690eba7c84c9327f9f813d4b3fea">InterruptInitSMP(int, const char **)</a> { // 1. åˆå§‹åŒ–IDT (æ¯ä¸ªCPUéƒ½éœ€è¦) <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance()</a>.SetUpIdtr();</p>
<p>// 2. å¯ç”¨APICå®šæ—¶å™¨ <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance()</a>.SetupPeriodicTimer(
        kApicTimerFrequencyHz, kApicTimerVector
    );</p>
<p>// 3. å¼€å¯å…¨å±€ä¸­æ–­ cpu_io::Rflags::If::Set();</p>
<p><a class="el" href="structklog_1_1Info.html">klog::Info</a>("Hello InterruptInit SMP\n"); } </p><div class="fragment"><div class="line">## ğŸ”§ é»˜è®¤å¼‚å¸¸å¤„ç†</div>
<div class="line"> </div>
<div class="line">ç³»ç»Ÿä¸ºæ‰€æœ‰æœªæ³¨å†Œçš„ä¸­æ–­/å¼‚å¸¸æä¾›é»˜è®¤å¤„ç†å™¨ï¼š</div>
</div><!-- fragment --><p> cpp <a class="el" href="classInterrupt.html#a736dd658be198f3dc94db0f876fb2499">Interrupt::Interrupt()</a> { // ä¸ºæ‰€æœ‰ä¸­æ–­æ³¨å†Œé»˜è®¤å¤„ç†å‡½æ•° for (auto &amp;i : interrupt_handlers) { i = [](uint64_t cause, uint8_t *context) -&gt; uint64_t { <a class="el" href="structklog_1_1Info.html">klog::Info</a>("Default Interrupt handler [%s] 0x%X, 0x%p\n", kInterruptNames[cause], cause, context); <a class="el" href="aarch64_2backtrace_8cpp.html#a8446673829abff96859f4f7fef26c6fc">DumpStack()</a>; // æ‰“å°è°ƒç”¨æ ˆ while (true) { ; } // åœæœº }; } <a class="el" href="structklog_1_1Info.html">klog::Info</a>("Interrupt init.\n"); } </p><div class="fragment"><div class="line">## ğŸ“Š ä¸­æ–­ä¸Šä¸‹æ–‡ç»“æ„</div>
<div class="line"> </div>
<div class="line">### æ— é”™è¯¯ç ä¸­æ–­ä¸Šä¸‹æ–‡</div>
</div><!-- fragment --><p> cpp struct InterruptContext { uint64_t rip; // æŒ‡ä»¤æŒ‡é’ˆ uint64_t cs; // ä»£ç æ®µé€‰æ‹©å­ uint64_t rflags; // æ ‡å¿—å¯„å­˜å™¨ uint64_t rsp; // æ ˆæŒ‡é’ˆ uint64_t ss; // æ ˆæ®µé€‰æ‹©å­ }; </p><div class="fragment"><div class="line">### æœ‰é”™è¯¯ç ä¸­æ–­ä¸Šä¸‹æ–‡</div>
</div><!-- fragment --><p> cpp struct InterruptContextErrorCode { uint32_t error_code; // é”™è¯¯ç  uint32_t padding; // å¡«å……å¯¹é½ uint64_t rip; uint64_t cs; uint64_t rflags; uint64_t rsp; uint64_t ss; }; </p><div class="fragment"><div class="line">## âš¡ æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§</div>
<div class="line"> </div>
<div class="line">### 1. æ¨¡æ¿å…ƒç¼–ç¨‹</div>
<div class="line">- **ç¼–è¯‘æ—¶å±•å¼€**: ä½¿ç”¨æ¨¡æ¿é€’å½’åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆæ‰€æœ‰IDTæ¡ç›®</div>
<div class="line">- **é›¶è¿è¡Œæ—¶å¼€é”€**: é¿å…å¾ªç¯åˆå§‹åŒ–çš„è¿è¡Œæ—¶æˆæœ¬</div>
<div class="line"> </div>
<div class="line">### 2. å†…å­˜å¯¹é½ä¼˜åŒ–</div>
</div><!-- fragment --><p> cpp // 4KBå¯¹é½ä¼˜åŒ–ç¼“å­˜è¡Œä¸º alignas(4096) static std::array&lt;InterruptFunc, 256&gt; interrupt_handlers; alignas(4096) static std::array&lt;Idt, 256&gt; idts; </p><div class="fragment"><div class="line">### 3. é«˜æ•ˆä¸­æ–­å±æ€§</div>
</div><!-- fragment --><p> cpp // ç¼–è¯‘å™¨ä¼˜åŒ–å±æ€§ <b>attribute</b>((target("general-regs-only"))) // åªä½¿ç”¨é€šç”¨å¯„å­˜å™¨ <b>attribute</b>((interrupt)) // ä¸­æ–­å‡½æ•°ä¼˜åŒ– </p><div class="fragment"><div class="line">## ğŸ”„ å¤šæ ¸å¤„ç† (SMP)</div>
<div class="line"> </div>
<div class="line">### BSP vs AP åˆå§‹åŒ–å·®å¼‚</div>
<div class="line"> </div>
<div class="line">| ç»„ä»¶ | BSP (ä¸»å¤„ç†å™¨) | AP (åº”ç”¨å¤„ç†å™¨) |</div>
<div class="line">|------|---------------|----------------|</div>
<div class="line">| IDTåˆå§‹åŒ– | âœ… | âœ… |</div>
<div class="line">| ä¸­æ–­å¤„ç†å‡½æ•°æ³¨å†Œ | âœ… | âŒ (å…±äº«) |</div>
<div class="line">| é”®ç›˜ä¸­æ–­é…ç½® | âœ… | âŒ |</div>
<div class="line">| APICå®šæ—¶å™¨ | âœ… | âœ… |</div>
<div class="line">| å…¨å±€ä¸­æ–­ä½¿èƒ½ | âœ… | âœ… |</div>
<div class="line"> </div>
<div class="line">### å¤šæ ¸ä¸­æ–­å®‰å…¨æ€§</div>
<div class="line">- **æ¯æ ¸ç‹¬ç«‹IDT**: æ¯ä¸ªCPUæ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„IDTå‰¯æœ¬</div>
<div class="line">- **å…±äº«ä¸­æ–­å¤„ç†å‡½æ•°**: ä¸­æ–­å¤„ç†å‡½æ•°æ•°ç»„åœ¨æ‰€æœ‰æ ¸å¿ƒé—´å…±äº«</div>
<div class="line">- **APIC EOI**: æ¯ä¸ªæ ¸å¿ƒç‹¬ç«‹å‘é€EOIä¿¡å·</div>
<div class="line"> </div>
<div class="line">## ğŸ› è°ƒè¯•å’Œç›‘æ§</div>
<div class="line"> </div>
<div class="line">### ä¸­æ–­ä¿¡æ¯è¾“å‡º</div>
</div><!-- fragment --><p> cpp // è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºä¸­æ–­æ³¨å†Œä¿¡æ¯ <a class="el" href="structklog_1_1Debug.html">klog::Debug</a>("RegisterInterruptFunc [%s] 0x%X, 0x%p\n", kInterruptNames[cause], cause, func);</p>
<p>// IDTæ¡ç›®è°ƒè¯•ä¿¡æ¯ for (size_t i = 0; i &lt; interrupt_count; i++) { <a class="el" href="structklog_1_1Debug.html">klog::Debug</a>("idtr[%d] 0x%p\n", i, idtr.base + i); } </p><div class="fragment"><div class="line">### é”™è¯¯å¤„ç†</div>
<div class="line">- **æ ˆè½¬å‚¨**: æœªå¤„ç†å¼‚å¸¸æ—¶è‡ªåŠ¨æ‰“å°è°ƒç”¨æ ˆ</div>
<div class="line">- **ç³»ç»Ÿåœæœº**: ä¸¥é‡é”™è¯¯æ—¶å®‰å…¨åœæœº</div>
<div class="line">- **ä¸­æ–­åç§°æ˜ å°„**: é€šè¿‡åç§°æ•°ç»„æä¾›å¯è¯»çš„ä¸­æ–­ä¿¡æ¯</div>
<div class="line"> </div>
<div class="line">## ğŸ“š ç›¸å…³æ–‡æ¡£</div>
<div class="line"> </div>
<div class="line">- [APIC é©±åŠ¨æ–‡æ¡£](../src/driver/apic/README.md)</div>
<div class="line">- [CPU I/O åº“æ–‡æ¡£](../3rd/cpu_io/README.md)</div>
<div class="line">- [å†…æ ¸æ—¥å¿—ç³»ç»Ÿ](../src/include/kernel_log.hpp)</div>
<div class="line"> </div>
<div class="line">## ğŸ”— å…³é”®æ•°æ®ç»“æ„</div>
<div class="line"> </div>
<div class="line">### ä¸­æ–­å‘é‡åˆ†é…</div>
</div><!-- fragment --><p> cpp 0x00-0x1F: CPUå¼‚å¸¸ (é¡µé”™è¯¯ã€é™¤é›¶ç­‰) 0x20-0xEF: å¯ç”¨ç”¨æˆ·ä¸­æ–­å‘é‡ 0xF0: APICå®šæ—¶å™¨ä¸­æ–­ 0xF1: é”®ç›˜ä¸­æ–­ 0xF2-0xFF: ä¿ç•™å‘é‡ </p><div class="fragment"><div class="line">### APIC é›†æˆç‚¹</div>
<div class="line">- **Local APIC**: æ¯æ ¸å¿ƒå®šæ—¶å™¨å’ŒEOIå¤„ç†</div>
<div class="line">- **IO APIC**: IRQé‡å®šå‘é…ç½®</div>
<div class="line">- **x2APIC/xAPIC**: è‡ªåŠ¨æ£€æµ‹å’Œé…ç½®</div>
<div class="line"> </div>
<div class="line">---</div>
<div class="line"> </div>
<div class="line"># RISC-V 64 ä¸­æ–­å¤„ç†ç³»ç»Ÿ</div>
<div class="line"> </div>
<div class="line">SimpleKernel åœ¨ RISC-V 64 æ¶æ„ä¸Šå®ç°äº†åŸºäº CSR (Control and Status Registers) å’Œ PLIC (Platform-Level Interrupt Controller) çš„å®Œæ•´ä¸­æ–­å¤„ç†ç³»ç»Ÿã€‚</div>
<div class="line"> </div>
<div class="line">## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„</div>
<div class="line"> </div>
<div class="line">### æ ¸å¿ƒç»„ä»¶</div>
</div><!-- fragment --><p> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ RISC-V 64 ä¸­æ–­å¤„ç†ç³»ç»Ÿ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ <a class="el" href="classInterruptBase.html">InterruptBase</a> (æŠ½è±¡åŸºç±») â”‚ â”‚ â”œâ”€â”€ Do(cause, context) â”‚ â”‚ â””â”€â”€ RegisterInterruptFunc(cause, func) â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ <a class="el" href="classInterrupt.html" title="ä¸­æ–­å¤„ç†">Interrupt</a> (RISC-Vå®ç°) â”‚ â”‚ â”œâ”€â”€ ä¸­æ–­/å¼‚å¸¸åˆ†ç¦»å¤„ç† â”‚ â”‚ â”œâ”€â”€ CSR scause è§£ç  â”‚ â”‚ â”œâ”€â”€ ä¸­æ–­å¤„ç†å‡½æ•°æ•°ç»„ â”‚ â”‚ â””â”€â”€ å¼‚å¸¸å¤„ç†å‡½æ•°æ•°ç»„ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ PLIC (Platform-Level <a class="el" href="classInterrupt.html" title="ä¸­æ–­å¤„ç†">Interrupt</a> Controller) â”‚ â”‚ â”œâ”€â”€ å¤–éƒ¨ä¸­æ–­è·¯ç”± â”‚ â”‚ â”œâ”€â”€ ä¸­æ–­ä¼˜å…ˆçº§ç®¡ç† â”‚ â”‚ â”œâ”€â”€ å¤š Hart ä¸­æ–­åˆ†å‘ â”‚ â”‚ â””â”€â”€ ä¸­æ–­å®Œæˆç¡®è®¤ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ OpenSBI æ¥å£ â”‚ â”‚ â”œâ”€â”€ SBI å®šæ—¶å™¨æœåŠ¡ â”‚ â”‚ â”œâ”€â”€ Hart å¯åŠ¨ç®¡ç† â”‚ â”‚ â”œâ”€â”€ ç³»ç»Ÿè°ƒç”¨æ¥å£ â”‚ â”‚ â””â”€â”€ è°ƒè¯•æ§åˆ¶å° â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ è®¾å¤‡ç‰¹å®šä¸­æ–­ â”‚ â”‚ â”œâ”€â”€ å®šæ—¶å™¨ä¸­æ–­ (SBI Timer) â”‚ â”‚ â”œâ”€â”€ ä¸²å£ä¸­æ–­ (NS16550A) â”‚ â”‚ â”œâ”€â”€ å¤–éƒ¨ä¸­æ–­ (PLIC) â”‚ â”‚ â””â”€â”€ æ–­ç‚¹å¼‚å¸¸ (ebreak) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ </p><div class="fragment"><div class="line">## ğŸ“‹ CSR å¯„å­˜å™¨ç®¡ç†</div>
<div class="line"> </div>
<div class="line">### å…³é”® CSR å¯„å­˜å™¨</div>
</div><!-- fragment --><p> cpp // ä¸­æ–­/å¼‚å¸¸å¤„ç†ç›¸å…³çš„CSRå¯„å­˜å™¨</p><ul>
<li>stvec: Supervisor Trap Vector Base Address (é™·é˜±å‘é‡åŸºå€)</li>
<li>scause: Supervisor Cause Register (é™·é˜±åŸå› )</li>
<li>sstatus: Supervisor Status Register (ç›‘ç®¡è€…çŠ¶æ€)</li>
<li>sie: Supervisor <a class="el" href="classInterrupt.html" title="ä¸­æ–­å¤„ç†">Interrupt</a> Enable (ç›‘ç®¡è€…ä¸­æ–­ä½¿èƒ½)</li>
<li>sip: Supervisor <a class="el" href="classInterrupt.html" title="ä¸­æ–­å¤„ç†">Interrupt</a> Pending (ç›‘ç®¡è€…ä¸­æ–­æŒ‚èµ·)</li>
<li>sepc: Supervisor Exception Program Counter (å¼‚å¸¸PC)</li>
<li><p class="startli">stval: Supervisor Trap Value (é™·é˜±å€¼) </p><div class="fragment"><div class="line">### scause å¯„å­˜å™¨è§£ç </div>
</div><!-- fragment --><p> cpp void Interrupt::Do(uint64_t cause, uint8_t *context) { // è§£æ scause å¯„å­˜å™¨ auto interrupt = cpu_io::Scause::Interrupt::Get(cause); // æœ€é«˜ä½ auto exception_code = cpu_io::Scause::ExceptionCode::Get(cause); // ä½ä½</p>
<p class="startli">if (interrupt) { // å¤„ç†ä¸­æ–­ (å¼‚æ­¥äº‹ä»¶) if (exception_code &lt; kInterruptMaxCount) { interrupt_handlers_[exception_code](exception_code, context); } } else { // å¤„ç†å¼‚å¸¸ (åŒæ­¥äº‹ä»¶) if (exception_code &lt; kExceptionMaxCount) { exception_handlers_[exception_code](exception_code, context); } } } </p><div class="fragment"><div class="line">### é™·é˜±å…¥å£è®¾ç½®</div>
</div><!-- fragment --><p> cpp // è®¾ç½®é™·é˜±å‘é‡ - ç›´æ¥æ¨¡å¼ <b>attribute</b>((interrupt("supervisor"))) alignas(4) void TarpEntry() { <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance()</a>.Do( static_cast&lt;uint64_t&gt;(cpu_io::Scause::Read()), nullptr ); }</p>
</li>
</ul>
<p>// åˆå§‹åŒ–æ—¶è®¾ç½® cpu_io::Stvec::SetDirect(reinterpret_cast&lt;uint64_t&gt;(TarpEntry)); </p><div class="fragment"><div class="line">## ğŸ¯ ä¸­æ–­/å¼‚å¸¸åˆ†ç±»å¤„ç†</div>
<div class="line"> </div>
<div class="line">### ä¸­æ–­ç±»å‹ (scause[63] = 1)</div>
</div><!-- fragment --><p> cpp enum SupervisorInterrupts { kSupervisorSoftwareInterrupt = 1, // Sæ¨¡å¼è½¯ä»¶ä¸­æ–­ kSupervisorTimerInterrupt = 5, // Sæ¨¡å¼å®šæ—¶å™¨ä¸­æ–­ kSupervisorExternalInterrupt = 9, // Sæ¨¡å¼å¤–éƒ¨ä¸­æ–­ }; </p><div class="fragment"><div class="line">### å¼‚å¸¸ç±»å‹ (scause[63] = 0)</div>
</div><!-- fragment --><p> cpp enum SupervisorExceptions { kInstructionAddressMisaligned = 0, // æŒ‡ä»¤åœ°å€ä¸å¯¹é½ kInstructionAccessFault = 1, // æŒ‡ä»¤è®¿é—®é”™è¯¯ kIllegalInstruction = 2, // éæ³•æŒ‡ä»¤ kBreakpoint = 3, // æ–­ç‚¹å¼‚å¸¸ kLoadAddressMisaligned = 4, // åŠ è½½åœ°å€ä¸å¯¹é½ kLoadAccessFault = 5, // åŠ è½½è®¿é—®é”™è¯¯ kStoreAddressMisaligned = 6, // å­˜å‚¨åœ°å€ä¸å¯¹é½ kStoreAccessFault = 7, // å­˜å‚¨è®¿é—®é”™è¯¯ kEnvironmentCall = 8, // ç¯å¢ƒè°ƒç”¨ kInstructionPageFault = 12, // æŒ‡ä»¤é¡µé”™è¯¯ kLoadPageFault = 13, // åŠ è½½é¡µé”™è¯¯ kStorePageFault = 15, // å­˜å‚¨é¡µé”™è¯¯ }; </p><div class="fragment"><div class="line">## â° SBI å®šæ—¶å™¨ä¸­æ–­</div>
<div class="line"> </div>
<div class="line">### å®šæ—¶å™¨é…ç½®å’Œå¤„ç†</div>
</div><!-- fragment --><p> cpp namespace { uint64_t kInterval = 0; // å®šæ—¶å™¨é—´éš” }</p>
<p>void <a class="el" href="aarch64_2interrupt__main_8cpp.html#a660e4785391d83bb3aa43f15ae53a530">InterruptInit(int, const char **)</a> { // ä»è®¾å¤‡æ ‘è·å–æ—¶é’Ÿé¢‘ç‡ kInterval = <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance()</a>.GetTimebaseFrequency(); <a class="el" href="structklog_1_1Info.html">klog::Info</a>("kInterval: 0x%X\n", kInterval);</p>
<p>// æ³¨å†Œå®šæ—¶å™¨ä¸­æ–­å¤„ç†å‡½æ•° <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance()</a>.RegisterInterruptFunc( kSupervisorTimerInterrupt, [](uint64_t exception_code, uint8_t *) -&gt; uint64_t { // è®¾ç½®ä¸‹ä¸€æ¬¡å®šæ—¶å™¨ä¸­æ–­ sbi_set_timer(cpu_io::Time::Read() + kInterval); <a class="el" href="structklog_1_1Info.html">klog::Info</a>("Handle %s\n", kInterruptNames[exception_code]); return 0; } );</p>
<p>// å¯ç”¨å®šæ—¶å™¨ä¸­æ–­ cpu_io::Sie::Stie::Set();</p>
<p>// è®¾ç½®é¦–æ¬¡å®šæ—¶å™¨ä¸­æ–­ sbi_set_timer(kInterval); } </p><div class="fragment"><div class="line">### OpenSBI å®šæ—¶å™¨æ¥å£</div>
</div><!-- fragment --><p> cpp // è®¾ç½®å®šæ—¶å™¨ä¸­æ–­æ—¶é—´ (ç»å¯¹æ—¶é—´) sbi_set_timer(cpu_io::Time::Read() + kInterval);</p>
<p>// è¯»å–å½“å‰æ—¶é—´ uint64_t current_time = cpu_io::Time::Read(); </p><div class="fragment"><div class="line">## ğŸ”Œ PLIC å¤–éƒ¨ä¸­æ–­æ§åˆ¶</div>
<div class="line"> </div>
<div class="line">### PLIC åˆå§‹åŒ–</div>
</div><!-- fragment --><p> cpp void <a class="el" href="aarch64_2interrupt__main_8cpp.html#a660e4785391d83bb3aa43f15ae53a530">InterruptInit(int, const char **)</a> { // ä»è®¾å¤‡æ ‘è·å–PLICä¿¡æ¯ auto [plic_addr, plic_size, ndev, context_count] = <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance()</a>.GetPlic();</p>
<p>// åˆå§‹åŒ–PLICå®ä¾‹ <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Plic&gt;::GetInstance()</a> = std::move(Plic(plic_addr, ndev, context_count));</p>
<p>// æ³¨å†Œå¤–éƒ¨ä¸­æ–­å¤„ç†å‡½æ•° <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance()</a>.RegisterInterruptFunc( kSupervisorExternalInterrupt, [](uint64_t exception_code, uint8_t *) -&gt; uint64_t { // æŸ¥è¯¢ä¸­æ–­æº auto source_id = <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Plic&gt;::GetInstance()</a>.Which(); <a class="el" href="structklog_1_1Debug.html">klog::Debug</a>("External interrupt from source %d\n", source_id);</p>
<p>// æ‰§è¡Œä¸­æ–­å¤„ç† <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Plic&gt;::GetInstance()</a>.Do(source_id, nullptr);</p>
<p>// å®Œæˆä¸­æ–­å¤„ç† <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Plic&gt;::GetInstance()</a>.Done(source_id); return 0; } );</p>
<p>// å¯ç”¨å¤–éƒ¨ä¸­æ–­ cpu_io::Sie::Seie::Set(); } </p><div class="fragment"><div class="line">### PLIC å¯„å­˜å™¨å¸ƒå±€</div>
</div><!-- fragment --><p> cpp class <a class="el" href="classPlic.html" title="Plic é©±åŠ¨">Plic</a> { private: static constexpr uint64_t kSourcePriorityOffset = 0x000000; // ä¼˜å…ˆçº§ static constexpr uint64_t kPendingBitsOffset = 0x001000; // æŒ‚èµ·ä½ static constexpr uint64_t kEnableBitsOffset = 0x002000; // ä½¿èƒ½ä½ static constexpr uint64_t kContextOffset = 0x200000; // ä¸Šä¸‹æ–‡</p>
<p>static constexpr uint64_t kContextSize = 0x1000; // ä¸Šä¸‹æ–‡å¤§å° static constexpr uint64_t kPriorityThresholdOffset = 0x0; // ä¼˜å…ˆçº§é˜ˆå€¼ static constexpr uint64_t kClaimCompleteOffset = 0x4; // å£°æ˜/å®Œæˆ }; </p><div class="fragment"><div class="line">### PLIC ä¸­æ–­å¤„ç†æµç¨‹</div>
</div><!-- fragment --><p> cpp // 1. ä¸­æ–­è§¦å‘ â†’ PLIC è·¯ç”±åˆ°æŒ‡å®š Hart // 2. Hart æ¥æ”¶å¤–éƒ¨ä¸­æ–­ â†’ æŸ¥è¯¢ä¸­æ–­æº auto source_id = <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Plic&gt;::GetInstance()</a>.Which();</p>
<p>// 3. æ‰§è¡Œè®¾å¤‡ç‰¹å®šçš„ä¸­æ–­å¤„ç† <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Plic&gt;::GetInstance()</a>.Do(source_id, nullptr);</p>
<p>// 4. é€šçŸ¥ PLIC ä¸­æ–­å¤„ç†å®Œæˆ <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Plic&gt;::GetInstance()</a>.Done(source_id); </p><div class="fragment"><div class="line">## ğŸ“¡ ä¸²å£ä¸­æ–­å¤„ç†</div>
<div class="line"> </div>
<div class="line">### NS16550A ä¸²å£ä¸­æ–­</div>
</div><!-- fragment --><p> cpp void <a class="el" href="aarch64_2interrupt__main_8cpp.html#a660e4785391d83bb3aa43f15ae53a530">InterruptInit(int, const char **)</a> { // ä»è®¾å¤‡æ ‘è·å–ä¸²å£ä¿¡æ¯ auto [base, size, irq] = <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance()</a>.GetSerial();</p>
<p>// åˆå§‹åŒ–ä¸²å£é©±åŠ¨ <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Ns16550a&gt;::GetInstance()</a> = std::move(Ns16550a(base));</p>
<p>// æ³¨å†Œä¸²å£ä¸­æ–­å¤„ç†å‡½æ•° <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Plic&gt;::GetInstance()</a>.RegisterInterruptFunc( irq, // ä¸²å£IRQå· [](uint64_t, uint8_t *) -&gt; uint64_t { // è¯»å–ä¸²å£å­—ç¬¦å¹¶å›æ˜¾ sk_putchar(<a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Ns16550a&gt;::GetInstance()</a>.TryGetChar(), nullptr); return 0; } );</p>
<p>// ä¸ºå½“å‰æ ¸å¿ƒå¯ç”¨ä¸²å£ä¸­æ–­ <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Plic&gt;::GetInstance()</a>.Set( <a class="el" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId()</a>, // Hart ID irq, // ä¸­æ–­æºID 1, // ä¼˜å…ˆçº§ true // å¯ç”¨ ); } </p><div class="fragment"><div class="line">## ğŸ›‘ å¼‚å¸¸å¤„ç†</div>
<div class="line"> </div>
<div class="line">### æ–­ç‚¹å¼‚å¸¸ (ebreak)</div>
</div><!-- fragment --><p> cpp // æ³¨å†Œæ–­ç‚¹å¼‚å¸¸å¤„ç† <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Interrupt&gt;::GetInstance()</a>.RegisterInterruptFunc( kBreakpoint, [](uint64_t exception_code, uint8_t *) -&gt; uint64_t { // ebreak æŒ‡ä»¤æ˜¯2å­—èŠ‚ï¼Œéœ€è¦è·³è¿‡ cpu_io::Sepc::Write(cpu_io::Sepc::Read() + 2); <a class="el" href="structklog_1_1Info.html">klog::Info</a>("Handle %s\n", kExceptionNames[exception_code]); return 0; } ); </p><div class="fragment"><div class="line">### é»˜è®¤å¼‚å¸¸å¤„ç†</div>
</div><!-- fragment --><p> cpp <a class="el" href="classInterrupt.html#a736dd658be198f3dc94db0f876fb2499">Interrupt::Interrupt()</a> { // é»˜è®¤å¼‚å¸¸å¤„ç† - ç³»ç»Ÿåœæœº for (auto &amp;i : exception_handlers_) { i = [](uint64_t cause, uint8_t *context) -&gt; uint64_t { <a class="el" href="structklog_1_1Err.html">klog::Err</a>("Default Exception handler [%s] 0x%X, 0x%p\n", kExceptionNames[cause], cause, context); while (1) ; // åœæœºç­‰å¾… return 0; }; } } </p><div class="fragment"><div class="line">## ğŸš€ å¤šæ ¸ç³»ç»Ÿåˆå§‹åŒ–</div>
<div class="line"> </div>
<div class="line">### ä¸»æ ¸å¿ƒ (BSP) åˆå§‹åŒ–</div>
</div><!-- fragment --><p> cpp void <a class="el" href="aarch64_2interrupt__main_8cpp.html#a660e4785391d83bb3aa43f15ae53a530">InterruptInit(int, const char **)</a> { // 1. è·å–ç³»ç»Ÿé…ç½®ä¿¡æ¯ kInterval = <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance()</a>.GetTimebaseFrequency();</p>
<p>// 2. æ³¨å†Œæ‰€æœ‰ä¸­æ–­/å¼‚å¸¸å¤„ç†å‡½æ•° RegisterTimerInterrupt(); RegisterExternalInterrupt(); RegisterSerialInterrupt(); RegisterBreakpointException();</p>
<p>// 3. åˆå§‹åŒ–ç¡¬ä»¶æ§åˆ¶å™¨ InitializePlic(); InitializeSerial();</p>
<p>// 4. è®¾ç½®é™·é˜±å‘é‡å’Œå¯ç”¨ä¸­æ–­ cpu_io::Stvec::SetDirect(reinterpret_cast&lt;uint64_t&gt;(TarpEntry)); cpu_io::Sstatus::Sie::Set(); // å¯ç”¨ç›‘ç®¡è€…ä¸­æ–­ cpu_io::Sie::Ssie::Set(); // å¯ç”¨è½¯ä»¶ä¸­æ–­ cpu_io::Sie::Stie::Set(); // å¯ç”¨å®šæ—¶å™¨ä¸­æ–­ cpu_io::Sie::Seie::Set(); // å¯ç”¨å¤–éƒ¨ä¸­æ–­</p>
<p>// 5. å¯åŠ¨å®šæ—¶å™¨ sbi_set_timer(kInterval);</p>
<p>// 6. å¯åŠ¨å…¶ä»–æ ¸å¿ƒ for (size_t i = 0; i &lt; core_count; i++) { auto ret = sbi_hart_start(i, reinterpret_cast&lt;uint64_t&gt;(_boot), 0); if (ret.error != SBI_SUCCESS &amp;&amp; ret.error != SBI_ERR_ALREADY_AVAILABLE) { <a class="el" href="structklog_1_1Warn.html">klog::Warn</a>("hart %d start failed: %d\n", i, ret.error); } } } </p><div class="fragment"><div class="line">### åº”ç”¨æ ¸å¿ƒ (AP) åˆå§‹åŒ–</div>
</div><!-- fragment --><p> cpp void <a class="el" href="aarch64_2interrupt__main_8cpp.html#ac31c690eba7c84c9327f9f813d4b3fea">InterruptInitSMP(int, const char **)</a> { // 1. è®¾ç½®é™·é˜±å‘é‡ (ä¸BSPç›¸åŒ) cpu_io::Stvec::SetDirect(reinterpret_cast&lt;uint64_t&gt;(TarpEntry));</p>
<p>// 2. å¯ç”¨ä¸­æ–­ (ä¸BSPç›¸åŒ) cpu_io::Sstatus::Sie::Set(); cpu_io::Sie::Ssie::Set(); cpu_io::Sie::Stie::Set(); cpu_io::Sie::Seie::Set();</p>
<p>// 3. å¯åŠ¨å®šæ—¶å™¨ (ä½¿ç”¨å…¨å±€é—´éš”) sbi_set_timer(kInterval);</p>
<p><a class="el" href="structklog_1_1Info.html">klog::Info</a>("Hello InterruptInitSMP\n"); } </p><div class="fragment"><div class="line">## ğŸ”§ OpenSBI é›†æˆ</div>
<div class="line"> </div>
<div class="line">### SBI è°ƒç”¨æ¥å£</div>
</div><!-- fragment --><p> cpp // Hart ç®¡ç† sbi_hart_start(hart_id, start_addr, priv); // å¯åŠ¨æŒ‡å®šHart sbi_hart_stop(); // åœæ­¢å½“å‰Hart sbi_hart_get_status(hart_id); // è·å–HartçŠ¶æ€</p>
<p>// å®šæ—¶å™¨æœåŠ¡ sbi_set_timer(stime_value); // è®¾ç½®å®šæ—¶å™¨ uint64_t time = cpu_io::Time::Read(); // è¯»å–å½“å‰æ—¶é—´</p>
<p>// è°ƒè¯•æœåŠ¡ sbi_debug_console_write_byte(ch); // è°ƒè¯•æ§åˆ¶å°è¾“å‡º</p>
<p>// ç³»ç»Ÿé‡ç½® sbi_system_reset(reset_type, reset_reason); // ç³»ç»Ÿé‡ç½® </p><div class="fragment"><div class="line">### SBI é”™è¯¯å¤„ç†</div>
</div><!-- fragment --><p> cpp auto ret = sbi_hart_start(i, start_addr, 0); switch (ret.error) { case SBI_SUCCESS: <a class="el" href="structklog_1_1Info.html">klog::Info</a>("Hart %zu started successfully\n", i); break; case SBI_ERR_ALREADY_AVAILABLE: <a class="el" href="structklog_1_1Debug.html">klog::Debug</a>("Hart %zu already running\n", i); break; default: <a class="el" href="structklog_1_1Warn.html">klog::Warn</a>("Hart %zu start failed: %ld\n", i, ret.error); break; } </p><div class="fragment"><div class="line">## ğŸ“Š è®¾å¤‡æ ‘ (Device Tree) é›†æˆ</div>
<div class="line"> </div>
<div class="line">### ä»è®¾å¤‡æ ‘è·å–ç¡¬ä»¶ä¿¡æ¯</div>
</div><!-- fragment --><p> cpp class <a class="el" href="classKernelFdt.html">KernelFdt</a> { public: // è·å–æ—¶é’Ÿé¢‘ç‡ uint64_t GetTimebaseFrequency();</p>
<p>// è·å–PLICä¿¡æ¯ &lt;åœ°å€, å¤§å°, è®¾å¤‡æ•°, ä¸Šä¸‹æ–‡æ•°&gt; std::tuple&lt;uint64_t, uint64_t, size_t, size_t&gt; GetPlic();</p>
<p>// è·å–ä¸²å£ä¿¡æ¯ &lt;åœ°å€, å¤§å°, IRQå·&gt; std::tuple&lt;uint64_t, uint64_t, uint32_t&gt; GetSerial(); };</p>
<p>// ä½¿ç”¨ç¤ºä¾‹ auto [plic_addr, plic_size, ndev, context_count] = <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance()</a>.GetPlic();</p>
<p>auto [serial_base, serial_size, serial_irq] = <a class="el" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;KernelFdt&gt;::GetInstance()</a>.GetSerial(); </p><div class="fragment"><div class="line">## âš¡ æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§</div>
<div class="line"> </div>
<div class="line">### 1. å¯¹é½ä¼˜åŒ–</div>
</div><!-- fragment --><p> cpp // 4å­—èŠ‚å¯¹é½çš„ä¸­æ–­å¤„ç†å‡½æ•°æ•°ç»„ alignas(4) std::array&lt;InterruptFunc, kInterruptMaxCount&gt; interrupt_handlers_; alignas(4) std::array&lt;InterruptFunc, kExceptionMaxCount&gt; exception_handlers_;</p>
<p>// 4å­—èŠ‚å¯¹é½çš„é™·é˜±å…¥å£ <b>attribute</b>((interrupt("supervisor"))) alignas(4) void TarpEntry(); </p><div class="fragment"><div class="line">### 2. åˆ†ç¦»çš„ä¸­æ–­/å¼‚å¸¸å¤„ç†</div>
</div><!-- fragment --><p> cpp // åˆ†ç¦»çš„å¤„ç†æ•°ç»„é¿å…æ— æ•ˆçš„èŒƒå›´æ£€æŸ¥ static std::array&lt;InterruptFunc, kInterruptMaxCount&gt; interrupt_handlers_; static std::array&lt;InterruptFunc, kExceptionMaxCount&gt; exception_handlers_; </p><div class="fragment"><div class="line">### 3. ç¡¬ä»¶ç‰¹å®šä¼˜åŒ–</div>
</div><!-- fragment --><p> cpp // åˆ©ç”¨RISC-V CSRæŒ‡ä»¤çš„åŸå­æ€§ auto cause = cpu_io::Scause::Read(); // åŸå­è¯»å– cpu_io::Sepc::Write(pc + 2); // åŸå­å†™å…¥ </p><div class="fragment"><div class="line">## ğŸ”„ å¤šæ ¸å¤„ç†ç‰¹æ€§</div>
<div class="line"> </div>
<div class="line">### BSP vs AP åˆå§‹åŒ–å·®å¼‚</div>
<div class="line"> </div>
<div class="line">| ç»„ä»¶ | BSP (ä¸»æ ¸å¿ƒ) | AP (åº”ç”¨æ ¸å¿ƒ) |</div>
<div class="line">|------|-------------|--------------|</div>
<div class="line">| è®¾å¤‡æ ‘è§£æ | âœ… | âŒ (å…±äº«) |</div>
<div class="line">| ä¸­æ–­å¤„ç†å‡½æ•°æ³¨å†Œ | âœ… | âŒ (å…±äº«) |</div>
<div class="line">| PLICåˆå§‹åŒ– | âœ… | âŒ (å…±äº«) |</div>
<div class="line">| ä¸²å£é…ç½® | âœ… | âŒ (å…±äº«) |</div>
<div class="line">| CSRé…ç½® | âœ… | âœ… |</div>
<div class="line">| å®šæ—¶å™¨å¯åŠ¨ | âœ… | âœ… |</div>
<div class="line">| å…¶ä»–æ ¸å¿ƒå¯åŠ¨ | âœ… | âŒ |</div>
<div class="line"> </div>
<div class="line">### å¤šæ ¸ä¸­æ–­å®‰å…¨æ€§</div>
<div class="line"> </div>
<div class="line">- **æ¯æ ¸ç‹¬ç«‹CSR**: æ¯ä¸ªHartæœ‰è‡ªå·±çš„CSRå‰¯æœ¬</div>
<div class="line">- **å…±äº«PLIC**: æ‰€æœ‰Hartå…±äº«PLICï¼Œé€šè¿‡ä¸Šä¸‹æ–‡éš”ç¦»</div>
<div class="line">- **å…±äº«å¤„ç†å‡½æ•°**: ä¸­æ–­å¤„ç†å‡½æ•°åœ¨æ‰€æœ‰æ ¸å¿ƒé—´å…±äº«</div>
<div class="line">- **åŸå­æ“ä½œ**: CSRè®¿é—®å…·æœ‰ç¡¬ä»¶åŸå­æ€§ä¿è¯</div>
<div class="line"> </div>
<div class="line">## ğŸ› è°ƒè¯•å’Œç›‘æ§</div>
<div class="line"> </div>
<div class="line">### ä¸­æ–­ä¿¡æ¯è¾“å‡º</div>
</div><!-- fragment --><p> cpp // ä¸­æ–­æ³¨å†Œè°ƒè¯•ä¿¡æ¯ <a class="el" href="structklog_1_1Info.html">klog::Info</a>("RegisterInterruptFunc [%s] 0x%X, 0x%p\n", kInterruptNames[exception_code], cause, func);</p>
<p>// PLICå¤–éƒ¨ä¸­æ–­è°ƒè¯• <a class="el" href="structklog_1_1Debug.html">klog::Debug</a>("External interrupt from source %d\n", source_id);</p>
<p>// CSRçŠ¶æ€ç›‘æ§ <a class="el" href="structklog_1_1Debug.html">klog::Debug</a>("scause: 0x%lX, sepc: 0x%lX\n", cpu_io::Scause::Read(), cpu_io::Sepc::Read()); </p><div class="fragment"><div class="line">### å¼‚å¸¸è°ƒè¯•</div>
</div><!-- fragment --><p> cpp // å¼‚å¸¸å¤„ç†æ—¶çš„è¯¦ç»†ä¿¡æ¯è¾“å‡º <a class="el" href="structklog_1_1Err.html">klog::Err</a>("Exception [%s] at PC 0x%lX, tval: 0x%lX\n", kExceptionNames[cause], cpu_io::Sepc::Read(), cpu_io::Stval::Read()); </p><div class="fragment"><div class="line">## ğŸ“š ç›¸å…³æ–‡æ¡£</div>
<div class="line"> </div>
<div class="line">- [OpenSBI æ¥å£æ–‡æ¡£](../3rd/opensbi_interface/README.md)</div>
<div class="line">- [PLIC é©±åŠ¨æ–‡æ¡£](../src/driver/plic/README.md)</div>
<div class="line">- [CPU I/O åº“æ–‡æ¡£](../3rd/cpu_io/README.md)</div>
<div class="line">- [è®¾å¤‡æ ‘è§£æ](../src/include/kernel_fdt.hpp)</div>
<div class="line"> </div>
<div class="line">## ğŸ”— å…³é”®æ•°æ®ç»“æ„</div>
<div class="line"> </div>
<div class="line">### RISC-V ä¸­æ–­/å¼‚å¸¸ç¼–å·</div>
</div><!-- fragment --><p> cpp // ç›‘ç®¡è€…æ¨¡å¼ä¸­æ–­ (scause[63]=1) #define S_SOFTWARE_INTERRUPT 1 // è½¯ä»¶ä¸­æ–­ #define S_TIMER_INTERRUPT 5 // å®šæ—¶å™¨ä¸­æ–­ #define S_EXTERNAL_INTERRUPT 9 // å¤–éƒ¨ä¸­æ–­</p>
<p>// ç›‘ç®¡è€…æ¨¡å¼å¼‚å¸¸ (scause[63]=0) #define INSTRUCTION_MISALIGNED 0 // æŒ‡ä»¤ä¸å¯¹é½ #define INSTRUCTION_ACCESS_FAULT 1 // æŒ‡ä»¤è®¿é—®é”™è¯¯ #define ILLEGAL_INSTRUCTION 2 // éæ³•æŒ‡ä»¤ #define BREAKPOINT 3 // æ–­ç‚¹ #define LOAD_MISALIGNED 4 // åŠ è½½ä¸å¯¹é½ #define LOAD_ACCESS_FAULT 5 // åŠ è½½è®¿é—®é”™è¯¯ #define STORE_MISALIGNED 6 // å­˜å‚¨ä¸å¯¹é½ #define STORE_ACCESS_FAULT 7 // å­˜å‚¨è®¿é—®é”™è¯¯ #define ECALL_FROM_U_MODE 8 // ç”¨æˆ·æ¨¡å¼ç¯å¢ƒè°ƒç”¨ #define ECALL_FROM_S_MODE 9 // ç›‘ç®¡è€…æ¨¡å¼ç¯å¢ƒè°ƒç”¨ #define INSTRUCTION_PAGE_FAULT 12 // æŒ‡ä»¤é¡µé”™è¯¯ #define LOAD_PAGE_FAULT 13 // åŠ è½½é¡µé”™è¯¯ #define STORE_PAGE_FAULT 15 // å­˜å‚¨é¡µé”™è¯¯ </p><div class="fragment"><div class="line">### PLIC ä¸Šä¸‹æ–‡æ˜ å°„</div>
</div><!-- fragment --><p> cpp // PLIC ä¸Šä¸‹æ–‡è®¡ç®— (é€šå¸¸ä¸º 2 * hart_count) Context 0: Hart 0 M-mode Context 1: Hart 0 S-mode Context 2: Hart 1 M-mode Context 3: Hart 1 S-mode ... ``` </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
