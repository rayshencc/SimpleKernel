<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: APIC 驱动</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__2root_2src_2driver_2apic_2README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">APIC 驱动</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md381"></a> 这个目录包含了 Advanced Programmable <a class="el" href="classInterrupt.html" title="中断处理">Interrupt</a> Controller (APIC) 的驱动实现，专为多核系统设计。</p>
<h1><a class="anchor" id="autotoc_md382"></a>
架构设计</h1>
<h2><a class="anchor" id="autotoc_md383"></a>
多核系统中的 APIC 结构</h2>
<p>在多核系统中，APIC 系统包含：</p>
<ol type="1">
<li><b>Local APIC</b>: 每个 CPU 核心都有一个 Local APIC<ul>
<li>支持传统 xAPIC 和现代 x2APIC 模式</li>
<li>优先使用 x2APIC，不可用时自动回退到 xAPIC</li>
<li>处理本地中断、IPI、定时器</li>
<li>xAPIC 通过内存映射访问，x2APIC 通过 MSR 访问</li>
</ul>
</li>
<li><b>IO APIC</b>: 系统级别的中断控制器<ul>
<li>通常有 1-2 个 IO APIC</li>
<li>处理外部设备中断并路由到不同 CPU</li>
<li>通过内存映射 I/O 访问</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md384"></a>
支持的 APIC 模式</h2>
<h3><a class="anchor" id="autotoc_md385"></a>
x2APIC 模式 (推荐)</h3>
<ul>
<li>使用 MSR 接口访问</li>
<li>支持更多 CPU（最多 2^32 个）</li>
<li>更高的性能</li>
<li>需要 CPU 硬件支持</li>
</ul>
<h3><a class="anchor" id="autotoc_md386"></a>
xAPIC 模式 (兼容性)</h3>
<ul>
<li>使用内存映射接口访问</li>
<li>支持最多 256 个 CPU</li>
<li>兼容旧系统</li>
<li>所有现代 CPU 都支持</li>
</ul>
<p>驱动会自动检测 CPU 能力并选择最佳模式。</p>
<h2><a class="anchor" id="autotoc_md387"></a>
类结构</h2>
<ol type="1">
<li><b><a class="el" href="classLocalApic.html" title="Local APIC 驱动类">LocalApic</a></b> - 管理 Local APIC 功能（per-CPU）<ul>
<li>自动模式检测（x2APIC 优先，回退到 xAPIC）</li>
<li>处理器间中断 (IPI)</li>
<li>定时器功能</li>
<li>中断优先级管理</li>
<li>CPU 启动支持（INIT/SIPI）</li>
</ul>
</li>
<li><b><a class="el" href="classIoApic.html" title="IO APIC 驱动类">IoApic</a></b> - 管理 IO APIC 功能（系统级）<ul>
<li>IRQ 重定向</li>
<li>中断屏蔽/取消屏蔽</li>
<li>重定向表管理</li>
</ul>
</li>
<li><b><a class="el" href="classApic.html" title="APIC 管理类，管理整个系统的 Local APIC 和 IO APIC.">Apic</a></b> - 多核系统管理类<ul>
<li>管理多个 CPU 的 Local APIC</li>
<li>管理多个 IO APIC 实例</li>
<li>CPU 在线状态管理</li>
<li>AP (Application Processor) 启动</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md388"></a>
使用方式</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="apic_8h.html">apic.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="singleton_8hpp.html">singleton.hpp</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 通过单例访问 APIC 管理器</span></div>
<div class="line"><span class="keyword">auto</span>&amp; apic = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 初始化 APIC 系统（在 BSP 上执行）</span></div>
<div class="line"><span class="keywordflow">if</span> (!apic.Init(max_cpu_count)) {</div>
<div class="line">    <span class="comment">// 处理初始化失败</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 添加 IO APIC（通过 ACPI 或其他方式发现）</span></div>
<div class="line"><span class="keywordflow">if</span> (!apic.AddIoApic(io_apic_base_address, gsi_base)) {</div>
<div class="line">    <span class="comment">// 处理添加失败</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 在每个 CPU 核心上初始化 Local APIC</span></div>
<div class="line"><span class="keywordflow">if</span> (!apic.InitCurrentCpuLocalApic()) {</div>
<div class="line">    <span class="comment">// 处理初始化失败</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 发送 EOI 信号</span></div>
<div class="line">apic.SendEoi();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 设置 Local APIC 定时器</span></div>
<div class="line">apic.SetupPeriodicTimer(100, 0xF0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 发送 IPI 到指定 CPU</span></div>
<div class="line">apic.SendIpi(target_apic_id, 0x30);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 启动 AP</span></div>
<div class="line">apic.StartupAp(ap_apic_id, start_vector);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 设置 IRQ 重定向</span></div>
<div class="line">apic.SetIrqRedirection(1, 0x21, target_apic_id); <span class="comment">// 键盘中断</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 标记 CPU 为在线</span></div>
<div class="line">apic.SetCpuOnline(apic.GetCurrentApicId());</div>
<div class="ttc" id="aapic_8h_html"><div class="ttname"><a href="apic_8h.html">apic.h</a></div></div>
<div class="ttc" id="aclassSingleton_html_a68856b49e098eadba37b60366db33ebd"><div class="ttname"><a href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton::GetInstance</a></div><div class="ttdeci">static auto GetInstance() -&gt; T &amp;</div><div class="ttdef"><b>Definition</b> <a href="singleton_8hpp_source.html#l00023">singleton.hpp:23</a></div></div>
<div class="ttc" id="asingleton_8hpp_html"><div class="ttname"><a href="singleton_8hpp.html">singleton.hpp</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md389"></a>
特性</h1>
<h2><a class="anchor" id="autotoc_md390"></a>
Local APIC (per-CPU)</h2>
<ul>
<li>✅ x2APIC 模式支持</li>
<li>✅ 处理器间中断 (IPI)</li>
<li>✅ 定时器功能（周期性和单次）</li>
<li>✅ 任务优先级管理</li>
<li>✅ CPU 启动支持 (INIT/SIPI)</li>
</ul>
<h2><a class="anchor" id="autotoc_md391"></a>
IO APIC (系统级)</h2>
<ul>
<li>✅ IRQ 重定向</li>
<li>✅ 中断屏蔽控制</li>
<li>✅ 多 IO APIC 支持</li>
<li>✅ GSI (Global System <a class="el" href="classInterrupt.html" title="中断处理">Interrupt</a>) 管理</li>
<li>✅ 重定向表管理</li>
</ul>
<h2><a class="anchor" id="autotoc_md392"></a>
多核系统管理</h2>
<ul>
<li>✅ 支持最多 256 个 CPU 核心</li>
<li>✅ CPU 在线状态管理</li>
<li>✅ AP 启动序列</li>
<li>✅ IPI 广播和单播</li>
<li>✅ 多 IO APIC 管理（最多 8 个）</li>
</ul>
<h1><a class="anchor" id="autotoc_md393"></a>
多核系统工作流程</h1>
<h2><a class="anchor" id="autotoc_md394"></a>
1. 系统启动阶段（BSP）</h2>
<div class="fragment"><div class="line"><span class="keyword">auto</span>&amp; apic = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. 初始化 APIC 系统</span></div>
<div class="line">apic.Init(detected_cpu_count);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. 通过 ACPI 发现并添加 IO APIC</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; io_apic_entry : acpi_io_apics) {</div>
<div class="line">    apic.AddIoApic(io_apic_entry.base, io_apic_entry.gsi_base);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. 初始化 BSP 的 Local APIC</span></div>
<div class="line">apic.InitCurrentCpuLocalApic();</div>
<div class="line">apic.SetCpuOnline(apic.GetCurrentApicId());</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md395"></a>
2. AP 启动阶段</h2>
<div class="fragment"><div class="line"><span class="comment">// 在 BSP 上启动 AP</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">auto</span> apic_id : ap_list) {</div>
<div class="line">    apic.StartupAp(apic_id, ap_startup_vector);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 在每个 AP 上执行</span></div>
<div class="line"><span class="keywordtype">void</span> ap_main() {</div>
<div class="line">    <span class="keyword">auto</span>&amp; apic = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;Apic&gt;::GetInstance</a>();</div>
<div class="line">    apic.InitCurrentCpuLocalApic();</div>
<div class="line">    apic.SetCpuOnline(apic.GetCurrentApicId());</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md396"></a>
3. 运行时中断管理</h2>
<div class="fragment"><div class="line"><span class="comment">// 设置设备中断路由</span></div>
<div class="line">apic.SetIrqRedirection(keyboard_irq, KEYBOARD_VECTOR, target_cpu);</div>
<div class="line">apic.SetIrqRedirection(timer_irq, TIMER_VECTOR, target_cpu);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 发送 IPI 通知其他 CPU</span></div>
<div class="line">apic.SendIpi(target_cpu, IPI_VECTOR);</div>
<div class="line">apic.BroadcastIpi(BROADCAST_VECTOR);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md397"></a>
限制</h1>
<ul>
<li>仅支持 x2APIC 模式</li>
<li>不支持传统 xAPIC 模式</li>
<li>最多支持 256 个 CPU 核心</li>
<li>最多支持 8 个 IO APIC</li>
<li>当前实现为接口定义，具体功能需要实现</li>
</ul>
<h1><a class="anchor" id="autotoc_md398"></a>
文件结构</h1>
<div class="fragment"><div class="line">apic/</div>
<div class="line">├── include/</div>
<div class="line">│   └── apic.h          # 头文件，包含所有类定义</div>
<div class="line">├── apic.cpp            # Apic 多核管理类实现</div>
<div class="line">├── local_apic.cpp      # LocalApic 类实现</div>
<div class="line">├── io_apic.cpp         # IoApic 类实现</div>
<div class="line">├── CMakeLists.txt      # 构建配置</div>
<div class="line">└── README.md           # 说明文档</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md399"></a>
依赖</h1>
<ul>
<li><a class="el" href="namespacecpu__io.html">cpu_io</a> 库（用于 MSR 操作）</li>
<li>kernel_log.hpp（用于日志输出）</li>
<li>singleton.hpp（用于单例模式）</li>
</ul>
<h1><a class="anchor" id="autotoc_md400"></a>
注意事项</h1>
<ol type="1">
<li>Local APIC 操作是 per-CPU 的，每个 CPU 访问自己的 Local APIC</li>
<li>IO APIC 是系统级别的，多个 CPU 可能同时访问，需要考虑同步</li>
<li>使用 klog 进行日志输出</li>
<li>使用 std::array 而不是 std::vector</li>
<li>所有接口目前都是空实现，需要根据具体需求填充</li>
<li>支持 GSI 到 IRQ 的映射管理</li>
<li>CPU 在线状态管理用于多核协调 </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
