<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: Task 单元测试环境层实现总结</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__2root_2tests_2unit__test_2task_2IMPLEMENTATION__SUMMARY.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Task 单元测试环境层实现总结</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md444"></a> </p>
<h1><a class="anchor" id="autotoc_md445"></a>
实现概览</h1>
<p>已成功实现 Task 模块单元测试的三层架构设计：</p>
<div class="fragment"><div class="line">测试层 (Test Layer)</div>
<div class="line">    ↓ 调用 Mock API</div>
<div class="line">Mock 层 (Mock Layer) - cpu_io.h, arch_mock.cpp</div>
<div class="line">    ↓ 操作环境状态</div>
<div class="line">环境层 (Environment Layer) - TestEnvironmentState, CoreEnvironment</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md446"></a>
已创建的文件</h1>
<h2><a class="anchor" id="autotoc_md447"></a>
核心实现文件</h2>
<ol type="1">
<li><b>环境层</b><ul>
<li><code><a class="el" href="test__environment__state_8hpp.html">tests/unit_test/mocks/test_environment_state.hpp</a></code> - 环境层头文件</li>
<li><code><a class="el" href="test__environment__state_8cpp.html">tests/unit_test/mocks/test_environment_state.cpp</a></code> - 环境层实现</li>
</ul>
</li>
<li><b>Mock 层（已修改）</b><ul>
<li><code><a class="el" href="cpu__io_8h.html">tests/unit_test/mocks/cpu_io.h</a></code> - 更新为使用环境层</li>
<li><code>tests/unit_test/mocks/arch_mock.cpp</code> - 增强 switch_to 实现</li>
</ul>
</li>
<li><b>测试框架</b><ul>
<li><code><a class="el" href="task__test__harness_8hpp.html">tests/unit_test/task/fixtures/task_test_harness.hpp</a></code> - 测试基类头文件</li>
<li><code><a class="el" href="task__test__harness_8cpp.html">tests/unit_test/task/fixtures/task_test_harness.cpp</a></code> - 测试基类实现</li>
</ul>
</li>
<li><b>示例与文档</b><ul>
<li><code><a class="el" href="example__environment__test_8cpp.html">tests/unit_test/task/example_environment_test.cpp</a></code> - 环境层功能测试</li>
<li><code><a class="el" href="task__scheduling__example__test_8cpp.html">tests/unit_test/task/task_scheduling_example_test.cpp</a></code> - 任务调度测试示例</li>
<li><code><a class="el" href="README__ENVIRONMENT__LAYER_8md.html">tests/unit_test/task/README_ENVIRONMENT_LAYER.md</a></code> - 详细使用文档</li>
</ul>
</li>
<li><b>构建配置</b><ul>
<li><code>tests/unit_test/CMakeLists.txt</code> - 已更新包含新文件</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md448"></a>
核心功能</h1>
<h2><a class="anchor" id="autotoc_md449"></a>
1. CoreEnvironment（单核环境状态）</h2>
<p>模拟单个 CPU 核心的所有关键状态：</p><ul>
<li>✅ 核心 ID</li>
<li>✅ 中断状态（使能/禁用、嵌套深度）</li>
<li>✅ 页表状态（页表基地址、分页使能）</li>
<li>✅ 线程状态（当前线程、空闲线程）</li>
<li>✅ 调度数据指针</li>
<li>✅ 上下文切换历史记录</li>
<li>✅ 性能统计（tick 计数、切换次数）</li>
<li>✅ 线程 ID 映射</li>
</ul>
<h2><a class="anchor" id="autotoc_md450"></a>
2. TestEnvironmentState（全局环境管理）</h2>
<p>提供统一的环境管理接口：</p><ul>
<li>✅ 多核初始化与重置</li>
<li>✅ 线程到核心的映射</li>
<li>✅ 上下文到任务的映射（用于 switch_to）</li>
<li>✅ 调试状态转储</li>
<li>✅ 切换历史聚合与清理</li>
<li>✅ 线程安全（互斥锁保护）</li>
</ul>
<h2><a class="anchor" id="autotoc_md451"></a>
3. Mock 层集成</h2>
<p>所有硬件接口都通过环境层实现：</p><ul>
<li>✅ <code>GetCurrentCoreId()</code> - 查询当前核心 ID</li>
<li>✅ <code>EnableInterrupt() / DisableInterrupt()</code> - 中断控制</li>
<li>✅ <code>GetInterruptStatus()</code> - 查询中断状态</li>
<li>✅ <code>SetPageDirectory()</code> - 设置页表</li>
<li>✅ <code>GetPageDirectory()</code> - 查询页表</li>
<li>✅ <code>EnablePage()</code> - 启用分页</li>
<li>✅ <code><a class="el" href="arch_8h.html#a1a5356ccbae40313871a4877d89cc53d">switch_to()</a></code> - 记录上下文切换</li>
</ul>
<h2><a class="anchor" id="autotoc_md452"></a>
4. 测试框架</h2>
<p>提供统一的测试基类：</p><ul>
<li>✅ <code><a class="el" href="classTaskTestHarness.html" title="Task 模块单元测试的基类 Fixture.">TaskTestHarness</a></code> - 自动管理环境生命周期</li>
<li>✅ 测试隔离（每个测试独立重置环境）</li>
<li>✅ 多核支持（可配置核心数量）</li>
<li>✅ 主线程自动绑定到 core 0</li>
</ul>
<h1><a class="anchor" id="autotoc_md453"></a>
使用流程</h1>
<h2><a class="anchor" id="autotoc_md454"></a>
1. 编写测试类</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyTaskTest : <span class="keyword">public</span> <a class="code hl_class" href="classTaskTestHarness.html">TaskTestHarness</a> {</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">SetUp</a>()<span class="keyword"> override </span>{</div>
<div class="line">    <a class="code hl_function" href="classTaskTestHarness.html#a34722547f18a938d8f44c28bcbbc8b2c">SetNumCores</a>(2);  <span class="comment">// 配置核心数量</span></div>
<div class="line">    <a class="code hl_function" href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">TaskTestHarness::SetUp</a>();</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="ttc" id="aclassTaskTestHarness_html"><div class="ttname"><a href="classTaskTestHarness.html">TaskTestHarness</a></div><div class="ttdoc">Task 模块单元测试的基类 Fixture.</div><div class="ttdef"><b>Definition</b> <a href="task__test__harness_8hpp_source.html#l00019">task_test_harness.hpp:19</a></div></div>
<div class="ttc" id="aclassTaskTestHarness_html_a34722547f18a938d8f44c28bcbbc8b2c"><div class="ttname"><a href="classTaskTestHarness.html#a34722547f18a938d8f44c28bcbbc8b2c">TaskTestHarness::SetNumCores</a></div><div class="ttdeci">void SetNumCores(size_t num_cores)</div><div class="ttdoc">设置测试使用的核心数量（在 SetUp 前调用）</div><div class="ttdef"><b>Definition</b> <a href="task__test__harness_8hpp_source.html#l00027">task_test_harness.hpp:27</a></div></div>
<div class="ttc" id="aclassTaskTestHarness_html_a9b21a4be72464267c2d3059fa165ca6d"><div class="ttname"><a href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">TaskTestHarness::SetUp</a></div><div class="ttdeci">void SetUp() override</div><div class="ttdef"><b>Definition</b> <a href="task__test__harness_8cpp_source.html#l00013">task_test_harness.cpp:13</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md455"></a>
2. 注册任务上下文</h2>
<div class="fragment"><div class="line"><a class="code hl_function" href="kernel__fdt__test_8cpp.html#a3ad49ba9a2026e9c2c37e5cc99c307c4">TEST_F</a>(MyTaskTest, TaskSwitching) {</div>
<div class="line">  <span class="keyword">auto</span>&amp; env = GetEnvironmentState();</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a> task1, task2;</div>
<div class="line">  env.RegisterTaskContext(&amp;task1.<a class="code hl_variable" href="structTaskControlBlock.html#af087bcb6f419c7484c1200719e0751a9">task_context</a>, &amp;task1);</div>
<div class="line">  env.RegisterTaskContext(&amp;task2.<a class="code hl_variable" href="structTaskControlBlock.html#af087bcb6f419c7484c1200719e0751a9">task_context</a>, &amp;task2);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ... 执行测试 ...</span></div>
<div class="line"> </div>
<div class="line">  env.UnregisterTaskContext(&amp;task1.<a class="code hl_variable" href="structTaskControlBlock.html#af087bcb6f419c7484c1200719e0751a9">task_context</a>);</div>
<div class="line">  env.UnregisterTaskContext(&amp;task2.<a class="code hl_variable" href="structTaskControlBlock.html#af087bcb6f419c7484c1200719e0751a9">task_context</a>);</div>
<div class="line">}</div>
<div class="ttc" id="akernel__fdt__test_8cpp_html_a3ad49ba9a2026e9c2c37e5cc99c307c4"><div class="ttname"><a href="kernel__fdt__test_8cpp.html#a3ad49ba9a2026e9c2c37e5cc99c307c4">TEST_F</a></div><div class="ttdeci">TEST_F(KernelFdtTest, ConstructorTest)</div><div class="ttdef"><b>Definition</b> <a href="kernel__fdt__test_8cpp_source.html#l00025">kernel_fdt_test.cpp:25</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html"><div class="ttname"><a href="structTaskControlBlock.html">TaskControlBlock</a></div><div class="ttdoc">任务控制块，管理进程/线程的核心数据结构</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00080">task_control_block.hpp:80</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_af087bcb6f419c7484c1200719e0751a9"><div class="ttname"><a href="structTaskControlBlock.html#af087bcb6f419c7484c1200719e0751a9">TaskControlBlock::task_context</a></div><div class="ttdeci">cpu_io::CalleeSavedContext task_context</div><div class="ttdoc">任务上下文</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00176">task_control_block.hpp:176</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md456"></a>
3. 验证调度行为</h2>
<div class="fragment"><div class="line"><span class="comment">// 执行任务切换</span></div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> <a class="code hl_function" href="arch_8h.html#a1a5356ccbae40313871a4877d89cc53d">switch_to</a>(<a class="code hl_struct" href="structcpu__io_1_1CalleeSavedContext.html">cpu_io::CalleeSavedContext</a>*,</div>
<div class="line">                         <a class="code hl_struct" href="structcpu__io_1_1CalleeSavedContext.html">cpu_io::CalleeSavedContext</a>*);</div>
<div class="line"><a class="code hl_function" href="arch_8h.html#a1a5356ccbae40313871a4877d89cc53d">switch_to</a>(&amp;task1.<a class="code hl_variable" href="structTaskControlBlock.html#af087bcb6f419c7484c1200719e0751a9">task_context</a>, &amp;task2.<a class="code hl_variable" href="structTaskControlBlock.html#af087bcb6f419c7484c1200719e0751a9">task_context</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 验证切换历史</span></div>
<div class="line"><span class="keyword">auto</span> history = env.GetAllSwitchHistory();</div>
<div class="line"><a class="code hl_define" href="system__test_8h.html#abfc1b6826e51b93338e02cabfa5cfcd1">EXPECT_EQ</a>(history[0].from, &amp;task1);</div>
<div class="line"><a class="code hl_define" href="system__test_8h.html#abfc1b6826e51b93338e02cabfa5cfcd1">EXPECT_EQ</a>(history[0].to, &amp;task2);</div>
<div class="ttc" id="aarch_8h_html_a1a5356ccbae40313871a4877d89cc53d"><div class="ttname"><a href="arch_8h.html#a1a5356ccbae40313871a4877d89cc53d">switch_to</a></div><div class="ttdeci">void switch_to(cpu_io::CalleeSavedContext *prev, cpu_io::CalleeSavedContext *next)</div><div class="ttdef"><b>Definition</b> <a href="arch_8cpp_source.html#l00015">arch.cpp:15</a></div></div>
<div class="ttc" id="astructcpu__io_1_1CalleeSavedContext_html"><div class="ttname"><a href="structcpu__io_1_1CalleeSavedContext.html">cpu_io::CalleeSavedContext</a></div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00194">cpu_io.h:194</a></div></div>
<div class="ttc" id="asystem__test_8h_html_abfc1b6826e51b93338e02cabfa5cfcd1"><div class="ttname"><a href="system__test_8h.html#abfc1b6826e51b93338e02cabfa5cfcd1">EXPECT_EQ</a></div><div class="ttdeci">#define EXPECT_EQ(val1, val2, msg)</div><div class="ttdef"><b>Definition</b> <a href="system__test_8h_source.html#l00102">system_test.h:102</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md457"></a>
已验证的功能</h1>
<p>通过示例测试验证了以下功能：</p>
<h2><a class="anchor" id="autotoc_md458"></a>
基础功能测试（example_environment_test.cpp）</h2>
<ul>
<li>✅ 核心初始化</li>
<li>✅ 中断状态控制</li>
<li>✅ 页表操作</li>
<li>✅ CoreId 查询</li>
<li>✅ 状态转储</li>
<li>✅ 切换历史追踪</li>
</ul>
<h2><a class="anchor" id="autotoc_md459"></a>
调度功能测试（task_scheduling_example_test.cpp）</h2>
<ul>
<li>✅ 任务上下文注册与注销</li>
<li>✅ switch_to 记录切换事件</li>
<li>✅ 多次切换的历史记录</li>
<li>✅ 中断状态在切换时的行为</li>
<li>✅ 页表在任务间切换</li>
<li>✅ 切换历史清空</li>
</ul>
<h1><a class="anchor" id="autotoc_md460"></a>
设计优势</h1>
<h2><a class="anchor" id="autotoc_md461"></a>
1. 职责清晰</h2>
<ul>
<li><b>环境层</b>: 纯数据容器，存储模拟状态</li>
<li><b>Mock 层</b>: 提供硬件接口，操作环境层</li>
<li><b>测试层</b>: 编写测试逻辑，验证行为</li>
</ul>
<h2><a class="anchor" id="autotoc_md462"></a>
2. 可观测性强</h2>
<ul>
<li>所有硬件状态可随时查询</li>
<li>完整的上下文切换历史</li>
<li>性能统计信息（tick、切换次数）</li>
</ul>
<h2><a class="anchor" id="autotoc_md463"></a>
3. 易于扩展</h2>
<p>需要添加新的硬件特性时，只需：</p><ol type="1">
<li>在 <code>CoreEnvironment</code> 中添加字段</li>
<li>在 Mock 层添加对应接口</li>
<li>测试层自动可用</li>
</ol>
<p>示例扩展（TLB 模拟）： </p><div class="fragment"><div class="line"><span class="comment">// 1. 扩展 CoreEnvironment</span></div>
<div class="line"><span class="keyword">struct </span>CoreEnvironment {</div>
<div class="line">  std::unordered_map&lt;uint64_t, uint64_t&gt; tlb_cache;</div>
<div class="line">  <span class="keywordtype">size_t</span> tlb_hits = 0;</div>
<div class="line">  <span class="keywordtype">size_t</span> tlb_misses = 0;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. 添加 Mock 接口</span></div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacecpu__io_1_1virtual__memory.html">cpu_io::virtual_memory</a> {</div>
<div class="line">  <span class="keyword">inline</span> <span class="keywordtype">void</span> FlushTLB(uint64_t va) {</div>
<div class="line">    <span class="keyword">auto</span>&amp; core = test_env::TestEnvironmentState::GetInstance()</div>
<div class="line">        .GetCurrentCoreEnv();</div>
<div class="line">    core.tlb_cache.erase(va);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. 测试层直接使用</span></div>
<div class="line"><a class="code hl_function" href="kernel__fdt__test_8cpp.html#a3ad49ba9a2026e9c2c37e5cc99c307c4">TEST_F</a>(MyTest, TLBBehavior) {</div>
<div class="line">  cpu_io::virtual_memory::FlushTLB(0x1000);</div>
<div class="line">  <span class="keyword">auto</span>&amp; core = GetEnvironmentState().GetCurrentCoreEnv();</div>
<div class="line">  <a class="code hl_define" href="system__test_8h.html#a00a870caa41dce04e9db04bd0c2fca57">EXPECT_TRUE</a>(core.tlb_cache.empty());</div>
<div class="line">}</div>
<div class="ttc" id="anamespacecpu__io_1_1virtual__memory_html"><div class="ttname"><a href="namespacecpu__io_1_1virtual__memory.html">cpu_io::virtual_memory</a></div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00055">cpu_io.h:55</a></div></div>
<div class="ttc" id="asystem__test_8h_html_a00a870caa41dce04e9db04bd0c2fca57"><div class="ttname"><a href="system__test_8h.html#a00a870caa41dce04e9db04bd0c2fca57">EXPECT_TRUE</a></div><div class="ttdeci">#define EXPECT_TRUE(cond, msg)</div><div class="ttdef"><b>Definition</b> <a href="system__test_8h_source.html#l00127">system_test.h:127</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md464"></a>
4. 线程安全</h2>
<ul>
<li>所有环境层接口使用互斥锁保护</li>
<li>支持真实的多线程测试</li>
<li>自动核心映射机制</li>
</ul>
<h2><a class="anchor" id="autotoc_md465"></a>
5. 测试隔离</h2>
<ul>
<li>每个测试自动重置环境</li>
<li>无全局状态污染</li>
<li>测试间完全独立</li>
</ul>
<h1><a class="anchor" id="autotoc_md466"></a>
下一步工作</h1>
<h2><a class="anchor" id="autotoc_md467"></a>
建议优先实现的功能</h2>
<ol type="1">
<li><b><a class="el" href="classTaskManager.html" title="任务管理器">TaskManager</a> 的 ResetForTesting 方法</b> <div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_class" href="classTaskManager.html">TaskManager</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keywordtype">void</span> ResetForTesting() {</div>
<div class="line">    <span class="comment">// 清空调度器队列</span></div>
<div class="line">    <span class="comment">// 重置 PID 分配器</span></div>
<div class="line">    <span class="comment">// 清理任务表</span></div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="ttc" id="aclassTaskManager_html"><div class="ttname"><a href="classTaskManager.html">TaskManager</a></div><div class="ttdoc">任务管理器</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8hpp_source.html#l00060">task_manager.hpp:60</a></div></div>
</div><!-- fragment --></li>
<li><b>多核工作线程框架</b> <div class="fragment"><div class="line"><span class="keyword">class </span>SchedulingWorker {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SchedulingWorker(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a>);</div>
<div class="line">  <span class="keywordtype">void</span> Start();</div>
<div class="line">  <span class="keywordtype">void</span> Stop();</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> WorkerLoop();</div>
<div class="line">};</div>
<div class="ttc" id="aper__cpu_8hpp_html_af349ef2aacd2314294eac3283d14e3ca"><div class="ttname"><a href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a></div><div class="ttdeci">size_t core_id</div><div class="ttdoc">核心 ID</div><div class="ttdef"><b>Definition</b> <a href="per__cpu_8hpp_source.html#l00001">per_cpu.hpp:1</a></div></div>
</div><!-- fragment --></li>
<li><b>超时保护机制</b> <div class="fragment"><div class="line"><span class="keyword">class </span>TimeoutGuard {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  TimeoutGuard(std::chrono::seconds timeout);</div>
<div class="line">  <span class="keywordtype">bool</span> IsTimeout() <span class="keyword">const</span>;</div>
<div class="line">};</div>
</div><!-- fragment --></li>
<li><b>任务创建辅助函数</b> <div class="fragment"><div class="line"><span class="keyword">auto</span> CreateTestTask(<span class="keyword">const</span> <span class="keywordtype">char</span>* name, <a class="code hl_typedef" href="task__control__block_8hpp.html#a78d16f92c80a8342bc67d945b720a1cf">ThreadEntry</a> func, <span class="keywordtype">void</span>* arg)</div>
<div class="line">    -&gt; <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>*;</div>
<div class="ttc" id="atask__control__block_8hpp_html_a78d16f92c80a8342bc67d945b720a1cf"><div class="ttname"><a href="task__control__block_8hpp.html#a78d16f92c80a8342bc67d945b720a1cf">ThreadEntry</a></div><div class="ttdeci">void(*)(void *) ThreadEntry</div><div class="ttdoc">线程入口函数类型</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00020">task_control_block.hpp:20</a></div></div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md468"></a>
可以开始编写的测试</h2>
<p>有了这个环境层，现在可以编写：</p><ul>
<li>✅ 调度器单元测试（FIFO、RR、CFS）</li>
<li>✅ 任务状态转换测试</li>
<li>✅ 多核负载均衡测试</li>
<li>✅ CPU 亲和性测试</li>
<li>✅ 阻塞/唤醒测试</li>
<li>✅ 时间片管理测试</li>
</ul>
<h1><a class="anchor" id="autotoc_md469"></a>
构建与运行</h1>
<div class="fragment"><div class="line"># 1. 配置构建（选择架构，以 riscv64 为例）</div>
<div class="line">cmake --preset build_riscv64</div>
<div class="line"> </div>
<div class="line"># 2. 编译单元测试</div>
<div class="line">cd build_riscv64 &amp;&amp; make unit-test</div>
<div class="line"> </div>
<div class="line"># 3. 运行测试</div>
<div class="line">./tests/unit-test</div>
<div class="line"> </div>
<div class="line"># 4. 运行特定测试</div>
<div class="line">./tests/unit-test --gtest_filter=&quot;EnvironmentLayerTest.*&quot;</div>
<div class="line">./tests/unit-test --gtest_filter=&quot;TaskSchedulingExample.*&quot;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md470"></a>
文档参考</h1>
<ul>
<li><a class="el" href="README__ENVIRONMENT__LAYER_8md.html">环境层使用指南</a> - 详细的 API 文档和使用示例</li>
<li><a class="el" href="task__unit__test__new__design_8md.html">Task 单元测试设计</a> - 整体设计思路</li>
</ul>
<h1><a class="anchor" id="autotoc_md471"></a>
技术细节</h1>
<h2><a class="anchor" id="autotoc_md472"></a>
线程到核心的映射</h2>
<p>使用 <code>std::thread::id</code> 作为 key，自动或手动绑定：</p>
<div class="fragment"><div class="line"><span class="comment">// 自动绑定（首次调用时）</span></div>
<div class="line"><span class="keywordtype">size_t</span> <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a> = <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a>();  <span class="comment">// 自动分配</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 手动绑定（多核测试时推荐）</span></div>
<div class="line">env.BindThreadToCore(std::this_thread::get_id(), 2);</div>
<div class="ttc" id="anamespacecpu__io_html_a52b8a7263a31e6670ef4dec7922d9e72"><div class="ttname"><a href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a></div><div class="ttdeci">auto GetCurrentCoreId() -&gt; size_t</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00026">cpu_io.h:26</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md473"></a>
上下文到任务的映射</h2>
<p>用于 <code>switch_to</code> 函数找到对应的任务：</p>
<div class="fragment"><div class="line"><span class="comment">// 注册</span></div>
<div class="line">env.RegisterTaskContext(&amp;task.task_context, &amp;task);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 查找</span></div>
<div class="line"><span class="keyword">auto</span>* task = env.FindTaskByContext(context_ptr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 注销</span></div>
<div class="line">env.UnregisterTaskContext(&amp;task.task_context);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md474"></a>
切换事件记录</h2>
<p>每次调用 <code>switch_to</code> 都会自动记录：</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>SwitchEvent {</div>
<div class="line">  uint64_t timestamp;        <span class="comment">// 切换时的 tick</span></div>
<div class="line">  <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* from;    <span class="comment">// 源任务</span></div>
<div class="line">  <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* to;      <span class="comment">// 目标任务</span></div>
<div class="line">  <span class="keywordtype">size_t</span> <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a>;           <span class="comment">// 执行切换的核心</span></div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md475"></a>
总结</h1>
<p>✅ <b>环境层实现完成</b> - 提供完整的硬件状态模拟 ✅ <b>Mock 层集成完成</b> - 所有接口使用环境层 ✅ <b>测试框架就绪</b> - <a class="el" href="classTaskTestHarness.html" title="Task 模块单元测试的基类 Fixture.">TaskTestHarness</a> 提供统一基类 ✅ <b>示例测试通过</b> - 验证了核心功能 ✅ <b>文档完善</b> - 详细的使用指南和示例</p>
<p>现在可以基于这个环境层编写完整的 Task 模块单元测试了！ </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
