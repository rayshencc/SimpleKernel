<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: Task 模块单元测试环境层设计</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__2root_2tests_2unit__test_2task_2README__ENVIRONMENT__LAYER.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Task 模块单元测试环境层设计</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md476"></a> </p>
<h1><a class="anchor" id="autotoc_md477"></a>
架构概述</h1>
<p>Task 模块的单元测试采用三层架构设计，职责清晰、易于维护：</p>
<div class="fragment"><div class="line">┌─────────────────────────────────────┐</div>
<div class="line">│         测试层 (Test Layer)          │</div>
<div class="line">│  - 编写测试用例                       │</div>
<div class="line">│  - 调用 Mock 层接口                   │</div>
<div class="line">│  - 验证调度行为                       │</div>
<div class="line">└──────────────┬──────────────────────┘</div>
<div class="line">               │ 通过 Mock API</div>
<div class="line">               ↓</div>
<div class="line">┌─────────────────────────────────────┐</div>
<div class="line">│         Mock 层 (Mock Layer)         │</div>
<div class="line">│  - cpu_io.h: 中断、CoreID、页表      │</div>
<div class="line">│  - arch_mock.cpp: switch_to 等       │</div>
<div class="line">│  - 提供硬件接口的模拟实现             │</div>
<div class="line">└──────────────┬──────────────────────┘</div>
<div class="line">               │ 操作环境状态</div>
<div class="line">               ↓</div>
<div class="line">┌─────────────────────────────────────┐</div>
<div class="line">│       环境层 (Environment Layer)     │</div>
<div class="line">│  - TestEnvironmentState: 全局状态    │</div>
<div class="line">│  - CoreEnvironment: 单核状态         │</div>
<div class="line">│  - 记录中断、页表、线程、切换历史     │</div>
<div class="line">└─────────────────────────────────────┘</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md478"></a>
核心组件</h1>
<h2><a class="anchor" id="autotoc_md479"></a>
1. 环境层 (Environment Layer)</h2>
<h3><a class="anchor" id="autotoc_md480"></a>
&lt;tt&gt;CoreEnvironment&lt;/tt&gt; - 单核环境状态</h3>
<p>模拟单个 CPU 核心的运行环境：</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>CoreEnvironment {</div>
<div class="line">  <span class="keywordtype">size_t</span> <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a>;                    <span class="comment">// 核心 ID</span></div>
<div class="line">  <span class="keywordtype">bool</span> interrupt_enabled;            <span class="comment">// 中断使能状态</span></div>
<div class="line">  <span class="keywordtype">int</span> interrupt_nest_level;          <span class="comment">// 中断嵌套深度</span></div>
<div class="line">  uint64_t page_directory;           <span class="comment">// 页表基地址</span></div>
<div class="line">  <span class="keywordtype">bool</span> paging_enabled;               <span class="comment">// 分页是否启用</span></div>
<div class="line">  <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* current_thread;  <span class="comment">// 当前运行线程</span></div>
<div class="line">  <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* idle_thread;     <span class="comment">// 空闲线程</span></div>
<div class="line">  <a class="code hl_struct" href="structCpuSchedData.html">CpuSchedData</a>* <a class="code hl_variable" href="per__cpu_8hpp.html#a2212638d15cc941050a49d7089c8ca9d">sched_data</a>;          <span class="comment">// 调度数据</span></div>
<div class="line">  std::vector&lt;SwitchEvent&gt; switch_history;  <span class="comment">// 切换历史</span></div>
<div class="line">  uint64_t local_tick;               <span class="comment">// 本地时钟</span></div>
<div class="line">  uint64_t total_switches;           <span class="comment">// 切换次数统计</span></div>
<div class="line">  std::thread::id thread_id;         <span class="comment">// 关联的 std::thread</span></div>
<div class="line">};</div>
<div class="ttc" id="aper__cpu_8hpp_html_a2212638d15cc941050a49d7089c8ca9d"><div class="ttname"><a href="per__cpu_8hpp.html#a2212638d15cc941050a49d7089c8ca9d">sched_data</a></div><div class="ttdeci">CpuSchedData * sched_data</div><div class="ttdoc">调度数据 (RunQueue) 指针</div><div class="ttdef"><b>Definition</b> <a href="per__cpu_8hpp_source.html#l00008">per_cpu.hpp:8</a></div></div>
<div class="ttc" id="aper__cpu_8hpp_html_af349ef2aacd2314294eac3283d14e3ca"><div class="ttname"><a href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a></div><div class="ttdeci">size_t core_id</div><div class="ttdoc">核心 ID</div><div class="ttdef"><b>Definition</b> <a href="per__cpu_8hpp_source.html#l00001">per_cpu.hpp:1</a></div></div>
<div class="ttc" id="astructCpuSchedData_html"><div class="ttname"><a href="structCpuSchedData.html">CpuSchedData</a></div><div class="ttdoc">每个核心的调度数据 (RunQueue)</div><div class="ttdef"><b>Definition</b> <a href="task__manager_8hpp_source.html#l00030">task_manager.hpp:30</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html"><div class="ttname"><a href="structTaskControlBlock.html">TaskControlBlock</a></div><div class="ttdoc">任务控制块，管理进程/线程的核心数据结构</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00080">task_control_block.hpp:80</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md481"></a>
&lt;tt&gt;TestEnvironmentState&lt;/tt&gt; - 全局环境管理器</h3>
<p>单例模式，管理所有核心的环境：</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>TestEnvironmentState {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">auto</span> GetInstance() -&gt; TestEnvironmentState&amp;;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 核心管理</span></div>
<div class="line">  <span class="keywordtype">void</span> InitializeCores(<span class="keywordtype">size_t</span> num_cores);</div>
<div class="line">  <span class="keywordtype">void</span> ResetAllCores();</div>
<div class="line">  <span class="keyword">auto</span> GetCore(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a>) -&gt; CoreEnvironment&amp;;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 线程到核心的映射</span></div>
<div class="line">  <span class="keywordtype">void</span> BindThreadToCore(std::thread::id tid, <span class="keywordtype">size_t</span> <a class="code hl_variable" href="per__cpu_8hpp.html#af349ef2aacd2314294eac3283d14e3ca">core_id</a>);</div>
<div class="line">  <span class="keyword">auto</span> GetCoreIdForThread(std::thread::id tid) -&gt; size_t;</div>
<div class="line">  <span class="keyword">auto</span> GetCurrentCoreEnv() -&gt; CoreEnvironment&amp;;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 上下文到任务的映射</span></div>
<div class="line">  <span class="keywordtype">void</span> RegisterTaskContext(<span class="keywordtype">void</span>* context_ptr, <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* task);</div>
<div class="line">  <span class="keyword">auto</span> FindTaskByContext(<span class="keywordtype">void</span>* context_ptr) -&gt; <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>*;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 调试与验证</span></div>
<div class="line">  <span class="keywordtype">void</span> DumpAllCoreStates() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keyword">auto</span> GetAllSwitchHistory() const -&gt; <a class="code hl_namespace" href="namespacestd.html">std</a>::vector&lt;SwitchEvent&gt;;</div>
<div class="line">  <span class="keywordtype">void</span> ClearSwitchHistory();</div>
<div class="line">};</div>
<div class="ttc" id="anamespacestd_html"><div class="ttname"><a href="namespacestd.html">std</a></div><div class="ttdef"><b>Definition</b> <a href="resource__id_8hpp_source.html#l00135">resource_id.hpp:135</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md482"></a>
2. Mock 层 (Mock Layer)</h2>
<h3><a class="anchor" id="autotoc_md483"></a>
&lt;tt&gt;cpu_io.h&lt;/tt&gt; - 硬件接口模拟</h3>
<p>所有硬件相关的接口都通过环境层实现：</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacecpu__io.html">cpu_io</a> {</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 核心 ID 查询</span></div>
<div class="line"><span class="keyword">inline</span> <span class="keyword">auto</span> <a class="code hl_function" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">GetCurrentCoreId</a>() -&gt; <span class="keywordtype">size_t</span> {</div>
<div class="line">  <span class="keywordflow">return</span> test_env::TestEnvironmentState::GetInstance()</div>
<div class="line">      .GetCoreIdForThread(std::this_thread::get_id());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 中断控制</span></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code hl_function" href="namespacecpu__io.html#afe7f925ac3cb632ed212166712288451">EnableInterrupt</a>() {</div>
<div class="line">  <span class="keyword">auto</span>&amp; core = test_env::TestEnvironmentState::GetInstance()</div>
<div class="line">      .GetCurrentCoreEnv();</div>
<div class="line">  core.interrupt_enabled = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code hl_function" href="namespacecpu__io.html#a6c4ee629d8129247969cace77d47fecb">DisableInterrupt</a>() {</div>
<div class="line">  <span class="keyword">auto</span>&amp; core = test_env::TestEnvironmentState::GetInstance()</div>
<div class="line">      .GetCurrentCoreEnv();</div>
<div class="line">  core.interrupt_enabled = <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="namespacecpu__io.html#aaab46268534006b116de3e112c237f7f">GetInterruptStatus</a>() {</div>
<div class="line">  <span class="keyword">auto</span>&amp; core = test_env::TestEnvironmentState::GetInstance()</div>
<div class="line">      .GetCurrentCoreEnv();</div>
<div class="line">  <span class="keywordflow">return</span> core.interrupt_enabled;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 页表操作</span></div>
<div class="line"><span class="keyword">namespace </span>virtual_memory {</div>
<div class="line">  <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code hl_function" href="namespacecpu__io_1_1virtual__memory.html#a34641ac6c78b4598532a2d089c1357b2">SetPageDirectory</a>(uint64_t pd) {</div>
<div class="line">    <span class="keyword">auto</span>&amp; core = test_env::TestEnvironmentState::GetInstance()</div>
<div class="line">        .GetCurrentCoreEnv();</div>
<div class="line">    core.page_directory = pd;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">inline</span> <span class="keyword">auto</span> <a class="code hl_function" href="namespacecpu__io_1_1virtual__memory.html#acac13e4ce3e785b0e52dfb296d2c15b7">GetPageDirectory</a>() -&gt; uint64_t {</div>
<div class="line">    <span class="keyword">auto</span>&amp; core = test_env::TestEnvironmentState::GetInstance()</div>
<div class="line">        .GetCurrentCoreEnv();</div>
<div class="line">    <span class="keywordflow">return</span> core.page_directory;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace cpu_io</span></div>
<div class="ttc" id="anamespacecpu__io_1_1virtual__memory_html_a34641ac6c78b4598532a2d089c1357b2"><div class="ttname"><a href="namespacecpu__io_1_1virtual__memory.html#a34641ac6c78b4598532a2d089c1357b2">cpu_io::virtual_memory::SetPageDirectory</a></div><div class="ttdeci">void SetPageDirectory(uint64_t pd)</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00115">cpu_io.h:115</a></div></div>
<div class="ttc" id="anamespacecpu__io_1_1virtual__memory_html_acac13e4ce3e785b0e52dfb296d2c15b7"><div class="ttname"><a href="namespacecpu__io_1_1virtual__memory.html#acac13e4ce3e785b0e52dfb296d2c15b7">cpu_io::virtual_memory::GetPageDirectory</a></div><div class="ttdeci">auto GetPageDirectory() -&gt; uint64_t</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00122">cpu_io.h:122</a></div></div>
<div class="ttc" id="anamespacecpu__io_html"><div class="ttname"><a href="namespacecpu__io.html">cpu_io</a></div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00018">cpu_io.h:18</a></div></div>
<div class="ttc" id="anamespacecpu__io_html_a52b8a7263a31e6670ef4dec7922d9e72"><div class="ttname"><a href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId</a></div><div class="ttdeci">auto GetCurrentCoreId() -&gt; size_t</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00026">cpu_io.h:26</a></div></div>
<div class="ttc" id="anamespacecpu__io_html_a6c4ee629d8129247969cace77d47fecb"><div class="ttname"><a href="namespacecpu__io.html#a6c4ee629d8129247969cace77d47fecb">cpu_io::DisableInterrupt</a></div><div class="ttdeci">void DisableInterrupt()</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00041">cpu_io.h:41</a></div></div>
<div class="ttc" id="anamespacecpu__io_html_aaab46268534006b116de3e112c237f7f"><div class="ttname"><a href="namespacecpu__io.html#aaab46268534006b116de3e112c237f7f">cpu_io::GetInterruptStatus</a></div><div class="ttdeci">bool GetInterruptStatus()</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00048">cpu_io.h:48</a></div></div>
<div class="ttc" id="anamespacecpu__io_html_afe7f925ac3cb632ed212166712288451"><div class="ttname"><a href="namespacecpu__io.html#afe7f925ac3cb632ed212166712288451">cpu_io::EnableInterrupt</a></div><div class="ttdeci">void EnableInterrupt()</div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00034">cpu_io.h:34</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md484"></a>
&lt;tt&gt;arch_mock.cpp&lt;/tt&gt; - 架构相关函数</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="arch_8h.html#a1a5356ccbae40313871a4877d89cc53d">switch_to</a>(<a class="code hl_struct" href="structcpu__io_1_1CalleeSavedContext.html">cpu_io::CalleeSavedContext</a>* prev_ctx,</div>
<div class="line">               <a class="code hl_struct" href="structcpu__io_1_1CalleeSavedContext.html">cpu_io::CalleeSavedContext</a>* next_ctx) {</div>
<div class="line">  <span class="keyword">auto</span>&amp; env_state = test_env::TestEnvironmentState::GetInstance();</div>
<div class="line">  <span class="keyword">auto</span>&amp; core = env_state.GetCurrentCoreEnv();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 查找任务</span></div>
<div class="line">  <span class="keyword">auto</span>* prev_task = env_state.FindTaskByContext(prev_ctx);</div>
<div class="line">  <span class="keyword">auto</span>* next_task = env_state.FindTaskByContext(next_ctx);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 记录切换事件</span></div>
<div class="line">  core.switch_history.push_back({</div>
<div class="line">    .timestamp = core.local_tick,</div>
<div class="line">    .from = prev_task,</div>
<div class="line">    .to = next_task,</div>
<div class="line">    .core_id = core.core_id,</div>
<div class="line">  });</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 更新当前线程</span></div>
<div class="line">  core.current_thread = next_task;</div>
<div class="line">  core.total_switches++;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 不执行真实的栈切换（单元测试中）</span></div>
<div class="line">}</div>
<div class="ttc" id="aarch_8h_html_a1a5356ccbae40313871a4877d89cc53d"><div class="ttname"><a href="arch_8h.html#a1a5356ccbae40313871a4877d89cc53d">switch_to</a></div><div class="ttdeci">void switch_to(cpu_io::CalleeSavedContext *prev, cpu_io::CalleeSavedContext *next)</div><div class="ttdef"><b>Definition</b> <a href="arch_8cpp_source.html#l00015">arch.cpp:15</a></div></div>
<div class="ttc" id="astructcpu__io_1_1CalleeSavedContext_html"><div class="ttname"><a href="structcpu__io_1_1CalleeSavedContext.html">cpu_io::CalleeSavedContext</a></div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00194">cpu_io.h:194</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md485"></a>
3. 测试层 (Test Layer)</h2>
<h3><a class="anchor" id="autotoc_md486"></a>
&lt;tt&gt;TaskTestHarness&lt;/tt&gt; - 测试 Fixture 基类</h3>
<p>所有 Task 模块的测试都应继承自这个类：</p>
<div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_class" href="classTaskTestHarness.html">TaskTestHarness</a> : <span class="keyword">public</span> ::testing::Test {</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">SetUp</a>()<span class="keyword"> override </span>{</div>
<div class="line">    <span class="comment">// 1. 重置环境层</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; env_state = test_env::TestEnvironmentState::GetInstance();</div>
<div class="line">    env_state.ResetAllCores();</div>
<div class="line">    env_state.InitializeCores(<a class="code hl_variable" href="classTaskTestHarness.html#abd7a9b94b9049521896e423224471840">num_cores_</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. 绑定主测试线程到 core 0</span></div>
<div class="line">    env_state.BindThreadToCore(std::this_thread::get_id(), 0);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. 重置 PerCpu 数据</span></div>
<div class="line">    <span class="comment">// 4. 重置 TaskManager</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="classTaskTestHarness.html#a2cb71293bed79eba46bd9a86291cb4bd">TearDown</a>()<span class="keyword"> override </span>{</div>
<div class="line">    <span class="comment">// 清理环境</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="classTaskTestHarness.html#a34722547f18a938d8f44c28bcbbc8b2c">SetNumCores</a>(<span class="keywordtype">size_t</span> num_cores) { <a class="code hl_variable" href="classTaskTestHarness.html#abd7a9b94b9049521896e423224471840">num_cores_</a> = num_cores; }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">size_t</span> <a class="code hl_variable" href="classTaskTestHarness.html#abd7a9b94b9049521896e423224471840">num_cores_</a> = 1;  <span class="comment">// 默认单核</span></div>
<div class="line">};</div>
<div class="ttc" id="aclassTaskTestHarness_html"><div class="ttname"><a href="classTaskTestHarness.html">TaskTestHarness</a></div><div class="ttdoc">Task 模块单元测试的基类 Fixture.</div><div class="ttdef"><b>Definition</b> <a href="task__test__harness_8hpp_source.html#l00019">task_test_harness.hpp:19</a></div></div>
<div class="ttc" id="aclassTaskTestHarness_html_a2cb71293bed79eba46bd9a86291cb4bd"><div class="ttname"><a href="classTaskTestHarness.html#a2cb71293bed79eba46bd9a86291cb4bd">TaskTestHarness::TearDown</a></div><div class="ttdeci">void TearDown() override</div><div class="ttdef"><b>Definition</b> <a href="task__test__harness_8cpp_source.html#l00035">task_test_harness.cpp:35</a></div></div>
<div class="ttc" id="aclassTaskTestHarness_html_a34722547f18a938d8f44c28bcbbc8b2c"><div class="ttname"><a href="classTaskTestHarness.html#a34722547f18a938d8f44c28bcbbc8b2c">TaskTestHarness::SetNumCores</a></div><div class="ttdeci">void SetNumCores(size_t num_cores)</div><div class="ttdoc">设置测试使用的核心数量（在 SetUp 前调用）</div><div class="ttdef"><b>Definition</b> <a href="task__test__harness_8hpp_source.html#l00027">task_test_harness.hpp:27</a></div></div>
<div class="ttc" id="aclassTaskTestHarness_html_a9b21a4be72464267c2d3059fa165ca6d"><div class="ttname"><a href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">TaskTestHarness::SetUp</a></div><div class="ttdeci">void SetUp() override</div><div class="ttdef"><b>Definition</b> <a href="task__test__harness_8cpp_source.html#l00013">task_test_harness.cpp:13</a></div></div>
<div class="ttc" id="aclassTaskTestHarness_html_abd7a9b94b9049521896e423224471840"><div class="ttname"><a href="classTaskTestHarness.html#abd7a9b94b9049521896e423224471840">TaskTestHarness::num_cores_</a></div><div class="ttdeci">size_t num_cores_</div><div class="ttdef"><b>Definition</b> <a href="task__test__harness_8hpp_source.html#l00036">task_test_harness.hpp:36</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md487"></a>
使用示例</h1>
<h2><a class="anchor" id="autotoc_md488"></a>
单核测试</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>SingleCoreSchedulerTest : <span class="keyword">public</span> <a class="code hl_class" href="classTaskTestHarness.html">TaskTestHarness</a> {</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">SetUp</a>()<span class="keyword"> override </span>{</div>
<div class="line">    <a class="code hl_function" href="classTaskTestHarness.html#a34722547f18a938d8f44c28bcbbc8b2c">SetNumCores</a>(1);  <span class="comment">// 单核</span></div>
<div class="line">    <a class="code hl_function" href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">TaskTestHarness::SetUp</a>();</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="kernel__fdt__test_8cpp.html#a3ad49ba9a2026e9c2c37e5cc99c307c4">TEST_F</a>(SingleCoreSchedulerTest, RoundRobinScheduling) {</div>
<div class="line">  <span class="keyword">auto</span>&amp; env = GetEnvironmentState();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 创建任务...</span></div>
<div class="line">  <span class="comment">// 运行调度器...</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 验证切换历史</span></div>
<div class="line">  <span class="keyword">auto</span> history = env.GetAllSwitchHistory();</div>
<div class="line">  ASSERT_EQ(history.size(), expected_switches);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 验证切换顺序</span></div>
<div class="line">  <a class="code hl_define" href="system__test_8h.html#abfc1b6826e51b93338e02cabfa5cfcd1">EXPECT_EQ</a>(history[0].from, task1);</div>
<div class="line">  <a class="code hl_define" href="system__test_8h.html#abfc1b6826e51b93338e02cabfa5cfcd1">EXPECT_EQ</a>(history[0].to, task2);</div>
<div class="line">}</div>
<div class="ttc" id="akernel__fdt__test_8cpp_html_a3ad49ba9a2026e9c2c37e5cc99c307c4"><div class="ttname"><a href="kernel__fdt__test_8cpp.html#a3ad49ba9a2026e9c2c37e5cc99c307c4">TEST_F</a></div><div class="ttdeci">TEST_F(KernelFdtTest, ConstructorTest)</div><div class="ttdef"><b>Definition</b> <a href="kernel__fdt__test_8cpp_source.html#l00025">kernel_fdt_test.cpp:25</a></div></div>
<div class="ttc" id="asystem__test_8h_html_abfc1b6826e51b93338e02cabfa5cfcd1"><div class="ttname"><a href="system__test_8h.html#abfc1b6826e51b93338e02cabfa5cfcd1">EXPECT_EQ</a></div><div class="ttdeci">#define EXPECT_EQ(val1, val2, msg)</div><div class="ttdef"><b>Definition</b> <a href="system__test_8h_source.html#l00102">system_test.h:102</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md489"></a>
多核测试</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>MultiCoreSchedulerTest : <span class="keyword">public</span> <a class="code hl_class" href="classTaskTestHarness.html">TaskTestHarness</a> {</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">SetUp</a>()<span class="keyword"> override </span>{</div>
<div class="line">    <a class="code hl_function" href="classTaskTestHarness.html#a34722547f18a938d8f44c28bcbbc8b2c">SetNumCores</a>(4);  <span class="comment">// 四核</span></div>
<div class="line">    <a class="code hl_function" href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">TaskTestHarness::SetUp</a>();</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="kernel__fdt__test_8cpp.html#a3ad49ba9a2026e9c2c37e5cc99c307c4">TEST_F</a>(MultiCoreSchedulerTest, LoadBalancing) {</div>
<div class="line">  <span class="keyword">auto</span>&amp; env = GetEnvironmentState();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 创建多个工作线程模拟多核</span></div>
<div class="line">  std::vector&lt;std::thread&gt; workers;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; 4; ++i) {</div>
<div class="line">    workers.emplace_back([&amp;env, i]() {</div>
<div class="line">      <span class="comment">// 绑定到指定核心</span></div>
<div class="line">      env.BindThreadToCore(std::this_thread::get_id(), i);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// 运行调度器...</span></div>
<div class="line">    });</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 等待所有线程完成</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; t : workers) {</div>
<div class="line">    t.join();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 验证各核心的负载</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; 4; ++i) {</div>
<div class="line">    <span class="keyword">auto</span>&amp; core = env.GetCore(i);</div>
<div class="line">    <a class="code hl_define" href="system__test_8h.html#aab850358cd9bdeb95d390ab0918461da">EXPECT_GT</a>(core.total_switches, 0);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="asystem__test_8h_html_aab850358cd9bdeb95d390ab0918461da"><div class="ttname"><a href="system__test_8h.html#aab850358cd9bdeb95d390ab0918461da">EXPECT_GT</a></div><div class="ttdeci">#define EXPECT_GT(val1, val2, msg)</div><div class="ttdef"><b>Definition</b> <a href="system__test_8h_source.html#l00112">system_test.h:112</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md490"></a>
验证中断状态</h2>
<div class="fragment"><div class="line"><a class="code hl_function" href="kernel__fdt__test_8cpp.html#a3ad49ba9a2026e9c2c37e5cc99c307c4">TEST_F</a>(<a class="code hl_class" href="classTaskTestHarness.html">TaskTestHarness</a>, InterruptDisabledDuringSwitch) {</div>
<div class="line">  <span class="keyword">auto</span>&amp; env = GetEnvironmentState();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 在任务切换前禁用中断</span></div>
<div class="line">  <a class="code hl_function" href="namespacecpu__io.html#a6c4ee629d8129247969cace77d47fecb">cpu_io::DisableInterrupt</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 执行切换...</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 验证环境层状态</span></div>
<div class="line">  <span class="keyword">auto</span>&amp; core = env.GetCurrentCoreEnv();</div>
<div class="line">  <a class="code hl_define" href="system__test_8h.html#aa627ee666d1479db9959f3423adc3549">EXPECT_FALSE</a>(core.interrupt_enabled);</div>
<div class="line">}</div>
<div class="ttc" id="asystem__test_8h_html_aa627ee666d1479db9959f3423adc3549"><div class="ttname"><a href="system__test_8h.html#aa627ee666d1479db9959f3423adc3549">EXPECT_FALSE</a></div><div class="ttdeci">#define EXPECT_FALSE(cond, msg)</div><div class="ttdef"><b>Definition</b> <a href="system__test_8h_source.html#l00133">system_test.h:133</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md491"></a>
验证页表切换</h2>
<div class="fragment"><div class="line"><a class="code hl_function" href="kernel__fdt__test_8cpp.html#a3ad49ba9a2026e9c2c37e5cc99c307c4">TEST_F</a>(<a class="code hl_class" href="classTaskTestHarness.html">TaskTestHarness</a>, PageTableSwitching) {</div>
<div class="line">  <span class="keyword">auto</span>&amp; env = GetEnvironmentState();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> uint64_t task1_pd = 0x1000;</div>
<div class="line">  <span class="keyword">const</span> uint64_t task2_pd = 0x2000;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 设置任务1的页表</span></div>
<div class="line">  <a class="code hl_function" href="namespacecpu__io_1_1virtual__memory.html#a34641ac6c78b4598532a2d089c1357b2">cpu_io::virtual_memory::SetPageDirectory</a>(task1_pd);</div>
<div class="line">  <a class="code hl_define" href="system__test_8h.html#abfc1b6826e51b93338e02cabfa5cfcd1">EXPECT_EQ</a>(env.GetCurrentCoreEnv().page_directory, task1_pd);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 切换到任务2并设置其页表</span></div>
<div class="line">  <a class="code hl_function" href="namespacecpu__io_1_1virtual__memory.html#a34641ac6c78b4598532a2d089c1357b2">cpu_io::virtual_memory::SetPageDirectory</a>(task2_pd);</div>
<div class="line">  <a class="code hl_define" href="system__test_8h.html#abfc1b6826e51b93338e02cabfa5cfcd1">EXPECT_EQ</a>(env.GetCurrentCoreEnv().page_directory, task2_pd);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md492"></a>
关键优势</h1>
<ol type="1">
<li><b>职责分离</b>: 环境层、Mock层、测试层各司其职，易于维护</li>
<li><b>可观测性</b>: 所有硬件状态和切换历史都被记录，便于调试</li>
<li><b>易于扩展</b>: 需要模拟新特性时只需扩展 <code>CoreEnvironment</code></li>
<li><b>线程安全</b>: 使用互斥锁保护共享数据</li>
<li><b>测试隔离</b>: 每个测试的 SetUp/TearDown 确保状态独立</li>
</ol>
<h1><a class="anchor" id="autotoc_md493"></a>
扩展点</h1>
<h2><a class="anchor" id="autotoc_md494"></a>
添加新的硬件特性</h2>
<p>例如添加 TLB 模拟：</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>CoreEnvironment {</div>
<div class="line">  <span class="comment">// ... 现有字段 ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// TLB 模拟</span></div>
<div class="line">  std::unordered_map&lt;uint64_t, uint64_t&gt; tlb_cache;  <span class="comment">// VA -&gt; PA</span></div>
<div class="line">  <span class="keywordtype">size_t</span> tlb_hits = 0;</div>
<div class="line">  <span class="keywordtype">size_t</span> tlb_misses = 0;</div>
<div class="line">};</div>
</div><!-- fragment --><p>在 Mock 层添加对应接口：</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacecpu__io_1_1virtual__memory.html">cpu_io::virtual_memory</a> {</div>
<div class="line">  <span class="keyword">inline</span> <span class="keywordtype">void</span> FlushTLB(uint64_t va) {</div>
<div class="line">    <span class="keyword">auto</span>&amp; core = test_env::TestEnvironmentState::GetInstance()</div>
<div class="line">        .GetCurrentCoreEnv();</div>
<div class="line">    core.tlb_cache.erase(va);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="anamespacecpu__io_1_1virtual__memory_html"><div class="ttname"><a href="namespacecpu__io_1_1virtual__memory.html">cpu_io::virtual_memory</a></div><div class="ttdef"><b>Definition</b> <a href="cpu__io_8h_source.html#l00055">cpu_io.h:55</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md495"></a>
添加性能计数器</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>CoreEnvironment {</div>
<div class="line">  <span class="keyword">struct </span>PerfCounters {</div>
<div class="line">    uint64_t instructions_executed = 0;</div>
<div class="line">    uint64_t cache_misses = 0;</div>
<div class="line">    uint64_t branch_mispredictions = 0;</div>
<div class="line">  } perf_counters;</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md496"></a>
注意事项</h1>
<ol type="1">
<li><b>上下文注册</b>: 创建任务时需要调用 <code>RegisterTaskContext</code> 将任务上下文注册到环境层</li>
<li><b>线程绑定</b>: 多核测试时每个工作线程都需要显式绑定到核心</li>
<li><b>状态重置</b>: 每个测试结束后环境层会自动重置，无需手动清理</li>
<li><b>线程安全</b>: 所有环境层接口都是线程安全的，可以在多线程环境中使用</li>
</ol>
<h1><a class="anchor" id="autotoc_md497"></a>
文件清单</h1>
<ul>
<li><code><a class="el" href="test__environment__state_8hpp.html">mocks/test_environment_state.hpp</a></code> - 环境层头文件</li>
<li><code><a class="el" href="test__environment__state_8cpp.html">mocks/test_environment_state.cpp</a></code> - 环境层实现</li>
<li><code><a class="el" href="cpu__io_8h.html">mocks/cpu_io.h</a></code> - Mock 层硬件接口</li>
<li><code>mocks/arch_mock.cpp</code> - Mock 层架构函数</li>
<li><code><a class="el" href="task__test__harness_8hpp.html">task/fixtures/task_test_harness.hpp</a></code> - 测试 Fixture 基类头文件</li>
<li><code><a class="el" href="task__test__harness_8cpp.html">task/fixtures/task_test_harness.cpp</a></code> - 测试 Fixture 基类实现</li>
<li><code><a class="el" href="example__environment__test_8cpp.html">task/example_environment_test.cpp</a></code> - 环境层功能测试示例 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
