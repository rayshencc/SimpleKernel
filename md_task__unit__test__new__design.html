<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: Task 模块 Unit Test 设计（精简版）</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_task__unit__test__new__design.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Task 模块 Unit Test 设计（精简版）</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md253"></a> </p>
<h1><a class="anchor" id="autotoc_md254"></a>
1. 目标</h1>
<p>1) 支持单核/多核调度测试。 2) 每个测试独立、无全局污染。 3) 处理死循环 <code>while(1) <a class="el" href="namespacecpu__io.html#acf7d7c3a4a0720cfd4f57914b52c7e9b">cpu_io::Pause()</a></code>。 4) 使用 <code>std::thread</code> 模拟核心。 5) 最小化 Mock，尽量复用现有 <code>TaskManager/PerCpu/Scheduler</code>。</p>
<h1><a class="anchor" id="autotoc_md255"></a>
2. 架构</h1>
<p>三层结构，职责清晰： 1) <code><a class="el" href="classTaskTestHarness.html" title="Task 模块单元测试的基类 Fixture.">TaskTestHarness</a></code>（Fixture）：统一 SetUp/TearDown，重置全局状态。 2) <code>TaskTestEnvironment</code>：管理多核线程、任务创建、等待条件。 3) <code>SchedulingWorker</code>：每核一个线程，循环调用 <code>Schedule()</code>/<code>TickUpdate()</code>。</p>
<p>依赖现有：<code><a class="el" href="classTaskManager.html" title="任务管理器">TaskManager</a></code>、<code>PerCpu</code>、<code><a class="el" href="classFifoScheduler.html" title="先来先服务 (FIFO) 调度器">FifoScheduler</a></code>、<code><a class="el" href="classRoundRobinScheduler.html" title="Round-Robin 调度器">RoundRobinScheduler</a></code>、<code><a class="el" href="classIdleScheduler.html" title="Idle 调度器">IdleScheduler</a></code>。 Mock 仅覆盖架构相关接口与核心 ID 映射。</p>
<h1><a class="anchor" id="autotoc_md256"></a>
3. 关键机制</h1>
<h2><a class="anchor" id="autotoc_md257"></a>
3.1 测试隔离</h2>
<p><code><a class="el" href="classTaskTestHarness.html#a9b21a4be72464267c2d3059fa165ca6d">TaskTestHarness::SetUp()</a></code> 完成：</p><ul>
<li>重置 <code><a class="el" href="classTaskManager.html" title="任务管理器">TaskManager</a></code>（新增 <code>ResetForTesting()</code>）</li>
<li>清理 PID 分配器与全局任务表</li>
<li>重置 <code>PerCpu</code> 数组</li>
<li>重新初始化测试环境</li>
</ul>
<h2><a class="anchor" id="autotoc_md258"></a>
3.2 多核支持与亲和性</h2>
<ul>
<li><code>MockCoreManager</code> 管理线程→核心 ID 映射。 <code><a class="el" href="namespacecpu__io.html#a52b8a7263a31e6670ef4dec7922d9e72">cpu_io::GetCurrentCoreId()</a></code> 从这里取值。</li>
<li><code>TaskTestEnvironment::AddTask()</code>：<ul>
<li>若 <code>task-&gt;cpu_affinity</code> 指定，放入允许的核心（可选择负载最低核心）。</li>
<li>若未指定，按各核心队列长度/负载均衡选择。</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md259"></a>
3.3 &lt;tt&gt;switch_to&lt;/tt&gt; 处理（架构无关）</h2>
<p>单测中不依赖汇编实现，提供“软切换”测试桩：</p><ul>
<li>记录切换事件（from/to/时间戳）。</li>
<li>更新 <code>per_cpu::running_task</code>。</li>
<li>不执行真实栈切换。 调度逻辑仍由 <code><a class="el" href="classTaskManager.html#af7525954e852c09c1dd8ba50235f1d78" title="调度函数 选择下一个任务并切换上下文">TaskManager::Schedule()</a></code> 真实执行，因此可验证调度策略。</li>
</ul>
<h2><a class="anchor" id="autotoc_md260"></a>
3.4 超时保护（避免死循环）</h2>
<p><code>TimeoutGuard</code> 在 4 秒内监控测试：</p><ul>
<li>超时仅设置原子标志并停止调度线程（不直接调用 GTest 失败）。</li>
<li>主线程检查 <code>IsTimeout()</code> 并决定失败。</li>
</ul>
<h1><a class="anchor" id="autotoc_md261"></a>
4. 文件结构（最小集）</h1>
<p><code>tests/unit_test/task/</code></p><ul>
<li><code>fixtures/</code>：<code>task_test_harness.*</code>, <code>task_test_environment.*</code>, <code>scheduling_worker.*</code>, <code>mock_core_manager.*</code>, <code>timeout_guard.*</code></li>
<li><code>unit_tests/</code>：调度器、生命周期、多核、阻塞/唤醒等测试</li>
</ul>
<h1><a class="anchor" id="autotoc_md262"></a>
5. 必要的最小改动</h1>
<p>1) <code>TaskManager::ResetForTesting()</code>：清空调度器、任务表、统计信息。 2) <code><a class="el" href="structTaskControlBlock.html" title="任务控制块，管理进程/线程的核心数据结构">TaskControlBlock</a></code> 可选提供便捷构造（便于测试创建任务）。 3) 单测目标链接测试桩版 <code>switch_to</code>（不走架构汇编）。</p>
<h1><a class="anchor" id="autotoc_md263"></a>
6. 典型测试覆盖</h1>
<ul>
<li>单核：RR/FIFO 时间片与顺序。</li>
<li>多核：负载均衡与亲和性。</li>
<li>状态：Ready→Running→Blocked/Sleeping→Ready。</li>
<li>异常：超时处理、死锁/无限循环检测。</li>
</ul>
<h1><a class="anchor" id="autotoc_md264"></a>
7. 为什么这样做</h1>
<ul>
<li>调度逻辑真实运行，Mock 最少。</li>
<li>代码量小、职责清晰、维护成本低。</li>
<li>多核与异常场景可复现且可控。 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
