<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: /root/src/include/syscall.hpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('syscall_8hpp.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">syscall.hpp File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;<a class="el" href="cpu__io_8h_source.html">cpu_io.h</a>&gt;</code><br />
<code>#include &lt;cstddef&gt;</code><br />
<code>#include &lt;cstdint&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for syscall.hpp:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp__incl.png" border="0" usemap="#a_2root_2src_2include_2syscall_8hpp" alt=""/></div>
<map name="a_2root_2src_2include_2syscall_8hpp" id="a_2root_2src_2include_2syscall_8hpp">
<area shape="rect" title=" " alt="" coords="243,5,446,31"/>
<area shape="rect" href="cpu__io_8h.html" title=" " alt="" coords="307,79,383,104"/>
<area shape="poly" title=" " alt="" coords="347,31,347,65,342,65,342,31"/>
<area shape="rect" title=" " alt="" coords="5,225,76,251"/>
<area shape="poly" title=" " alt="" coords="269,33,212,48,151,72,94,106,69,128,48,153,42,167,38,182,38,212,33,212,33,181,37,165,44,151,65,125,91,102,149,67,210,43,267,28"/>
<area shape="rect" title=" " alt="" coords="641,225,707,251"/>
<area shape="poly" title=" " alt="" coords="383,28,433,46,494,73,558,107,617,150,644,180,664,211,660,214,640,183,614,154,555,112,491,77,431,51,381,33"/>
<area shape="rect" title=" " alt="" coords="78,152,145,177"/>
<area shape="poly" title=" " alt="" coords="308,107,159,152,157,147,306,101"/>
<area shape="rect" title=" " alt="" coords="169,152,238,177"/>
<area shape="poly" title=" " alt="" coords="323,106,240,148,237,143,321,102"/>
<area shape="poly" title=" " alt="" coords="307,99,174,117,110,133,85,143,68,154,58,166,51,181,44,212,39,211,46,179,53,164,64,150,82,138,108,128,173,112,306,93"/>
<area shape="poly" title=" " alt="" coords="383,94,476,111,530,127,582,150,624,180,657,213,654,216,621,184,579,154,528,132,475,116,382,99"/>
<area shape="rect" title=" " alt="" coords="465,225,529,251"/>
<area shape="poly" title=" " alt="" coords="383,90,420,94,461,103,500,121,518,134,532,151,538,167,536,184,519,215,515,213,531,183,533,167,528,153,514,138,498,126,459,108,419,99,382,95"/>
<area shape="rect" title=" " alt="" coords="553,225,617,251"/>
<area shape="poly" title=" " alt="" coords="383,91,423,95,468,105,514,123,555,150,574,179,584,211,579,212,569,182,551,154,512,127,467,110,422,101,383,96"/>
<area shape="rect" title=" " alt="" coords="219,225,343,251"/>
<area shape="poly" title=" " alt="" coords="336,106,319,127,303,153,293,183,286,212,281,211,287,182,298,151,315,124,332,102"/>
<area shape="rect" href="test__environment__state_8hpp.html" title=" " alt="" coords="313,152,518,177"/>
<area shape="poly" title=" " alt="" coords="358,102,396,140,392,144,354,106"/>
<area shape="poly" title=" " alt="" coords="356,180,90,230,89,225,355,175"/>
<area shape="poly" title=" " alt="" coords="458,175,628,221,627,227,456,180"/>
<area shape="poly" title=" " alt="" coords="430,175,475,214,471,218,427,179"/>
<area shape="poly" title=" " alt="" coords="444,175,545,217,543,222,442,180"/>
<area shape="poly" title=" " alt="" coords="395,180,316,221,314,216,392,175"/>
<area shape="rect" title=" " alt="" coords="377,225,440,251"/>
<area shape="poly" title=" " alt="" coords="417,178,414,212,408,212,412,177"/>
</map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp__dep__incl.png" border="0" usemap="#a_2root_2src_2include_2syscall_8hppdep" alt=""/></div>
<map name="a_2root_2src_2include_2syscall_8hppdep" id="a_2root_2src_2include_2syscall_8hppdep">
<area shape="rect" title=" " alt="" coords="1171,5,1373,31"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html" title=" " alt="" coords="5,86,168,126"/>
<area shape="poly" title=" " alt="" coords="1157,25,648,44,377,61,266,70,180,81,147,89,146,83,180,76,265,65,377,55,647,39,1157,20"/>
<area shape="rect" href="riscv64_2interrupt__main_8cpp.html" title=" " alt="" coords="193,86,351,126"/>
<area shape="poly" title=" " alt="" coords="1157,22,999,25,801,34,582,51,363,81,331,88,330,83,362,76,581,46,800,28,999,19,1157,16"/>
<area shape="rect" href="arch_2riscv64_2syscall_8cpp.html" title=" " alt="" coords="375,86,534,126"/>
<area shape="poly" title=" " alt="" coords="1157,24,1030,30,877,40,711,57,546,81,514,89,513,83,545,76,710,51,877,35,1030,24,1156,19"/>
<area shape="rect" href="arch_2x86__64_2syscall_8cpp.html" title=" " alt="" coords="558,86,693,126"/>
<area shape="poly" title=" " alt="" coords="1157,27,946,44,825,60,706,81,679,88,677,83,705,76,824,55,945,39,1157,22"/>
<area shape="rect" href="src_2main_8cpp.html" title=" " alt="" coords="717,93,856,119"/>
<area shape="poly" title=" " alt="" coords="1157,34,1019,53,869,81,819,96,817,91,867,76,1018,48,1157,29"/>
<area shape="rect" href="syscall_8cpp.html" title=" " alt="" coords="881,93,1031,119"/>
<area shape="poly" title=" " alt="" coords="1213,37,1043,81,994,96,992,91,1042,76,1212,31"/>
<area shape="rect" href="clone__system__test_8cpp.html" title=" " alt="" coords="1055,86,1262,126"/>
<area shape="poly" title=" " alt="" coords="1248,41,1185,88,1182,84,1244,37"/>
<area shape="rect" href="exit__system__test_8cpp.html" title=" " alt="" coords="1287,86,1484,126"/>
<area shape="poly" title=" " alt="" coords="1300,37,1362,84,1359,88,1296,41"/>
<area shape="rect" href="kernel__task__test_8cpp.html" title=" " alt="" coords="1508,86,1700,126"/>
<area shape="poly" title=" " alt="" coords="1330,32,1532,83,1531,89,1329,37"/>
<area shape="rect" href="tests_2system__test_2main_8cpp.html" title=" " alt="" coords="1725,86,1865,126"/>
<area shape="poly" title=" " alt="" coords="1387,27,1542,46,1713,76,1740,83,1739,88,1711,81,1542,51,1386,32"/>
<area shape="rect" href="mutex__test_8cpp.html" title=" " alt="" coords="1889,86,2047,126"/>
<area shape="poly" title=" " alt="" coords="1387,22,1615,39,1747,55,1878,76,1909,83,1908,89,1877,81,1746,60,1614,45,1387,27"/>
<area shape="rect" href="thread__group__system__test_8cpp.html" title=" " alt="" coords="2071,79,2270,133"/>
<area shape="poly" title=" " alt="" coords="1388,20,1693,36,1877,53,2060,76,2072,78,2071,83,2060,81,1876,58,1692,42,1387,25"/>
<area shape="rect" href="user__task__test_8cpp.html" title=" " alt="" coords="2294,86,2474,126"/>
<area shape="poly" title=" " alt="" coords="1387,16,1561,19,1785,28,2034,46,2160,59,2283,76,2319,83,2318,88,2282,81,2159,64,2033,51,1785,33,1561,24,1387,22"/>
<area shape="rect" href="wait__system__test_8cpp.html" title=" " alt="" coords="2499,86,2699,126"/>
<area shape="poly" title=" " alt="" coords="1387,15,1594,17,1868,24,2176,43,2333,57,2487,76,2527,83,2526,89,2486,81,2333,63,2176,48,1868,30,1594,22,1387,21"/>
</map>
</div>
</div>
<p><a href="syscall_8hpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a754e3c00eb93be17daa96d00a12bc447" id="r_a754e3c00eb93be17daa96d00a12bc447"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a754e3c00eb93be17daa96d00a12bc447">Syscall</a> (uint64_t cause, <a class="el" href="structcpu__io_1_1TrapContext.html">cpu_io::TrapContext</a> *context)</td></tr>
<tr class="separator:a754e3c00eb93be17daa96d00a12bc447"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9c01f57bb4ef6f1b91ccce212494a199" id="r_a9c01f57bb4ef6f1b91ccce212494a199"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a9c01f57bb4ef6f1b91ccce212494a199">syscall_dispatcher</a> (int64_t syscall_id, uint64_t args[6])</td></tr>
<tr class="separator:a9c01f57bb4ef6f1b91ccce212494a199"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4fa66935c10e294006b6310af1c68f37" id="r_a4fa66935c10e294006b6310af1c68f37"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a4fa66935c10e294006b6310af1c68f37">sys_write</a> (int fd, const char *buf, size_t len)</td></tr>
<tr class="memdesc:a4fa66935c10e294006b6310af1c68f37"><td class="mdescLeft">&#160;</td><td class="mdescRight">向文件描述符写入数据  <br /></td></tr>
<tr class="separator:a4fa66935c10e294006b6310af1c68f37"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a34c7946fbbdfb071d2b453a745dcb9b4" id="r_a34c7946fbbdfb071d2b453a745dcb9b4"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a34c7946fbbdfb071d2b453a745dcb9b4">sys_exit</a> (int code)</td></tr>
<tr class="memdesc:a34c7946fbbdfb071d2b453a745dcb9b4"><td class="mdescLeft">&#160;</td><td class="mdescRight">退出当前进程或线程  <br /></td></tr>
<tr class="separator:a34c7946fbbdfb071d2b453a745dcb9b4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a23ac80734740f098e56332da33758ace" id="r_a23ac80734740f098e56332da33758ace"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a23ac80734740f098e56332da33758ace">sys_yield</a> ()</td></tr>
<tr class="memdesc:a23ac80734740f098e56332da33758ace"><td class="mdescLeft">&#160;</td><td class="mdescRight">主动放弃CPU，让出时间片  <br /></td></tr>
<tr class="separator:a23ac80734740f098e56332da33758ace"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a83d46a7afcd47f11ed83ae871d058d20" id="r_a83d46a7afcd47f11ed83ae871d058d20"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a83d46a7afcd47f11ed83ae871d058d20">sys_sleep</a> (uint64_t ms)</td></tr>
<tr class="memdesc:a83d46a7afcd47f11ed83ae871d058d20"><td class="mdescLeft">&#160;</td><td class="mdescRight">休眠指定毫秒数  <br /></td></tr>
<tr class="separator:a83d46a7afcd47f11ed83ae871d058d20"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6d9ce836fd264a98548781886f375d2a" id="r_a6d9ce836fd264a98548781886f375d2a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a6d9ce836fd264a98548781886f375d2a">sys_clone</a> (uint64_t <a class="el" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a>, void *stack, int *parent_tid, int *child_tid, void *tls)</td></tr>
<tr class="memdesc:a6d9ce836fd264a98548781886f375d2a"><td class="mdescLeft">&#160;</td><td class="mdescRight">创建新线程（或进程）  <br /></td></tr>
<tr class="separator:a6d9ce836fd264a98548781886f375d2a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a01fbd4b45143dd51bf6f338d8ee325da" id="r_a01fbd4b45143dd51bf6f338d8ee325da"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a01fbd4b45143dd51bf6f338d8ee325da">sys_fork</a> ()</td></tr>
<tr class="memdesc:a01fbd4b45143dd51bf6f338d8ee325da"><td class="mdescLeft">&#160;</td><td class="mdescRight">创建新进程（fork）  <br /></td></tr>
<tr class="separator:a01fbd4b45143dd51bf6f338d8ee325da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a17717d9e7bc25b272fe4dbb63bc52baa" id="r_a17717d9e7bc25b272fe4dbb63bc52baa"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a17717d9e7bc25b272fe4dbb63bc52baa">sys_gettid</a> ()</td></tr>
<tr class="memdesc:a17717d9e7bc25b272fe4dbb63bc52baa"><td class="mdescLeft">&#160;</td><td class="mdescRight">获取当前线程ID  <br /></td></tr>
<tr class="separator:a17717d9e7bc25b272fe4dbb63bc52baa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab5c00759c95d8ce9e9db75b1b55a9552" id="r_ab5c00759c95d8ce9e9db75b1b55a9552"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#ab5c00759c95d8ce9e9db75b1b55a9552">sys_set_tid_address</a> (int *tidptr)</td></tr>
<tr class="memdesc:ab5c00759c95d8ce9e9db75b1b55a9552"><td class="mdescLeft">&#160;</td><td class="mdescRight">设置线程ID地址（用于线程退出时的清理）  <br /></td></tr>
<tr class="separator:ab5c00759c95d8ce9e9db75b1b55a9552"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa03f906affa67ef23ebfbcb79efa569f" id="r_aa03f906affa67ef23ebfbcb79efa569f"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#aa03f906affa67ef23ebfbcb79efa569f">sys_futex</a> (int *uaddr, int op, int val, const void *timeout, int *uaddr2, int val3)</td></tr>
<tr class="memdesc:aa03f906affa67ef23ebfbcb79efa569f"><td class="mdescLeft">&#160;</td><td class="mdescRight">快速用户空间互斥锁操作（futex）  <br /></td></tr>
<tr class="separator:aa03f906affa67ef23ebfbcb79efa569f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4dd37ef811b362b4638eb21fab7f09fc" id="r_a4dd37ef811b362b4638eb21fab7f09fc"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#a4dd37ef811b362b4638eb21fab7f09fc">sys_sched_getaffinity</a> (int pid, size_t cpusetsize, uint64_t *mask)</td></tr>
<tr class="memdesc:a4dd37ef811b362b4638eb21fab7f09fc"><td class="mdescLeft">&#160;</td><td class="mdescRight">获取线程的CPU亲和性  <br /></td></tr>
<tr class="separator:a4dd37ef811b362b4638eb21fab7f09fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afc0c058ad3c8a4b5746d97c2f49b97a4" id="r_afc0c058ad3c8a4b5746d97c2f49b97a4"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="syscall_8hpp.html#afc0c058ad3c8a4b5746d97c2f49b97a4">sys_sched_setaffinity</a> (int pid, size_t cpusetsize, const uint64_t *mask)</td></tr>
<tr class="memdesc:afc0c058ad3c8a4b5746d97c2f49b97a4"><td class="mdescLeft">&#160;</td><td class="mdescRight">设置线程的CPU亲和性  <br /></td></tr>
<tr class="separator:afc0c058ad3c8a4b5746d97c2f49b97a4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a6d9ce836fd264a98548781886f375d2a" name="a6d9ce836fd264a98548781886f375d2a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6d9ce836fd264a98548781886f375d2a">&#9670;&#160;</a></span>sys_clone()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_clone </td>
          <td>(</td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>stack</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>parent_tid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>child_tid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>tls</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>创建新线程（或进程） </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">flags</td><td>克隆标志（CLONE_VM、CLONE_THREAD、CLONE_SIGHAND 等） </td></tr>
    <tr><td class="paramname">stack</td><td>新线程的栈指针（用户空间） </td></tr>
    <tr><td class="paramname">parent_tid</td><td>父线程TID存储地址（可选） </td></tr>
    <tr><td class="paramname">child_tid</td><td>子线程TID存储地址（可选） </td></tr>
    <tr><td class="paramname">tls</td><td>线程本地存储指针 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>成功返回新线程TID，失败返回负数 </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：<ul>
<li>pthread_create 底层实现</li>
<li>fork() 实现（不带 CLONE_VM）</li>
<li><p class="startli">创建轻量级线程</p>
<p class="startli">flags 常用组合：</p><ul>
<li>CLONE_VM | CLONE_THREAD | CLONE_SIGHAND: 创建共享地址空间的线程</li>
<li>0: 创建独立进程（类似 fork） </li>
</ul>
</li>
</ul>
</dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00087">87</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   88</span>                         {</div>
<div class="line"><span class="lineno">   89</span>  <span class="keyword">auto</span>&amp; task_manager = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>();</div>
<div class="line"><span class="lineno">   90</span>  <span class="keyword">auto</span> current = task_manager.GetCurrentTask();</div>
<div class="line"><span class="lineno">   91</span> </div>
<div class="line"><span class="lineno">   92</span>  <span class="keywordflow">if</span> (!current || !current-&gt;trap_context_ptr) {</div>
<div class="line"><span class="lineno">   93</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] sys_clone: Invalid current task or trap context\n&quot;</span>);</div>
<div class="line"><span class="lineno">   94</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">   95</span>  }</div>
<div class="line"><span class="lineno">   96</span> </div>
<div class="line"><span class="lineno">   97</span>  <span class="comment">// 调用 TaskManager 的 Clone 方法</span></div>
<div class="line"><span class="lineno">   98</span>  <span class="keyword">auto</span> result = task_manager.Clone(<a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a>, stack, parent_tid, child_tid, tls,</div>
<div class="line"><span class="lineno">   99</span>                                   *current-&gt;trap_context_ptr);</div>
<div class="line"><span class="lineno">  100</span> </div>
<div class="line"><span class="lineno">  101</span>  <span class="keywordflow">if</span> (!result.has_value()) {</div>
<div class="line"><span class="lineno">  102</span>    <span class="comment">// 失败返回 -1</span></div>
<div class="line"><span class="lineno">  103</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] sys_clone failed: %s\n&quot;</span>, result.error().message());</div>
<div class="line"><span class="lineno">  104</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  105</span>  }</div>
<div class="line"><span class="lineno">  106</span> </div>
<div class="line"><span class="lineno">  107</span>  <a class="code hl_typedef" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> child_pid = result.value();</div>
<div class="line"><span class="lineno">  108</span>  <span class="keywordflow">if</span> (child_pid == 0) {</div>
<div class="line"><span class="lineno">  109</span>    <span class="comment">// 子进程/线程返回 0</span></div>
<div class="line"><span class="lineno">  110</span>    <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  111</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  112</span>    <span class="comment">// 父进程返回子进程 PID</span></div>
<div class="line"><span class="lineno">  113</span>    <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(child_pid);</div>
<div class="line"><span class="lineno">  114</span>  }</div>
<div class="line"><span class="lineno">  115</span>}</div>
<div class="ttc" id="aacpi_8h_html_a773b39d480759f67926cb18ae2219281"><div class="ttname"><a href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a></div><div class="ttdeci">uint32_t flags</div><div class="ttdef"><b>Definition</b> <a href="acpi_8h_source.html#l00038">acpi.h:38</a></div></div>
<div class="ttc" id="aclassSingleton_html_a68856b49e098eadba37b60366db33ebd"><div class="ttname"><a href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton::GetInstance</a></div><div class="ttdeci">static auto GetInstance() -&gt; T &amp;</div><div class="ttdef"><b>Definition</b> <a href="singleton_8hpp_source.html#l00023">singleton.hpp:23</a></div></div>
<div class="ttc" id="astructklog_1_1Err_html"><div class="ttname"><a href="structklog_1_1Err.html">klog::Err</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00188">kernel_log.hpp:188</a></div></div>
<div class="ttc" id="atask__control__block_8hpp_html_a7b3497faea769e764efc8647bc2103f1"><div class="ttname"><a href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a></div><div class="ttdeci">size_t Pid</div><div class="ttdoc">进程 ID 类型</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00017">task_control_block.hpp:17</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a6d9ce836fd264a98548781886f375d2a_cgraph.png" border="0" usemap="#asyscall_8hpp_a6d9ce836fd264a98548781886f375d2a_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a6d9ce836fd264a98548781886f375d2a_cgraph" id="asyscall_8hpp_a6d9ce836fd264a98548781886f375d2a_cgraph">
<area shape="rect" title="创建新线程（或进程）" alt="" coords="5,5,92,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="140,5,309,31"/>
<area shape="poly" title=" " alt="" coords="92,15,126,15,126,21,92,21"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a6d9ce836fd264a98548781886f375d2a_icgraph.png" border="0" usemap="#asyscall_8hpp_a6d9ce836fd264a98548781886f375d2a_icgraph" alt=""/></div>
<map name="asyscall_8hpp_a6d9ce836fd264a98548781886f375d2a_icgraph" id="asyscall_8hpp_a6d9ce836fd264a98548781886f375d2a_icgraph">
<area shape="rect" title="创建新线程（或进程）" alt="" coords="312,5,399,31"/>
<area shape="rect" href="syscall_8cpp.html#a9c01f57bb4ef6f1b91ccce212494a199" title=" " alt="" coords="121,5,264,31"/>
<area shape="poly" title=" " alt="" coords="298,21,264,21,264,15,298,15"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html#a27f252437c17e7b5d2e8aef749daf1f0" title=" " alt="" coords="5,5,73,31"/>
<area shape="poly" title=" " alt="" coords="108,21,74,21,74,15,108,15"/>
</map>
</div>

</div>
</div>
<a id="a34c7946fbbdfb071d2b453a745dcb9b4" name="a34c7946fbbdfb071d2b453a745dcb9b4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a34c7946fbbdfb071d2b453a745dcb9b4">&#9670;&#160;</a></span>sys_exit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_exit </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>code</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>退出当前进程或线程 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">code</td><td>退出码 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>不返回 </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：<ul>
<li>进程正常/异常终止</li>
<li><p class="startli">线程退出（clone 创建的线程调用时只退出当前线程）</p>
<p class="startli">行为取决于线程创建方式：</p><ul>
<li>普通进程：退出整个进程</li>
<li>CLONE_THREAD 线程：仅退出当前线程 </li>
</ul>
</li>
</ul>
</dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00067">67</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   67</span>                       {</div>
<div class="line"><span class="lineno">   68</span>  <a class="code hl_struct" href="structklog_1_1Info.html">klog::Info</a>(<span class="stringliteral">&quot;[Syscall] Process %d exited with code %d\n&quot;</span>,</div>
<div class="line"><span class="lineno">   69</span>             <a class="code hl_class" href="classSingleton.html">Singleton&lt;TaskManager&gt;::GetInstance</a>().GetCurrentTask()-&gt;pid, code);</div>
<div class="line"><span class="lineno">   70</span>  <span class="comment">// 调用 TaskManager 的 Exit 方法处理线程退出</span></div>
<div class="line"><span class="lineno">   71</span>  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>().Exit(code);</div>
<div class="line"><span class="lineno">   72</span>  <span class="comment">// 不会执行到这里，因为 Exit 会触发调度切换</span></div>
<div class="line"><span class="lineno">   73</span>  <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] sys_exit should not return!\n&quot;</span>);</div>
<div class="line"><span class="lineno">   74</span>  <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">   75</span>}</div>
<div class="ttc" id="aclassSingleton_html"><div class="ttname"><a href="classSingleton.html">Singleton</a></div><div class="ttdef"><b>Definition</b> <a href="singleton_8hpp_source.html#l00010">singleton.hpp:10</a></div></div>
<div class="ttc" id="astructklog_1_1Info_html"><div class="ttname"><a href="structklog_1_1Info.html">klog::Info</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00168">kernel_log.hpp:168</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a34c7946fbbdfb071d2b453a745dcb9b4_cgraph.png" border="0" usemap="#asyscall_8hpp_a34c7946fbbdfb071d2b453a745dcb9b4_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a34c7946fbbdfb071d2b453a745dcb9b4_cgraph" id="asyscall_8hpp_a34c7946fbbdfb071d2b453a745dcb9b4_cgraph">
<area shape="rect" title="退出当前进程或线程" alt="" coords="5,5,81,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="129,5,299,31"/>
<area shape="poly" title=" " alt="" coords="82,15,115,15,115,21,82,21"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a34c7946fbbdfb071d2b453a745dcb9b4_icgraph.png" border="0" usemap="#asyscall_8hpp_a34c7946fbbdfb071d2b453a745dcb9b4_icgraph" alt=""/></div>
<map name="asyscall_8hpp_a34c7946fbbdfb071d2b453a745dcb9b4_icgraph" id="asyscall_8hpp_a34c7946fbbdfb071d2b453a745dcb9b4_icgraph">
<area shape="rect" title="退出当前进程或线程" alt="" coords="312,5,388,31"/>
<area shape="rect" href="syscall_8cpp.html#a9c01f57bb4ef6f1b91ccce212494a199" title=" " alt="" coords="121,5,264,31"/>
<area shape="poly" title=" " alt="" coords="298,21,264,21,264,15,298,15"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html#a27f252437c17e7b5d2e8aef749daf1f0" title=" " alt="" coords="5,5,73,31"/>
<area shape="poly" title=" " alt="" coords="108,21,74,21,74,15,108,15"/>
</map>
</div>

</div>
</div>
<a id="a01fbd4b45143dd51bf6f338d8ee325da" name="a01fbd4b45143dd51bf6f338d8ee325da"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a01fbd4b45143dd51bf6f338d8ee325da">&#9670;&#160;</a></span>sys_fork()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_fork </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>创建新进程（fork） </p>
<dl class="section return"><dt>Returns</dt><dd>父进程返回子进程 PID，子进程返回 0，失败返回 -1 </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：<ul>
<li>进程创建</li>
<li><p class="startli">完全复制父进程的地址空间和资源</p>
<p class="startli">fork 创建的子进程：</p><ul>
<li>拥有独立的地址空间（页表被复制）</li>
<li>拥有独立的进程 ID (PID)</li>
<li>继承父进程的文件描述符、信号处理器等</li>
<li>父子进程独立运行，互不影响 </li>
</ul>
</li>
</ul>
</dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00117">117</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  117</span>               {</div>
<div class="line"><span class="lineno">  118</span>  <span class="keyword">auto</span>&amp; task_manager = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>();</div>
<div class="line"><span class="lineno">  119</span>  <span class="keyword">auto</span> current = task_manager.GetCurrentTask();</div>
<div class="line"><span class="lineno">  120</span> </div>
<div class="line"><span class="lineno">  121</span>  <span class="keywordflow">if</span> (!current || !current-&gt;trap_context_ptr) {</div>
<div class="line"><span class="lineno">  122</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] sys_fork: Invalid current task or trap context\n&quot;</span>);</div>
<div class="line"><span class="lineno">  123</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  124</span>  }</div>
<div class="line"><span class="lineno">  125</span> </div>
<div class="line"><span class="lineno">  126</span>  <span class="comment">// fork = clone with flags=0 (完全复制，不共享任何资源)</span></div>
<div class="line"><span class="lineno">  127</span>  <span class="keyword">auto</span> result = task_manager.Clone(0, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>,</div>
<div class="line"><span class="lineno">  128</span>                                   *current-&gt;trap_context_ptr);</div>
<div class="line"><span class="lineno">  129</span> </div>
<div class="line"><span class="lineno">  130</span>  <span class="keywordflow">if</span> (!result.has_value()) {</div>
<div class="line"><span class="lineno">  131</span>    <span class="comment">// 失败返回 -1</span></div>
<div class="line"><span class="lineno">  132</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] sys_fork failed: %s\n&quot;</span>, result.error().message());</div>
<div class="line"><span class="lineno">  133</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  134</span>  }</div>
<div class="line"><span class="lineno">  135</span> </div>
<div class="line"><span class="lineno">  136</span>  <a class="code hl_typedef" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a> child_pid = result.value();</div>
<div class="line"><span class="lineno">  137</span>  <span class="keywordflow">if</span> (child_pid == 0) {</div>
<div class="line"><span class="lineno">  138</span>    <span class="comment">// 子进程返回 0</span></div>
<div class="line"><span class="lineno">  139</span>    <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  140</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  141</span>    <span class="comment">// 父进程返回子进程 PID</span></div>
<div class="line"><span class="lineno">  142</span>    <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(child_pid);</div>
<div class="line"><span class="lineno">  143</span>  }</div>
<div class="line"><span class="lineno">  144</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a01fbd4b45143dd51bf6f338d8ee325da_cgraph.png" border="0" usemap="#asyscall_8hpp_a01fbd4b45143dd51bf6f338d8ee325da_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a01fbd4b45143dd51bf6f338d8ee325da_cgraph" id="asyscall_8hpp_a01fbd4b45143dd51bf6f338d8ee325da_cgraph">
<area shape="rect" title="创建新进程（fork）" alt="" coords="5,5,83,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="131,5,300,31"/>
<area shape="poly" title=" " alt="" coords="83,15,117,15,117,21,83,21"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a01fbd4b45143dd51bf6f338d8ee325da_icgraph.png" border="0" usemap="#asyscall_8hpp_a01fbd4b45143dd51bf6f338d8ee325da_icgraph" alt=""/></div>
<map name="asyscall_8hpp_a01fbd4b45143dd51bf6f338d8ee325da_icgraph" id="asyscall_8hpp_a01fbd4b45143dd51bf6f338d8ee325da_icgraph">
<area shape="rect" title="创建新进程（fork）" alt="" coords="312,5,389,31"/>
<area shape="rect" href="syscall_8cpp.html#a9c01f57bb4ef6f1b91ccce212494a199" title=" " alt="" coords="121,5,264,31"/>
<area shape="poly" title=" " alt="" coords="298,21,264,21,264,15,298,15"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html#a27f252437c17e7b5d2e8aef749daf1f0" title=" " alt="" coords="5,5,73,31"/>
<area shape="poly" title=" " alt="" coords="108,21,74,21,74,15,108,15"/>
</map>
</div>

</div>
</div>
<a id="aa03f906affa67ef23ebfbcb79efa569f" name="aa03f906affa67ef23ebfbcb79efa569f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa03f906affa67ef23ebfbcb79efa569f">&#9670;&#160;</a></span>sys_futex()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_futex </td>
          <td>(</td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>uaddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>op</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>val</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&#160;</td>
          <td class="paramname"><em>timeout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>uaddr2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>val3</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>快速用户空间互斥锁操作（futex） </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">uaddr</td><td>用户空间的futex地址 </td></tr>
    <tr><td class="paramname">op</td><td>操作类型（FUTEX_WAIT、FUTEX_WAKE 等） </td></tr>
    <tr><td class="paramname">val</td><td>操作参数 </td></tr>
    <tr><td class="paramname">timeout</td><td>超时时间（可选） </td></tr>
    <tr><td class="paramname">uaddr2</td><td>第二个futex地址（部分操作使用） </td></tr>
    <tr><td class="paramname">val3</td><td>第三个参数（部分操作使用） </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>依操作类型而定，失败返回负数 </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：<ul>
<li>实现互斥锁（mutex）</li>
<li>实现条件变量（condition variable）</li>
<li>实现读写锁（rwlock）</li>
<li>实现信号量（semaphore）</li>
<li>实现 pthread_join（等待线程退出）</li>
<li><p class="startli">实现 pthread_detach（线程状态管理）</p>
<p class="startli">常用操作：</p><ul>
<li>FUTEX_WAIT: 等待futex值变化</li>
<li>FUTEX_WAKE: 唤醒等待的线程</li>
<li>FUTEX_REQUEUE: 重新排队等待的线程 </li>
</ul>
</li>
</ul>
</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000013">Todo:</a></b></dt><dd>需要实现原子比较和阻塞逻辑 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000014">Todo:</a></b></dt><dd></dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000015">Todo:</a></b></dt><dd>需要在 <a class="el" href="classTaskManager.html" title="任务管理器">TaskManager</a> 中添加 futex 等待队列 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000016">Todo:</a></b></dt><dd>应该返回实际唤醒的线程数 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000017">Todo:</a></b></dt><dd>实现 FUTEX_REQUEUE </dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00170">170</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  171</span>                                                                       {</div>
<div class="line"><span class="lineno">  172</span>  <span class="comment">// Futex 常量定义</span></div>
<div class="line"><span class="lineno">  173</span>  <span class="keyword">constexpr</span> <span class="keywordtype">int</span> FUTEX_WAIT = 0;</div>
<div class="line"><span class="lineno">  174</span>  <span class="keyword">constexpr</span> <span class="keywordtype">int</span> FUTEX_WAKE = 1;</div>
<div class="line"><span class="lineno">  175</span>  <span class="keyword">constexpr</span> <span class="keywordtype">int</span> FUTEX_REQUEUE = 3;</div>
<div class="line"><span class="lineno">  176</span> </div>
<div class="line"><span class="lineno">  177</span>  <span class="comment">// 提取操作类型（低位）</span></div>
<div class="line"><span class="lineno">  178</span>  <span class="keywordtype">int</span> cmd = op &amp; 0x7F;</div>
<div class="line"><span class="lineno">  179</span> </div>
<div class="line"><span class="lineno">  180</span>  <span class="keyword">auto</span>&amp; task_manager = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>();</div>
<div class="line"><span class="lineno">  181</span> </div>
<div class="line"><span class="lineno">  182</span>  <span class="keywordflow">switch</span> (cmd) {</div>
<div class="line"><span class="lineno">  183</span>    <span class="keywordflow">case</span> FUTEX_WAIT: {</div>
<div class="line"><span class="lineno">  184</span>      <span class="comment">// 检查 *uaddr 是否等于 val，如果相等则阻塞</span></div>
<div class="line"><span class="lineno">  187</span>      <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;[Syscall] FUTEX_WAIT on %p (val=%d)\n&quot;</span>, uaddr, val);</div>
<div class="line"><span class="lineno">  188</span> </div>
<div class="line"><span class="lineno">  189</span>      <span class="comment">// 简化实现：直接检查值并阻塞</span></div>
<div class="line"><span class="lineno">  190</span>      <span class="keywordflow">if</span> (*uaddr == val) {</div>
<div class="line"><span class="lineno">  191</span>        <span class="comment">// 使用 Futex 类型的资源 ID，地址作为标识</span></div>
<div class="line"><span class="lineno">  192</span>        <a class="code hl_struct" href="structResourceId.html">ResourceId</a> futex_id(<a class="code hl_enumvalue" href="resource__id_8hpp.html#aeea667e01168927f6d83af2e203019bca1a69927dc0a295f27b6ce7e7fc9be66c">ResourceType::kFutex</a>,</div>
<div class="line"><span class="lineno">  193</span>                            <span class="keyword">reinterpret_cast&lt;</span>uintptr_t<span class="keyword">&gt;</span>(uaddr));</div>
<div class="line"><span class="lineno">  194</span>        task_manager.Block(futex_id);</div>
<div class="line"><span class="lineno">  195</span>      }</div>
<div class="line"><span class="lineno">  196</span>      <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  197</span>    }</div>
<div class="line"><span class="lineno">  198</span> </div>
<div class="line"><span class="lineno">  199</span>    <span class="keywordflow">case</span> FUTEX_WAKE: {</div>
<div class="line"><span class="lineno">  200</span>      <span class="comment">// 唤醒最多 val 个等待 uaddr 的线程</span></div>
<div class="line"><span class="lineno">  201</span>      <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;[Syscall] FUTEX_WAKE on %p (count=%d)\n&quot;</span>, uaddr, val);</div>
<div class="line"><span class="lineno">  202</span> </div>
<div class="line"><span class="lineno">  203</span>      <span class="comment">// 唤醒等待该 futex 的所有线程（简化实现，应该只唤醒 val 个）</span></div>
<div class="line"><span class="lineno">  204</span>      <a class="code hl_struct" href="structResourceId.html">ResourceId</a> futex_id(<a class="code hl_enumvalue" href="resource__id_8hpp.html#aeea667e01168927f6d83af2e203019bca1a69927dc0a295f27b6ce7e7fc9be66c">ResourceType::kFutex</a>,</div>
<div class="line"><span class="lineno">  205</span>                          <span class="keyword">reinterpret_cast&lt;</span>uintptr_t<span class="keyword">&gt;</span>(uaddr));</div>
<div class="line"><span class="lineno">  206</span>      task_manager.Wakeup(futex_id);</div>
<div class="line"><span class="lineno">  207</span> </div>
<div class="line"><span class="lineno">  209</span>      <span class="keywordflow">return</span> val;</div>
<div class="line"><span class="lineno">  210</span>    }</div>
<div class="line"><span class="lineno">  211</span> </div>
<div class="line"><span class="lineno">  212</span>    <span class="keywordflow">case</span> FUTEX_REQUEUE: {</div>
<div class="line"><span class="lineno">  213</span>      <span class="comment">// 将等待 uaddr 的线程重新排队到 uaddr2</span></div>
<div class="line"><span class="lineno">  215</span>      <a class="code hl_struct" href="structklog_1_1Warn.html">klog::Warn</a>(<span class="stringliteral">&quot;[Syscall] FUTEX_REQUEUE not implemented\n&quot;</span>);</div>
<div class="line"><span class="lineno">  216</span>      <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  217</span>    }</div>
<div class="line"><span class="lineno">  218</span> </div>
<div class="line"><span class="lineno">  219</span>    <span class="keywordflow">default</span>:</div>
<div class="line"><span class="lineno">  220</span>      <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] Unknown futex operation: %d\n&quot;</span>, cmd);</div>
<div class="line"><span class="lineno">  221</span>      <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  222</span>  }</div>
<div class="line"><span class="lineno">  223</span>}</div>
<div class="ttc" id="aresource__id_8hpp_html_aeea667e01168927f6d83af2e203019bca1a69927dc0a295f27b6ce7e7fc9be66c"><div class="ttname"><a href="resource__id_8hpp.html#aeea667e01168927f6d83af2e203019bca1a69927dc0a295f27b6ce7e7fc9be66c">ResourceType::kFutex</a></div><div class="ttdeci">@ kFutex</div></div>
<div class="ttc" id="astructResourceId_html"><div class="ttname"><a href="structResourceId.html">ResourceId</a></div><div class="ttdoc">资源 ID</div><div class="ttdef"><b>Definition</b> <a href="resource__id_8hpp_source.html#l00075">resource_id.hpp:75</a></div></div>
<div class="ttc" id="astructklog_1_1Debug_html"><div class="ttname"><a href="structklog_1_1Debug.html">klog::Debug</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00146">kernel_log.hpp:146</a></div></div>
<div class="ttc" id="astructklog_1_1Warn_html"><div class="ttname"><a href="structklog_1_1Warn.html">klog::Warn</a></div><div class="ttdef"><b>Definition</b> <a href="kernel__log_8hpp_source.html#l00178">kernel_log.hpp:178</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_aa03f906affa67ef23ebfbcb79efa569f_cgraph.png" border="0" usemap="#asyscall_8hpp_aa03f906affa67ef23ebfbcb79efa569f_cgraph" alt=""/></div>
<map name="asyscall_8hpp_aa03f906affa67ef23ebfbcb79efa569f_cgraph" id="asyscall_8hpp_aa03f906affa67ef23ebfbcb79efa569f_cgraph">
<area shape="rect" title="快速用户空间互斥锁操作（futex）" alt="" coords="5,5,91,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="139,5,308,31"/>
<area shape="poly" title=" " alt="" coords="91,15,125,15,125,21,91,21"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_aa03f906affa67ef23ebfbcb79efa569f_icgraph.png" border="0" usemap="#asyscall_8hpp_aa03f906affa67ef23ebfbcb79efa569f_icgraph" alt=""/></div>
<map name="asyscall_8hpp_aa03f906affa67ef23ebfbcb79efa569f_icgraph" id="asyscall_8hpp_aa03f906affa67ef23ebfbcb79efa569f_icgraph">
<area shape="rect" title="快速用户空间互斥锁操作（futex）" alt="" coords="312,5,397,31"/>
<area shape="rect" href="syscall_8cpp.html#a9c01f57bb4ef6f1b91ccce212494a199" title=" " alt="" coords="121,5,264,31"/>
<area shape="poly" title=" " alt="" coords="298,21,264,21,264,15,298,15"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html#a27f252437c17e7b5d2e8aef749daf1f0" title=" " alt="" coords="5,5,73,31"/>
<area shape="poly" title=" " alt="" coords="108,21,74,21,74,15,108,15"/>
</map>
</div>

</div>
</div>
<a id="a17717d9e7bc25b272fe4dbb63bc52baa" name="a17717d9e7bc25b272fe4dbb63bc52baa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a17717d9e7bc25b272fe4dbb63bc52baa">&#9670;&#160;</a></span>sys_gettid()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_gettid </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>获取当前线程ID </p>
<dl class="section return"><dt>Returns</dt><dd>当前线程的TID </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：<ul>
<li>线程标识</li>
<li>调试信息输出</li>
<li>线程本地数据索引 </li>
</ul>
</dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00146">146</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  146</span>                 {</div>
<div class="line"><span class="lineno">  147</span>  <span class="keyword">auto</span> current = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>().GetCurrentTask();</div>
<div class="line"><span class="lineno">  148</span>  <span class="keywordflow">if</span> (!current) {</div>
<div class="line"><span class="lineno">  149</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] sys_gettid: No current task\n&quot;</span>);</div>
<div class="line"><span class="lineno">  150</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  151</span>  }</div>
<div class="line"><span class="lineno">  152</span>  <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(current-&gt;pid);</div>
<div class="line"><span class="lineno">  153</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a17717d9e7bc25b272fe4dbb63bc52baa_cgraph.png" border="0" usemap="#asyscall_8hpp_a17717d9e7bc25b272fe4dbb63bc52baa_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a17717d9e7bc25b272fe4dbb63bc52baa_cgraph" id="asyscall_8hpp_a17717d9e7bc25b272fe4dbb63bc52baa_cgraph">
<area shape="rect" title="获取当前线程ID" alt="" coords="5,5,95,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="143,5,312,31"/>
<area shape="poly" title=" " alt="" coords="95,15,129,15,129,21,95,21"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a17717d9e7bc25b272fe4dbb63bc52baa_icgraph.png" border="0" usemap="#asyscall_8hpp_a17717d9e7bc25b272fe4dbb63bc52baa_icgraph" alt=""/></div>
<map name="asyscall_8hpp_a17717d9e7bc25b272fe4dbb63bc52baa_icgraph" id="asyscall_8hpp_a17717d9e7bc25b272fe4dbb63bc52baa_icgraph">
<area shape="rect" title="获取当前线程ID" alt="" coords="312,5,401,31"/>
<area shape="rect" href="syscall_8cpp.html#a9c01f57bb4ef6f1b91ccce212494a199" title=" " alt="" coords="121,5,264,31"/>
<area shape="poly" title=" " alt="" coords="298,21,264,21,264,15,298,15"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html#a27f252437c17e7b5d2e8aef749daf1f0" title=" " alt="" coords="5,5,73,31"/>
<area shape="poly" title=" " alt="" coords="108,21,74,21,74,15,108,15"/>
</map>
</div>

</div>
</div>
<a id="a4dd37ef811b362b4638eb21fab7f09fc" name="a4dd37ef811b362b4638eb21fab7f09fc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4dd37ef811b362b4638eb21fab7f09fc">&#9670;&#160;</a></span>sys_sched_getaffinity()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_sched_getaffinity </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>pid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>cpusetsize</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t *&#160;</td>
          <td class="paramname"><em>mask</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>获取线程的CPU亲和性 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pid</td><td>线程ID（0 表示当前线程） </td></tr>
    <tr><td class="paramname">cpusetsize</td><td>CPU集合大小 </td></tr>
    <tr><td class="paramname">mask</td><td>CPU亲和性掩码 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>成功返回 0，失败返回负数 </dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00225">225</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  225</span>                                                                      {</div>
<div class="line"><span class="lineno">  226</span>  <span class="keyword">auto</span>&amp; task_manager = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>();</div>
<div class="line"><span class="lineno">  227</span> </div>
<div class="line"><span class="lineno">  228</span>  <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* target;</div>
<div class="line"><span class="lineno">  229</span>  <span class="keywordflow">if</span> (pid == 0) {</div>
<div class="line"><span class="lineno">  230</span>    <span class="comment">// pid=0 表示当前线程</span></div>
<div class="line"><span class="lineno">  231</span>    target = task_manager.GetCurrentTask();</div>
<div class="line"><span class="lineno">  232</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  233</span>    <span class="comment">// 查找指定 PID 的任务</span></div>
<div class="line"><span class="lineno">  234</span>    target = task_manager.FindTask(<span class="keyword">static_cast&lt;</span><a class="code hl_typedef" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a><span class="keyword">&gt;</span>(pid));</div>
<div class="line"><span class="lineno">  235</span>    <span class="keywordflow">if</span> (!target) {</div>
<div class="line"><span class="lineno">  236</span>      <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] sys_sched_getaffinity: Task %d not found\n&quot;</span>, pid);</div>
<div class="line"><span class="lineno">  237</span>      <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  238</span>    }</div>
<div class="line"><span class="lineno">  239</span>  }</div>
<div class="line"><span class="lineno">  240</span> </div>
<div class="line"><span class="lineno">  241</span>  <span class="keywordflow">if</span> (!target) {</div>
<div class="line"><span class="lineno">  242</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  243</span>  }</div>
<div class="line"><span class="lineno">  244</span> </div>
<div class="line"><span class="lineno">  245</span>  <span class="comment">// 简单实现：将 cpu_affinity 复制到用户空间</span></div>
<div class="line"><span class="lineno">  246</span>  <span class="keywordflow">if</span> (cpusetsize &lt; <span class="keyword">sizeof</span>(uint64_t)) {</div>
<div class="line"><span class="lineno">  247</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  248</span>  }</div>
<div class="line"><span class="lineno">  249</span> </div>
<div class="line"><span class="lineno">  250</span>  *mask = target-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a82296b6fec3ae8a120ffec4f0e97ef81">cpu_affinity</a>;</div>
<div class="line"><span class="lineno">  251</span>  <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  252</span>}</div>
<div class="ttc" id="astructTaskControlBlock_html"><div class="ttname"><a href="structTaskControlBlock.html">TaskControlBlock</a></div><div class="ttdoc">任务控制块，管理进程/线程的核心数据结构</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00080">task_control_block.hpp:80</a></div></div>
<div class="ttc" id="astructTaskControlBlock_html_a82296b6fec3ae8a120ffec4f0e97ef81"><div class="ttname"><a href="structTaskControlBlock.html#a82296b6fec3ae8a120ffec4f0e97ef81">TaskControlBlock::cpu_affinity</a></div><div class="ttdeci">uint64_t cpu_affinity</div><div class="ttdoc">CPU 亲和性位掩码</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00181">task_control_block.hpp:181</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a4dd37ef811b362b4638eb21fab7f09fc_cgraph.png" border="0" usemap="#asyscall_8hpp_a4dd37ef811b362b4638eb21fab7f09fc_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a4dd37ef811b362b4638eb21fab7f09fc_cgraph" id="asyscall_8hpp_a4dd37ef811b362b4638eb21fab7f09fc_cgraph">
<area shape="rect" title="获取线程的CPU亲和性" alt="" coords="5,5,168,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="216,5,385,31"/>
<area shape="poly" title=" " alt="" coords="168,15,202,15,202,21,168,21"/>
</map>
</div>

</div>
</div>
<a id="afc0c058ad3c8a4b5746d97c2f49b97a4" name="afc0c058ad3c8a4b5746d97c2f49b97a4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afc0c058ad3c8a4b5746d97c2f49b97a4">&#9670;&#160;</a></span>sys_sched_setaffinity()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_sched_setaffinity </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>pid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>cpusetsize</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint64_t *&#160;</td>
          <td class="paramname"><em>mask</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>设置线程的CPU亲和性 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pid</td><td>线程ID（0 表示当前线程） </td></tr>
    <tr><td class="paramname">cpusetsize</td><td>CPU集合大小 </td></tr>
    <tr><td class="paramname">mask</td><td>CPU亲和性掩码 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>成功返回 0，失败返回负数 </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：<ul>
<li>CPU绑定优化</li>
<li>实时任务调度</li>
<li>NUMA优化 </li>
</ul>
</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000018">Todo:</a></b></dt><dd>如果当前任务不在允许的 CPU 上运行，应该触发迁移 </dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00254">254</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  254</span>                                                                            {</div>
<div class="line"><span class="lineno">  255</span>  <span class="keyword">auto</span>&amp; task_manager = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>();</div>
<div class="line"><span class="lineno">  256</span> </div>
<div class="line"><span class="lineno">  257</span>  <a class="code hl_struct" href="structTaskControlBlock.html">TaskControlBlock</a>* target;</div>
<div class="line"><span class="lineno">  258</span>  <span class="keywordflow">if</span> (pid == 0) {</div>
<div class="line"><span class="lineno">  259</span>    target = task_manager.GetCurrentTask();</div>
<div class="line"><span class="lineno">  260</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  261</span>    <span class="comment">// 查找指定 PID 的任务</span></div>
<div class="line"><span class="lineno">  262</span>    target = task_manager.FindTask(<span class="keyword">static_cast&lt;</span><a class="code hl_typedef" href="task__control__block_8hpp.html#a7b3497faea769e764efc8647bc2103f1">Pid</a><span class="keyword">&gt;</span>(pid));</div>
<div class="line"><span class="lineno">  263</span>    <span class="keywordflow">if</span> (!target) {</div>
<div class="line"><span class="lineno">  264</span>      <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] sys_sched_setaffinity: Task %d not found\n&quot;</span>, pid);</div>
<div class="line"><span class="lineno">  265</span>      <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  266</span>    }</div>
<div class="line"><span class="lineno">  267</span>  }</div>
<div class="line"><span class="lineno">  268</span> </div>
<div class="line"><span class="lineno">  269</span>  <span class="keywordflow">if</span> (!target) {</div>
<div class="line"><span class="lineno">  270</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  271</span>  }</div>
<div class="line"><span class="lineno">  272</span> </div>
<div class="line"><span class="lineno">  273</span>  <span class="comment">// 简单实现：更新 cpu_affinity</span></div>
<div class="line"><span class="lineno">  274</span>  <span class="keywordflow">if</span> (cpusetsize &lt; <span class="keyword">sizeof</span>(uint64_t)) {</div>
<div class="line"><span class="lineno">  275</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  276</span>  }</div>
<div class="line"><span class="lineno">  277</span> </div>
<div class="line"><span class="lineno">  278</span>  target-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#a82296b6fec3ae8a120ffec4f0e97ef81">cpu_affinity</a> = *mask;</div>
<div class="line"><span class="lineno">  279</span> </div>
<div class="line"><span class="lineno">  280</span>  <a class="code hl_struct" href="structklog_1_1Debug.html">klog::Debug</a>(<span class="stringliteral">&quot;[Syscall] Set CPU affinity for task %zu to 0x%lx\n&quot;</span>, target-&gt;<a class="code hl_variable" href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">pid</a>,</div>
<div class="line"><span class="lineno">  281</span>              *mask);</div>
<div class="line"><span class="lineno">  282</span> </div>
<div class="line"><span class="lineno">  284</span> </div>
<div class="line"><span class="lineno">  285</span>  <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  286</span>}</div>
<div class="ttc" id="astructTaskControlBlock_html_aca9ca152ecda65751f10c515c4dbb867"><div class="ttname"><a href="structTaskControlBlock.html#aca9ca152ecda65751f10c515c4dbb867">TaskControlBlock::pid</a></div><div class="ttdeci">Pid pid</div><div class="ttdoc">线程 ID (Task ID)</div><div class="ttdef"><b>Definition</b> <a href="task__control__block_8hpp_source.html#l00102">task_control_block.hpp:102</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_afc0c058ad3c8a4b5746d97c2f49b97a4_cgraph.png" border="0" usemap="#asyscall_8hpp_afc0c058ad3c8a4b5746d97c2f49b97a4_cgraph" alt=""/></div>
<map name="asyscall_8hpp_afc0c058ad3c8a4b5746d97c2f49b97a4_cgraph" id="asyscall_8hpp_afc0c058ad3c8a4b5746d97c2f49b97a4_cgraph">
<area shape="rect" title="设置线程的CPU亲和性" alt="" coords="5,5,168,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="216,5,385,31"/>
<area shape="poly" title=" " alt="" coords="168,15,202,15,202,21,168,21"/>
</map>
</div>

</div>
</div>
<a id="ab5c00759c95d8ce9e9db75b1b55a9552" name="ab5c00759c95d8ce9e9db75b1b55a9552"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab5c00759c95d8ce9e9db75b1b55a9552">&#9670;&#160;</a></span>sys_set_tid_address()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_set_tid_address </td>
          <td>(</td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>tidptr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>设置线程ID地址（用于线程退出时的清理） </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tidptr</td><td>线程ID存储地址 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>成功返回0，失败返回负数 </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：<ul>
<li>线程库内部使用</li>
<li>实现线程退出时的通知机制 </li>
</ul>
</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000012">Todo:</a></b></dt><dd>需要在 <a class="el" href="structTaskControlBlock.html" title="任务控制块，管理进程/线程的核心数据结构">TaskControlBlock</a> 中添加字段保存 tidptr </dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00155">155</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  155</span>                                                      {</div>
<div class="line"><span class="lineno">  156</span>  <span class="keyword">auto</span> current = <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>().GetCurrentTask();</div>
<div class="line"><span class="lineno">  157</span>  <span class="keywordflow">if</span> (!current) {</div>
<div class="line"><span class="lineno">  158</span>    <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] sys_set_tid_address: No current task\n&quot;</span>);</div>
<div class="line"><span class="lineno">  159</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  160</span>  }</div>
<div class="line"><span class="lineno">  161</span> </div>
<div class="line"><span class="lineno">  162</span>  <span class="comment">// 保存 tidptr，在线程退出时会清零该地址并执行 futex wake</span></div>
<div class="line"><span class="lineno">  164</span>  <span class="comment">// current-&gt;clear_child_tid = tidptr;</span></div>
<div class="line"><span class="lineno">  165</span> </div>
<div class="line"><span class="lineno">  166</span>  <span class="comment">// 返回当前线程的 TID</span></div>
<div class="line"><span class="lineno">  167</span>  <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(current-&gt;pid);</div>
<div class="line"><span class="lineno">  168</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_ab5c00759c95d8ce9e9db75b1b55a9552_cgraph.png" border="0" usemap="#asyscall_8hpp_ab5c00759c95d8ce9e9db75b1b55a9552_cgraph" alt=""/></div>
<map name="asyscall_8hpp_ab5c00759c95d8ce9e9db75b1b55a9552_cgraph" id="asyscall_8hpp_ab5c00759c95d8ce9e9db75b1b55a9552_cgraph">
<area shape="rect" title="设置线程ID地址（用于线程退出时的清理）" alt="" coords="5,5,159,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="207,5,376,31"/>
<area shape="poly" title=" " alt="" coords="159,15,193,15,193,21,159,21"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_ab5c00759c95d8ce9e9db75b1b55a9552_icgraph.png" border="0" usemap="#asyscall_8hpp_ab5c00759c95d8ce9e9db75b1b55a9552_icgraph" alt=""/></div>
<map name="asyscall_8hpp_ab5c00759c95d8ce9e9db75b1b55a9552_icgraph" id="asyscall_8hpp_ab5c00759c95d8ce9e9db75b1b55a9552_icgraph">
<area shape="rect" title="设置线程ID地址（用于线程退出时的清理）" alt="" coords="312,5,465,31"/>
<area shape="rect" href="syscall_8cpp.html#a9c01f57bb4ef6f1b91ccce212494a199" title=" " alt="" coords="121,5,264,31"/>
<area shape="poly" title=" " alt="" coords="298,21,265,21,265,15,298,15"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html#a27f252437c17e7b5d2e8aef749daf1f0" title=" " alt="" coords="5,5,73,31"/>
<area shape="poly" title=" " alt="" coords="108,21,74,21,74,15,108,15"/>
</map>
</div>

</div>
</div>
<a id="a83d46a7afcd47f11ed83ae871d058d20" name="a83d46a7afcd47f11ed83ae871d058d20"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a83d46a7afcd47f11ed83ae871d058d20">&#9670;&#160;</a></span>sys_sleep()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_sleep </td>
          <td>(</td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>ms</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>休眠指定毫秒数 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ms</td><td>休眠时长（毫秒） </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 表示成功 </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：定时任务、延迟执行 </dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00082">82</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   82</span>                           {</div>
<div class="line"><span class="lineno">   83</span>  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>().Sleep(ms);</div>
<div class="line"><span class="lineno">   84</span>  <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">   85</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a83d46a7afcd47f11ed83ae871d058d20_cgraph.png" border="0" usemap="#asyscall_8hpp_a83d46a7afcd47f11ed83ae871d058d20_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a83d46a7afcd47f11ed83ae871d058d20_cgraph" id="asyscall_8hpp_a83d46a7afcd47f11ed83ae871d058d20_cgraph">
<area shape="rect" title="休眠指定毫秒数" alt="" coords="5,5,92,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="140,5,309,31"/>
<area shape="poly" title=" " alt="" coords="92,15,126,15,126,21,92,21"/>
</map>
</div>

</div>
</div>
<a id="a4fa66935c10e294006b6310af1c68f37" name="a4fa66935c10e294006b6310af1c68f37"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4fa66935c10e294006b6310af1c68f37">&#9670;&#160;</a></span>sys_write()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_write </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>向文件描述符写入数据 </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fd</td><td>文件描述符 </td></tr>
    <tr><td class="paramname">buf</td><td>数据缓冲区 </td></tr>
    <tr><td class="paramname">len</td><td>数据长度 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>成功写入的字节数，失败返回负数 </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：标准输出、日志输出等 </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000011">Todo:</a></b></dt><dd>应该检查 buf 是否在用户空间合法范围内 </dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00054">54</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   54</span>                                                   {</div>
<div class="line"><span class="lineno">   55</span>  <span class="comment">// 简单实现：仅支持向标准输出(1)和错误输出(2)打印</span></div>
<div class="line"><span class="lineno">   56</span>  <span class="keywordflow">if</span> (fd == 1 || fd == 2) {</div>
<div class="line"><span class="lineno">   58</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; len; ++i) {</div>
<div class="line"><span class="lineno">   59</span>      <span class="comment">// 使用 klog::Print 而不是 Format，避免 buffer 解析带来的问题</span></div>
<div class="line"><span class="lineno">   60</span>      <a class="code hl_function" href="sk__stdio_8h.html#ad8142b94111a30f723c6c0a2301bae7f">sk_printf</a>(<span class="stringliteral">&quot;%c&quot;</span>, buf[i]);</div>
<div class="line"><span class="lineno">   61</span>    }</div>
<div class="line"><span class="lineno">   62</span>    <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(len);</div>
<div class="line"><span class="lineno">   63</span>  }</div>
<div class="line"><span class="lineno">   64</span>  <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">   65</span>}</div>
<div class="ttc" id="ask__stdio_8h_html_ad8142b94111a30f723c6c0a2301bae7f"><div class="ttname"><a href="sk__stdio_8h.html#ad8142b94111a30f723c6c0a2301bae7f">sk_printf</a></div><div class="ttdeci">int sk_printf(const char *format,...) __attribute__((format(printf</div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a4fa66935c10e294006b6310af1c68f37_cgraph.png" border="0" usemap="#asyscall_8hpp_a4fa66935c10e294006b6310af1c68f37_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a4fa66935c10e294006b6310af1c68f37_cgraph" id="asyscall_8hpp_a4fa66935c10e294006b6310af1c68f37_cgraph">
<area shape="rect" title="向文件描述符写入数据" alt="" coords="5,5,89,31"/>
<area shape="rect" href="sk__stdio_8h.html#ad8142b94111a30f723c6c0a2301bae7f" title=" " alt="" coords="137,5,216,31"/>
<area shape="poly" title=" " alt="" coords="89,15,124,15,124,21,89,21"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a4fa66935c10e294006b6310af1c68f37_icgraph.png" border="0" usemap="#asyscall_8hpp_a4fa66935c10e294006b6310af1c68f37_icgraph" alt=""/></div>
<map name="asyscall_8hpp_a4fa66935c10e294006b6310af1c68f37_icgraph" id="asyscall_8hpp_a4fa66935c10e294006b6310af1c68f37_icgraph">
<area shape="rect" title="向文件描述符写入数据" alt="" coords="312,5,396,31"/>
<area shape="rect" href="syscall_8cpp.html#a9c01f57bb4ef6f1b91ccce212494a199" title=" " alt="" coords="121,5,264,31"/>
<area shape="poly" title=" " alt="" coords="298,21,264,21,264,15,298,15"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html#a27f252437c17e7b5d2e8aef749daf1f0" title=" " alt="" coords="5,5,73,31"/>
<area shape="poly" title=" " alt="" coords="108,21,74,21,74,15,108,15"/>
</map>
</div>

</div>
</div>
<a id="a23ac80734740f098e56332da33758ace" name="a23ac80734740f098e56332da33758ace"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a23ac80734740f098e56332da33758ace">&#9670;&#160;</a></span>sys_yield()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sys_yield </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>主动放弃CPU，让出时间片 </p>
<dl class="section return"><dt>Returns</dt><dd>0 表示成功 </dd></dl>
<dl class="section note"><dt>Note</dt><dd>使用场景：协作式调度、忙等待优化 </dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00077">77</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   77</span>                {</div>
<div class="line"><span class="lineno">   78</span>  <a class="code hl_function" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd">Singleton&lt;TaskManager&gt;::GetInstance</a>().Schedule();</div>
<div class="line"><span class="lineno">   79</span>  <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">   80</span>}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a23ac80734740f098e56332da33758ace_cgraph.png" border="0" usemap="#asyscall_8hpp_a23ac80734740f098e56332da33758ace_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a23ac80734740f098e56332da33758ace_cgraph" id="asyscall_8hpp_a23ac80734740f098e56332da33758ace_cgraph">
<area shape="rect" title="主动放弃CPU，让出时间片" alt="" coords="5,5,88,31"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="136,5,305,31"/>
<area shape="poly" title=" " alt="" coords="88,15,122,15,122,21,88,21"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a23ac80734740f098e56332da33758ace_icgraph.png" border="0" usemap="#asyscall_8hpp_a23ac80734740f098e56332da33758ace_icgraph" alt=""/></div>
<map name="asyscall_8hpp_a23ac80734740f098e56332da33758ace_icgraph" id="asyscall_8hpp_a23ac80734740f098e56332da33758ace_icgraph">
<area shape="rect" title="主动放弃CPU，让出时间片" alt="" coords="312,5,395,31"/>
<area shape="rect" href="syscall_8cpp.html#a9c01f57bb4ef6f1b91ccce212494a199" title=" " alt="" coords="121,5,264,31"/>
<area shape="poly" title=" " alt="" coords="298,21,264,21,264,15,298,15"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html#a27f252437c17e7b5d2e8aef749daf1f0" title=" " alt="" coords="5,5,73,31"/>
<area shape="poly" title=" " alt="" coords="108,21,74,21,74,15,108,15"/>
</map>
</div>

</div>
</div>
<a id="a754e3c00eb93be17daa96d00a12bc447" name="a754e3c00eb93be17daa96d00a12bc447"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a754e3c00eb93be17daa96d00a12bc447">&#9670;&#160;</a></span>Syscall()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Syscall </td>
          <td>(</td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>cause</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structcpu__io_1_1TrapContext.html">cpu_io::TrapContext</a> *&#160;</td>
          <td class="paramname"><em>context_ptr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright The SimpleKernel Contributors </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000007">Todo:</a></b></dt><dd></dd></dl>

<p class="definition">Definition at line <a class="el" href="arch_2aarch64_2syscall_8cpp_source.html#l00011">11</a> of file <a class="el" href="arch_2aarch64_2syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   11</span>                                                       {</div>
<div class="line"><span class="lineno">   12</span>  <span class="comment">// 获取系统调用号和参数</span></div>
<div class="line"><span class="lineno">   13</span>  uint64_t syscall_id = 0;</div>
<div class="line"><span class="lineno">   14</span>  uint64_t args[6] = {0};</div>
<div class="line"><span class="lineno">   15</span> </div>
<div class="line"><span class="lineno">   16</span>  syscall_id = context_ptr-&gt;x8;</div>
<div class="line"><span class="lineno">   17</span>  args[0] = context_ptr-&gt;x0;</div>
<div class="line"><span class="lineno">   18</span>  args[1] = context_ptr-&gt;x1;</div>
<div class="line"><span class="lineno">   19</span>  args[2] = context_ptr-&gt;x2;</div>
<div class="line"><span class="lineno">   20</span>  args[3] = context_ptr-&gt;x3;</div>
<div class="line"><span class="lineno">   21</span>  args[4] = context_ptr-&gt;x4;</div>
<div class="line"><span class="lineno">   22</span>  args[5] = context_ptr-&gt;x5;</div>
<div class="line"><span class="lineno">   23</span> </div>
<div class="line"><span class="lineno">   24</span>  <span class="comment">// 执行处理函数</span></div>
<div class="line"><span class="lineno">   25</span>  <span class="keyword">auto</span> ret = <a class="code hl_function" href="syscall_8hpp.html#a9c01f57bb4ef6f1b91ccce212494a199">syscall_dispatcher</a>(syscall_id, args);</div>
<div class="line"><span class="lineno">   26</span> </div>
<div class="line"><span class="lineno">   27</span>  <span class="comment">// 设置返回值</span></div>
<div class="line"><span class="lineno">   28</span>  context_ptr-&gt;x0 = <span class="keyword">static_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(ret);</div>
<div class="line"><span class="lineno">   29</span> </div>
<div class="line"><span class="lineno">   30</span>  <span class="comment">// 跳过 svc 指令</span></div>
<div class="line"><span class="lineno">   31</span>  context_ptr-&gt;elr_el1 += 4;</div>
<div class="line"><span class="lineno">   32</span>}</div>
<div class="ttc" id="asyscall_8hpp_html_a9c01f57bb4ef6f1b91ccce212494a199"><div class="ttname"><a href="syscall_8hpp.html#a9c01f57bb4ef6f1b91ccce212494a199">syscall_dispatcher</a></div><div class="ttdeci">int syscall_dispatcher(int64_t syscall_id, uint64_t args[6])</div><div class="ttdef"><b>Definition</b> <a href="syscall_8cpp_source.html#l00011">syscall.cpp:11</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a754e3c00eb93be17daa96d00a12bc447_cgraph.png" border="0" usemap="#asyscall_8hpp_a754e3c00eb93be17daa96d00a12bc447_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a754e3c00eb93be17daa96d00a12bc447_cgraph" id="asyscall_8hpp_a754e3c00eb93be17daa96d00a12bc447_cgraph">
<area shape="rect" title=" " alt="" coords="5,179,73,204"/>
<area shape="rect" href="syscall_8cpp.html#a9c01f57bb4ef6f1b91ccce212494a199" title=" " alt="" coords="121,179,264,204"/>
<area shape="poly" title=" " alt="" coords="73,189,107,189,107,194,73,194"/>
<area shape="rect" href="syscall_8cpp.html#a6d9ce836fd264a98548781886f375d2a" title="创建新线程（或进程）" alt="" coords="345,5,432,31"/>
<area shape="poly" title=" " alt="" coords="198,177,240,112,272,73,310,40,331,29,333,34,314,44,276,77,244,115,203,180"/>
<area shape="rect" href="syscall_8cpp.html#a34c7946fbbdfb071d2b453a745dcb9b4" title="退出当前进程或线程" alt="" coords="351,55,427,80"/>
<area shape="poly" title=" " alt="" coords="204,176,248,134,278,110,311,89,337,78,339,82,313,94,281,114,252,138,208,180"/>
<area shape="rect" href="syscall_8cpp.html#a01fbd4b45143dd51bf6f338d8ee325da" title="创建新进程（fork）" alt="" coords="350,104,427,129"/>
<area shape="poly" title=" " alt="" coords="221,176,311,138,336,129,338,134,313,143,223,181"/>
<area shape="rect" href="syscall_8cpp.html#aa03f906affa67ef23ebfbcb79efa569f" title="快速用户空间互斥锁操作（futex）" alt="" coords="346,153,431,179"/>
<area shape="poly" title=" " alt="" coords="264,179,332,171,332,176,265,185"/>
<area shape="rect" href="syscall_8cpp.html#a17717d9e7bc25b272fe4dbb63bc52baa" title="获取当前线程ID" alt="" coords="344,203,433,228"/>
<area shape="poly" title=" " alt="" coords="265,197,330,206,330,211,264,203"/>
<area shape="rect" href="syscall_8cpp.html#ab5c00759c95d8ce9e9db75b1b55a9552" title="设置线程ID地址（用于线程退出时的清理）" alt="" coords="312,252,465,277"/>
<area shape="poly" title=" " alt="" coords="225,202,313,237,336,245,334,250,311,242,223,207"/>
<area shape="rect" href="syscall_8cpp.html#a4fa66935c10e294006b6310af1c68f37" title="向文件描述符写入数据" alt="" coords="347,351,431,376"/>
<area shape="poly" title=" " alt="" coords="203,203,245,266,276,304,314,336,335,347,332,352,310,340,272,307,240,269,199,206"/>
<area shape="rect" href="syscall_8cpp.html#a23ac80734740f098e56332da33758ace" title="主动放弃CPU，让出时间片" alt="" coords="347,301,430,327"/>
<area shape="poly" title=" " alt="" coords="208,203,253,243,282,266,313,286,335,296,333,301,311,291,279,271,249,247,205,206"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="513,153,683,179"/>
<area shape="poly" title=" " alt="" coords="433,25,467,40,501,63,532,90,580,141,576,145,528,94,497,67,464,44,431,30"/>
<area shape="poly" title=" " alt="" coords="428,75,466,89,521,116,567,144,565,148,518,121,464,94,426,80"/>
<area shape="poly" title=" " alt="" coords="428,123,531,148,530,153,427,128"/>
<area shape="poly" title=" " alt="" coords="432,163,499,163,499,169,432,169"/>
<area shape="poly" title=" " alt="" coords="433,202,530,179,531,184,434,207"/>
<area shape="poly" title=" " alt="" coords="431,249,464,237,517,210,564,184,566,188,520,215,466,242,433,254"/>
<area shape="rect" href="sk__stdio_8h.html#ad8142b94111a30f723c6c0a2301bae7f" title=" " alt="" coords="559,351,637,376"/>
<area shape="poly" title=" " alt="" coords="431,361,545,361,545,366,431,366"/>
<area shape="poly" title=" " alt="" coords="429,302,464,286,497,263,528,237,576,187,579,191,531,241,500,268,467,291,431,306"/>
</map>
</div>

</div>
</div>
<a id="a9c01f57bb4ef6f1b91ccce212494a199" name="a9c01f57bb4ef6f1b91ccce212494a199"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9c01f57bb4ef6f1b91ccce212494a199">&#9670;&#160;</a></span>syscall_dispatcher()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int syscall_dispatcher </td>
          <td>(</td>
          <td class="paramtype">int64_t&#160;</td>
          <td class="paramname"><em>syscall_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>args</em>[6]&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright The SimpleKernel Contributors </dd></dl>

<p class="definition">Definition at line <a class="el" href="syscall_8cpp_source.html#l00011">11</a> of file <a class="el" href="syscall_8cpp_source.html">syscall.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   11</span>                                                             {</div>
<div class="line"><span class="lineno">   12</span>  int64_t ret = 0;</div>
<div class="line"><span class="lineno">   13</span>  <span class="keywordflow">switch</span> (syscall_id) {</div>
<div class="line"><span class="lineno">   14</span>    <span class="keywordflow">case</span> SYSCALL_WRITE:</div>
<div class="line"><span class="lineno">   15</span>      ret = <a class="code hl_function" href="syscall_8cpp.html#a4fa66935c10e294006b6310af1c68f37">sys_write</a>(<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(args[0]),</div>
<div class="line"><span class="lineno">   16</span>                      <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(args[1]),</div>
<div class="line"><span class="lineno">   17</span>                      <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(args[2]));</div>
<div class="line"><span class="lineno">   18</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   19</span>    <span class="keywordflow">case</span> SYSCALL_EXIT:</div>
<div class="line"><span class="lineno">   20</span>      ret = <a class="code hl_function" href="syscall_8cpp.html#a34c7946fbbdfb071d2b453a745dcb9b4">sys_exit</a>(<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(args[0]));</div>
<div class="line"><span class="lineno">   21</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   22</span>    <span class="keywordflow">case</span> SYSCALL_YIELD:</div>
<div class="line"><span class="lineno">   23</span>      ret = <a class="code hl_function" href="syscall_8cpp.html#a23ac80734740f098e56332da33758ace">sys_yield</a>();</div>
<div class="line"><span class="lineno">   24</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   25</span>    <span class="keywordflow">case</span> SYSCALL_CLONE:</div>
<div class="line"><span class="lineno">   26</span>      ret = <a class="code hl_function" href="syscall_8cpp.html#a6d9ce836fd264a98548781886f375d2a">sys_clone</a>(args[0], <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">void</span>*<span class="keyword">&gt;</span>(args[1]),</div>
<div class="line"><span class="lineno">   27</span>                      <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(args[2]),</div>
<div class="line"><span class="lineno">   28</span>                      <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(args[3]),</div>
<div class="line"><span class="lineno">   29</span>                      <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">void</span>*<span class="keyword">&gt;</span>(args[4]));</div>
<div class="line"><span class="lineno">   30</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   31</span>    <span class="keywordflow">case</span> SYSCALL_FORK:</div>
<div class="line"><span class="lineno">   32</span>      ret = <a class="code hl_function" href="syscall_8cpp.html#a01fbd4b45143dd51bf6f338d8ee325da">sys_fork</a>();</div>
<div class="line"><span class="lineno">   33</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   34</span>    <span class="keywordflow">case</span> SYSCALL_GETTID:</div>
<div class="line"><span class="lineno">   35</span>      ret = <a class="code hl_function" href="syscall_8cpp.html#a17717d9e7bc25b272fe4dbb63bc52baa">sys_gettid</a>();</div>
<div class="line"><span class="lineno">   36</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   37</span>    <span class="keywordflow">case</span> SYSCALL_SET_TID_ADDRESS:</div>
<div class="line"><span class="lineno">   38</span>      ret = <a class="code hl_function" href="syscall_8cpp.html#ab5c00759c95d8ce9e9db75b1b55a9552">sys_set_tid_address</a>(<span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(args[0]));</div>
<div class="line"><span class="lineno">   39</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   40</span>    <span class="keywordflow">case</span> SYSCALL_FUTEX:</div>
<div class="line"><span class="lineno">   41</span>      ret = <a class="code hl_function" href="syscall_8cpp.html#aa03f906affa67ef23ebfbcb79efa569f">sys_futex</a>(</div>
<div class="line"><span class="lineno">   42</span>          <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(args[0]), <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(args[1]),</div>
<div class="line"><span class="lineno">   43</span>          <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(args[2]), <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">void</span>*<span class="keyword">&gt;</span>(args[3]),</div>
<div class="line"><span class="lineno">   44</span>          <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(args[4]), <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(args[5]));</div>
<div class="line"><span class="lineno">   45</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   46</span>    <span class="keywordflow">default</span>:</div>
<div class="line"><span class="lineno">   47</span>      <a class="code hl_struct" href="structklog_1_1Err.html">klog::Err</a>(<span class="stringliteral">&quot;[Syscall] Unknown syscall id: %d\n&quot;</span>, syscall_id);</div>
<div class="line"><span class="lineno">   48</span>      ret = -1;</div>
<div class="line"><span class="lineno">   49</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">   50</span>  }</div>
<div class="line"><span class="lineno">   51</span>  <span class="keywordflow">return</span> ret;</div>
<div class="line"><span class="lineno">   52</span>}</div>
<div class="ttc" id="asyscall_8cpp_html_a01fbd4b45143dd51bf6f338d8ee325da"><div class="ttname"><a href="syscall_8cpp.html#a01fbd4b45143dd51bf6f338d8ee325da">sys_fork</a></div><div class="ttdeci">int sys_fork()</div><div class="ttdoc">创建新进程（fork）</div><div class="ttdef"><b>Definition</b> <a href="syscall_8cpp_source.html#l00117">syscall.cpp:117</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_a17717d9e7bc25b272fe4dbb63bc52baa"><div class="ttname"><a href="syscall_8cpp.html#a17717d9e7bc25b272fe4dbb63bc52baa">sys_gettid</a></div><div class="ttdeci">int sys_gettid()</div><div class="ttdoc">获取当前线程ID</div><div class="ttdef"><b>Definition</b> <a href="syscall_8cpp_source.html#l00146">syscall.cpp:146</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_a23ac80734740f098e56332da33758ace"><div class="ttname"><a href="syscall_8cpp.html#a23ac80734740f098e56332da33758ace">sys_yield</a></div><div class="ttdeci">int sys_yield()</div><div class="ttdoc">主动放弃CPU，让出时间片</div><div class="ttdef"><b>Definition</b> <a href="syscall_8cpp_source.html#l00077">syscall.cpp:77</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_a34c7946fbbdfb071d2b453a745dcb9b4"><div class="ttname"><a href="syscall_8cpp.html#a34c7946fbbdfb071d2b453a745dcb9b4">sys_exit</a></div><div class="ttdeci">int sys_exit(int code)</div><div class="ttdoc">退出当前进程或线程</div><div class="ttdef"><b>Definition</b> <a href="syscall_8cpp_source.html#l00067">syscall.cpp:67</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_a4fa66935c10e294006b6310af1c68f37"><div class="ttname"><a href="syscall_8cpp.html#a4fa66935c10e294006b6310af1c68f37">sys_write</a></div><div class="ttdeci">int sys_write(int fd, const char *buf, size_t len)</div><div class="ttdoc">向文件描述符写入数据</div><div class="ttdef"><b>Definition</b> <a href="syscall_8cpp_source.html#l00054">syscall.cpp:54</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_a6d9ce836fd264a98548781886f375d2a"><div class="ttname"><a href="syscall_8cpp.html#a6d9ce836fd264a98548781886f375d2a">sys_clone</a></div><div class="ttdeci">int sys_clone(uint64_t flags, void *stack, int *parent_tid, int *child_tid, void *tls)</div><div class="ttdoc">创建新线程（或进程）</div><div class="ttdef"><b>Definition</b> <a href="syscall_8cpp_source.html#l00087">syscall.cpp:87</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_aa03f906affa67ef23ebfbcb79efa569f"><div class="ttname"><a href="syscall_8cpp.html#aa03f906affa67ef23ebfbcb79efa569f">sys_futex</a></div><div class="ttdeci">int sys_futex(int *uaddr, int op, int val, const void *timeout, int *uaddr2, int val3)</div><div class="ttdoc">快速用户空间互斥锁操作（futex）</div><div class="ttdef"><b>Definition</b> <a href="syscall_8cpp_source.html#l00170">syscall.cpp:170</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_ab5c00759c95d8ce9e9db75b1b55a9552"><div class="ttname"><a href="syscall_8cpp.html#ab5c00759c95d8ce9e9db75b1b55a9552">sys_set_tid_address</a></div><div class="ttdeci">int sys_set_tid_address(int *tidptr)</div><div class="ttdoc">设置线程ID地址（用于线程退出时的清理）</div><div class="ttdef"><b>Definition</b> <a href="syscall_8cpp_source.html#l00155">syscall.cpp:155</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a9c01f57bb4ef6f1b91ccce212494a199_cgraph.png" border="0" usemap="#asyscall_8hpp_a9c01f57bb4ef6f1b91ccce212494a199_cgraph" alt=""/></div>
<map name="asyscall_8hpp_a9c01f57bb4ef6f1b91ccce212494a199_cgraph" id="asyscall_8hpp_a9c01f57bb4ef6f1b91ccce212494a199_cgraph">
<area shape="rect" title=" " alt="" coords="5,179,148,204"/>
<area shape="rect" href="syscall_8cpp.html#a6d9ce836fd264a98548781886f375d2a" title="创建新线程（或进程）" alt="" coords="229,5,316,31"/>
<area shape="poly" title=" " alt="" coords="82,177,124,112,156,73,194,40,215,29,217,34,198,44,160,77,128,115,87,180"/>
<area shape="rect" href="syscall_8cpp.html#a34c7946fbbdfb071d2b453a745dcb9b4" title="退出当前进程或线程" alt="" coords="235,55,311,80"/>
<area shape="poly" title=" " alt="" coords="88,176,132,134,162,110,195,89,221,78,223,82,197,94,165,114,136,138,92,180"/>
<area shape="rect" href="syscall_8cpp.html#a01fbd4b45143dd51bf6f338d8ee325da" title="创建新进程（fork）" alt="" coords="234,104,311,129"/>
<area shape="poly" title=" " alt="" coords="105,176,195,138,220,129,222,134,197,143,107,181"/>
<area shape="rect" href="syscall_8cpp.html#aa03f906affa67ef23ebfbcb79efa569f" title="快速用户空间互斥锁操作（futex）" alt="" coords="230,153,315,179"/>
<area shape="poly" title=" " alt="" coords="148,179,216,171,216,176,149,185"/>
<area shape="rect" href="syscall_8cpp.html#a17717d9e7bc25b272fe4dbb63bc52baa" title="获取当前线程ID" alt="" coords="228,203,317,228"/>
<area shape="poly" title=" " alt="" coords="149,197,214,206,214,211,148,203"/>
<area shape="rect" href="syscall_8cpp.html#ab5c00759c95d8ce9e9db75b1b55a9552" title="设置线程ID地址（用于线程退出时的清理）" alt="" coords="196,252,349,277"/>
<area shape="poly" title=" " alt="" coords="109,202,197,237,220,245,218,250,195,242,107,207"/>
<area shape="rect" href="syscall_8cpp.html#a4fa66935c10e294006b6310af1c68f37" title="向文件描述符写入数据" alt="" coords="231,351,315,376"/>
<area shape="poly" title=" " alt="" coords="87,203,129,266,160,304,198,336,219,347,216,352,194,340,156,307,124,269,83,206"/>
<area shape="rect" href="syscall_8cpp.html#a23ac80734740f098e56332da33758ace" title="主动放弃CPU，让出时间片" alt="" coords="231,301,314,327"/>
<area shape="poly" title=" " alt="" coords="92,203,137,243,166,266,197,286,219,296,217,301,195,291,163,271,133,247,89,206"/>
<area shape="rect" href="classSingleton.html#a68856b49e098eadba37b60366db33ebd" title=" " alt="" coords="397,153,567,179"/>
<area shape="poly" title=" " alt="" coords="317,25,351,40,385,63,416,90,464,141,460,145,412,94,381,67,348,44,315,30"/>
<area shape="poly" title=" " alt="" coords="312,75,350,89,405,116,451,144,449,148,402,121,348,94,310,80"/>
<area shape="poly" title=" " alt="" coords="312,123,415,148,414,153,311,128"/>
<area shape="poly" title=" " alt="" coords="316,163,383,163,383,169,316,169"/>
<area shape="poly" title=" " alt="" coords="317,202,414,179,415,184,318,207"/>
<area shape="poly" title=" " alt="" coords="315,249,348,237,401,210,448,184,450,188,404,215,350,242,317,254"/>
<area shape="rect" href="sk__stdio_8h.html#ad8142b94111a30f723c6c0a2301bae7f" title=" " alt="" coords="443,351,521,376"/>
<area shape="poly" title=" " alt="" coords="315,361,429,361,429,366,315,366"/>
<area shape="poly" title=" " alt="" coords="313,302,348,286,381,263,412,237,460,187,463,191,415,241,384,268,351,291,315,306"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="syscall_8hpp_a9c01f57bb4ef6f1b91ccce212494a199_icgraph.png" border="0" usemap="#asyscall_8hpp_a9c01f57bb4ef6f1b91ccce212494a199_icgraph" alt=""/></div>
<map name="asyscall_8hpp_a9c01f57bb4ef6f1b91ccce212494a199_icgraph" id="asyscall_8hpp_a9c01f57bb4ef6f1b91ccce212494a199_icgraph">
<area shape="rect" title=" " alt="" coords="121,5,264,31"/>
<area shape="rect" href="arch_2aarch64_2syscall_8cpp.html#a27f252437c17e7b5d2e8aef749daf1f0" title=" " alt="" coords="5,5,73,31"/>
<area shape="poly" title=" " alt="" coords="108,21,74,21,74,15,108,15"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_b0856f6b0d80ccb263b2f415c91f9e17.html">include</a></li><li class="navelem"><a class="el" href="syscall_8hpp.html">syscall.hpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
